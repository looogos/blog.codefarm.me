<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>3 - Kubernetes Services and Ingress | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="3 - Kubernetes Services and Ingress" />
<meta property="og:locale" content="en" />
<meta name="description" content="Contents Services Discover &amp; Environment variables (00) Services Discover &amp; Environment variables (01) Services Discover &amp; Environment variables (10) Services Discover &amp; DNS (00) Services Discover &amp; DNS (01) Services Discover &amp; DNS (10) Services Discover &amp; DNS (11) Services with Label Selectors (00) Services with Label Selectors (01) Services with Label Selectors (10) Services with Label Selectors (11) Services without Label Selectors (00) Services without Label Selectors (01) Headless Services with Label Selectors (00) Headless Services with Label Selectors (01) Headless Services without Label Selectors (00) Headless Services without Label Selectors (01) NodePort Services (00) NodePort Services (01) NodePort Services (10) NodePort Services (11) Ingress Ingress Controller Ingress Controller Ingress TLS &amp; Rules (00) Ingress TLS &amp; Rules (01) Ingress TLS &amp; Rules (10) References Quit or not quit ? Contents Services Discover Environment Variables DNS (recommended) Services with/without Label Selector Headless Services with/without Label Selector Service Types ClusterIP/ExternalName/NodePort Ingress Services Discover &amp; Environment variables (00) $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 32h $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl exec nginx-5f47c69c5b-8ppph env KUBERNETES_SERVICE_HOST=10.96.0.1 KUBERNETES_SERVICE_PORT=443 Services Discover &amp; Environment variables (01) $ kubectl expose deployment nginx --port=80 service/nginx exposed $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 33h nginx ClusterIP 10.101.123.96 &lt;none&gt; 80/TCP 9m50s $ kubectl exec -it nginx-5f47c69c5b-8ppph env KUBERNETES_SERVICE_HOST=10.96.0.1 KUBERNETES_SERVICE_PORT=443 Services Discover &amp; Environment variables (10) $ kubectl delete po nginx-5f47c69c5b-8ppph pod &quot;nginx-5f47c69c5b-8ppph&quot; deleted $ kubectl exec nginx-5f47c69c5b-v7kkm env KUBERNETES_SERVICE_PORT=443 KUBERNETES_SERVICE_HOST=10.96.0.1 NGINX_SERVICE_HOST=10.101.123.96 NGINX_SERVICE_PORT=80 Services Discover &amp; DNS (00) $ kubectl get svc --all-namespaces NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 33h kube-system default-http-backend NodePort 10.108.162.115 &lt;none&gt; 80:30001/TCP 3d4h kube-system kube-dns ClusterIP 10.96.0.10 &lt;none&gt; 53/UDP,53/TCP 10d kube-system kubernetes-dashboard NodePort 10.108.191.216 &lt;none&gt; 443:31115/TCP 33h Services Discover &amp; DNS (01) # network-utils-pod.yaml apiVersion: v1 kind: Pod metadata: name: network-utils namespace: default labels: app: network-utils spec: containers: - name: network-utils image: amouat/network-utils command: [&#39;sleep&#39;, &#39;10h&#39;] Services Discover &amp; DNS (10) $ kubectl create -f network-utils-pod.yaml pod/network-utils created $ kubectl exec -it network-utils bash root@network-utils:/# nslookup kubernetes Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kubernetes.default.svc.cluster.local Address: 10.96.0.1 root@network-utils:/# nslookup kubernetes.default Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kubernetes.default.svc.cluster.local Address: 10.96.0.1 Services Discover &amp; DNS (11) root@network-utils:/# nslookup kube-dns ;; connection timed out; no servers could be reached root@network-utils:/# nslookup kube-dns.kube-system Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kube-dns.kube-system.svc.cluster.local Address: 10.96.0.10 Services with Label Selectors (00) $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl expose deployment nginx --port=80 service/nginx exposed $ kubectl get svc,ep -l app=nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/nginx ClusterIP 10.111.193.91 &lt;none&gt; 80/TCP 59s NAME ENDPOINTS AGE endpoints/nginx 10.244.0.124:80 59s $ kubectl exec network-utils nslookup nginx Server: 10.96.0.10 Address: 10.96.0.10#53 Name: nginx.default.svc.cluster.local Address: 10.111.193.91 Services with Label Selectors (01) $ kubectl get ep nginx -oyaml --export apiVersion: v1 kind: Endpoints metadata: labels: app: nginx name: nginx subsets: - addresses: - ip: 10.244.0.124 targetRef: kind: Pod name: nginx-5f47c69c5b-vlt69 ports: - port: 80 protocol: TCP Services with Label Selectors (10) $ kubectl get svc nginx -oyaml --export apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx spec: ports: - port: 80 protocol: TCP targetPort: 80 selector: app: nginx type: ClusterIP Services with Label Selectors (11) $ kubectl scale deployment nginx --replicas=3 deployment.extensions/nginx scaled $ kubectl get po -l app=nginx -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-5f47c69c5b-bw7wm 1/1 Running 0 15s 10.244.0.127 far-seer-01 &lt;none&gt; &lt;none&gt; nginx-5f47c69c5b-shcch 1/1 Running 0 15s 10.244.0.128 far-seer-01 &lt;none&gt; &lt;none&gt; nginx-5f47c69c5b-vlt69 1/1 Running 0 6m10s 10.244.0.124 far-seer-01 &lt;none&gt; &lt;none&gt; $ kubectl get ep -l app=nginx NAME ENDPOINTS AGE nginx 10.244.0.124:80,10.244.0.127:80,10.244.0.128:80 6m13s $ kubectl exec network-utils nslookup nginx Server: 10.96.0.10 Address: 10.96.0.10#53 Name: nginx.default.svc.cluster.local Address: 10.102.44.128 Services without Label Selectors (00) # mongo-svc.yaml (1) apiVersion: v1 kind: Service metadata: name: mongo labels: app: mongo spec: ports: - port: 27017 targetPort: 27017 type: ClusterIP # mongo-svc.yaml (2) apiVersion: v1 kind: Endpoints metadata: name: mongo labels: app: mongo subsets: - addresses: - ip: 10.200.200.157 ports: - port: 27017 Services without Label Selectors (01) $ kubectl create -f mongo-svc.yaml service/mongo created endpoints/mongo created $ kubectl get svc,ep -l app=mongo NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/mongo ClusterIP 10.103.114.91 &lt;none&gt; 27017/TCP 12s NAME ENDPOINTS AGE endpoints/mongo 10.200.200.157:27017 11s $ kubectl exec network-utils nslookup mongo Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongo.default.svc.cluster.local Address: 10.103.114.91 Headless Services with Label Selectors (00) # hmac-svc.yaml apiVersion: v1 kind: Service metadata: labels: app: hmacsvc name: hmacsvc spec: externalName: hmac.internal.example.com type: ExternalName Headless Services with Label Selectors (01) $ kubectl create -f hmac-svc.yaml service/hmacsvc created $ kubectl get svc hamcsvc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hmacsvc ExternalName &lt;none&gt; hmac.internal.example.com &lt;none&gt; 7s $ kubectl exec network-utils nslookup hmacsvc Server: 10.96.0.10 Address: 10.96.0.10#53 hmacsvc.default.svc.cluster.local canonical name = hmac.internal.example.com. Headless Services without Label Selectors (00) # prod-mongo-svc.yaml apiVersion: v1 kind: Service metadata: name: prod-mongo labels: app: prod-mongo spec: ports: - port: 27017 targetPort: 27017 type: ClusterIP # prod-mongo-svc.yaml apiVersion: v1 kind: Endpoints metadata: name: prod-mongo labels: app: prod-mongo subsets: - addresses: - ip: 10.10.43.10 ports: - port: 27017 - addresses: - ip: 10.10.43.11 ports: - port: 27017 - addresses: - ip: 10.10.43.12 ports: - port: 27017 Headless Services without Label Selectors (01) $ kubectl create -f prod-mongo-svc.yaml service/prod-mongo created endpoints/prod-mongo created $ kubectl get svc,ep -l app=prod-mongo NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/prod-mongo ClusterIP None &lt;none&gt; 27017/TCP 7s NAME ENDPOINTS AGE endpoints/prod-mongo 10.10.43.10:27017,10.10.43.11:27017,10.10.43.12:27017 7s $ kubectl exec network-utils nslookup prod-mongo Server: 10.96.0.10 Address: 10.96.0.10#53 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.11 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.10 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.12 NodePort Services (00) $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl expose deployment nginx --type=NodePort --port=80 service/nginx exposed $ kubectl get svc -l app NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx NodePort 10.106.42.214 &lt;none&gt; 80:31868/TCP 32s $ curl -iI localhost:31868 HTTP/1.1 200 OK Server: nginx/1.15.8 Date: Mon, 11 Mar 2019 02:42:28 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT Connection: keep-alive ETag: &quot;5c21fedf-264&quot; Accept-Ranges: bytes NodePort Services (01) # kubectl get svc nginx -oyaml --export apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx spec: ports: - port: 80 targetPort: 80 selector: app: nginx type: NodePort NodePort Services (10) # nginx-svc.yaml apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx-01 spec: ports: - port: 80 targetPort: 80 nodePort: 31115 selector: app: nginx type: NodePort NodePort Services (11) $ kubectl create -f nginx-svc.yaml service/nginx-01 created $ kubectl get svc -l app NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx NodePort 10.106.42.214 &lt;none&gt; 80:31868/TCP 12m nginx-01 NodePort 10.104.36.29 &lt;none&gt; 80:31115/TCP 5s $ curl -iI localhost:31115 HTTP/1.1 200 OK Server: nginx/1.15.8 Date: Mon, 11 Mar 2019 02:54:30 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT Connection: keep-alive ETag: &quot;5c21fedf-264&quot; Accept-Ranges: bytes Ingress Ingress Controller $ kubectl get po -n kube-system NAME READY STATUS RESTARTS AGE coredns-86c58d9df4-cnx48 1/1 Running 11 13d coredns-86c58d9df4-x46nn 1/1 Running 15 13d default-http-backend-676d78555d-54jvx 1/1 Running 23 6d1h etcd-far-seer-01 1/1 Running 9 13d kube-apiserver-far-seer-01 1/1 Running 1 3d1h kube-controller-manager-far-seer-01 1/1 Running 71 13d kube-flannel-ds-amd64-vrt27 1/1 Running 11 13d kube-proxy-b4lqx 1/1 Running 9 13d kube-scheduler-far-seer-01 1/1 Running 69 13d kubernetes-dashboard-7bbbdc6696-rrzk4 1/1 Running 0 6h4m nginx-ingress-controller-779d9d54f-k795k 1/1 Running 83 6d1h Ingress Controller # kubectl -n kube-system get po nginx-ingress-controller-779d9d54f-k795k -oyaml spec: containers: - args: - /nginx-ingress-controller - --default-backend-service=$(POD_NAMESPACE)/default-http-backend - --configmap=$(POD_NAMESPACE)/nginx-load-balancer-conf - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services - --udp-services-configmap=$(POD_NAMESPACE)/udp-services - --annotations-prefix=nginx.ingress.kubernetes.io - --report-node-internal-ip-address name: nginx-ingress-controller ports: - containerPort: 80 hostPort: 80 protocol: TCP - containerPort: 443 hostPort: 443 protocol: TCP Ingress TLS &amp; Rules (00) $ openssl req -x509 -nodes -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=*.bar.com&quot; Generating a RSA private key ...........................................................................................................................+++++ ........................................................................+++++ writing new private key to &#39;tls.key&#39; ----- $ kubectl create secret tls tls-crt --cert=tls.crt --key=tls.key secret/tls-crt created $ kubectl get secret NAME TYPE DATA AGE default-token-5gh7g kubernetes.io/service-account-token 3 13d tls-crt kubernetes.io/tls 2 31s Ingress TLS &amp; Rules (01) # foo-bar-ing.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata: name: foo-bar annotations: kubernetes.io/ingress.class: &quot;nginx&quot; nginx.ingress.kubernetes.io/rewrite-target: / spec: tls: - hosts: - &#39;*.bar.com&#39; secretName: tls-crt rules: - host: &#39;foo.bar.com&#39; http: paths: - path: / backend: serviceName: foo-bar servicePort: 80 Ingress TLS &amp; Rules (10) $ kubectl create -f ingress.yaml ingress.extensions/foo-bar created $ kubectl get ing NAME HOSTS ADDRESS PORTS AGE foo-bar foo.bar.com 192.168.66.128 80, 443 101s $ curl -iILk http://foo.bar.com HTTP/1.1 308 Permanent Redirect Location: https://foo.bar.com/ HTTP/2 200 server: nginx/1.15.8 References https://kubernetes.io/docs/concepts/services-networking/service/ https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services https://kubernetes.io/docs/concepts/services-networking/service/#headless-services https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types https://kubernetes.io/docs/concepts/services-networking/ingress/ https://kubernetes.io/docs/concepts/services-networking/ingress/#name-based-virtual-hosting https://kubernetes.io/docs/concepts/services-networking/ingress/#tls https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts Quit or not quit ? https://kubernetes.io/" />
<meta property="og:description" content="Contents Services Discover &amp; Environment variables (00) Services Discover &amp; Environment variables (01) Services Discover &amp; Environment variables (10) Services Discover &amp; DNS (00) Services Discover &amp; DNS (01) Services Discover &amp; DNS (10) Services Discover &amp; DNS (11) Services with Label Selectors (00) Services with Label Selectors (01) Services with Label Selectors (10) Services with Label Selectors (11) Services without Label Selectors (00) Services without Label Selectors (01) Headless Services with Label Selectors (00) Headless Services with Label Selectors (01) Headless Services without Label Selectors (00) Headless Services without Label Selectors (01) NodePort Services (00) NodePort Services (01) NodePort Services (10) NodePort Services (11) Ingress Ingress Controller Ingress Controller Ingress TLS &amp; Rules (00) Ingress TLS &amp; Rules (01) Ingress TLS &amp; Rules (10) References Quit or not quit ? Contents Services Discover Environment Variables DNS (recommended) Services with/without Label Selector Headless Services with/without Label Selector Service Types ClusterIP/ExternalName/NodePort Ingress Services Discover &amp; Environment variables (00) $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 32h $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl exec nginx-5f47c69c5b-8ppph env KUBERNETES_SERVICE_HOST=10.96.0.1 KUBERNETES_SERVICE_PORT=443 Services Discover &amp; Environment variables (01) $ kubectl expose deployment nginx --port=80 service/nginx exposed $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 33h nginx ClusterIP 10.101.123.96 &lt;none&gt; 80/TCP 9m50s $ kubectl exec -it nginx-5f47c69c5b-8ppph env KUBERNETES_SERVICE_HOST=10.96.0.1 KUBERNETES_SERVICE_PORT=443 Services Discover &amp; Environment variables (10) $ kubectl delete po nginx-5f47c69c5b-8ppph pod &quot;nginx-5f47c69c5b-8ppph&quot; deleted $ kubectl exec nginx-5f47c69c5b-v7kkm env KUBERNETES_SERVICE_PORT=443 KUBERNETES_SERVICE_HOST=10.96.0.1 NGINX_SERVICE_HOST=10.101.123.96 NGINX_SERVICE_PORT=80 Services Discover &amp; DNS (00) $ kubectl get svc --all-namespaces NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 33h kube-system default-http-backend NodePort 10.108.162.115 &lt;none&gt; 80:30001/TCP 3d4h kube-system kube-dns ClusterIP 10.96.0.10 &lt;none&gt; 53/UDP,53/TCP 10d kube-system kubernetes-dashboard NodePort 10.108.191.216 &lt;none&gt; 443:31115/TCP 33h Services Discover &amp; DNS (01) # network-utils-pod.yaml apiVersion: v1 kind: Pod metadata: name: network-utils namespace: default labels: app: network-utils spec: containers: - name: network-utils image: amouat/network-utils command: [&#39;sleep&#39;, &#39;10h&#39;] Services Discover &amp; DNS (10) $ kubectl create -f network-utils-pod.yaml pod/network-utils created $ kubectl exec -it network-utils bash root@network-utils:/# nslookup kubernetes Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kubernetes.default.svc.cluster.local Address: 10.96.0.1 root@network-utils:/# nslookup kubernetes.default Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kubernetes.default.svc.cluster.local Address: 10.96.0.1 Services Discover &amp; DNS (11) root@network-utils:/# nslookup kube-dns ;; connection timed out; no servers could be reached root@network-utils:/# nslookup kube-dns.kube-system Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kube-dns.kube-system.svc.cluster.local Address: 10.96.0.10 Services with Label Selectors (00) $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl expose deployment nginx --port=80 service/nginx exposed $ kubectl get svc,ep -l app=nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/nginx ClusterIP 10.111.193.91 &lt;none&gt; 80/TCP 59s NAME ENDPOINTS AGE endpoints/nginx 10.244.0.124:80 59s $ kubectl exec network-utils nslookup nginx Server: 10.96.0.10 Address: 10.96.0.10#53 Name: nginx.default.svc.cluster.local Address: 10.111.193.91 Services with Label Selectors (01) $ kubectl get ep nginx -oyaml --export apiVersion: v1 kind: Endpoints metadata: labels: app: nginx name: nginx subsets: - addresses: - ip: 10.244.0.124 targetRef: kind: Pod name: nginx-5f47c69c5b-vlt69 ports: - port: 80 protocol: TCP Services with Label Selectors (10) $ kubectl get svc nginx -oyaml --export apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx spec: ports: - port: 80 protocol: TCP targetPort: 80 selector: app: nginx type: ClusterIP Services with Label Selectors (11) $ kubectl scale deployment nginx --replicas=3 deployment.extensions/nginx scaled $ kubectl get po -l app=nginx -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-5f47c69c5b-bw7wm 1/1 Running 0 15s 10.244.0.127 far-seer-01 &lt;none&gt; &lt;none&gt; nginx-5f47c69c5b-shcch 1/1 Running 0 15s 10.244.0.128 far-seer-01 &lt;none&gt; &lt;none&gt; nginx-5f47c69c5b-vlt69 1/1 Running 0 6m10s 10.244.0.124 far-seer-01 &lt;none&gt; &lt;none&gt; $ kubectl get ep -l app=nginx NAME ENDPOINTS AGE nginx 10.244.0.124:80,10.244.0.127:80,10.244.0.128:80 6m13s $ kubectl exec network-utils nslookup nginx Server: 10.96.0.10 Address: 10.96.0.10#53 Name: nginx.default.svc.cluster.local Address: 10.102.44.128 Services without Label Selectors (00) # mongo-svc.yaml (1) apiVersion: v1 kind: Service metadata: name: mongo labels: app: mongo spec: ports: - port: 27017 targetPort: 27017 type: ClusterIP # mongo-svc.yaml (2) apiVersion: v1 kind: Endpoints metadata: name: mongo labels: app: mongo subsets: - addresses: - ip: 10.200.200.157 ports: - port: 27017 Services without Label Selectors (01) $ kubectl create -f mongo-svc.yaml service/mongo created endpoints/mongo created $ kubectl get svc,ep -l app=mongo NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/mongo ClusterIP 10.103.114.91 &lt;none&gt; 27017/TCP 12s NAME ENDPOINTS AGE endpoints/mongo 10.200.200.157:27017 11s $ kubectl exec network-utils nslookup mongo Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongo.default.svc.cluster.local Address: 10.103.114.91 Headless Services with Label Selectors (00) # hmac-svc.yaml apiVersion: v1 kind: Service metadata: labels: app: hmacsvc name: hmacsvc spec: externalName: hmac.internal.example.com type: ExternalName Headless Services with Label Selectors (01) $ kubectl create -f hmac-svc.yaml service/hmacsvc created $ kubectl get svc hamcsvc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hmacsvc ExternalName &lt;none&gt; hmac.internal.example.com &lt;none&gt; 7s $ kubectl exec network-utils nslookup hmacsvc Server: 10.96.0.10 Address: 10.96.0.10#53 hmacsvc.default.svc.cluster.local canonical name = hmac.internal.example.com. Headless Services without Label Selectors (00) # prod-mongo-svc.yaml apiVersion: v1 kind: Service metadata: name: prod-mongo labels: app: prod-mongo spec: ports: - port: 27017 targetPort: 27017 type: ClusterIP # prod-mongo-svc.yaml apiVersion: v1 kind: Endpoints metadata: name: prod-mongo labels: app: prod-mongo subsets: - addresses: - ip: 10.10.43.10 ports: - port: 27017 - addresses: - ip: 10.10.43.11 ports: - port: 27017 - addresses: - ip: 10.10.43.12 ports: - port: 27017 Headless Services without Label Selectors (01) $ kubectl create -f prod-mongo-svc.yaml service/prod-mongo created endpoints/prod-mongo created $ kubectl get svc,ep -l app=prod-mongo NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/prod-mongo ClusterIP None &lt;none&gt; 27017/TCP 7s NAME ENDPOINTS AGE endpoints/prod-mongo 10.10.43.10:27017,10.10.43.11:27017,10.10.43.12:27017 7s $ kubectl exec network-utils nslookup prod-mongo Server: 10.96.0.10 Address: 10.96.0.10#53 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.11 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.10 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.12 NodePort Services (00) $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl expose deployment nginx --type=NodePort --port=80 service/nginx exposed $ kubectl get svc -l app NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx NodePort 10.106.42.214 &lt;none&gt; 80:31868/TCP 32s $ curl -iI localhost:31868 HTTP/1.1 200 OK Server: nginx/1.15.8 Date: Mon, 11 Mar 2019 02:42:28 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT Connection: keep-alive ETag: &quot;5c21fedf-264&quot; Accept-Ranges: bytes NodePort Services (01) # kubectl get svc nginx -oyaml --export apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx spec: ports: - port: 80 targetPort: 80 selector: app: nginx type: NodePort NodePort Services (10) # nginx-svc.yaml apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx-01 spec: ports: - port: 80 targetPort: 80 nodePort: 31115 selector: app: nginx type: NodePort NodePort Services (11) $ kubectl create -f nginx-svc.yaml service/nginx-01 created $ kubectl get svc -l app NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx NodePort 10.106.42.214 &lt;none&gt; 80:31868/TCP 12m nginx-01 NodePort 10.104.36.29 &lt;none&gt; 80:31115/TCP 5s $ curl -iI localhost:31115 HTTP/1.1 200 OK Server: nginx/1.15.8 Date: Mon, 11 Mar 2019 02:54:30 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT Connection: keep-alive ETag: &quot;5c21fedf-264&quot; Accept-Ranges: bytes Ingress Ingress Controller $ kubectl get po -n kube-system NAME READY STATUS RESTARTS AGE coredns-86c58d9df4-cnx48 1/1 Running 11 13d coredns-86c58d9df4-x46nn 1/1 Running 15 13d default-http-backend-676d78555d-54jvx 1/1 Running 23 6d1h etcd-far-seer-01 1/1 Running 9 13d kube-apiserver-far-seer-01 1/1 Running 1 3d1h kube-controller-manager-far-seer-01 1/1 Running 71 13d kube-flannel-ds-amd64-vrt27 1/1 Running 11 13d kube-proxy-b4lqx 1/1 Running 9 13d kube-scheduler-far-seer-01 1/1 Running 69 13d kubernetes-dashboard-7bbbdc6696-rrzk4 1/1 Running 0 6h4m nginx-ingress-controller-779d9d54f-k795k 1/1 Running 83 6d1h Ingress Controller # kubectl -n kube-system get po nginx-ingress-controller-779d9d54f-k795k -oyaml spec: containers: - args: - /nginx-ingress-controller - --default-backend-service=$(POD_NAMESPACE)/default-http-backend - --configmap=$(POD_NAMESPACE)/nginx-load-balancer-conf - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services - --udp-services-configmap=$(POD_NAMESPACE)/udp-services - --annotations-prefix=nginx.ingress.kubernetes.io - --report-node-internal-ip-address name: nginx-ingress-controller ports: - containerPort: 80 hostPort: 80 protocol: TCP - containerPort: 443 hostPort: 443 protocol: TCP Ingress TLS &amp; Rules (00) $ openssl req -x509 -nodes -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=*.bar.com&quot; Generating a RSA private key ...........................................................................................................................+++++ ........................................................................+++++ writing new private key to &#39;tls.key&#39; ----- $ kubectl create secret tls tls-crt --cert=tls.crt --key=tls.key secret/tls-crt created $ kubectl get secret NAME TYPE DATA AGE default-token-5gh7g kubernetes.io/service-account-token 3 13d tls-crt kubernetes.io/tls 2 31s Ingress TLS &amp; Rules (01) # foo-bar-ing.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata: name: foo-bar annotations: kubernetes.io/ingress.class: &quot;nginx&quot; nginx.ingress.kubernetes.io/rewrite-target: / spec: tls: - hosts: - &#39;*.bar.com&#39; secretName: tls-crt rules: - host: &#39;foo.bar.com&#39; http: paths: - path: / backend: serviceName: foo-bar servicePort: 80 Ingress TLS &amp; Rules (10) $ kubectl create -f ingress.yaml ingress.extensions/foo-bar created $ kubectl get ing NAME HOSTS ADDRESS PORTS AGE foo-bar foo.bar.com 192.168.66.128 80, 443 101s $ curl -iILk http://foo.bar.com HTTP/1.1 308 Permanent Redirect Location: https://foo.bar.com/ HTTP/2 200 server: nginx/1.15.8 References https://kubernetes.io/docs/concepts/services-networking/service/ https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services https://kubernetes.io/docs/concepts/services-networking/service/#headless-services https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types https://kubernetes.io/docs/concepts/services-networking/ingress/ https://kubernetes.io/docs/concepts/services-networking/ingress/#name-based-virtual-hosting https://kubernetes.io/docs/concepts/services-networking/ingress/#tls https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts Quit or not quit ? https://kubernetes.io/" />
<link rel="canonical" href="https://blog.codefarm.me/2019/03/04/kubernetes-crash-course-3/" />
<meta property="og:url" content="https://blog.codefarm.me/2019/03/04/kubernetes-crash-course-3/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-04T17:55:05+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="3 - Kubernetes Services and Ingress" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-03-04T17:55:05+08:00","datePublished":"2019-03-04T17:55:05+08:00","description":"Contents Services Discover &amp; Environment variables (00) Services Discover &amp; Environment variables (01) Services Discover &amp; Environment variables (10) Services Discover &amp; DNS (00) Services Discover &amp; DNS (01) Services Discover &amp; DNS (10) Services Discover &amp; DNS (11) Services with Label Selectors (00) Services with Label Selectors (01) Services with Label Selectors (10) Services with Label Selectors (11) Services without Label Selectors (00) Services without Label Selectors (01) Headless Services with Label Selectors (00) Headless Services with Label Selectors (01) Headless Services without Label Selectors (00) Headless Services without Label Selectors (01) NodePort Services (00) NodePort Services (01) NodePort Services (10) NodePort Services (11) Ingress Ingress Controller Ingress Controller Ingress TLS &amp; Rules (00) Ingress TLS &amp; Rules (01) Ingress TLS &amp; Rules (10) References Quit or not quit ? Contents Services Discover Environment Variables DNS (recommended) Services with/without Label Selector Headless Services with/without Label Selector Service Types ClusterIP/ExternalName/NodePort Ingress Services Discover &amp; Environment variables (00) $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 32h $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl exec nginx-5f47c69c5b-8ppph env KUBERNETES_SERVICE_HOST=10.96.0.1 KUBERNETES_SERVICE_PORT=443 Services Discover &amp; Environment variables (01) $ kubectl expose deployment nginx --port=80 service/nginx exposed $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 33h nginx ClusterIP 10.101.123.96 &lt;none&gt; 80/TCP 9m50s $ kubectl exec -it nginx-5f47c69c5b-8ppph env KUBERNETES_SERVICE_HOST=10.96.0.1 KUBERNETES_SERVICE_PORT=443 Services Discover &amp; Environment variables (10) $ kubectl delete po nginx-5f47c69c5b-8ppph pod &quot;nginx-5f47c69c5b-8ppph&quot; deleted $ kubectl exec nginx-5f47c69c5b-v7kkm env KUBERNETES_SERVICE_PORT=443 KUBERNETES_SERVICE_HOST=10.96.0.1 NGINX_SERVICE_HOST=10.101.123.96 NGINX_SERVICE_PORT=80 Services Discover &amp; DNS (00) $ kubectl get svc --all-namespaces NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 33h kube-system default-http-backend NodePort 10.108.162.115 &lt;none&gt; 80:30001/TCP 3d4h kube-system kube-dns ClusterIP 10.96.0.10 &lt;none&gt; 53/UDP,53/TCP 10d kube-system kubernetes-dashboard NodePort 10.108.191.216 &lt;none&gt; 443:31115/TCP 33h Services Discover &amp; DNS (01) # network-utils-pod.yaml apiVersion: v1 kind: Pod metadata: name: network-utils namespace: default labels: app: network-utils spec: containers: - name: network-utils image: amouat/network-utils command: [&#39;sleep&#39;, &#39;10h&#39;] Services Discover &amp; DNS (10) $ kubectl create -f network-utils-pod.yaml pod/network-utils created $ kubectl exec -it network-utils bash root@network-utils:/# nslookup kubernetes Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kubernetes.default.svc.cluster.local Address: 10.96.0.1 root@network-utils:/# nslookup kubernetes.default Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kubernetes.default.svc.cluster.local Address: 10.96.0.1 Services Discover &amp; DNS (11) root@network-utils:/# nslookup kube-dns ;; connection timed out; no servers could be reached root@network-utils:/# nslookup kube-dns.kube-system Server: 10.96.0.10 Address: 10.96.0.10#53 Name: kube-dns.kube-system.svc.cluster.local Address: 10.96.0.10 Services with Label Selectors (00) $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl expose deployment nginx --port=80 service/nginx exposed $ kubectl get svc,ep -l app=nginx NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/nginx ClusterIP 10.111.193.91 &lt;none&gt; 80/TCP 59s NAME ENDPOINTS AGE endpoints/nginx 10.244.0.124:80 59s $ kubectl exec network-utils nslookup nginx Server: 10.96.0.10 Address: 10.96.0.10#53 Name: nginx.default.svc.cluster.local Address: 10.111.193.91 Services with Label Selectors (01) $ kubectl get ep nginx -oyaml --export apiVersion: v1 kind: Endpoints metadata: labels: app: nginx name: nginx subsets: - addresses: - ip: 10.244.0.124 targetRef: kind: Pod name: nginx-5f47c69c5b-vlt69 ports: - port: 80 protocol: TCP Services with Label Selectors (10) $ kubectl get svc nginx -oyaml --export apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx spec: ports: - port: 80 protocol: TCP targetPort: 80 selector: app: nginx type: ClusterIP Services with Label Selectors (11) $ kubectl scale deployment nginx --replicas=3 deployment.extensions/nginx scaled $ kubectl get po -l app=nginx -owide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES nginx-5f47c69c5b-bw7wm 1/1 Running 0 15s 10.244.0.127 far-seer-01 &lt;none&gt; &lt;none&gt; nginx-5f47c69c5b-shcch 1/1 Running 0 15s 10.244.0.128 far-seer-01 &lt;none&gt; &lt;none&gt; nginx-5f47c69c5b-vlt69 1/1 Running 0 6m10s 10.244.0.124 far-seer-01 &lt;none&gt; &lt;none&gt; $ kubectl get ep -l app=nginx NAME ENDPOINTS AGE nginx 10.244.0.124:80,10.244.0.127:80,10.244.0.128:80 6m13s $ kubectl exec network-utils nslookup nginx Server: 10.96.0.10 Address: 10.96.0.10#53 Name: nginx.default.svc.cluster.local Address: 10.102.44.128 Services without Label Selectors (00) # mongo-svc.yaml (1) apiVersion: v1 kind: Service metadata: name: mongo labels: app: mongo spec: ports: - port: 27017 targetPort: 27017 type: ClusterIP # mongo-svc.yaml (2) apiVersion: v1 kind: Endpoints metadata: name: mongo labels: app: mongo subsets: - addresses: - ip: 10.200.200.157 ports: - port: 27017 Services without Label Selectors (01) $ kubectl create -f mongo-svc.yaml service/mongo created endpoints/mongo created $ kubectl get svc,ep -l app=mongo NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/mongo ClusterIP 10.103.114.91 &lt;none&gt; 27017/TCP 12s NAME ENDPOINTS AGE endpoints/mongo 10.200.200.157:27017 11s $ kubectl exec network-utils nslookup mongo Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongo.default.svc.cluster.local Address: 10.103.114.91 Headless Services with Label Selectors (00) # hmac-svc.yaml apiVersion: v1 kind: Service metadata: labels: app: hmacsvc name: hmacsvc spec: externalName: hmac.internal.example.com type: ExternalName Headless Services with Label Selectors (01) $ kubectl create -f hmac-svc.yaml service/hmacsvc created $ kubectl get svc hamcsvc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE hmacsvc ExternalName &lt;none&gt; hmac.internal.example.com &lt;none&gt; 7s $ kubectl exec network-utils nslookup hmacsvc Server: 10.96.0.10 Address: 10.96.0.10#53 hmacsvc.default.svc.cluster.local canonical name = hmac.internal.example.com. Headless Services without Label Selectors (00) # prod-mongo-svc.yaml apiVersion: v1 kind: Service metadata: name: prod-mongo labels: app: prod-mongo spec: ports: - port: 27017 targetPort: 27017 type: ClusterIP # prod-mongo-svc.yaml apiVersion: v1 kind: Endpoints metadata: name: prod-mongo labels: app: prod-mongo subsets: - addresses: - ip: 10.10.43.10 ports: - port: 27017 - addresses: - ip: 10.10.43.11 ports: - port: 27017 - addresses: - ip: 10.10.43.12 ports: - port: 27017 Headless Services without Label Selectors (01) $ kubectl create -f prod-mongo-svc.yaml service/prod-mongo created endpoints/prod-mongo created $ kubectl get svc,ep -l app=prod-mongo NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/prod-mongo ClusterIP None &lt;none&gt; 27017/TCP 7s NAME ENDPOINTS AGE endpoints/prod-mongo 10.10.43.10:27017,10.10.43.11:27017,10.10.43.12:27017 7s $ kubectl exec network-utils nslookup prod-mongo Server: 10.96.0.10 Address: 10.96.0.10#53 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.11 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.10 Name: prod-mongo.default.svc.cluster.local Address: 10.10.43.12 NodePort Services (00) $ kubectl create deployment nginx --image=nginx:1.15 deployment.apps/nginx created $ kubectl expose deployment nginx --type=NodePort --port=80 service/nginx exposed $ kubectl get svc -l app NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx NodePort 10.106.42.214 &lt;none&gt; 80:31868/TCP 32s $ curl -iI localhost:31868 HTTP/1.1 200 OK Server: nginx/1.15.8 Date: Mon, 11 Mar 2019 02:42:28 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT Connection: keep-alive ETag: &quot;5c21fedf-264&quot; Accept-Ranges: bytes NodePort Services (01) # kubectl get svc nginx -oyaml --export apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx spec: ports: - port: 80 targetPort: 80 selector: app: nginx type: NodePort NodePort Services (10) # nginx-svc.yaml apiVersion: v1 kind: Service metadata: labels: app: nginx name: nginx-01 spec: ports: - port: 80 targetPort: 80 nodePort: 31115 selector: app: nginx type: NodePort NodePort Services (11) $ kubectl create -f nginx-svc.yaml service/nginx-01 created $ kubectl get svc -l app NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE nginx NodePort 10.106.42.214 &lt;none&gt; 80:31868/TCP 12m nginx-01 NodePort 10.104.36.29 &lt;none&gt; 80:31115/TCP 5s $ curl -iI localhost:31115 HTTP/1.1 200 OK Server: nginx/1.15.8 Date: Mon, 11 Mar 2019 02:54:30 GMT Content-Type: text/html Content-Length: 612 Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT Connection: keep-alive ETag: &quot;5c21fedf-264&quot; Accept-Ranges: bytes Ingress Ingress Controller $ kubectl get po -n kube-system NAME READY STATUS RESTARTS AGE coredns-86c58d9df4-cnx48 1/1 Running 11 13d coredns-86c58d9df4-x46nn 1/1 Running 15 13d default-http-backend-676d78555d-54jvx 1/1 Running 23 6d1h etcd-far-seer-01 1/1 Running 9 13d kube-apiserver-far-seer-01 1/1 Running 1 3d1h kube-controller-manager-far-seer-01 1/1 Running 71 13d kube-flannel-ds-amd64-vrt27 1/1 Running 11 13d kube-proxy-b4lqx 1/1 Running 9 13d kube-scheduler-far-seer-01 1/1 Running 69 13d kubernetes-dashboard-7bbbdc6696-rrzk4 1/1 Running 0 6h4m nginx-ingress-controller-779d9d54f-k795k 1/1 Running 83 6d1h Ingress Controller # kubectl -n kube-system get po nginx-ingress-controller-779d9d54f-k795k -oyaml spec: containers: - args: - /nginx-ingress-controller - --default-backend-service=$(POD_NAMESPACE)/default-http-backend - --configmap=$(POD_NAMESPACE)/nginx-load-balancer-conf - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services - --udp-services-configmap=$(POD_NAMESPACE)/udp-services - --annotations-prefix=nginx.ingress.kubernetes.io - --report-node-internal-ip-address name: nginx-ingress-controller ports: - containerPort: 80 hostPort: 80 protocol: TCP - containerPort: 443 hostPort: 443 protocol: TCP Ingress TLS &amp; Rules (00) $ openssl req -x509 -nodes -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=*.bar.com&quot; Generating a RSA private key ...........................................................................................................................+++++ ........................................................................+++++ writing new private key to &#39;tls.key&#39; ----- $ kubectl create secret tls tls-crt --cert=tls.crt --key=tls.key secret/tls-crt created $ kubectl get secret NAME TYPE DATA AGE default-token-5gh7g kubernetes.io/service-account-token 3 13d tls-crt kubernetes.io/tls 2 31s Ingress TLS &amp; Rules (01) # foo-bar-ing.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata: name: foo-bar annotations: kubernetes.io/ingress.class: &quot;nginx&quot; nginx.ingress.kubernetes.io/rewrite-target: / spec: tls: - hosts: - &#39;*.bar.com&#39; secretName: tls-crt rules: - host: &#39;foo.bar.com&#39; http: paths: - path: / backend: serviceName: foo-bar servicePort: 80 Ingress TLS &amp; Rules (10) $ kubectl create -f ingress.yaml ingress.extensions/foo-bar created $ kubectl get ing NAME HOSTS ADDRESS PORTS AGE foo-bar foo.bar.com 192.168.66.128 80, 443 101s $ curl -iILk http://foo.bar.com HTTP/1.1 308 Permanent Redirect Location: https://foo.bar.com/ HTTP/2 200 server: nginx/1.15.8 References https://kubernetes.io/docs/concepts/services-networking/service/ https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services https://kubernetes.io/docs/concepts/services-networking/service/#headless-services https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types https://kubernetes.io/docs/concepts/services-networking/ingress/ https://kubernetes.io/docs/concepts/services-networking/ingress/#name-based-virtual-hosting https://kubernetes.io/docs/concepts/services-networking/ingress/#tls https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts Quit or not quit ? https://kubernetes.io/","headline":"3 - Kubernetes Services and Ingress","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2019/03/04/kubernetes-crash-course-3/"},"url":"https://blog.codefarm.me/2019/03/04/kubernetes-crash-course-3/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">3 - Kubernetes Services and Ingress</h1><p class="c-post-meta">04 Mar 2019</p>
  </header>

  <div class="c-post-content">
    <ul id="markdown-toc">
  <li><a href="#contents" id="markdown-toc-contents">Contents</a></li>
  <li><a href="#services-discover--environment-variables-00" id="markdown-toc-services-discover--environment-variables-00">Services Discover <small>&amp; Environment variables (00)</small></a></li>
  <li><a href="#services-discover--environment-variables-01" id="markdown-toc-services-discover--environment-variables-01">Services Discover <small>&amp; Environment variables (01)</small></a></li>
  <li><a href="#services-discover--environment-variables-10" id="markdown-toc-services-discover--environment-variables-10">Services Discover <small>&amp; Environment variables (10)</small></a></li>
  <li><a href="#services-discover--dns-00" id="markdown-toc-services-discover--dns-00">Services Discover <small>&amp; DNS (00)</small></a></li>
  <li><a href="#services-discover--dns-01" id="markdown-toc-services-discover--dns-01">Services Discover <small>&amp; DNS (01)</small></a></li>
  <li><a href="#services-discover--dns-10" id="markdown-toc-services-discover--dns-10">Services Discover <small>&amp; DNS (10)</small></a></li>
  <li><a href="#services-discover--dns-11" id="markdown-toc-services-discover--dns-11">Services Discover <small>&amp; DNS (11)</small></a></li>
  <li><a href="#services-with-label-selectors-00" id="markdown-toc-services-with-label-selectors-00">Services <small>with Label Selectors (00)</small></a></li>
  <li><a href="#services-with-label-selectors-01" id="markdown-toc-services-with-label-selectors-01">Services <small>with Label Selectors (01)</small></a></li>
  <li><a href="#services-with-label-selectors-10" id="markdown-toc-services-with-label-selectors-10">Services <small>with Label Selectors (10)</small></a></li>
  <li><a href="#services-with-label-selectors-11" id="markdown-toc-services-with-label-selectors-11">Services <small>with Label Selectors (11)</small></a></li>
  <li><a href="#services-without-label-selectors-00" id="markdown-toc-services-without-label-selectors-00">Services <small>without Label Selectors (00)</small></a></li>
  <li><a href="#services-without-label-selectors-01" id="markdown-toc-services-without-label-selectors-01">Services <small>without Label Selectors (01)</small></a></li>
  <li><a href="#headless-services-with-label-selectors-00" id="markdown-toc-headless-services-with-label-selectors-00">Headless Services <small>with Label Selectors (00)</small></a></li>
  <li><a href="#headless-services-with-label-selectors-01" id="markdown-toc-headless-services-with-label-selectors-01">Headless Services <small>with Label Selectors (01)</small></a></li>
  <li><a href="#headless-services-without-label-selectors-00" id="markdown-toc-headless-services-without-label-selectors-00">Headless Services <small>without Label Selectors (00)</small></a></li>
  <li><a href="#headless-services-without-label-selectors-01" id="markdown-toc-headless-services-without-label-selectors-01">Headless Services <small>without Label Selectors (01)</small></a></li>
  <li><a href="#nodeport-services-00" id="markdown-toc-nodeport-services-00">NodePort Services (00)</a></li>
  <li><a href="#nodeport-services-01" id="markdown-toc-nodeport-services-01">NodePort Services (01)</a></li>
  <li><a href="#nodeport-services-10" id="markdown-toc-nodeport-services-10">NodePort Services (10)</a></li>
  <li><a href="#nodeport-services-11" id="markdown-toc-nodeport-services-11">NodePort Services (11)</a></li>
  <li><a href="#ingress" id="markdown-toc-ingress">Ingress</a></li>
  <li><a href="#ingress-controller" id="markdown-toc-ingress-controller">Ingress Controller</a></li>
  <li><a href="#ingress-controller-1" id="markdown-toc-ingress-controller-1">Ingress Controller</a></li>
  <li><a href="#ingress-tls--rules-00" id="markdown-toc-ingress-tls--rules-00">Ingress TLS &amp; Rules (00)</a></li>
  <li><a href="#ingress-tls--rules-01" id="markdown-toc-ingress-tls--rules-01">Ingress TLS &amp; Rules (01)</a></li>
  <li><a href="#ingress-tls--rules-10" id="markdown-toc-ingress-tls--rules-10">Ingress TLS &amp; Rules (10)</a></li>
  <li><a href="#references" id="markdown-toc-references">References</a></li>
  <li><a href="#quit-or-not-quit-" id="markdown-toc-quit-or-not-quit-">Quit or not quit ?</a></li>
</ul>

<hr />

<h3 id="contents">Contents</h3>

<ul>
  <li>Services Discover
    <ul>
      <li>Environment Variables</li>
      <li><strong>DNS</strong> (recommended)</li>
    </ul>
  </li>
  <li>Services <small>with/without Label Selector</small></li>
  <li>Headless Services <small>with/without Label Selector</small></li>
  <li>Service Types <strong>ClusterIP/ExternalName/NodePort</strong></li>
  <li>Ingress</li>
</ul>

<h3 id="services-discover--environment-variables-00">Services Discover <small>&amp; Environment variables (00)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   32h
<span class="nv">$ </span>kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx:1.15
deployment.apps/nginx created
<span class="nv">$ </span>kubectl <span class="nb">exec </span>nginx-5f47c69c5b-8ppph <span class="nb">env
</span><span class="nv">KUBERNETES_SERVICE_HOST</span><span class="o">=</span>10.96.0.1
<span class="nv">KUBERNETES_SERVICE_PORT</span><span class="o">=</span>443
</code></pre></div></div>

<h3 id="services-discover--environment-variables-01">Services Discover <small>&amp; Environment variables (01)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl expose deployment nginx <span class="nt">--port</span><span class="o">=</span>80
service/nginx exposed
<span class="nv">$ </span>kubectl get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   33h
nginx        ClusterIP   10.101.123.96   &lt;none&gt;        80/TCP    9m50s
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> nginx-5f47c69c5b-8ppph <span class="nb">env
</span><span class="nv">KUBERNETES_SERVICE_HOST</span><span class="o">=</span>10.96.0.1
<span class="nv">KUBERNETES_SERVICE_PORT</span><span class="o">=</span>443
</code></pre></div></div>

<h3 id="services-discover--environment-variables-10">Services Discover <small>&amp; Environment variables (10)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete po nginx-5f47c69c5b-8ppph 
pod <span class="s2">"nginx-5f47c69c5b-8ppph"</span> deleted
<span class="nv">$ </span>kubectl <span class="nb">exec </span>nginx-5f47c69c5b-v7kkm <span class="nb">env
</span><span class="nv">KUBERNETES_SERVICE_PORT</span><span class="o">=</span>443
<span class="nv">KUBERNETES_SERVICE_HOST</span><span class="o">=</span>10.96.0.1
<span class="nv">NGINX_SERVICE_HOST</span><span class="o">=</span>10.101.123.96
<span class="nv">NGINX_SERVICE_PORT</span><span class="o">=</span>80
</code></pre></div></div>

<h3 id="services-discover--dns-00">Services Discover <small>&amp; DNS (00)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get svc <span class="nt">--all-namespaces</span> 
NAMESPACE     NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>         AGE
default       kubernetes             ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP         33h
kube-system   default-http-backend   NodePort    10.108.162.115   &lt;none&gt;        80:30001/TCP    3d4h
kube-system   kube-dns               ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP   10d
kube-system   kubernetes-dashboard   NodePort    10.108.191.216   &lt;none&gt;        443:31115/TCP   33h
</code></pre></div></div>

<h3 id="services-discover--dns-01">Services Discover <small>&amp; DNS (01)</small></h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># network-utils-pod.yaml </span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">network-utils</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">network-utils</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">network-utils</span> 
      <span class="na">image</span><span class="pi">:</span> <span class="s">amouat/network-utils</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">sleep'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">10h'</span><span class="pi">]</span>
</code></pre></div></div>

<h3 id="services-discover--dns-10">Services Discover <small>&amp; DNS (10)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> network-utils-pod.yaml 
pod/network-utils created
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> network-utils bash
root@network-utils:/# nslookup kubernetes
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   kubernetes.default.svc.cluster.local
Address: 10.96.0.1

root@network-utils:/# nslookup kubernetes.default
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   kubernetes.default.svc.cluster.local
Address: 10.96.0.1
</code></pre></div></div>

<h3 id="services-discover--dns-11">Services Discover <small>&amp; DNS (11)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@network-utils:/# nslookup kube-dns          
<span class="p">;;</span> connection timed out<span class="p">;</span> no servers could be reached

root@network-utils:/# nslookup kube-dns.kube-system
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   kube-dns.kube-system.svc.cluster.local
Address: 10.96.0.10
</code></pre></div></div>

<h3 id="services-with-label-selectors-00">Services <small>with Label Selectors (00)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx:1.15
deployment.apps/nginx created
<span class="nv">$ </span>kubectl expose deployment nginx <span class="nt">--port</span><span class="o">=</span>80
service/nginx exposed
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>nginx
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
service/nginx   ClusterIP   10.111.193.91   &lt;none&gt;        80/TCP    59s

NAME              ENDPOINTS         AGE
endpoints/nginx   10.244.0.124:80   59s
<span class="nv">$ </span>kubectl <span class="nb">exec </span>network-utils nslookup nginx
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   nginx.default.svc.cluster.local
Address: 10.111.193.91
</code></pre></div></div>

<h3 id="services-with-label-selectors-01">Services <small>with Label Selectors (01)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get ep nginx <span class="nt">-oyaml</span> <span class="nt">--export</span> 
apiVersion: v1
kind: Endpoints
metadata:
  labels:
    app: nginx
  name: nginx
subsets:
- addresses:
  - ip: 10.244.0.124
    targetRef:
      kind: Pod
      name: nginx-5f47c69c5b-vlt69
  ports:
  - port: 80
    protocol: TCP
</code></pre></div></div>

<h3 id="services-with-label-selectors-10">Services <small>with Label Selectors (10)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get svc nginx <span class="nt">-oyaml</span> <span class="nt">--export</span> 
apiVersion: v1
kind: Service
metadata:
  labels:
    app: nginx
  name: nginx
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: nginx
  <span class="nb">type</span>: ClusterIP
</code></pre></div></div>

<h3 id="services-with-label-selectors-11">Services <small>with Label Selectors (11)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl scale deployment nginx <span class="nt">--replicas</span><span class="o">=</span>3
deployment.extensions/nginx scaled
<span class="nv">$ </span>kubectl get po <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>nginx <span class="nt">-owide</span>
NAME                     READY   STATUS    RESTARTS   AGE     IP             NODE          NOMINATED NODE   READINESS GATES
nginx-5f47c69c5b-bw7wm   1/1     Running   0          15s     10.244.0.127   far-seer-01   &lt;none&gt;           &lt;none&gt;
nginx-5f47c69c5b-shcch   1/1     Running   0          15s     10.244.0.128   far-seer-01   &lt;none&gt;           &lt;none&gt;
nginx-5f47c69c5b-vlt69   1/1     Running   0          6m10s   10.244.0.124   far-seer-01   &lt;none&gt;           &lt;none&gt;
<span class="nv">$ </span>kubectl get ep <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>nginx
NAME    ENDPOINTS                                         AGE
nginx   10.244.0.124:80,10.244.0.127:80,10.244.0.128:80   6m13s
<span class="nv">$ </span>kubectl <span class="nb">exec </span>network-utils nslookup nginx
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   nginx.default.svc.cluster.local
Address: 10.102.44.128
</code></pre></div></div>

<h3 id="services-without-label-selectors-00">Services <small>without Label Selectors (00)</small></h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mongo-svc.yaml (1)</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongo</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mongo</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">27017</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">27017</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mongo-svc.yaml (2)</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Endpoints</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongo</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mongo</span>
<span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">addresses</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s">10.200.200.157</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">27017</span>
</code></pre></div></div>

<h3 id="services-without-label-selectors-01">Services <small>without Label Selectors (01)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> mongo-svc.yaml 
service/mongo created
endpoints/mongo created
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>mongo
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>     AGE
service/mongo   ClusterIP   10.103.114.91   &lt;none&gt;        27017/TCP   12s

NAME              ENDPOINTS              AGE
endpoints/mongo   10.200.200.157:27017   11s
<span class="nv">$ </span>kubectl <span class="nb">exec </span>network-utils nslookup mongo
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   mongo.default.svc.cluster.local
Address: 10.103.114.91
</code></pre></div></div>

<h3 id="headless-services-with-label-selectors-00">Headless Services <small>with Label Selectors (00)</small></h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># hmac-svc.yaml </span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">hmacsvc</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hmacsvc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">externalName</span><span class="pi">:</span> <span class="s">hmac.internal.example.com</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ExternalName</span>
</code></pre></div></div>

<h3 id="headless-services-with-label-selectors-01">Headless Services <small>with Label Selectors (01)</small></h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">$ kubectl create -f hmac-svc.yaml</span> 
<span class="s">service/hmacsvc created</span>
<span class="s">$ kubectl get svc hamcsvc</span> 
<span class="s">NAME      TYPE           CLUSTER-IP   EXTERNAL-IP                          PORT(S)   AGE</span>
<span class="s">hmacsvc   ExternalName   &lt;none&gt;       hmac.internal.example.com   &lt;none&gt;    7s</span>
<span class="s">$ kubectl exec network-utils nslookup hmacsvc</span>
<span class="na">Server</span><span class="pi">:</span>     <span class="s">10.96.0.10</span>
<span class="na">Address</span><span class="pi">:</span>    <span class="s">10.96.0.10#53</span>

<span class="s">hmacsvc.default.svc.cluster.local   canonical name = hmac.internal.example.com.</span>
</code></pre></div></div>

<h3 id="headless-services-without-label-selectors-00">Headless Services <small>without Label Selectors (00)</small></h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># prod-mongo-svc.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prod-mongo</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">prod-mongo</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">27017</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">27017</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># prod-mongo-svc.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Endpoints</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prod-mongo</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">prod-mongo</span>
<span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">addresses</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s">10.10.43.10</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">27017</span>
  <span class="pi">-</span> <span class="na">addresses</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s">10.10.43.11</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">27017</span>
  <span class="pi">-</span> <span class="na">addresses</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s">10.10.43.12</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">27017</span>
</code></pre></div></div>

<h3 id="headless-services-without-label-selectors-01">Headless Services <small>without Label Selectors (01)</small></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> prod-mongo-svc.yaml 
service/prod-mongo created
endpoints/prod-mongo created
<span class="nv">$ </span>kubectl get svc,ep <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>prod-mongo
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>     AGE
service/prod-mongo   ClusterIP   None         &lt;none&gt;        27017/TCP   7s

NAME                   ENDPOINTS                                                     AGE
endpoints/prod-mongo   10.10.43.10:27017,10.10.43.11:27017,10.10.43.12:27017   7s
<span class="nv">$ </span>kubectl <span class="nb">exec </span>network-utils nslookup prod-mongo
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   prod-mongo.default.svc.cluster.local
Address: 10.10.43.11
Name:   prod-mongo.default.svc.cluster.local
Address: 10.10.43.10
Name:   prod-mongo.default.svc.cluster.local
Address: 10.10.43.12
</code></pre></div></div>

<h3 id="nodeport-services-00">NodePort Services (00)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx:1.15
deployment.apps/nginx created
<span class="nv">$ </span>kubectl expose deployment nginx <span class="nt">--type</span><span class="o">=</span>NodePort <span class="nt">--port</span><span class="o">=</span>80
service/nginx exposed
<span class="nv">$ </span>kubectl get svc <span class="nt">-l</span> app
NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
nginx   NodePort   10.106.42.214   &lt;none&gt;        80:31868/TCP   32s
<span class="nv">$ </span>curl <span class="nt">-iI</span> localhost:31868
HTTP/1.1 200 OK
Server: nginx/1.15.8
Date: Mon, 11 Mar 2019 02:42:28 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT
Connection: keep-alive
ETag: <span class="s2">"5c21fedf-264"</span>
Accept-Ranges: bytes
</code></pre></div></div>

<h3 id="nodeport-services-01">NodePort Services (01)</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubectl get svc nginx -oyaml --export </span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</code></pre></div></div>

<h3 id="nodeport-services-10">NodePort Services (10)</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># nginx-svc.yaml </span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-01</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">nodePort</span><span class="pi">:</span> <span class="m">31115</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</code></pre></div></div>

<h3 id="nodeport-services-11">NodePort Services (11)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> nginx-svc.yaml 
service/nginx-01 created
<span class="nv">$ </span>kubectl get svc <span class="nt">-l</span> app
NAME       TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
nginx      NodePort   10.106.42.214   &lt;none&gt;        80:31868/TCP   12m
nginx-01   NodePort   10.104.36.29    &lt;none&gt;        80:31115/TCP   5s
<span class="nv">$ </span>curl <span class="nt">-iI</span> localhost:31115
HTTP/1.1 200 OK
Server: nginx/1.15.8
Date: Mon, 11 Mar 2019 02:54:30 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 25 Dec 2018 09:56:47 GMT
Connection: keep-alive
ETag: <span class="s2">"5c21fedf-264"</span>
Accept-Ranges: bytes
</code></pre></div></div>

<h3 id="ingress">Ingress</h3>

<p><img src="/assets/kubernetes/ingress.png" alt="Ingress Topo" /></p>

<h3 id="ingress-controller">Ingress Controller</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get po <span class="nt">-n</span> kube-system 
NAME                                       READY   STATUS    RESTARTS   AGE
coredns-86c58d9df4-cnx48                   1/1     Running   11         13d
coredns-86c58d9df4-x46nn                   1/1     Running   15         13d
default-http-backend-676d78555d-54jvx      1/1     Running   23         6d1h
etcd-far-seer-01                           1/1     Running   9          13d
kube-apiserver-far-seer-01                 1/1     Running   1          3d1h
kube-controller-manager-far-seer-01        1/1     Running   71         13d
kube-flannel-ds-amd64-vrt27                1/1     Running   11         13d
kube-proxy-b4lqx                           1/1     Running   9          13d
kube-scheduler-far-seer-01                 1/1     Running   69         13d
kubernetes-dashboard-7bbbdc6696-rrzk4      1/1     Running   0          6h4m
nginx-ingress-controller-779d9d54f-k795k   1/1     Running   83         6d1h
</code></pre></div></div>

<h3 id="ingress-controller-1">Ingress Controller</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kubectl -n kube-system get po nginx-ingress-controller-779d9d54f-k795k -oyaml </span>
spec:
  containers:
  - args:
    - /nginx-ingress-controller
    - <span class="nt">--default-backend-service</span><span class="o">=</span><span class="si">$(</span>POD_NAMESPACE<span class="si">)</span>/default-http-backend
    - <span class="nt">--configmap</span><span class="o">=</span><span class="si">$(</span>POD_NAMESPACE<span class="si">)</span>/nginx-load-balancer-conf
    - <span class="nt">--tcp-services-configmap</span><span class="o">=</span><span class="si">$(</span>POD_NAMESPACE<span class="si">)</span>/tcp-services
    - <span class="nt">--udp-services-configmap</span><span class="o">=</span><span class="si">$(</span>POD_NAMESPACE<span class="si">)</span>/udp-services
    - <span class="nt">--annotations-prefix</span><span class="o">=</span>nginx.ingress.kubernetes.io
    - <span class="nt">--report-node-internal-ip-address</span>
    name: nginx-ingress-controller
    ports:
    - containerPort: 80
      hostPort: 80
      protocol: TCP
    - containerPort: 443
      hostPort: 443
      protocol: TCP
</code></pre></div></div>

<h3 id="ingress-tls--rules-00">Ingress TLS &amp; Rules (00)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl req <span class="nt">-x509</span> <span class="nt">-nodes</span> <span class="nt">-newkey</span> rsa:2048 <span class="nt">-keyout</span> tls.key <span class="nt">-out</span> tls.crt <span class="nt">-subj</span> <span class="s2">"/CN=*.bar.com"</span>
Generating a RSA private key
...........................................................................................................................+++++
........................................................................+++++
writing new private key to <span class="s1">'tls.key'</span>
<span class="nt">-----</span>
<span class="nv">$ </span>kubectl create secret tls tls-crt <span class="nt">--cert</span><span class="o">=</span>tls.crt <span class="nt">--key</span><span class="o">=</span>tls.key
secret/tls-crt created
<span class="nv">$ </span>kubectl get secret
NAME                  TYPE                                  DATA   AGE
default-token-5gh7g   kubernetes.io/service-account-token   3      13d
tls-crt               kubernetes.io/tls                     2      31s
</code></pre></div></div>

<h3 id="ingress-tls--rules-01">Ingress TLS &amp; Rules (01)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># foo-bar-ing.yaml</span>
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: foo-bar
  annotations:
    kubernetes.io/ingress.class: <span class="s2">"nginx"</span>
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  tls:
    - hosts:
        - <span class="s1">'*.bar.com'</span>
      secretName: tls-crt
  rules:
    - host: <span class="s1">'foo.bar.com'</span>
      http:
        paths:
          - path: /
            backend:
              serviceName: foo-bar
              servicePort: 80
</code></pre></div></div>

<h3 id="ingress-tls--rules-10">Ingress TLS &amp; Rules (10)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> ingress.yaml 
ingress.extensions/foo-bar created
<span class="nv">$ </span>kubectl get ing
NAME      HOSTS         ADDRESS          PORTS     AGE
foo-bar   foo.bar.com   192.168.66.128   80, 443   101s
<span class="nv">$ </span>curl <span class="nt">-iILk</span> http://foo.bar.com
HTTP/1.1 308 Permanent Redirect
Location: https://foo.bar.com/

HTTP/2 200 
server: nginx/1.15.8
</code></pre></div></div>

<h3 id="references">References</h3>

<ul>
  <li>https://kubernetes.io/docs/concepts/services-networking/service/</li>
  <li>https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services</li>
  <li>https://kubernetes.io/docs/concepts/services-networking/service/#headless-services</li>
  <li>https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types</li>
  <li>https://kubernetes.io/docs/concepts/services-networking/ingress/</li>
  <li>https://kubernetes.io/docs/concepts/services-networking/ingress/#name-based-virtual-hosting</li>
  <li>https://kubernetes.io/docs/concepts/services-networking/ingress/#tls</li>
  <li>https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#custom-timeouts</li>
</ul>

<h3 id="quit-or-not-quit-">Quit or not quit ?</h3>

<p><a href="https://kubernetes.io/">https://kubernetes.io/</a></p>

<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
