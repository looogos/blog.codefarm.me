<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Deploy MongoDB with Docker | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Deploy MongoDB with Docker" />
<meta property="og:locale" content="en" />
<meta name="description" content="0. Prerequisites 1. Start a MongoDB Instance. 2. Start a MongoDB Instance with Access Control. 3. Deploy a Replica Set 4. Deploy a Replica Set with Access Control. References: 0. Prerequisites Make sure you have already installed both Docker Engine and Docker Compose. You don’t need to install MongoDB, as it’s provided by Docker image. 1. Start a MongoDB Instance. $ docker run -d -p 27017:27017 --name db mongo:3 2. Start a MongoDB Instance with Access Control. $ docker run -d -p 27017:27017 --name db mongo:3 --auth Connect a mongo shell to one of the config server mongod instances over the localhost interface and create the user administrator. $ docker exec -it db mongo admin --quiet &gt; db.createUser({ ... user:&quot;admin&quot;, ... pwd:&quot;admin&quot;, ... roles: [ ... {role: &quot;userAdmin&quot;, db:&quot;admin&quot;} ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;admin&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;userAdmin&quot;, &quot;db&quot; : &quot;admin&quot; } ] } &gt; db.auth(&quot;admin&quot;,&quot;admin&quot;) 1 &gt; db.createUser({ ... user: &quot;user1&quot;, ... pwd: &quot;user1&quot;, ... roles: [ ... { ... role: &quot;readWriteAnyDatabase&quot;, ... db: &quot;admin&quot; ... } ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;user1&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;readWriteAnyDatabase&quot;, &quot;db&quot; : &quot;admin&quot; } ] } &gt; use test switched to db test &gt; db.test.insertOne({ x: 1 }) 2017-09-08T08:50:53.276+0000 E QUERY [thread1] TypeError: err.hasWriteErrors ... DBCollection.prototype.insertOne@src/mongo/shell/crud_api.js:244:13 @(shell):1:1 &gt; db.auth(&quot;user1&quot;,&quot;user1&quot;) Error: Authentication failed. 0 &gt; use admin switched to db admin &gt; db.auth(&quot;user1&quot;,&quot;user1&quot;) 1 &gt; use test switched to db test &gt; db.test.insertOne({ x: 1 }) { &quot;acknowledged&quot; : true, &quot;insertedId&quot; : ObjectId(&quot;59b25a108bcdfe4e19c35a13&quot;) } &gt; 3. Deploy a Replica Set $ mkdir mogors $ cd mogors/ $ cat &lt;&lt;EOF &gt; docker-compose.yml &gt; --- &gt; version: &quot;3.2&quot; &gt; services: &gt; db-0: &gt; container_name: db-0 &gt; image: mongo:3 &gt; # Start each member of the replica set with the appropriate options . &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; db-1: &gt; container_name: db-1 &gt; image: mongo:3 &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; db-2: &gt; container_name: db-2 &gt; image: mongo:3 &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; EOF $ docker-compose up -d Creating network &quot;mongors_default&quot; with the default driver Creating db-2 ... Creating db-0 ... Creating db-1 ... Creating db-2 Creating db-1 Creating db-0 ... done $ docker ps -a CONTAINER ID IMAGE STATUS PORTS NAMES 0f6a34b826b2 mongo:3 Up 45 seconds 27017/tcp db-1 c4c04bfc53f3 mongo:3 Up 46 seconds 27017/tcp db-0 9d8bc021082c mongo:3 Up 46 seconds 27017/tcp db-2 $ docker exec -it db-0 mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;db-0&quot; } ] ... }) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&quot;db-1&quot;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&quot;db-2&quot;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; db.runCommand(&quot;isMaster&quot;) { &quot;hosts&quot; : [ &quot;db-0:27017&quot;, &quot;db-1:27017&quot;, &quot;db-2:27017&quot; ], &quot;setName&quot; : &quot;rs0&quot;, &quot;setVersion&quot; : 3, &quot;ismaster&quot; : true, &quot;secondary&quot; : false, &quot;primary&quot; : &quot;db-0:27017&quot;, &quot;me&quot; : &quot;db-0:27017&quot;, &quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;), &quot;lastWrite&quot; : { &quot;opTime&quot; : { &quot;ts&quot; : Timestamp(1504859331, 1), &quot;t&quot; : NumberLong(1) }, &quot;lastWriteDate&quot; : ISODate(&quot;2017-09-08T08:28:51Z&quot;) }, &quot;maxBsonObjectSize&quot; : 16777216, &quot;maxMessageSizeBytes&quot; : 48000000, &quot;maxWriteBatchSize&quot; : 1000, &quot;localTime&quot; : ISODate(&quot;2017-09-08T08:28:56.329Z&quot;), &quot;maxWireVersion&quot; : 5, &quot;minWireVersion&quot; : 0, &quot;readOnly&quot; : false, &quot;ok&quot; : 1 } rs0:PRIMARY&gt; 4. Deploy a Replica Set with Access Control. $ mkdir mogors $ cd mogors/ $ # Create a keyfile. $ openssl rand -base64 756 &gt; keyfile $ cat keyfile AFO3EYmmmQQLF68tUd3aQsFI/C53XtOpUGt8R5ecS1F9uWRFg4dN6jlCjiBbYqHC w3lqUhlRBe00YhDM97z31oYkQBSyID20pIMeQ3e40FY6zBE1w+4lWYekuPJAUtzS ZspGfFExltwL0700Dwu7b1mnMbqfmfrpSVxTKHaY7Hcw60mvbBPPCp6IWkDVZ9NX NKveHX3Wuq28/PSMw8sVPUbP5eqPux05PCyp5VBp6/fhg8Np8vIlWAy9fMsAgkmE kBeGcRNst6t0iXbqNi9VrW6szJN5yyq0x1+0XB1QJZCjnLczoXMTPQeDCTrijbpI N4zr7L2EV6n8FsgSJ7vwzRMj0ZRFjuK/wwBblPCuisv5JlcClZ6I0WEtV1yg5HQu AFv3v7FPmfodQ6Sz81c6sNEKuwg3kzCY7wkeA163RZrujHViYFka6zOcv/kDdQ5h rL6EBXE3v6bnd24/nzys9Zx6CrqPPUqSVfugmIW78r9imXswUqdr/VZVbhGsKcjH Uza306prvuWmh0o1hpFGReGbHIdWhEtP/ldXKBbPy+27tgNeSiSP1GjVG2rkaIlb bsnahiNj2EaAa1ov9pYiyO51m+ouEg+H9LPBcLhLXipI3wbST8BqMZweLSNfeLFi Kpel5Q3rNtmRrjCbVIiiAXmxECU+PcwL+a4XhISnktdq6Du43d4INSJ/cn8JVLFS VbR5nTnc4cMmEE3n/0BrScZinGZT1gbtwbE5izA5E17/7n/HLGUXhfhMGWrwdL9f CsDt8ZEg7AUCPhFhsbcwfHkROXmYYubcd41NqLEYyktDzqsu3CaXFvH3QyD5AqmN ylh6UGgjqgWIC7y553qNE9v7Go/9zKTUj8Df/wcQVl6ALOdZgPmchNTX8PtENdKT aPUu/dcctYZUxz1DKwkaH3aUblSBGtSHa94knUA+R3DWPTcGNt3n46AL45Ty5amX c5yYTpaKB6jgXwIMjO96OA9XlZKxOVgqdASsN6O0wCzfAg55 $ chmod 400 keyfile $ sudo chown 999 keyfile $ cat docker-compose.yml --- version: &quot;3.2&quot; services: db-0: container_name: db-0 image: mongo:3 # Start each member of the replica set with the appropriate options . command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile read_only: true db-1: container_name: db-1 image: mongo:3 command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile db-2: container_name: db-2 image: mongo:3 command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile $ docker-compose up -d Creating network &quot;mongors_default&quot; with the default driver Creating db-1 ... Creating db-0 ... Creating db-1 Creating db-0 Creating db-2 ... Creating db-2 ... done $ docker ps -a CONTAINER ID IMAGE STATUS PORTS NAMES 02143821d0d7 mongo:3 Up 3 seconds 27017/tcp db-2 338aef4ef282 mongo:3 Up 3 seconds 27017/tcp db-0 ff459a50af25 mongo:3 Up 3 seconds 27017/tcp db-1 $ docker exec -it db-0 mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;db-0&quot; } ] ... }) { &quot;ok&quot; : 1 } rs0:SECONDARY&gt; use admin switched to db admin rs0:PRIMARY&gt; db.createUser({ ... user:&quot;admin&quot;, ... pwd:&quot;admin&quot;, ... roles: [ ... {role: &quot;userAdmin&quot;, db:&quot;admin&quot;}, ... {role: &quot;clusterAdmin&quot;, db: &quot;admin&quot;} ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;admin&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;userAdmin&quot;, &quot;db&quot; : &quot;admin&quot; }, { &quot;role&quot; : &quot;clusterAdmin&quot;, &quot;db&quot; : &quot;admin&quot; } ] } rs0:PRIMARY&gt; rs.add(&#39;db-1&#39;) 2017-09-08T09:44:33.194+0000 E QUERY [thread1] Error: count failed: { &quot;ok&quot; : 0, &quot;errmsg&quot; : &quot;not authorized on local to execute command ... &quot;code&quot; : 13, &quot;codeName&quot; : &quot;Unauthorized&quot; } : _getErrorWithCode@src/mongo/shell/utils.js:25:13 DBQuery.prototype.count@src/mongo/shell/query.js:383:11 DBCollection.prototype.count@src/mongo/shell/collection.js:1700:12 rs.add@src/mongo/shell/utils.js:1227:1 @(shell):1:1 rs0:PRIMARY&gt; db.auth(&#39;admin&#39;,&#39;admin&#39;) 1 rs0:PRIMARY&gt; rs.add(&#39;db-1&#39;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&#39;db-2&#39;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; db.runCommand(&quot;isMaster&quot;) { &quot;hosts&quot; : [ &quot;db-0:27017&quot;, &quot;db-1:27017&quot;, &quot;db-2:27017&quot; ], &quot;setName&quot; : &quot;rs0&quot;, &quot;setVersion&quot; : 3, &quot;ismaster&quot; : true, &quot;secondary&quot; : false, &quot;primary&quot; : &quot;db-0:27017&quot;, &quot;me&quot; : &quot;db-0:27017&quot;, &quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;), &quot;lastWrite&quot; : { &quot;opTime&quot; : { &quot;ts&quot; : Timestamp(1504863894, 1), &quot;t&quot; : NumberLong(1) }, &quot;lastWriteDate&quot; : ISODate(&quot;2017-09-08T09:44:54Z&quot;) }, &quot;maxBsonObjectSize&quot; : 16777216, &quot;maxMessageSizeBytes&quot; : 48000000, &quot;maxWriteBatchSize&quot; : 1000, &quot;localTime&quot; : ISODate(&quot;2017-09-08T09:45:04.775Z&quot;), &quot;maxWireVersion&quot; : 5, &quot;minWireVersion&quot; : 0, &quot;readOnly&quot; : false, &quot;ok&quot; : 1 } rs0:PRIMARY&gt; References: mongo | Docker Documentation Enable Auth — MongoDB Tutorials Manage Users and Roles — MongoDB Tutorials Built-In Roles — MongoDB Manual 3.4 Deploy a Replica Set — MongoDB Manual 3.4 Enforce Keyfile Access Control in a Replica Set — MongoDB Manual 3.4 Compose file version 3 reference | Docker Documentation Deploy a MongoDB Cluster in 9 steps Using Docker Mongodb KeyFile too open permissions - Stack Overflow" />
<meta property="og:description" content="0. Prerequisites 1. Start a MongoDB Instance. 2. Start a MongoDB Instance with Access Control. 3. Deploy a Replica Set 4. Deploy a Replica Set with Access Control. References: 0. Prerequisites Make sure you have already installed both Docker Engine and Docker Compose. You don’t need to install MongoDB, as it’s provided by Docker image. 1. Start a MongoDB Instance. $ docker run -d -p 27017:27017 --name db mongo:3 2. Start a MongoDB Instance with Access Control. $ docker run -d -p 27017:27017 --name db mongo:3 --auth Connect a mongo shell to one of the config server mongod instances over the localhost interface and create the user administrator. $ docker exec -it db mongo admin --quiet &gt; db.createUser({ ... user:&quot;admin&quot;, ... pwd:&quot;admin&quot;, ... roles: [ ... {role: &quot;userAdmin&quot;, db:&quot;admin&quot;} ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;admin&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;userAdmin&quot;, &quot;db&quot; : &quot;admin&quot; } ] } &gt; db.auth(&quot;admin&quot;,&quot;admin&quot;) 1 &gt; db.createUser({ ... user: &quot;user1&quot;, ... pwd: &quot;user1&quot;, ... roles: [ ... { ... role: &quot;readWriteAnyDatabase&quot;, ... db: &quot;admin&quot; ... } ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;user1&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;readWriteAnyDatabase&quot;, &quot;db&quot; : &quot;admin&quot; } ] } &gt; use test switched to db test &gt; db.test.insertOne({ x: 1 }) 2017-09-08T08:50:53.276+0000 E QUERY [thread1] TypeError: err.hasWriteErrors ... DBCollection.prototype.insertOne@src/mongo/shell/crud_api.js:244:13 @(shell):1:1 &gt; db.auth(&quot;user1&quot;,&quot;user1&quot;) Error: Authentication failed. 0 &gt; use admin switched to db admin &gt; db.auth(&quot;user1&quot;,&quot;user1&quot;) 1 &gt; use test switched to db test &gt; db.test.insertOne({ x: 1 }) { &quot;acknowledged&quot; : true, &quot;insertedId&quot; : ObjectId(&quot;59b25a108bcdfe4e19c35a13&quot;) } &gt; 3. Deploy a Replica Set $ mkdir mogors $ cd mogors/ $ cat &lt;&lt;EOF &gt; docker-compose.yml &gt; --- &gt; version: &quot;3.2&quot; &gt; services: &gt; db-0: &gt; container_name: db-0 &gt; image: mongo:3 &gt; # Start each member of the replica set with the appropriate options . &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; db-1: &gt; container_name: db-1 &gt; image: mongo:3 &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; db-2: &gt; container_name: db-2 &gt; image: mongo:3 &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; EOF $ docker-compose up -d Creating network &quot;mongors_default&quot; with the default driver Creating db-2 ... Creating db-0 ... Creating db-1 ... Creating db-2 Creating db-1 Creating db-0 ... done $ docker ps -a CONTAINER ID IMAGE STATUS PORTS NAMES 0f6a34b826b2 mongo:3 Up 45 seconds 27017/tcp db-1 c4c04bfc53f3 mongo:3 Up 46 seconds 27017/tcp db-0 9d8bc021082c mongo:3 Up 46 seconds 27017/tcp db-2 $ docker exec -it db-0 mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;db-0&quot; } ] ... }) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&quot;db-1&quot;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&quot;db-2&quot;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; db.runCommand(&quot;isMaster&quot;) { &quot;hosts&quot; : [ &quot;db-0:27017&quot;, &quot;db-1:27017&quot;, &quot;db-2:27017&quot; ], &quot;setName&quot; : &quot;rs0&quot;, &quot;setVersion&quot; : 3, &quot;ismaster&quot; : true, &quot;secondary&quot; : false, &quot;primary&quot; : &quot;db-0:27017&quot;, &quot;me&quot; : &quot;db-0:27017&quot;, &quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;), &quot;lastWrite&quot; : { &quot;opTime&quot; : { &quot;ts&quot; : Timestamp(1504859331, 1), &quot;t&quot; : NumberLong(1) }, &quot;lastWriteDate&quot; : ISODate(&quot;2017-09-08T08:28:51Z&quot;) }, &quot;maxBsonObjectSize&quot; : 16777216, &quot;maxMessageSizeBytes&quot; : 48000000, &quot;maxWriteBatchSize&quot; : 1000, &quot;localTime&quot; : ISODate(&quot;2017-09-08T08:28:56.329Z&quot;), &quot;maxWireVersion&quot; : 5, &quot;minWireVersion&quot; : 0, &quot;readOnly&quot; : false, &quot;ok&quot; : 1 } rs0:PRIMARY&gt; 4. Deploy a Replica Set with Access Control. $ mkdir mogors $ cd mogors/ $ # Create a keyfile. $ openssl rand -base64 756 &gt; keyfile $ cat keyfile AFO3EYmmmQQLF68tUd3aQsFI/C53XtOpUGt8R5ecS1F9uWRFg4dN6jlCjiBbYqHC w3lqUhlRBe00YhDM97z31oYkQBSyID20pIMeQ3e40FY6zBE1w+4lWYekuPJAUtzS ZspGfFExltwL0700Dwu7b1mnMbqfmfrpSVxTKHaY7Hcw60mvbBPPCp6IWkDVZ9NX NKveHX3Wuq28/PSMw8sVPUbP5eqPux05PCyp5VBp6/fhg8Np8vIlWAy9fMsAgkmE kBeGcRNst6t0iXbqNi9VrW6szJN5yyq0x1+0XB1QJZCjnLczoXMTPQeDCTrijbpI N4zr7L2EV6n8FsgSJ7vwzRMj0ZRFjuK/wwBblPCuisv5JlcClZ6I0WEtV1yg5HQu AFv3v7FPmfodQ6Sz81c6sNEKuwg3kzCY7wkeA163RZrujHViYFka6zOcv/kDdQ5h rL6EBXE3v6bnd24/nzys9Zx6CrqPPUqSVfugmIW78r9imXswUqdr/VZVbhGsKcjH Uza306prvuWmh0o1hpFGReGbHIdWhEtP/ldXKBbPy+27tgNeSiSP1GjVG2rkaIlb bsnahiNj2EaAa1ov9pYiyO51m+ouEg+H9LPBcLhLXipI3wbST8BqMZweLSNfeLFi Kpel5Q3rNtmRrjCbVIiiAXmxECU+PcwL+a4XhISnktdq6Du43d4INSJ/cn8JVLFS VbR5nTnc4cMmEE3n/0BrScZinGZT1gbtwbE5izA5E17/7n/HLGUXhfhMGWrwdL9f CsDt8ZEg7AUCPhFhsbcwfHkROXmYYubcd41NqLEYyktDzqsu3CaXFvH3QyD5AqmN ylh6UGgjqgWIC7y553qNE9v7Go/9zKTUj8Df/wcQVl6ALOdZgPmchNTX8PtENdKT aPUu/dcctYZUxz1DKwkaH3aUblSBGtSHa94knUA+R3DWPTcGNt3n46AL45Ty5amX c5yYTpaKB6jgXwIMjO96OA9XlZKxOVgqdASsN6O0wCzfAg55 $ chmod 400 keyfile $ sudo chown 999 keyfile $ cat docker-compose.yml --- version: &quot;3.2&quot; services: db-0: container_name: db-0 image: mongo:3 # Start each member of the replica set with the appropriate options . command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile read_only: true db-1: container_name: db-1 image: mongo:3 command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile db-2: container_name: db-2 image: mongo:3 command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile $ docker-compose up -d Creating network &quot;mongors_default&quot; with the default driver Creating db-1 ... Creating db-0 ... Creating db-1 Creating db-0 Creating db-2 ... Creating db-2 ... done $ docker ps -a CONTAINER ID IMAGE STATUS PORTS NAMES 02143821d0d7 mongo:3 Up 3 seconds 27017/tcp db-2 338aef4ef282 mongo:3 Up 3 seconds 27017/tcp db-0 ff459a50af25 mongo:3 Up 3 seconds 27017/tcp db-1 $ docker exec -it db-0 mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;db-0&quot; } ] ... }) { &quot;ok&quot; : 1 } rs0:SECONDARY&gt; use admin switched to db admin rs0:PRIMARY&gt; db.createUser({ ... user:&quot;admin&quot;, ... pwd:&quot;admin&quot;, ... roles: [ ... {role: &quot;userAdmin&quot;, db:&quot;admin&quot;}, ... {role: &quot;clusterAdmin&quot;, db: &quot;admin&quot;} ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;admin&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;userAdmin&quot;, &quot;db&quot; : &quot;admin&quot; }, { &quot;role&quot; : &quot;clusterAdmin&quot;, &quot;db&quot; : &quot;admin&quot; } ] } rs0:PRIMARY&gt; rs.add(&#39;db-1&#39;) 2017-09-08T09:44:33.194+0000 E QUERY [thread1] Error: count failed: { &quot;ok&quot; : 0, &quot;errmsg&quot; : &quot;not authorized on local to execute command ... &quot;code&quot; : 13, &quot;codeName&quot; : &quot;Unauthorized&quot; } : _getErrorWithCode@src/mongo/shell/utils.js:25:13 DBQuery.prototype.count@src/mongo/shell/query.js:383:11 DBCollection.prototype.count@src/mongo/shell/collection.js:1700:12 rs.add@src/mongo/shell/utils.js:1227:1 @(shell):1:1 rs0:PRIMARY&gt; db.auth(&#39;admin&#39;,&#39;admin&#39;) 1 rs0:PRIMARY&gt; rs.add(&#39;db-1&#39;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&#39;db-2&#39;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; db.runCommand(&quot;isMaster&quot;) { &quot;hosts&quot; : [ &quot;db-0:27017&quot;, &quot;db-1:27017&quot;, &quot;db-2:27017&quot; ], &quot;setName&quot; : &quot;rs0&quot;, &quot;setVersion&quot; : 3, &quot;ismaster&quot; : true, &quot;secondary&quot; : false, &quot;primary&quot; : &quot;db-0:27017&quot;, &quot;me&quot; : &quot;db-0:27017&quot;, &quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;), &quot;lastWrite&quot; : { &quot;opTime&quot; : { &quot;ts&quot; : Timestamp(1504863894, 1), &quot;t&quot; : NumberLong(1) }, &quot;lastWriteDate&quot; : ISODate(&quot;2017-09-08T09:44:54Z&quot;) }, &quot;maxBsonObjectSize&quot; : 16777216, &quot;maxMessageSizeBytes&quot; : 48000000, &quot;maxWriteBatchSize&quot; : 1000, &quot;localTime&quot; : ISODate(&quot;2017-09-08T09:45:04.775Z&quot;), &quot;maxWireVersion&quot; : 5, &quot;minWireVersion&quot; : 0, &quot;readOnly&quot; : false, &quot;ok&quot; : 1 } rs0:PRIMARY&gt; References: mongo | Docker Documentation Enable Auth — MongoDB Tutorials Manage Users and Roles — MongoDB Tutorials Built-In Roles — MongoDB Manual 3.4 Deploy a Replica Set — MongoDB Manual 3.4 Enforce Keyfile Access Control in a Replica Set — MongoDB Manual 3.4 Compose file version 3 reference | Docker Documentation Deploy a MongoDB Cluster in 9 steps Using Docker Mongodb KeyFile too open permissions - Stack Overflow" />
<link rel="canonical" href="https://blog.codefarm.me/2017/09/08/deploy-mongodb-with-docker/" />
<meta property="og:url" content="https://blog.codefarm.me/2017/09/08/deploy-mongodb-with-docker/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-08T15:37:56+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploy MongoDB with Docker" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2017-09-08T15:37:56+08:00","datePublished":"2017-09-08T15:37:56+08:00","description":"0. Prerequisites 1. Start a MongoDB Instance. 2. Start a MongoDB Instance with Access Control. 3. Deploy a Replica Set 4. Deploy a Replica Set with Access Control. References: 0. Prerequisites Make sure you have already installed both Docker Engine and Docker Compose. You don’t need to install MongoDB, as it’s provided by Docker image. 1. Start a MongoDB Instance. $ docker run -d -p 27017:27017 --name db mongo:3 2. Start a MongoDB Instance with Access Control. $ docker run -d -p 27017:27017 --name db mongo:3 --auth Connect a mongo shell to one of the config server mongod instances over the localhost interface and create the user administrator. $ docker exec -it db mongo admin --quiet &gt; db.createUser({ ... user:&quot;admin&quot;, ... pwd:&quot;admin&quot;, ... roles: [ ... {role: &quot;userAdmin&quot;, db:&quot;admin&quot;} ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;admin&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;userAdmin&quot;, &quot;db&quot; : &quot;admin&quot; } ] } &gt; db.auth(&quot;admin&quot;,&quot;admin&quot;) 1 &gt; db.createUser({ ... user: &quot;user1&quot;, ... pwd: &quot;user1&quot;, ... roles: [ ... { ... role: &quot;readWriteAnyDatabase&quot;, ... db: &quot;admin&quot; ... } ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;user1&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;readWriteAnyDatabase&quot;, &quot;db&quot; : &quot;admin&quot; } ] } &gt; use test switched to db test &gt; db.test.insertOne({ x: 1 }) 2017-09-08T08:50:53.276+0000 E QUERY [thread1] TypeError: err.hasWriteErrors ... DBCollection.prototype.insertOne@src/mongo/shell/crud_api.js:244:13 @(shell):1:1 &gt; db.auth(&quot;user1&quot;,&quot;user1&quot;) Error: Authentication failed. 0 &gt; use admin switched to db admin &gt; db.auth(&quot;user1&quot;,&quot;user1&quot;) 1 &gt; use test switched to db test &gt; db.test.insertOne({ x: 1 }) { &quot;acknowledged&quot; : true, &quot;insertedId&quot; : ObjectId(&quot;59b25a108bcdfe4e19c35a13&quot;) } &gt; 3. Deploy a Replica Set $ mkdir mogors $ cd mogors/ $ cat &lt;&lt;EOF &gt; docker-compose.yml &gt; --- &gt; version: &quot;3.2&quot; &gt; services: &gt; db-0: &gt; container_name: db-0 &gt; image: mongo:3 &gt; # Start each member of the replica set with the appropriate options . &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; db-1: &gt; container_name: db-1 &gt; image: mongo:3 &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; db-2: &gt; container_name: db-2 &gt; image: mongo:3 &gt; command: &gt; - mongod &gt; - &quot;--replSet&quot; &gt; - &quot;rs0&quot; &gt; EOF $ docker-compose up -d Creating network &quot;mongors_default&quot; with the default driver Creating db-2 ... Creating db-0 ... Creating db-1 ... Creating db-2 Creating db-1 Creating db-0 ... done $ docker ps -a CONTAINER ID IMAGE STATUS PORTS NAMES 0f6a34b826b2 mongo:3 Up 45 seconds 27017/tcp db-1 c4c04bfc53f3 mongo:3 Up 46 seconds 27017/tcp db-0 9d8bc021082c mongo:3 Up 46 seconds 27017/tcp db-2 $ docker exec -it db-0 mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;db-0&quot; } ] ... }) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&quot;db-1&quot;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&quot;db-2&quot;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; db.runCommand(&quot;isMaster&quot;) { &quot;hosts&quot; : [ &quot;db-0:27017&quot;, &quot;db-1:27017&quot;, &quot;db-2:27017&quot; ], &quot;setName&quot; : &quot;rs0&quot;, &quot;setVersion&quot; : 3, &quot;ismaster&quot; : true, &quot;secondary&quot; : false, &quot;primary&quot; : &quot;db-0:27017&quot;, &quot;me&quot; : &quot;db-0:27017&quot;, &quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;), &quot;lastWrite&quot; : { &quot;opTime&quot; : { &quot;ts&quot; : Timestamp(1504859331, 1), &quot;t&quot; : NumberLong(1) }, &quot;lastWriteDate&quot; : ISODate(&quot;2017-09-08T08:28:51Z&quot;) }, &quot;maxBsonObjectSize&quot; : 16777216, &quot;maxMessageSizeBytes&quot; : 48000000, &quot;maxWriteBatchSize&quot; : 1000, &quot;localTime&quot; : ISODate(&quot;2017-09-08T08:28:56.329Z&quot;), &quot;maxWireVersion&quot; : 5, &quot;minWireVersion&quot; : 0, &quot;readOnly&quot; : false, &quot;ok&quot; : 1 } rs0:PRIMARY&gt; 4. Deploy a Replica Set with Access Control. $ mkdir mogors $ cd mogors/ $ # Create a keyfile. $ openssl rand -base64 756 &gt; keyfile $ cat keyfile AFO3EYmmmQQLF68tUd3aQsFI/C53XtOpUGt8R5ecS1F9uWRFg4dN6jlCjiBbYqHC w3lqUhlRBe00YhDM97z31oYkQBSyID20pIMeQ3e40FY6zBE1w+4lWYekuPJAUtzS ZspGfFExltwL0700Dwu7b1mnMbqfmfrpSVxTKHaY7Hcw60mvbBPPCp6IWkDVZ9NX NKveHX3Wuq28/PSMw8sVPUbP5eqPux05PCyp5VBp6/fhg8Np8vIlWAy9fMsAgkmE kBeGcRNst6t0iXbqNi9VrW6szJN5yyq0x1+0XB1QJZCjnLczoXMTPQeDCTrijbpI N4zr7L2EV6n8FsgSJ7vwzRMj0ZRFjuK/wwBblPCuisv5JlcClZ6I0WEtV1yg5HQu AFv3v7FPmfodQ6Sz81c6sNEKuwg3kzCY7wkeA163RZrujHViYFka6zOcv/kDdQ5h rL6EBXE3v6bnd24/nzys9Zx6CrqPPUqSVfugmIW78r9imXswUqdr/VZVbhGsKcjH Uza306prvuWmh0o1hpFGReGbHIdWhEtP/ldXKBbPy+27tgNeSiSP1GjVG2rkaIlb bsnahiNj2EaAa1ov9pYiyO51m+ouEg+H9LPBcLhLXipI3wbST8BqMZweLSNfeLFi Kpel5Q3rNtmRrjCbVIiiAXmxECU+PcwL+a4XhISnktdq6Du43d4INSJ/cn8JVLFS VbR5nTnc4cMmEE3n/0BrScZinGZT1gbtwbE5izA5E17/7n/HLGUXhfhMGWrwdL9f CsDt8ZEg7AUCPhFhsbcwfHkROXmYYubcd41NqLEYyktDzqsu3CaXFvH3QyD5AqmN ylh6UGgjqgWIC7y553qNE9v7Go/9zKTUj8Df/wcQVl6ALOdZgPmchNTX8PtENdKT aPUu/dcctYZUxz1DKwkaH3aUblSBGtSHa94knUA+R3DWPTcGNt3n46AL45Ty5amX c5yYTpaKB6jgXwIMjO96OA9XlZKxOVgqdASsN6O0wCzfAg55 $ chmod 400 keyfile $ sudo chown 999 keyfile $ cat docker-compose.yml --- version: &quot;3.2&quot; services: db-0: container_name: db-0 image: mongo:3 # Start each member of the replica set with the appropriate options . command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile read_only: true db-1: container_name: db-1 image: mongo:3 command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile db-2: container_name: db-2 image: mongo:3 command: - mongod - &quot;--replSet&quot; - &quot;rs0&quot; - &quot;--auth&quot; - &quot;--keyFile&quot; - &quot;/opt/mongors/keyfile&quot; volumes: - type: bind source: ./keyfile target: /opt/mongors/keyfile $ docker-compose up -d Creating network &quot;mongors_default&quot; with the default driver Creating db-1 ... Creating db-0 ... Creating db-1 Creating db-0 Creating db-2 ... Creating db-2 ... done $ docker ps -a CONTAINER ID IMAGE STATUS PORTS NAMES 02143821d0d7 mongo:3 Up 3 seconds 27017/tcp db-2 338aef4ef282 mongo:3 Up 3 seconds 27017/tcp db-0 ff459a50af25 mongo:3 Up 3 seconds 27017/tcp db-1 $ docker exec -it db-0 mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;db-0&quot; } ] ... }) { &quot;ok&quot; : 1 } rs0:SECONDARY&gt; use admin switched to db admin rs0:PRIMARY&gt; db.createUser({ ... user:&quot;admin&quot;, ... pwd:&quot;admin&quot;, ... roles: [ ... {role: &quot;userAdmin&quot;, db:&quot;admin&quot;}, ... {role: &quot;clusterAdmin&quot;, db: &quot;admin&quot;} ... ] ... }) Successfully added user: { &quot;user&quot; : &quot;admin&quot;, &quot;roles&quot; : [ { &quot;role&quot; : &quot;userAdmin&quot;, &quot;db&quot; : &quot;admin&quot; }, { &quot;role&quot; : &quot;clusterAdmin&quot;, &quot;db&quot; : &quot;admin&quot; } ] } rs0:PRIMARY&gt; rs.add(&#39;db-1&#39;) 2017-09-08T09:44:33.194+0000 E QUERY [thread1] Error: count failed: { &quot;ok&quot; : 0, &quot;errmsg&quot; : &quot;not authorized on local to execute command ... &quot;code&quot; : 13, &quot;codeName&quot; : &quot;Unauthorized&quot; } : _getErrorWithCode@src/mongo/shell/utils.js:25:13 DBQuery.prototype.count@src/mongo/shell/query.js:383:11 DBCollection.prototype.count@src/mongo/shell/collection.js:1700:12 rs.add@src/mongo/shell/utils.js:1227:1 @(shell):1:1 rs0:PRIMARY&gt; db.auth(&#39;admin&#39;,&#39;admin&#39;) 1 rs0:PRIMARY&gt; rs.add(&#39;db-1&#39;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; rs.add(&#39;db-2&#39;) { &quot;ok&quot; : 1 } rs0:PRIMARY&gt; db.runCommand(&quot;isMaster&quot;) { &quot;hosts&quot; : [ &quot;db-0:27017&quot;, &quot;db-1:27017&quot;, &quot;db-2:27017&quot; ], &quot;setName&quot; : &quot;rs0&quot;, &quot;setVersion&quot; : 3, &quot;ismaster&quot; : true, &quot;secondary&quot; : false, &quot;primary&quot; : &quot;db-0:27017&quot;, &quot;me&quot; : &quot;db-0:27017&quot;, &quot;electionId&quot; : ObjectId(&quot;7fffffff0000000000000001&quot;), &quot;lastWrite&quot; : { &quot;opTime&quot; : { &quot;ts&quot; : Timestamp(1504863894, 1), &quot;t&quot; : NumberLong(1) }, &quot;lastWriteDate&quot; : ISODate(&quot;2017-09-08T09:44:54Z&quot;) }, &quot;maxBsonObjectSize&quot; : 16777216, &quot;maxMessageSizeBytes&quot; : 48000000, &quot;maxWriteBatchSize&quot; : 1000, &quot;localTime&quot; : ISODate(&quot;2017-09-08T09:45:04.775Z&quot;), &quot;maxWireVersion&quot; : 5, &quot;minWireVersion&quot; : 0, &quot;readOnly&quot; : false, &quot;ok&quot; : 1 } rs0:PRIMARY&gt; References: mongo | Docker Documentation Enable Auth — MongoDB Tutorials Manage Users and Roles — MongoDB Tutorials Built-In Roles — MongoDB Manual 3.4 Deploy a Replica Set — MongoDB Manual 3.4 Enforce Keyfile Access Control in a Replica Set — MongoDB Manual 3.4 Compose file version 3 reference | Docker Documentation Deploy a MongoDB Cluster in 9 steps Using Docker Mongodb KeyFile too open permissions - Stack Overflow","headline":"Deploy MongoDB with Docker","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2017/09/08/deploy-mongodb-with-docker/"},"url":"https://blog.codefarm.me/2017/09/08/deploy-mongodb-with-docker/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">Deploy MongoDB with Docker</h1><p class="c-post-meta">08 Sep 2017</p>
  </header>

  <div class="c-post-content">
    <ul id="markdown-toc">
  <li><a href="#0-prerequisites" id="markdown-toc-0-prerequisites">0. Prerequisites</a></li>
  <li><a href="#1-start-a-mongodb-instance" id="markdown-toc-1-start-a-mongodb-instance">1. Start a MongoDB Instance.</a></li>
  <li><a href="#2-start-a-mongodb-instance-with-access-control" id="markdown-toc-2-start-a-mongodb-instance-with-access-control">2. Start a MongoDB Instance with Access Control.</a></li>
  <li><a href="#3-deploy-a-replica-set" id="markdown-toc-3-deploy-a-replica-set">3. Deploy a Replica Set</a></li>
  <li><a href="#4-deploy-a-replica-set-with-access-control" id="markdown-toc-4-deploy-a-replica-set-with-access-control">4. Deploy a Replica Set with Access Control.</a></li>
  <li><a href="#references" id="markdown-toc-references">References:</a></li>
</ul>

<hr />

<h3 id="0-prerequisites">0. Prerequisites</h3>

<p>Make sure you have already installed both <a href="https://docs.docker.com/engine/installation/">Docker Engine</a> and <a href="https://docs.docker.com/compose/install/">Docker Compose</a>. You don’t need to install MongoDB, as it’s provided by Docker image.</p>

<h3 id="1-start-a-mongodb-instance">1. Start a MongoDB Instance.</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 27017:27017 <span class="nt">--name</span> db mongo:3
</code></pre></div></div>

<h3 id="2-start-a-mongodb-instance-with-access-control">2. Start a MongoDB Instance with Access Control.</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 27017:27017 <span class="nt">--name</span> db mongo:3 <span class="nt">--auth</span>
</code></pre></div></div>

<p><em>Connect a mongo shell to one of the config server mongod instances over the <a href="https://docs.mongodb.com/manual/core/security-users/#localhost-exception">localhost interface</a> and create the user administrator.</em></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> db mongo admin <span class="nt">--quiet</span>
<span class="o">&gt;</span> db.createUser<span class="o">({</span>
... user:<span class="s2">"admin"</span>,
... <span class="nb">pwd</span>:<span class="s2">"admin"</span>,
... roles: <span class="o">[</span>
... <span class="o">{</span>role: <span class="s2">"userAdmin"</span>, db:<span class="s2">"admin"</span><span class="o">}</span>
... <span class="o">]</span>
... <span class="o">})</span>
Successfully added user: <span class="o">{</span>
        <span class="s2">"user"</span> : <span class="s2">"admin"</span>,
        <span class="s2">"roles"</span> : <span class="o">[</span>
                <span class="o">{</span>
                        <span class="s2">"role"</span> : <span class="s2">"userAdmin"</span>,
                        <span class="s2">"db"</span> : <span class="s2">"admin"</span>
                <span class="o">}</span>
        <span class="o">]</span>
<span class="o">}</span>
<span class="o">&gt;</span> db.auth<span class="o">(</span><span class="s2">"admin"</span>,<span class="s2">"admin"</span><span class="o">)</span>
1
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; db.createUser({
... user: "user1",
... pwd: "user1",
... roles: [
... {
... role: "readWriteAnyDatabase",
... db: "admin"
... }
... ]
... })
Successfully added user: {
        "user" : "user1",
        "roles" : [
                {
                        "role" : "readWriteAnyDatabase",
                        "db" : "admin"
                }
        ]
}
&gt; use test
switched to db test
&gt; db.test.insertOne({ x: 1 })
2017-09-08T08:50:53.276+0000 E QUERY    [thread1] TypeError: err.hasWriteErrors ...
DBCollection.prototype.insertOne@src/mongo/shell/crud_api.js:244:13
@(shell):1:1
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; db.auth("user1","user1")
Error: Authentication failed.
0
&gt; use admin
switched to db admin
&gt; db.auth("user1","user1")
1
&gt; use test
switched to db test
&gt; db.test.insertOne({ x: 1 })
{
        "acknowledged" : true,
        "insertedId" : ObjectId("59b25a108bcdfe4e19c35a13")
}
&gt;
</code></pre></div></div>

<h3 id="3-deploy-a-replica-set">3. Deploy a Replica Set</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>mogors
<span class="nv">$ </span><span class="nb">cd </span>mogors/
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat &lt;&lt;EOF &gt; docker-compose.yml
&gt; ---
&gt; version: "3.2"
&gt; services:
&gt;     db-0:
&gt;         container_name: db-0
&gt;         image: mongo:3
&gt;         # Start each member of the replica set with the appropriate options .
&gt;         command:
&gt;             - mongod
&gt;             - "--replSet"
&gt;             - "rs0"
&gt;     db-1:
&gt;         container_name: db-1
&gt;         image: mongo:3
&gt;         command:
&gt;             - mongod
&gt;             - "--replSet"
&gt;             - "rs0"
&gt;     db-2:
&gt;         container_name: db-2
&gt;         image: mongo:3
&gt;         command:
&gt;             - mongod
&gt;             - "--replSet"
&gt;             - "rs0"
&gt; EOF
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span>
Creating network <span class="s2">"mongors_default"</span> with the default driver
Creating db-2 ...
Creating db-0 ...
Creating db-1 ...
Creating db-2
Creating db-1
Creating db-0 ... <span class="k">done</span>
<span class="nv">$ </span>docker ps <span class="nt">-a</span>
CONTAINER ID        IMAGE               STATUS              PORTS               NAMES
0f6a34b826b2        mongo:3             Up 45 seconds       27017/tcp           db-1
c4c04bfc53f3        mongo:3             Up 46 seconds       27017/tcp           db-0
9d8bc021082c        mongo:3             Up 46 seconds       27017/tcp           db-2
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> db-0 mongo <span class="nt">--quiet</span>
<span class="o">&gt;</span> rs.initiate<span class="o">(</span> <span class="o">{</span>
...    _id : <span class="s2">"rs0"</span>,
...    members: <span class="o">[</span> <span class="o">{</span> _id : 0, host : <span class="s2">"db-0"</span> <span class="o">}</span> <span class="o">]</span>
... <span class="o">})</span>
<span class="o">{</span> <span class="s2">"ok"</span> : 1 <span class="o">}</span>
rs0:PRIMARY&gt; rs.add<span class="o">(</span><span class="s2">"db-1"</span><span class="o">)</span>
<span class="o">{</span> <span class="s2">"ok"</span> : 1 <span class="o">}</span>
rs0:PRIMARY&gt; rs.add<span class="o">(</span><span class="s2">"db-2"</span><span class="o">)</span>
<span class="o">{</span> <span class="s2">"ok"</span> : 1 <span class="o">}</span>
rs0:PRIMARY&gt; db.runCommand<span class="o">(</span><span class="s2">"isMaster"</span><span class="o">)</span>
<span class="o">{</span>
        <span class="s2">"hosts"</span> : <span class="o">[</span>
                <span class="s2">"db-0:27017"</span>,
                <span class="s2">"db-1:27017"</span>,
                <span class="s2">"db-2:27017"</span>
        <span class="o">]</span>,
        <span class="s2">"setName"</span> : <span class="s2">"rs0"</span>,
        <span class="s2">"setVersion"</span> : 3,
        <span class="s2">"ismaster"</span> : <span class="nb">true</span>,
        <span class="s2">"secondary"</span> : <span class="nb">false</span>,
        <span class="s2">"primary"</span> : <span class="s2">"db-0:27017"</span>,
        <span class="s2">"me"</span> : <span class="s2">"db-0:27017"</span>,
        <span class="s2">"electionId"</span> : ObjectId<span class="o">(</span><span class="s2">"7fffffff0000000000000001"</span><span class="o">)</span>,
        <span class="s2">"lastWrite"</span> : <span class="o">{</span>
                <span class="s2">"opTime"</span> : <span class="o">{</span>
                        <span class="s2">"ts"</span> : Timestamp<span class="o">(</span>1504859331, 1<span class="o">)</span>,
                        <span class="s2">"t"</span> : NumberLong<span class="o">(</span>1<span class="o">)</span>
                <span class="o">}</span>,
                <span class="s2">"lastWriteDate"</span> : ISODate<span class="o">(</span><span class="s2">"2017-09-08T08:28:51Z"</span><span class="o">)</span>
        <span class="o">}</span>,
        <span class="s2">"maxBsonObjectSize"</span> : 16777216,
        <span class="s2">"maxMessageSizeBytes"</span> : 48000000,
        <span class="s2">"maxWriteBatchSize"</span> : 1000,
        <span class="s2">"localTime"</span> : ISODate<span class="o">(</span><span class="s2">"2017-09-08T08:28:56.329Z"</span><span class="o">)</span>,
        <span class="s2">"maxWireVersion"</span> : 5,
        <span class="s2">"minWireVersion"</span> : 0,
        <span class="s2">"readOnly"</span> : <span class="nb">false</span>,
        <span class="s2">"ok"</span> : 1
<span class="o">}</span>
rs0:PRIMARY&gt;
</code></pre></div></div>

<h3 id="4-deploy-a-replica-set-with-access-control">4. Deploy a Replica Set with Access Control.</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir </span>mogors
<span class="nv">$ </span><span class="nb">cd </span>mogors/
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="c"># Create a keyfile.</span>
<span class="nv">$ </span>openssl rand <span class="nt">-base64</span> 756 <span class="o">&gt;</span> keyfile
<span class="nv">$ </span><span class="nb">cat </span>keyfile
AFO3EYmmmQQLF68tUd3aQsFI/C53XtOpUGt8R5ecS1F9uWRFg4dN6jlCjiBbYqHC
w3lqUhlRBe00YhDM97z31oYkQBSyID20pIMeQ3e40FY6zBE1w+4lWYekuPJAUtzS
ZspGfFExltwL0700Dwu7b1mnMbqfmfrpSVxTKHaY7Hcw60mvbBPPCp6IWkDVZ9NX
NKveHX3Wuq28/PSMw8sVPUbP5eqPux05PCyp5VBp6/fhg8Np8vIlWAy9fMsAgkmE
kBeGcRNst6t0iXbqNi9VrW6szJN5yyq0x1+0XB1QJZCjnLczoXMTPQeDCTrijbpI
N4zr7L2EV6n8FsgSJ7vwzRMj0ZRFjuK/wwBblPCuisv5JlcClZ6I0WEtV1yg5HQu
AFv3v7FPmfodQ6Sz81c6sNEKuwg3kzCY7wkeA163RZrujHViYFka6zOcv/kDdQ5h
rL6EBXE3v6bnd24/nzys9Zx6CrqPPUqSVfugmIW78r9imXswUqdr/VZVbhGsKcjH
Uza306prvuWmh0o1hpFGReGbHIdWhEtP/ldXKBbPy+27tgNeSiSP1GjVG2rkaIlb
bsnahiNj2EaAa1ov9pYiyO51m+ouEg+H9LPBcLhLXipI3wbST8BqMZweLSNfeLFi
Kpel5Q3rNtmRrjCbVIiiAXmxECU+PcwL+a4XhISnktdq6Du43d4INSJ/cn8JVLFS
VbR5nTnc4cMmEE3n/0BrScZinGZT1gbtwbE5izA5E17/7n/HLGUXhfhMGWrwdL9f
CsDt8ZEg7AUCPhFhsbcwfHkROXmYYubcd41NqLEYyktDzqsu3CaXFvH3QyD5AqmN
ylh6UGgjqgWIC7y553qNE9v7Go/9zKTUj8Df/wcQVl6ALOdZgPmchNTX8PtENdKT
aPUu/dcctYZUxz1DKwkaH3aUblSBGtSHa94knUA+R3DWPTcGNt3n46AL45Ty5amX
c5yYTpaKB6jgXwIMjO96OA9XlZKxOVgqdASsN6O0wCzfAg55
<span class="nv">$ </span><span class="nb">chmod </span>400 keyfile
<span class="nv">$ </span><span class="nb">sudo chown </span>999 keyfile
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>docker-compose.yml
<span class="nt">---</span>
version: <span class="s2">"3.2"</span>
services:
    db-0:
        container_name: db-0
        image: mongo:3
        <span class="c"># Start each member of the replica set with the appropriate options .</span>
        <span class="nb">command</span>:
            - mongod
            - <span class="s2">"--replSet"</span>
            - <span class="s2">"rs0"</span>
            - <span class="s2">"--auth"</span>
            - <span class="s2">"--keyFile"</span>
            - <span class="s2">"/opt/mongors/keyfile"</span>
        volumes:
            - <span class="nb">type</span>: <span class="nb">bind
              source</span>: ./keyfile
              target: /opt/mongors/keyfile
              read_only: <span class="nb">true
    </span>db-1:
        container_name: db-1
        image: mongo:3
        <span class="nb">command</span>:
            - mongod
            - <span class="s2">"--replSet"</span>
            - <span class="s2">"rs0"</span>
            - <span class="s2">"--auth"</span>
            - <span class="s2">"--keyFile"</span>
            - <span class="s2">"/opt/mongors/keyfile"</span>
        volumes:
            - <span class="nb">type</span>: <span class="nb">bind
              source</span>: ./keyfile
              target: /opt/mongors/keyfile
    db-2:
        container_name: db-2
        image: mongo:3
        <span class="nb">command</span>:
            - mongod
            - <span class="s2">"--replSet"</span>
            - <span class="s2">"rs0"</span>
            - <span class="s2">"--auth"</span>
            - <span class="s2">"--keyFile"</span>
            - <span class="s2">"/opt/mongors/keyfile"</span>
        volumes:
            - <span class="nb">type</span>: <span class="nb">bind
              source</span>: ./keyfile
              target: /opt/mongors/keyfile
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span>
Creating network <span class="s2">"mongors_default"</span> with the default driver
Creating db-1 ...
Creating db-0 ...
Creating db-1
Creating db-0
Creating db-2 ...
Creating db-2 ... <span class="k">done</span>
<span class="nv">$ </span>docker ps <span class="nt">-a</span>
CONTAINER ID        IMAGE               STATUS              PORTS               NAMES
02143821d0d7        mongo:3             Up 3 seconds        27017/tcp           db-2
338aef4ef282        mongo:3             Up 3 seconds        27017/tcp           db-0
ff459a50af25        mongo:3             Up 3 seconds        27017/tcp           db-1
</code></pre></div></div>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> db-0 mongo <span class="nt">--quiet</span>
<span class="o">&gt;</span> rs.initiate<span class="o">(</span> <span class="o">{</span>
...    _id : <span class="s2">"rs0"</span>,
...    members: <span class="o">[</span> <span class="o">{</span> _id : 0, host : <span class="s2">"db-0"</span> <span class="o">}</span> <span class="o">]</span>
... <span class="o">})</span>
<span class="o">{</span> <span class="s2">"ok"</span> : 1 <span class="o">}</span>
rs0:SECONDARY&gt; use admin
switched to db admin
rs0:PRIMARY&gt; db.createUser<span class="o">({</span>
... user:<span class="s2">"admin"</span>,
... <span class="nb">pwd</span>:<span class="s2">"admin"</span>,
... roles: <span class="o">[</span>
... <span class="o">{</span>role: <span class="s2">"userAdmin"</span>, db:<span class="s2">"admin"</span><span class="o">}</span>,
... <span class="o">{</span>role: <span class="s2">"clusterAdmin"</span>, db: <span class="s2">"admin"</span><span class="o">}</span>
... <span class="o">]</span>
... <span class="o">})</span>
Successfully added user: <span class="o">{</span>
        <span class="s2">"user"</span> : <span class="s2">"admin"</span>,
        <span class="s2">"roles"</span> : <span class="o">[</span>
                <span class="o">{</span>
                        <span class="s2">"role"</span> : <span class="s2">"userAdmin"</span>,
                        <span class="s2">"db"</span> : <span class="s2">"admin"</span>
                <span class="o">}</span>,
                <span class="o">{</span>
                        <span class="s2">"role"</span> : <span class="s2">"clusterAdmin"</span>,
                        <span class="s2">"db"</span> : <span class="s2">"admin"</span>
                <span class="o">}</span>
        <span class="o">]</span>
<span class="o">}</span>
rs0:PRIMARY&gt; rs.add<span class="o">(</span><span class="s1">'db-1'</span><span class="o">)</span>
2017-09-08T09:44:33.194+0000 E QUERY    <span class="o">[</span>thread1] Error: count failed: <span class="o">{</span>
        <span class="s2">"ok"</span> : 0,
        <span class="s2">"errmsg"</span> : <span class="s2">"not authorized on local to execute command ...
        "</span>code<span class="s2">" : 13,
        "</span>codeName<span class="s2">" : "</span>Unauthorized<span class="s2">"
} :
_getErrorWithCode@src/mongo/shell/utils.js:25:13
DBQuery.prototype.count@src/mongo/shell/query.js:383:11
DBCollection.prototype.count@src/mongo/shell/collection.js:1700:12
rs.add@src/mongo/shell/utils.js:1227:1
@(shell):1:1
</span></code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs0:PRIMARY&gt; db.auth('admin','admin')
1
rs0:PRIMARY&gt; rs.add('db-1')
{ "ok" : 1 }
rs0:PRIMARY&gt; rs.add('db-2')
{ "ok" : 1 }
rs0:PRIMARY&gt; db.runCommand("isMaster")
{
        "hosts" : [
                "db-0:27017",
                "db-1:27017",
                "db-2:27017"
        ],
        "setName" : "rs0",
        "setVersion" : 3,
        "ismaster" : true,
        "secondary" : false,
        "primary" : "db-0:27017",
        "me" : "db-0:27017",
        "electionId" : ObjectId("7fffffff0000000000000001"),
        "lastWrite" : {
                "opTime" : {
                        "ts" : Timestamp(1504863894, 1),
                        "t" : NumberLong(1)
                },
                "lastWriteDate" : ISODate("2017-09-08T09:44:54Z")
        },
        "maxBsonObjectSize" : 16777216,
        "maxMessageSizeBytes" : 48000000,
        "maxWriteBatchSize" : 1000,
        "localTime" : ISODate("2017-09-08T09:45:04.775Z"),
        "maxWireVersion" : 5,
        "minWireVersion" : 0,
        "readOnly" : false,
        "ok" : 1
}
rs0:PRIMARY&gt;
</code></pre></div></div>

<h3 id="references">References:</h3>

<ol>
  <li><a href="https://docs.docker.com/samples/library/mongo/#authentication-and-authorization">mongo | Docker Documentation</a></li>
  <li><a href="https://docs.mongodb.com/tutorials/enable-authentication/">Enable Auth — MongoDB Tutorials</a></li>
  <li><a href="https://docs.mongodb.com/tutorials/manage-users-and-roles/">Manage Users and Roles — MongoDB Tutorials</a></li>
  <li><a href="https://docs.mongodb.com/manual/reference/built-in-roles/">Built-In Roles — MongoDB Manual 3.4</a></li>
  <li><a href="https://docs.mongodb.com/manual/tutorial/deploy-replica-set/">Deploy a Replica Set — MongoDB Manual 3.4</a></li>
  <li><a href="https://docs.mongodb.com/manual/tutorial/enforce-keyfile-access-control-in-existing-replica-set/">Enforce Keyfile Access Control in a Replica Set — MongoDB Manual 3.4</a></li>
  <li><a href="https://docs.docker.com/compose/compose-file/">Compose file version 3 reference | Docker Documentation</a></li>
  <li><a href="https://medium.com/@gargar454/deploy-a-mongodb-cluster-in-steps-9-using-docker-49205e231319">Deploy a MongoDB Cluster in 9 steps Using Docker</a></li>
  <li><a href="https://stackoverflow.com/questions/14789622/mongodb-keyfile-too-open-permissions">Mongodb KeyFile too open permissions - Stack Overflow</a></li>
</ol>

<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
