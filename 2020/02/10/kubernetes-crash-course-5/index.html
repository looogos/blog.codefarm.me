<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>5 - Kubernetes StatefulSet | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="5 - Kubernetes StatefulSet" />
<meta property="og:locale" content="en" />
<meta name="description" content="StatefulSet Limitations Pod Identity pvs/mongodb-data-0-pv.yaml pvs/mongodb-data-1-pv.yaml pvs/mongodb-data-2-pv.yaml mongodb-svc.yaml mongodb-sts.yaml (1) mongod-keyfile-secret.yaml network-utils-pod.yaml rs-init.js Let’s do IT (0) Let’s do IT (1) Let’s do IT (2) Let’s do IT (3) Let’s do IT (4) Let’s do IT (5) Let’s do IT (6) Quit or not quit ? StatefulSet StatefulSet is the workload API object used to manage stateful applications. Like a Deployment , a StatefulSet manages Pods that are based on an identical container spec. Unlike a Deployment, a StatefulSet maintains a sticky identity for each of their Pods. These pods are created from the same spec, but are not interchangeable: each has a persistent identifier that it maintains across any rescheduling. A StatefulSet operates under the same pattern as any other Controller. You define your desired state in a StatefulSet object, and the StatefulSet controller makes any necessary updates to get there from the current state. StatefulSets are valuable for applications that require one or more of the following. Stable, unique network identifiers. Stable, persistent storage. Ordered, graceful deployment and scaling. Ordered, automated rolling updates. Limitations The storage for a given Pod must either be provisioned by a PersistentVolume Provisioner based on the requested storage class, or pre-provisioned by an admin. Deleting and/or scaling a StatefulSet down will not delete the volumes associated with the StatefulSet. This is done to ensure data safety, which is generally more valuable than an automatic purge of all related StatefulSet resources. StatefulSets currently require a Headless Service to be responsible for the network identity of the Pods. You are responsible for creating this Service. StatefulSets do not provide any guarantees on the termination of pods when a StatefulSet is deleted. To achieve ordered and graceful termination of the pods in the StatefulSet, it is possible to scale the StatefulSet down to 0 prior to deletion. Pod Identity StatefulSet Pods have a unique identity that is comprised of an ordinal, a stable network identity, and stable storage. The identity sticks to the Pod, regardless of which node it’s (re)scheduled on. For a StatefulSet with N replicas, each Pod in the StatefulSet will be assigned an integer ordinal, from 0 up through N-1, that is unique over the Set. Each Pod in a StatefulSet derives its hostname from the name of the StatefulSet and the ordinal of the Pod. The pattern for the constructed hostname is $(statefulset name)-$(ordinal). A StatefulSet can use a Headless Service to control the domain of its Pods. The domain managed by this Service takes the form: $(service name).$(namespace).svc.cluster.local, where “cluster.local” is the cluster domain. As each Pod is created, it gets a matching DNS subdomain, taking the form: $(podname).$(governing service domain), where the governing service is defined by the serviceName field on the StatefulSet. pvs/mongodb-data-0-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-0 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/0 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-0-ready operator: In values: - &quot;true&quot; pvs/mongodb-data-1-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-1 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/1 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-1-ready operator: In values: - &quot;true&quot; pvs/mongodb-data-2-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-2 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/2 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-2-ready operator: In values: - &quot;true&quot; mongodb-svc.yaml apiVersion: v1 kind: Service metadata: name: mongodb spec: clusterIP: None selector: app: mongodb ports: - port: 27017 mongodb-sts.yaml (1) apiVersion: apps/v1 kind: StatefulSet metadata: name: mongodb spec: replicas: 3 serviceName: mongodb volumeClaimTemplates: - metadata: name: data spec: storageClassName: local accessModes: - ReadWriteOnce resources: requests: storage: 16Mi template: metadata: labels: app: mongodb spec: volumes: - name: etc-mongod-keyfile secret: defaultMode: 0400 secretName: mongod-keyfile containers: - name: mongo image: mongo:3.6 command: [&quot;mongod&quot;, &quot;--bind_ip_all&quot;, &quot;--auth&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--keyFile&quot;, &quot;/etc/mongod.keyfile&quot;] volumeMounts: - mountPath: /data/db name: data - mountPath: /etc/mongod.keyfile name: etc-mongod-keyfile subPath: mongod.keyfile mongod-keyfile-secret.yaml apiVersion: v1 kind: Secret metadata: name: mongod-keyfile type: Opaque data: mongod.keyfile: QkpTUGEveElKNU9UTXRXcGZiSjl0M253SDMzZHJCSG9idEczYmtvN3RmMCtkVENKR1o4R0pRNS9oekFQdksxYgpLMHNqZExKNi9ZY3l1TFI4NDlsUEl6aUtIVFpiZWI4a0ZYR1Fnb0s3QkE4VlBqaHFySnhTVUxHb1YyQkNvZElsCmtqeE5nc29JOW1PTmxsMmh2WTJxYWlrOFMzVnBOc1orNlVjV0lXYk90ekE0ZFJXb3ZISTZZS0xrU3RTMlRoakwKM3lMQUlPM1ZUVlJ5bEptcFVwNFJiMzd5QUVPYlR6VHg2dStURjg2L1p3OEFGM2NGZ1JLdHgxQ0pKMTlOVjZ2NAowZ051ZEhUSXNkZXJSNWViSkhKMTZsY2I2ZGdPOUxxaWlBaXBxQmNPdzB2TXlsalVtZHpQRVN2VXhzbmtaRy9KCmRNbkJGYitOV2owelQ0aGpyLzJCTUZwTTYvcjlMYnpocnVGem5XOTBXb0JEZGRFdnNvVWwrU1lLMWJiUE1yTVIKekovc0pTa2t3eDZ2NUlZc2NmdnFrRllqSS9TaFNHQ0FWMXlXcS9pZ3ptSGg3b2ZLUXVHSHBoWVNVNzlwVTNqagpBRVN4VHhaMDJSTmZNOExRdU42eGl5dWRLbWF0TDBuWlp6VlAySnFSeTNiRGtpTVFhcmJLbzVRZ2JsNk0xSmlwClhVSElPUWFSQytlRU1weGxycWM5cGtaYVVqZEZEUmlEWDBUcHZISWNVaWNuVGxOeTFRMVpHYmczY09SVmo0R2sKZGZmRXdjRHNubWwyZS9oUFJpejZxQTJURGpBb3B6di9MakhZUWZ1U0JVREVwTkpIMytPQUlKcWJFeWpHWFdlQgp5L0dVL0w5OHpPN21mYWlrbG52SW5jR0M2czVtalVNS1JWVW8yaytMdXU2VVV3NkRYa1hjVXhvYzVkemQzNy94CitiNDZJN1YzUXJ5cnI0UWtDb3ZnbHBHVmtBa3lKamVZQnVUckY2MnV4bDlCaTM2MkwrMWdnWjVJZE1IYTErV0wKWGZOZXR6c1FqanFlWlNzdWxsaHRJaWFDMjZ5azQ5NXFHMks0T1N5bDBhbjZQQkdldmtpOE5xTm11UlY3N2M5YwpQM2wvdElJNUlhMllHdFFyNGZHU3BuQ1U5bHIxelRmUzYrZUFPNGxjNk85SXljQnEwU1VNd3IvUDhCTFVOYk96CndrR09NQTB1Vy8zMVR3RllNUE9vY0R6WHF5ejE2NTFUc0dHY0xEWnR5bUx1eEdqTitDbGNMVlN2K0lrMVBRa3gKV2FML2pCVzJCL2g4OXNaY21Zak9PTVQrUVdvTWo2WEtXSWsvNUpEOERpa28rNzA3Cg== network-utils-pod.yaml apiVersion: v1 kind: Pod metadata: name: network-utils spec: containers: - name: network-utils image: amouat/network-utils command: [&#39;sleep&#39;, &#39;10h&#39;] rs-init.js // 1. init replication set rs.initiate( { _id : &quot;rs0&quot;, members: [ { _id : 0, host : &quot;mongodb-0.mongodb&quot; } ] }); // 2. create cluster admin use admin; db.createUser({ user:&quot;admin&quot;, pwd:&quot;admin&quot;, roles: [ {role: &quot;userAdmin&quot;, db:&quot;admin&quot;}, {role: &quot;clusterAdmin&quot;, db: &quot;admin&quot;} ] }); // 3. login with cluster admin user db.auth(&quot;admin&quot;, &quot;admin&quot;); // 3. add slave nodes rs.add(&quot;mongodb-1.mongodb&quot;); rs.add(&quot;mongodb-2.mongodb&quot;); db.runCommand(&#39;isMaster&#39;); // 4. create database user db.createUser({ user: &quot;test&quot;, pwd: &quot;test&quot;, roles: [ { role: &quot;readWriteAnyDatabase&quot;, db: &quot;admin&quot; } ] }); Let’s do IT (0) $ sudo mkdir /tmp/data/db/{0,1,2} -p $ kubectl label no [NODE-0-NAME] node.kubernetes.io/mongodb-data-0-ready=true node/NODE-0-NAME labeled $ kubectl label no [NODE-1-NAME] node.kubernetes.io/mongodb-data-1-ready=true node/NODE-1-NAME labeled $ kubectl label no [NODE-2-NAME] node.kubernetes.io/mongodb-data-2-ready=true node/NODE-2-NAME labeled $ kubectl create -f pvs/ persistentvolume/mongodb-data-0 created persistentvolume/mongodb-data-1 created persistentvolume/mongodb-data-2 created Let’s do IT (1) $ kubectl create -f mongodb-svc.yaml service/mongodb created $ kubectl create -f mongod-keyfile-secret.yaml secret/mongod-keyfile created $ kubectl create -f mongodb-sts.yaml statefulset.apps/mongodb created $ kubectl get po -w NAME READY STATUS RESTARTS AGE mongodb-0 1/1 Running 0 4s mongodb-1 0/1 Pending 0 0s mongodb-1 0/1 Pending 0 1s mongodb-1 0/1 ContainerCreating 0 1s mongodb-1 1/1 Running 0 3s mongodb-2 0/1 Pending 0 0s mongodb-2 0/1 Pending 0 1s mongodb-2 0/1 ContainerCreating 0 1s mongodb-2 1/1 Running 0 3s Let’s do IT (2) $ kubectl get pv,pvc NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/mongodb-data-0 64Mi RWO Retain Bound default/data-mongodb-0 local 70s persistentvolume/mongodb-data-1 64Mi RWO Retain Bound default/data-mongodb-1 local 70s persistentvolume/mongodb-data-2 64Mi RWO Retain Bound default/data-mongodb-2 local 70s NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/data-mongodb-0 Bound mongodb-data-0 64Mi RWO local 43s persistentvolumeclaim/data-mongodb-1 Bound mongodb-data-1 64Mi RWO local 40s persistentvolumeclaim/data-mongodb-2 Bound mongodb-data-2 64Mi RWO local 36s Let’s do IT (3) $ kubectl create -f network-utils-pod.yaml pod/network-utils created $ kubectl exec -it network-utils bash root@network-utils:/# nslookup mongodb-0.mongodbclear Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongodb-0.mongodb.default.svc.cluster.local Address: 10.244.0.136 root@network-utils:/# nslookup mongodb Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongodb.default.svc.cluster.local Address: 10.244.0.138 Name: mongodb.default.svc.cluster.local Address: 10.244.0.137 Name: mongodb.default.svc.cluster.local Address: 10.244.0.136 Let’s do IT (4) $ kubectl describe po mongodb-0 Volumes: data: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: data-mongodb-0 ReadOnly: false etc-mongod-keyfile: Type: Secret (a volume populated by a Secret) SecretName: mongod-keyfile Optional: false Let’s do IT (5) $ kubectl delete -f mongodb-sts.yaml statefulset.apps &quot;mongodb&quot; deleted $ kubectl get po NAME READY STATUS RESTARTS AGE network-utils 1/1 Running 0 7m4s $ kubectl get pv,pvc NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/mongodb-data-0 64Mi RWO Retain Bound default/data-mongodb-0 local 11m persistentvolume/mongodb-data-1 64Mi RWO Retain Bound default/data-mongodb-1 local 11m persistentvolume/mongodb-data-2 64Mi RWO Retain Bound default/data-mongodb-2 local 11m NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/data-mongodb-0 Bound mongodb-data-0 64Mi RWO local 11m persistentvolumeclaim/data-mongodb-1 Bound mongodb-data-1 64Mi RWO local 11m persistentvolumeclaim/data-mongodb-2 Bound mongodb-data-2 64Mi RWO local 11m Let’s do IT (6) $ kubectl create -f mongodb-sts.yaml statefulset.apps/mongodb created $ kubectl exec -it mongodb-0 bash root@mongodb-0:/# mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;mongodb-0.mongodb&quot; } ] ... }); { &quot;ok&quot; : 1 } Quit or not quit ? https://kubernetes.io/" />
<meta property="og:description" content="StatefulSet Limitations Pod Identity pvs/mongodb-data-0-pv.yaml pvs/mongodb-data-1-pv.yaml pvs/mongodb-data-2-pv.yaml mongodb-svc.yaml mongodb-sts.yaml (1) mongod-keyfile-secret.yaml network-utils-pod.yaml rs-init.js Let’s do IT (0) Let’s do IT (1) Let’s do IT (2) Let’s do IT (3) Let’s do IT (4) Let’s do IT (5) Let’s do IT (6) Quit or not quit ? StatefulSet StatefulSet is the workload API object used to manage stateful applications. Like a Deployment , a StatefulSet manages Pods that are based on an identical container spec. Unlike a Deployment, a StatefulSet maintains a sticky identity for each of their Pods. These pods are created from the same spec, but are not interchangeable: each has a persistent identifier that it maintains across any rescheduling. A StatefulSet operates under the same pattern as any other Controller. You define your desired state in a StatefulSet object, and the StatefulSet controller makes any necessary updates to get there from the current state. StatefulSets are valuable for applications that require one or more of the following. Stable, unique network identifiers. Stable, persistent storage. Ordered, graceful deployment and scaling. Ordered, automated rolling updates. Limitations The storage for a given Pod must either be provisioned by a PersistentVolume Provisioner based on the requested storage class, or pre-provisioned by an admin. Deleting and/or scaling a StatefulSet down will not delete the volumes associated with the StatefulSet. This is done to ensure data safety, which is generally more valuable than an automatic purge of all related StatefulSet resources. StatefulSets currently require a Headless Service to be responsible for the network identity of the Pods. You are responsible for creating this Service. StatefulSets do not provide any guarantees on the termination of pods when a StatefulSet is deleted. To achieve ordered and graceful termination of the pods in the StatefulSet, it is possible to scale the StatefulSet down to 0 prior to deletion. Pod Identity StatefulSet Pods have a unique identity that is comprised of an ordinal, a stable network identity, and stable storage. The identity sticks to the Pod, regardless of which node it’s (re)scheduled on. For a StatefulSet with N replicas, each Pod in the StatefulSet will be assigned an integer ordinal, from 0 up through N-1, that is unique over the Set. Each Pod in a StatefulSet derives its hostname from the name of the StatefulSet and the ordinal of the Pod. The pattern for the constructed hostname is $(statefulset name)-$(ordinal). A StatefulSet can use a Headless Service to control the domain of its Pods. The domain managed by this Service takes the form: $(service name).$(namespace).svc.cluster.local, where “cluster.local” is the cluster domain. As each Pod is created, it gets a matching DNS subdomain, taking the form: $(podname).$(governing service domain), where the governing service is defined by the serviceName field on the StatefulSet. pvs/mongodb-data-0-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-0 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/0 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-0-ready operator: In values: - &quot;true&quot; pvs/mongodb-data-1-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-1 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/1 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-1-ready operator: In values: - &quot;true&quot; pvs/mongodb-data-2-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-2 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/2 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-2-ready operator: In values: - &quot;true&quot; mongodb-svc.yaml apiVersion: v1 kind: Service metadata: name: mongodb spec: clusterIP: None selector: app: mongodb ports: - port: 27017 mongodb-sts.yaml (1) apiVersion: apps/v1 kind: StatefulSet metadata: name: mongodb spec: replicas: 3 serviceName: mongodb volumeClaimTemplates: - metadata: name: data spec: storageClassName: local accessModes: - ReadWriteOnce resources: requests: storage: 16Mi template: metadata: labels: app: mongodb spec: volumes: - name: etc-mongod-keyfile secret: defaultMode: 0400 secretName: mongod-keyfile containers: - name: mongo image: mongo:3.6 command: [&quot;mongod&quot;, &quot;--bind_ip_all&quot;, &quot;--auth&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--keyFile&quot;, &quot;/etc/mongod.keyfile&quot;] volumeMounts: - mountPath: /data/db name: data - mountPath: /etc/mongod.keyfile name: etc-mongod-keyfile subPath: mongod.keyfile mongod-keyfile-secret.yaml apiVersion: v1 kind: Secret metadata: name: mongod-keyfile type: Opaque data: mongod.keyfile: QkpTUGEveElKNU9UTXRXcGZiSjl0M253SDMzZHJCSG9idEczYmtvN3RmMCtkVENKR1o4R0pRNS9oekFQdksxYgpLMHNqZExKNi9ZY3l1TFI4NDlsUEl6aUtIVFpiZWI4a0ZYR1Fnb0s3QkE4VlBqaHFySnhTVUxHb1YyQkNvZElsCmtqeE5nc29JOW1PTmxsMmh2WTJxYWlrOFMzVnBOc1orNlVjV0lXYk90ekE0ZFJXb3ZISTZZS0xrU3RTMlRoakwKM3lMQUlPM1ZUVlJ5bEptcFVwNFJiMzd5QUVPYlR6VHg2dStURjg2L1p3OEFGM2NGZ1JLdHgxQ0pKMTlOVjZ2NAowZ051ZEhUSXNkZXJSNWViSkhKMTZsY2I2ZGdPOUxxaWlBaXBxQmNPdzB2TXlsalVtZHpQRVN2VXhzbmtaRy9KCmRNbkJGYitOV2owelQ0aGpyLzJCTUZwTTYvcjlMYnpocnVGem5XOTBXb0JEZGRFdnNvVWwrU1lLMWJiUE1yTVIKekovc0pTa2t3eDZ2NUlZc2NmdnFrRllqSS9TaFNHQ0FWMXlXcS9pZ3ptSGg3b2ZLUXVHSHBoWVNVNzlwVTNqagpBRVN4VHhaMDJSTmZNOExRdU42eGl5dWRLbWF0TDBuWlp6VlAySnFSeTNiRGtpTVFhcmJLbzVRZ2JsNk0xSmlwClhVSElPUWFSQytlRU1weGxycWM5cGtaYVVqZEZEUmlEWDBUcHZISWNVaWNuVGxOeTFRMVpHYmczY09SVmo0R2sKZGZmRXdjRHNubWwyZS9oUFJpejZxQTJURGpBb3B6di9MakhZUWZ1U0JVREVwTkpIMytPQUlKcWJFeWpHWFdlQgp5L0dVL0w5OHpPN21mYWlrbG52SW5jR0M2czVtalVNS1JWVW8yaytMdXU2VVV3NkRYa1hjVXhvYzVkemQzNy94CitiNDZJN1YzUXJ5cnI0UWtDb3ZnbHBHVmtBa3lKamVZQnVUckY2MnV4bDlCaTM2MkwrMWdnWjVJZE1IYTErV0wKWGZOZXR6c1FqanFlWlNzdWxsaHRJaWFDMjZ5azQ5NXFHMks0T1N5bDBhbjZQQkdldmtpOE5xTm11UlY3N2M5YwpQM2wvdElJNUlhMllHdFFyNGZHU3BuQ1U5bHIxelRmUzYrZUFPNGxjNk85SXljQnEwU1VNd3IvUDhCTFVOYk96CndrR09NQTB1Vy8zMVR3RllNUE9vY0R6WHF5ejE2NTFUc0dHY0xEWnR5bUx1eEdqTitDbGNMVlN2K0lrMVBRa3gKV2FML2pCVzJCL2g4OXNaY21Zak9PTVQrUVdvTWo2WEtXSWsvNUpEOERpa28rNzA3Cg== network-utils-pod.yaml apiVersion: v1 kind: Pod metadata: name: network-utils spec: containers: - name: network-utils image: amouat/network-utils command: [&#39;sleep&#39;, &#39;10h&#39;] rs-init.js // 1. init replication set rs.initiate( { _id : &quot;rs0&quot;, members: [ { _id : 0, host : &quot;mongodb-0.mongodb&quot; } ] }); // 2. create cluster admin use admin; db.createUser({ user:&quot;admin&quot;, pwd:&quot;admin&quot;, roles: [ {role: &quot;userAdmin&quot;, db:&quot;admin&quot;}, {role: &quot;clusterAdmin&quot;, db: &quot;admin&quot;} ] }); // 3. login with cluster admin user db.auth(&quot;admin&quot;, &quot;admin&quot;); // 3. add slave nodes rs.add(&quot;mongodb-1.mongodb&quot;); rs.add(&quot;mongodb-2.mongodb&quot;); db.runCommand(&#39;isMaster&#39;); // 4. create database user db.createUser({ user: &quot;test&quot;, pwd: &quot;test&quot;, roles: [ { role: &quot;readWriteAnyDatabase&quot;, db: &quot;admin&quot; } ] }); Let’s do IT (0) $ sudo mkdir /tmp/data/db/{0,1,2} -p $ kubectl label no [NODE-0-NAME] node.kubernetes.io/mongodb-data-0-ready=true node/NODE-0-NAME labeled $ kubectl label no [NODE-1-NAME] node.kubernetes.io/mongodb-data-1-ready=true node/NODE-1-NAME labeled $ kubectl label no [NODE-2-NAME] node.kubernetes.io/mongodb-data-2-ready=true node/NODE-2-NAME labeled $ kubectl create -f pvs/ persistentvolume/mongodb-data-0 created persistentvolume/mongodb-data-1 created persistentvolume/mongodb-data-2 created Let’s do IT (1) $ kubectl create -f mongodb-svc.yaml service/mongodb created $ kubectl create -f mongod-keyfile-secret.yaml secret/mongod-keyfile created $ kubectl create -f mongodb-sts.yaml statefulset.apps/mongodb created $ kubectl get po -w NAME READY STATUS RESTARTS AGE mongodb-0 1/1 Running 0 4s mongodb-1 0/1 Pending 0 0s mongodb-1 0/1 Pending 0 1s mongodb-1 0/1 ContainerCreating 0 1s mongodb-1 1/1 Running 0 3s mongodb-2 0/1 Pending 0 0s mongodb-2 0/1 Pending 0 1s mongodb-2 0/1 ContainerCreating 0 1s mongodb-2 1/1 Running 0 3s Let’s do IT (2) $ kubectl get pv,pvc NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/mongodb-data-0 64Mi RWO Retain Bound default/data-mongodb-0 local 70s persistentvolume/mongodb-data-1 64Mi RWO Retain Bound default/data-mongodb-1 local 70s persistentvolume/mongodb-data-2 64Mi RWO Retain Bound default/data-mongodb-2 local 70s NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/data-mongodb-0 Bound mongodb-data-0 64Mi RWO local 43s persistentvolumeclaim/data-mongodb-1 Bound mongodb-data-1 64Mi RWO local 40s persistentvolumeclaim/data-mongodb-2 Bound mongodb-data-2 64Mi RWO local 36s Let’s do IT (3) $ kubectl create -f network-utils-pod.yaml pod/network-utils created $ kubectl exec -it network-utils bash root@network-utils:/# nslookup mongodb-0.mongodbclear Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongodb-0.mongodb.default.svc.cluster.local Address: 10.244.0.136 root@network-utils:/# nslookup mongodb Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongodb.default.svc.cluster.local Address: 10.244.0.138 Name: mongodb.default.svc.cluster.local Address: 10.244.0.137 Name: mongodb.default.svc.cluster.local Address: 10.244.0.136 Let’s do IT (4) $ kubectl describe po mongodb-0 Volumes: data: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: data-mongodb-0 ReadOnly: false etc-mongod-keyfile: Type: Secret (a volume populated by a Secret) SecretName: mongod-keyfile Optional: false Let’s do IT (5) $ kubectl delete -f mongodb-sts.yaml statefulset.apps &quot;mongodb&quot; deleted $ kubectl get po NAME READY STATUS RESTARTS AGE network-utils 1/1 Running 0 7m4s $ kubectl get pv,pvc NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/mongodb-data-0 64Mi RWO Retain Bound default/data-mongodb-0 local 11m persistentvolume/mongodb-data-1 64Mi RWO Retain Bound default/data-mongodb-1 local 11m persistentvolume/mongodb-data-2 64Mi RWO Retain Bound default/data-mongodb-2 local 11m NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/data-mongodb-0 Bound mongodb-data-0 64Mi RWO local 11m persistentvolumeclaim/data-mongodb-1 Bound mongodb-data-1 64Mi RWO local 11m persistentvolumeclaim/data-mongodb-2 Bound mongodb-data-2 64Mi RWO local 11m Let’s do IT (6) $ kubectl create -f mongodb-sts.yaml statefulset.apps/mongodb created $ kubectl exec -it mongodb-0 bash root@mongodb-0:/# mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;mongodb-0.mongodb&quot; } ] ... }); { &quot;ok&quot; : 1 } Quit or not quit ? https://kubernetes.io/" />
<link rel="canonical" href="https://blog.codefarm.me/2020/02/10/kubernetes-crash-course-5/" />
<meta property="og:url" content="https://blog.codefarm.me/2020/02/10/kubernetes-crash-course-5/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-10T10:46:33+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="5 - Kubernetes StatefulSet" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-02-10T10:46:33+08:00","datePublished":"2020-02-10T10:46:33+08:00","description":"StatefulSet Limitations Pod Identity pvs/mongodb-data-0-pv.yaml pvs/mongodb-data-1-pv.yaml pvs/mongodb-data-2-pv.yaml mongodb-svc.yaml mongodb-sts.yaml (1) mongod-keyfile-secret.yaml network-utils-pod.yaml rs-init.js Let’s do IT (0) Let’s do IT (1) Let’s do IT (2) Let’s do IT (3) Let’s do IT (4) Let’s do IT (5) Let’s do IT (6) Quit or not quit ? StatefulSet StatefulSet is the workload API object used to manage stateful applications. Like a Deployment , a StatefulSet manages Pods that are based on an identical container spec. Unlike a Deployment, a StatefulSet maintains a sticky identity for each of their Pods. These pods are created from the same spec, but are not interchangeable: each has a persistent identifier that it maintains across any rescheduling. A StatefulSet operates under the same pattern as any other Controller. You define your desired state in a StatefulSet object, and the StatefulSet controller makes any necessary updates to get there from the current state. StatefulSets are valuable for applications that require one or more of the following. Stable, unique network identifiers. Stable, persistent storage. Ordered, graceful deployment and scaling. Ordered, automated rolling updates. Limitations The storage for a given Pod must either be provisioned by a PersistentVolume Provisioner based on the requested storage class, or pre-provisioned by an admin. Deleting and/or scaling a StatefulSet down will not delete the volumes associated with the StatefulSet. This is done to ensure data safety, which is generally more valuable than an automatic purge of all related StatefulSet resources. StatefulSets currently require a Headless Service to be responsible for the network identity of the Pods. You are responsible for creating this Service. StatefulSets do not provide any guarantees on the termination of pods when a StatefulSet is deleted. To achieve ordered and graceful termination of the pods in the StatefulSet, it is possible to scale the StatefulSet down to 0 prior to deletion. Pod Identity StatefulSet Pods have a unique identity that is comprised of an ordinal, a stable network identity, and stable storage. The identity sticks to the Pod, regardless of which node it’s (re)scheduled on. For a StatefulSet with N replicas, each Pod in the StatefulSet will be assigned an integer ordinal, from 0 up through N-1, that is unique over the Set. Each Pod in a StatefulSet derives its hostname from the name of the StatefulSet and the ordinal of the Pod. The pattern for the constructed hostname is $(statefulset name)-$(ordinal). A StatefulSet can use a Headless Service to control the domain of its Pods. The domain managed by this Service takes the form: $(service name).$(namespace).svc.cluster.local, where “cluster.local” is the cluster domain. As each Pod is created, it gets a matching DNS subdomain, taking the form: $(podname).$(governing service domain), where the governing service is defined by the serviceName field on the StatefulSet. pvs/mongodb-data-0-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-0 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/0 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-0-ready operator: In values: - &quot;true&quot; pvs/mongodb-data-1-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-1 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/1 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-1-ready operator: In values: - &quot;true&quot; pvs/mongodb-data-2-pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: mongodb-data-2 spec: storageClassName: local capacity: storage: 64Mi accessModes: - ReadWriteOnce local: path: /tmp/data/db/2 nodeAffinity: required: nodeSelectorTerms: - matchExpressions: - key: node.kubernetes.io/mongodb-data-2-ready operator: In values: - &quot;true&quot; mongodb-svc.yaml apiVersion: v1 kind: Service metadata: name: mongodb spec: clusterIP: None selector: app: mongodb ports: - port: 27017 mongodb-sts.yaml (1) apiVersion: apps/v1 kind: StatefulSet metadata: name: mongodb spec: replicas: 3 serviceName: mongodb volumeClaimTemplates: - metadata: name: data spec: storageClassName: local accessModes: - ReadWriteOnce resources: requests: storage: 16Mi template: metadata: labels: app: mongodb spec: volumes: - name: etc-mongod-keyfile secret: defaultMode: 0400 secretName: mongod-keyfile containers: - name: mongo image: mongo:3.6 command: [&quot;mongod&quot;, &quot;--bind_ip_all&quot;, &quot;--auth&quot;, &quot;--replSet&quot;, &quot;rs0&quot;, &quot;--keyFile&quot;, &quot;/etc/mongod.keyfile&quot;] volumeMounts: - mountPath: /data/db name: data - mountPath: /etc/mongod.keyfile name: etc-mongod-keyfile subPath: mongod.keyfile mongod-keyfile-secret.yaml apiVersion: v1 kind: Secret metadata: name: mongod-keyfile type: Opaque data: mongod.keyfile: QkpTUGEveElKNU9UTXRXcGZiSjl0M253SDMzZHJCSG9idEczYmtvN3RmMCtkVENKR1o4R0pRNS9oekFQdksxYgpLMHNqZExKNi9ZY3l1TFI4NDlsUEl6aUtIVFpiZWI4a0ZYR1Fnb0s3QkE4VlBqaHFySnhTVUxHb1YyQkNvZElsCmtqeE5nc29JOW1PTmxsMmh2WTJxYWlrOFMzVnBOc1orNlVjV0lXYk90ekE0ZFJXb3ZISTZZS0xrU3RTMlRoakwKM3lMQUlPM1ZUVlJ5bEptcFVwNFJiMzd5QUVPYlR6VHg2dStURjg2L1p3OEFGM2NGZ1JLdHgxQ0pKMTlOVjZ2NAowZ051ZEhUSXNkZXJSNWViSkhKMTZsY2I2ZGdPOUxxaWlBaXBxQmNPdzB2TXlsalVtZHpQRVN2VXhzbmtaRy9KCmRNbkJGYitOV2owelQ0aGpyLzJCTUZwTTYvcjlMYnpocnVGem5XOTBXb0JEZGRFdnNvVWwrU1lLMWJiUE1yTVIKekovc0pTa2t3eDZ2NUlZc2NmdnFrRllqSS9TaFNHQ0FWMXlXcS9pZ3ptSGg3b2ZLUXVHSHBoWVNVNzlwVTNqagpBRVN4VHhaMDJSTmZNOExRdU42eGl5dWRLbWF0TDBuWlp6VlAySnFSeTNiRGtpTVFhcmJLbzVRZ2JsNk0xSmlwClhVSElPUWFSQytlRU1weGxycWM5cGtaYVVqZEZEUmlEWDBUcHZISWNVaWNuVGxOeTFRMVpHYmczY09SVmo0R2sKZGZmRXdjRHNubWwyZS9oUFJpejZxQTJURGpBb3B6di9MakhZUWZ1U0JVREVwTkpIMytPQUlKcWJFeWpHWFdlQgp5L0dVL0w5OHpPN21mYWlrbG52SW5jR0M2czVtalVNS1JWVW8yaytMdXU2VVV3NkRYa1hjVXhvYzVkemQzNy94CitiNDZJN1YzUXJ5cnI0UWtDb3ZnbHBHVmtBa3lKamVZQnVUckY2MnV4bDlCaTM2MkwrMWdnWjVJZE1IYTErV0wKWGZOZXR6c1FqanFlWlNzdWxsaHRJaWFDMjZ5azQ5NXFHMks0T1N5bDBhbjZQQkdldmtpOE5xTm11UlY3N2M5YwpQM2wvdElJNUlhMllHdFFyNGZHU3BuQ1U5bHIxelRmUzYrZUFPNGxjNk85SXljQnEwU1VNd3IvUDhCTFVOYk96CndrR09NQTB1Vy8zMVR3RllNUE9vY0R6WHF5ejE2NTFUc0dHY0xEWnR5bUx1eEdqTitDbGNMVlN2K0lrMVBRa3gKV2FML2pCVzJCL2g4OXNaY21Zak9PTVQrUVdvTWo2WEtXSWsvNUpEOERpa28rNzA3Cg== network-utils-pod.yaml apiVersion: v1 kind: Pod metadata: name: network-utils spec: containers: - name: network-utils image: amouat/network-utils command: [&#39;sleep&#39;, &#39;10h&#39;] rs-init.js // 1. init replication set rs.initiate( { _id : &quot;rs0&quot;, members: [ { _id : 0, host : &quot;mongodb-0.mongodb&quot; } ] }); // 2. create cluster admin use admin; db.createUser({ user:&quot;admin&quot;, pwd:&quot;admin&quot;, roles: [ {role: &quot;userAdmin&quot;, db:&quot;admin&quot;}, {role: &quot;clusterAdmin&quot;, db: &quot;admin&quot;} ] }); // 3. login with cluster admin user db.auth(&quot;admin&quot;, &quot;admin&quot;); // 3. add slave nodes rs.add(&quot;mongodb-1.mongodb&quot;); rs.add(&quot;mongodb-2.mongodb&quot;); db.runCommand(&#39;isMaster&#39;); // 4. create database user db.createUser({ user: &quot;test&quot;, pwd: &quot;test&quot;, roles: [ { role: &quot;readWriteAnyDatabase&quot;, db: &quot;admin&quot; } ] }); Let’s do IT (0) $ sudo mkdir /tmp/data/db/{0,1,2} -p $ kubectl label no [NODE-0-NAME] node.kubernetes.io/mongodb-data-0-ready=true node/NODE-0-NAME labeled $ kubectl label no [NODE-1-NAME] node.kubernetes.io/mongodb-data-1-ready=true node/NODE-1-NAME labeled $ kubectl label no [NODE-2-NAME] node.kubernetes.io/mongodb-data-2-ready=true node/NODE-2-NAME labeled $ kubectl create -f pvs/ persistentvolume/mongodb-data-0 created persistentvolume/mongodb-data-1 created persistentvolume/mongodb-data-2 created Let’s do IT (1) $ kubectl create -f mongodb-svc.yaml service/mongodb created $ kubectl create -f mongod-keyfile-secret.yaml secret/mongod-keyfile created $ kubectl create -f mongodb-sts.yaml statefulset.apps/mongodb created $ kubectl get po -w NAME READY STATUS RESTARTS AGE mongodb-0 1/1 Running 0 4s mongodb-1 0/1 Pending 0 0s mongodb-1 0/1 Pending 0 1s mongodb-1 0/1 ContainerCreating 0 1s mongodb-1 1/1 Running 0 3s mongodb-2 0/1 Pending 0 0s mongodb-2 0/1 Pending 0 1s mongodb-2 0/1 ContainerCreating 0 1s mongodb-2 1/1 Running 0 3s Let’s do IT (2) $ kubectl get pv,pvc NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/mongodb-data-0 64Mi RWO Retain Bound default/data-mongodb-0 local 70s persistentvolume/mongodb-data-1 64Mi RWO Retain Bound default/data-mongodb-1 local 70s persistentvolume/mongodb-data-2 64Mi RWO Retain Bound default/data-mongodb-2 local 70s NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/data-mongodb-0 Bound mongodb-data-0 64Mi RWO local 43s persistentvolumeclaim/data-mongodb-1 Bound mongodb-data-1 64Mi RWO local 40s persistentvolumeclaim/data-mongodb-2 Bound mongodb-data-2 64Mi RWO local 36s Let’s do IT (3) $ kubectl create -f network-utils-pod.yaml pod/network-utils created $ kubectl exec -it network-utils bash root@network-utils:/# nslookup mongodb-0.mongodbclear Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongodb-0.mongodb.default.svc.cluster.local Address: 10.244.0.136 root@network-utils:/# nslookup mongodb Server: 10.96.0.10 Address: 10.96.0.10#53 Name: mongodb.default.svc.cluster.local Address: 10.244.0.138 Name: mongodb.default.svc.cluster.local Address: 10.244.0.137 Name: mongodb.default.svc.cluster.local Address: 10.244.0.136 Let’s do IT (4) $ kubectl describe po mongodb-0 Volumes: data: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: data-mongodb-0 ReadOnly: false etc-mongod-keyfile: Type: Secret (a volume populated by a Secret) SecretName: mongod-keyfile Optional: false Let’s do IT (5) $ kubectl delete -f mongodb-sts.yaml statefulset.apps &quot;mongodb&quot; deleted $ kubectl get po NAME READY STATUS RESTARTS AGE network-utils 1/1 Running 0 7m4s $ kubectl get pv,pvc NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE persistentvolume/mongodb-data-0 64Mi RWO Retain Bound default/data-mongodb-0 local 11m persistentvolume/mongodb-data-1 64Mi RWO Retain Bound default/data-mongodb-1 local 11m persistentvolume/mongodb-data-2 64Mi RWO Retain Bound default/data-mongodb-2 local 11m NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE persistentvolumeclaim/data-mongodb-0 Bound mongodb-data-0 64Mi RWO local 11m persistentvolumeclaim/data-mongodb-1 Bound mongodb-data-1 64Mi RWO local 11m persistentvolumeclaim/data-mongodb-2 Bound mongodb-data-2 64Mi RWO local 11m Let’s do IT (6) $ kubectl create -f mongodb-sts.yaml statefulset.apps/mongodb created $ kubectl exec -it mongodb-0 bash root@mongodb-0:/# mongo --quiet &gt; rs.initiate( { ... _id : &quot;rs0&quot;, ... members: [ { _id : 0, host : &quot;mongodb-0.mongodb&quot; } ] ... }); { &quot;ok&quot; : 1 } Quit or not quit ? https://kubernetes.io/","headline":"5 - Kubernetes StatefulSet","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2020/02/10/kubernetes-crash-course-5/"},"url":"https://blog.codefarm.me/2020/02/10/kubernetes-crash-course-5/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">5 - Kubernetes StatefulSet</h1><p class="c-post-meta">10 Feb 2020</p>
  </header>

  <div class="c-post-content">
    <ul id="markdown-toc">
  <li><a href="#statefulset" id="markdown-toc-statefulset">StatefulSet</a></li>
  <li><a href="#limitations" id="markdown-toc-limitations">Limitations</a></li>
  <li><a href="#pod-identity" id="markdown-toc-pod-identity">Pod Identity</a></li>
  <li><a href="#pvsmongodb-data-0-pvyaml" id="markdown-toc-pvsmongodb-data-0-pvyaml">pvs/mongodb-data-0-pv.yaml</a></li>
  <li><a href="#pvsmongodb-data-1-pvyaml" id="markdown-toc-pvsmongodb-data-1-pvyaml">pvs/mongodb-data-1-pv.yaml</a></li>
  <li><a href="#pvsmongodb-data-2-pvyaml" id="markdown-toc-pvsmongodb-data-2-pvyaml">pvs/mongodb-data-2-pv.yaml</a></li>
  <li><a href="#mongodb-svcyaml" id="markdown-toc-mongodb-svcyaml">mongodb-svc.yaml</a></li>
  <li><a href="#mongodb-stsyaml-1" id="markdown-toc-mongodb-stsyaml-1">mongodb-sts.yaml (1)</a></li>
  <li><a href="#mongod-keyfile-secretyaml" id="markdown-toc-mongod-keyfile-secretyaml">mongod-keyfile-secret.yaml</a></li>
  <li><a href="#network-utils-podyaml" id="markdown-toc-network-utils-podyaml">network-utils-pod.yaml</a></li>
  <li><a href="#rs-initjs" id="markdown-toc-rs-initjs">rs-init.js</a></li>
  <li><a href="#lets-do-it-0" id="markdown-toc-lets-do-it-0">Let’s do IT (0)</a></li>
  <li><a href="#lets-do-it-1" id="markdown-toc-lets-do-it-1">Let’s do IT (1)</a></li>
  <li><a href="#lets-do-it-2" id="markdown-toc-lets-do-it-2">Let’s do IT (2)</a></li>
  <li><a href="#lets-do-it-3" id="markdown-toc-lets-do-it-3">Let’s do IT (3)</a></li>
  <li><a href="#lets-do-it-4" id="markdown-toc-lets-do-it-4">Let’s do IT (4)</a></li>
  <li><a href="#lets-do-it-5" id="markdown-toc-lets-do-it-5">Let’s do IT (5)</a></li>
  <li><a href="#lets-do-it-6" id="markdown-toc-lets-do-it-6">Let’s do IT (6)</a></li>
  <li><a href="#quit-or-not-quit-" id="markdown-toc-quit-or-not-quit-">Quit or not quit ?</a></li>
</ul>

<hr />

<h3 id="statefulset">StatefulSet</h3>

<ul>
  <li>StatefulSet is the workload API object used to manage stateful applications.</li>
  <li>Like a Deployment , a StatefulSet manages Pods that are based on an identical container spec.</li>
  <li>Unlike a Deployment, a StatefulSet maintains a sticky identity for each of their Pods. These pods are created from the same spec, but are not interchangeable: <strong>each has a persistent identifier that it maintains across any rescheduling</strong>.</li>
  <li>A StatefulSet operates under the same pattern as any other Controller. You define your desired state in a StatefulSet object, and the StatefulSet controller makes any necessary updates to get there from the current state.</li>
  <li>StatefulSets are valuable for applications that require one or more of the following.
    <ul>
      <li>Stable, <strong>unique network identifiers</strong>.</li>
      <li>Stable, <strong>persistent storage</strong>.</li>
      <li>Ordered, graceful deployment and scaling.</li>
      <li>Ordered, automated rolling updates.</li>
    </ul>
  </li>
</ul>

<h3 id="limitations">Limitations</h3>

<ul>
  <li>The storage for a given Pod must either be provisioned by a PersistentVolume Provisioner based on the requested storage class, or pre-provisioned by an admin.</li>
  <li><strong>Deleting and/or scaling a StatefulSet down will not delete the volumes associated with the StatefulSet</strong>. This is done to ensure data safety, which is generally more valuable than an automatic purge of all related StatefulSet resources.</li>
  <li>StatefulSets currently <strong>require a Headless Service</strong> to be responsible for the network identity of the Pods. You are responsible for creating this Service.</li>
  <li>StatefulSets do not provide any guarantees on the termination of pods when a StatefulSet is deleted. To achieve ordered and graceful termination of the pods in the StatefulSet, it is possible to scale the StatefulSet down to 0 prior to deletion.</li>
</ul>

<h3 id="pod-identity">Pod Identity</h3>

<ul>
  <li>StatefulSet Pods have a unique identity that is comprised of an <strong>ordinal</strong>, a <strong>stable network identity</strong>, and <strong>stable storage</strong>. The identity sticks to the Pod, regardless of which node it’s (re)scheduled on.</li>
  <li>For a StatefulSet with N replicas, each Pod in the StatefulSet will be assigned an integer ordinal, <strong>from 0 up through N-1</strong>, that is unique over the Set.</li>
  <li>Each Pod in a StatefulSet derives its hostname from the name of the StatefulSet and the ordinal of the Pod. The pattern for the constructed hostname is <strong>$(statefulset name)-$(ordinal)</strong>.</li>
  <li>A StatefulSet can use a Headless Service to control the domain of its Pods. The domain managed by this Service takes the form: <strong>$(service name).$(namespace).svc.cluster.local</strong>, where “cluster.local” is the cluster domain. As each Pod is created, it gets a matching DNS subdomain, taking the form: <strong>$(podname).$(governing service domain)</strong>, where the governing service is defined by the serviceName field on the StatefulSet.</li>
</ul>

<h3 id="pvsmongodb-data-0-pvyaml">pvs/mongodb-data-0-pv.yaml</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongodb-data-0</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">64Mi</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">local</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/tmp/data/db/0</span>
 <span class="na">nodeAffinity</span><span class="pi">:</span>
    <span class="na">required</span><span class="pi">:</span>
      <span class="na">nodeSelectorTerms</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node.kubernetes.io/mongodb-data-0-ready</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
            <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s2">"</span><span class="s">true"</span>
</code></pre></div></div>

<h3 id="pvsmongodb-data-1-pvyaml">pvs/mongodb-data-1-pv.yaml</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongodb-data-1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">64Mi</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">local</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/tmp/data/db/1</span>
 <span class="na">nodeAffinity</span><span class="pi">:</span>
    <span class="na">required</span><span class="pi">:</span>
      <span class="na">nodeSelectorTerms</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node.kubernetes.io/mongodb-data-1-ready</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
            <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s2">"</span><span class="s">true"</span>
</code></pre></div></div>

<h3 id="pvsmongodb-data-2-pvyaml">pvs/mongodb-data-2-pv.yaml</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongodb-data-2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">local</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">64Mi</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">local</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/tmp/data/db/2</span>
 <span class="na">nodeAffinity</span><span class="pi">:</span>
    <span class="na">required</span><span class="pi">:</span>
      <span class="na">nodeSelectorTerms</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">matchExpressions</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node.kubernetes.io/mongodb-data-2-ready</span>
            <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
            <span class="na">values</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s2">"</span><span class="s">true"</span>
</code></pre></div></div>

<h3 id="mongodb-svcyaml">mongodb-svc.yaml</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongodb</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mongodb</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">27017</span>
</code></pre></div></div>

<h3 id="mongodb-stsyaml-1">mongodb-sts.yaml (1)</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongodb</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">serviceName</span><span class="pi">:</span> <span class="s">mongodb</span>
  <span class="na">volumeClaimTemplates</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">metadata</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
      <span class="na">spec</span><span class="pi">:</span>
        <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">local</span>
        <span class="na">accessModes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">storage</span><span class="pi">:</span> <span class="s">16Mi</span>
 <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mongodb</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">etc-mongod-keyfile</span>
          <span class="na">secret</span><span class="pi">:</span>
            <span class="na">defaultMode</span><span class="pi">:</span> <span class="m">0400</span>
            <span class="na">secretName</span><span class="pi">:</span> <span class="s">mongod-keyfile</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mongo</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">mongo:3.6</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">mongod"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--bind_ip_all"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--auth"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--replSet"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">rs0"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">--keyFile"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/etc/mongod.keyfile"</span><span class="pi">]</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/data/db</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/mongod.keyfile</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">etc-mongod-keyfile</span>
              <span class="na">subPath</span><span class="pi">:</span> <span class="s">mongod.keyfile</span>
</code></pre></div></div>

<h3 id="mongod-keyfile-secretyaml">mongod-keyfile-secret.yaml</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mongod-keyfile</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">mongod.keyfile</span><span class="pi">:</span> <span class="s">QkpTUGEveElKNU9UTXRXcGZiSjl0M253SDMzZHJCSG9idEczYmtvN3RmMCtkVENKR1o4R0pRNS9oekFQdksxYgpLMHNqZExKNi9ZY3l1TFI4NDlsUEl6aUtIVFpiZWI4a0ZYR1Fnb0s3QkE4VlBqaHFySnhTVUxHb1YyQkNvZElsCmtqeE5nc29JOW1PTmxsMmh2WTJxYWlrOFMzVnBOc1orNlVjV0lXYk90ekE0ZFJXb3ZISTZZS0xrU3RTMlRoakwKM3lMQUlPM1ZUVlJ5bEptcFVwNFJiMzd5QUVPYlR6VHg2dStURjg2L1p3OEFGM2NGZ1JLdHgxQ0pKMTlOVjZ2NAowZ051ZEhUSXNkZXJSNWViSkhKMTZsY2I2ZGdPOUxxaWlBaXBxQmNPdzB2TXlsalVtZHpQRVN2VXhzbmtaRy9KCmRNbkJGYitOV2owelQ0aGpyLzJCTUZwTTYvcjlMYnpocnVGem5XOTBXb0JEZGRFdnNvVWwrU1lLMWJiUE1yTVIKekovc0pTa2t3eDZ2NUlZc2NmdnFrRllqSS9TaFNHQ0FWMXlXcS9pZ3ptSGg3b2ZLUXVHSHBoWVNVNzlwVTNqagpBRVN4VHhaMDJSTmZNOExRdU42eGl5dWRLbWF0TDBuWlp6VlAySnFSeTNiRGtpTVFhcmJLbzVRZ2JsNk0xSmlwClhVSElPUWFSQytlRU1weGxycWM5cGtaYVVqZEZEUmlEWDBUcHZISWNVaWNuVGxOeTFRMVpHYmczY09SVmo0R2sKZGZmRXdjRHNubWwyZS9oUFJpejZxQTJURGpBb3B6di9MakhZUWZ1U0JVREVwTkpIMytPQUlKcWJFeWpHWFdlQgp5L0dVL0w5OHpPN21mYWlrbG52SW5jR0M2czVtalVNS1JWVW8yaytMdXU2VVV3NkRYa1hjVXhvYzVkemQzNy94CitiNDZJN1YzUXJ5cnI0UWtDb3ZnbHBHVmtBa3lKamVZQnVUckY2MnV4bDlCaTM2MkwrMWdnWjVJZE1IYTErV0wKWGZOZXR6c1FqanFlWlNzdWxsaHRJaWFDMjZ5azQ5NXFHMks0T1N5bDBhbjZQQkdldmtpOE5xTm11UlY3N2M5YwpQM2wvdElJNUlhMllHdFFyNGZHU3BuQ1U5bHIxelRmUzYrZUFPNGxjNk85SXljQnEwU1VNd3IvUDhCTFVOYk96CndrR09NQTB1Vy8zMVR3RllNUE9vY0R6WHF5ejE2NTFUc0dHY0xEWnR5bUx1eEdqTitDbGNMVlN2K0lrMVBRa3gKV2FML2pCVzJCL2g4OXNaY21Zak9PTVQrUVdvTWo2WEtXSWsvNUpEOERpa28rNzA3Cg==</span>
</code></pre></div></div>

<h3 id="network-utils-podyaml">network-utils-pod.yaml</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">network-utils</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">network-utils</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">amouat/network-utils</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">sleep'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">10h'</span><span class="pi">]</span>
</code></pre></div></div>

<h3 id="rs-initjs">rs-init.js</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. init replication set</span>
<span class="nx">rs</span><span class="p">.</span><span class="nf">initiate</span><span class="p">(</span> <span class="p">{</span>
  <span class="na">_id</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">rs0</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">members</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="na">_id</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">host</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">mongodb-0.mongodb</span><span class="dl">"</span> <span class="p">}</span> <span class="p">]</span>
<span class="p">});</span>
<span class="c1">// 2. create cluster admin</span>
<span class="nx">use</span> <span class="nx">admin</span><span class="p">;</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createUser</span><span class="p">({</span>
  <span class="na">user</span><span class="p">:</span><span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">pwd</span><span class="p">:</span><span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">roles</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">userAdmin</span><span class="dl">"</span><span class="p">,</span> <span class="na">db</span><span class="p">:</span><span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">},</span>
      <span class="p">{</span><span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">clusterAdmin</span><span class="dl">"</span><span class="p">,</span> <span class="na">db</span><span class="p">:</span> <span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">}</span>
  <span class="p">]</span>
<span class="p">});</span>

<span class="c1">// 3. login with cluster admin user</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">auth</span><span class="p">(</span><span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// 3. add slave nodes</span>
<span class="nx">rs</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">mongodb-1.mongodb</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">rs</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">mongodb-2.mongodb</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">runCommand</span><span class="p">(</span><span class="dl">'</span><span class="s1">isMaster</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// 4. create database user</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createUser</span><span class="p">({</span>
    <span class="na">user</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">pwd</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">roles</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">readWriteAnyDatabase</span><span class="dl">"</span><span class="p">,</span> <span class="na">db</span><span class="p">:</span> <span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span> <span class="p">}</span>
    <span class="p">]</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="lets-do-it-0">Let’s do IT (0)</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo mkdir</span> /tmp/data/db/<span class="o">{</span>0,1,2<span class="o">}</span> <span class="nt">-p</span>
<span class="nv">$ </span>kubectl label no <span class="o">[</span>NODE-0-NAME] node.kubernetes.io/mongodb-data-0-ready<span class="o">=</span><span class="nb">true
</span>node/NODE-0-NAME labeled
<span class="nv">$ </span>kubectl label no <span class="o">[</span>NODE-1-NAME] node.kubernetes.io/mongodb-data-1-ready<span class="o">=</span><span class="nb">true
</span>node/NODE-1-NAME labeled
<span class="nv">$ </span>kubectl label no <span class="o">[</span>NODE-2-NAME] node.kubernetes.io/mongodb-data-2-ready<span class="o">=</span><span class="nb">true
</span>node/NODE-2-NAME labeled
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> pvs/
persistentvolume/mongodb-data-0 created
persistentvolume/mongodb-data-1 created
persistentvolume/mongodb-data-2 created
</code></pre></div></div>

<h3 id="lets-do-it-1">Let’s do IT (1)</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> mongodb-svc.yaml 
service/mongodb created
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> mongod-keyfile-secret.yaml 
secret/mongod-keyfile created
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> mongodb-sts.yaml 
statefulset.apps/mongodb created
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get po <span class="nt">-w</span>
NAME        READY   STATUS    RESTARTS   AGE
mongodb-0   1/1     Running   0          4s
mongodb-1   0/1     Pending   0          0s
mongodb-1   0/1     Pending   0          1s
mongodb-1   0/1     ContainerCreating   0          1s
mongodb-1   1/1     Running             0          3s
mongodb-2   0/1     Pending             0          0s
mongodb-2   0/1     Pending             0          1s
mongodb-2   0/1     ContainerCreating   0          1s
mongodb-2   1/1     Running             0          3s
</code></pre></div></div>

<h3 id="lets-do-it-2">Let’s do IT (2)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pv,pvc
NAME                              CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   REASON   AGE
persistentvolume/mongodb-data-0   64Mi       RWO            Retain           Bound    default/data-mongodb-0   <span class="nb">local                   </span>70s
persistentvolume/mongodb-data-1   64Mi       RWO            Retain           Bound    default/data-mongodb-1   <span class="nb">local                   </span>70s
persistentvolume/mongodb-data-2   64Mi       RWO            Retain           Bound    default/data-mongodb-2   <span class="nb">local                   </span>70s

NAME                                   STATUS   VOLUME           CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-mongodb-0   Bound    mongodb-data-0   64Mi       RWO            <span class="nb">local          </span>43s
persistentvolumeclaim/data-mongodb-1   Bound    mongodb-data-1   64Mi       RWO            <span class="nb">local          </span>40s
persistentvolumeclaim/data-mongodb-2   Bound    mongodb-data-2   64Mi       RWO            <span class="nb">local          </span>36s
</code></pre></div></div>

<h3 id="lets-do-it-3">Let’s do IT (3)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> network-utils-pod.yaml 
pod/network-utils created
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> network-utils bash
root@network-utils:/# nslookup mongodb-0.mongodbclear
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   mongodb-0.mongodb.default.svc.cluster.local
Address: 10.244.0.136
root@network-utils:/# nslookup mongodb          
Server:     10.96.0.10
Address:    10.96.0.10#53

Name:   mongodb.default.svc.cluster.local
Address: 10.244.0.138
Name:   mongodb.default.svc.cluster.local
Address: 10.244.0.137
Name:   mongodb.default.svc.cluster.local
Address: 10.244.0.136
</code></pre></div></div>

<h3 id="lets-do-it-4">Let’s do IT (4)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe po mongodb-0
Volumes:
  data:
    Type:       PersistentVolumeClaim <span class="o">(</span>a reference to a PersistentVolumeClaim <span class="k">in </span>the same namespace<span class="o">)</span>
    ClaimName:  data-mongodb-0
    ReadOnly:   <span class="nb">false
  </span>etc-mongod-keyfile:
    Type:        Secret <span class="o">(</span>a volume populated by a Secret<span class="o">)</span>
    SecretName:  mongod-keyfile
    Optional:    <span class="nb">false</span>
</code></pre></div></div>

<h3 id="lets-do-it-5">Let’s do IT (5)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl delete <span class="nt">-f</span> mongodb-sts.yaml 
statefulset.apps <span class="s2">"mongodb"</span> deleted
<span class="nv">$ </span>kubectl get po
NAME            READY   STATUS    RESTARTS   AGE
network-utils   1/1     Running   0          7m4s
<span class="nv">$ </span>kubectl get pv,pvc
NAME                              CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   REASON   AGE
persistentvolume/mongodb-data-0   64Mi       RWO            Retain           Bound    default/data-mongodb-0   <span class="nb">local                   </span>11m
persistentvolume/mongodb-data-1   64Mi       RWO            Retain           Bound    default/data-mongodb-1   <span class="nb">local                   </span>11m
persistentvolume/mongodb-data-2   64Mi       RWO            Retain           Bound    default/data-mongodb-2   <span class="nb">local                   </span>11m

NAME                                   STATUS   VOLUME           CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-mongodb-0   Bound    mongodb-data-0   64Mi       RWO            <span class="nb">local          </span>11m
persistentvolumeclaim/data-mongodb-1   Bound    mongodb-data-1   64Mi       RWO            <span class="nb">local          </span>11m
persistentvolumeclaim/data-mongodb-2   Bound    mongodb-data-2   64Mi       RWO            <span class="nb">local          </span>11m
</code></pre></div></div>

<h3 id="lets-do-it-6">Let’s do IT (6)</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> mongodb-sts.yaml 
statefulset.apps/mongodb created
<span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> mongodb-0 bash
root@mongodb-0:/# mongo <span class="nt">--quiet</span>
<span class="o">&gt;</span> rs.initiate<span class="o">(</span> <span class="o">{</span>
...   _id : <span class="s2">"rs0"</span>,
...   members: <span class="o">[</span> <span class="o">{</span> _id : 0, host : <span class="s2">"mongodb-0.mongodb"</span> <span class="o">}</span> <span class="o">]</span>
... <span class="o">})</span><span class="p">;</span>
<span class="o">{</span> <span class="s2">"ok"</span> : 1 <span class="o">}</span>
</code></pre></div></div>

<h3 id="quit-or-not-quit-">Quit or not quit ?</h3>

<p><a href="https://kubernetes.io/">https://kubernetes.io/</a></p>

<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
