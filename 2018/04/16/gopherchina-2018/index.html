<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>GopherChina 2018 | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="GopherChina 2018" />
<meta property="og:locale" content="en" />
<meta name="description" content="1.1 基于Go构建滴滴核心业务平台的实践 1.2 Go在Grab地理服务中的实践 1.3 Rethinking Errors for Go 2 1.4 Go在区块链的发展和演进 1.5 Badger_ Fast Key-Value DB in Go 1.6 Golang在阿里巴巴调度系统Sigma中的实践 1.7 罗辑思维Go语言微服务改造实践 1.8 Golang打造下一代互联网-IPFS全解析 2.1 Composition In Go 2.3 Bazel build Go 2.4 基于Go-Ethereum构建DPOS机制下的区块链 2.5 深入CGO编程 2.6 Go与虚拟化容器 runV/Kata 2.7 Go toolchain internals and implementation based on arm64 2.8 Go在探探后端的工程实践 1.1 基于Go构建滴滴核心业务平台的实践 # 服务治理 异常定位 日志格式混乱 大量 adaptor 人工配置与分析 处理性能低，资源消耗大 服务串联困难 上下游定位困难 跨业务定位效率低 缺乏服务调用拓扑关系 链路难以分析 日志孤立 性能要素缺失 链路优化 全链路压测 服务迁移 接口一致性兼容/代理/切流(旁路引流/流量切换/线上观察) 日志规范化, 服务日志规范/通信接口规范/日志组件 数据结构化 DLTAG Key/Value 请求串联 TraceId 链路可视化 SpanId 处理统一化, 处理系统/日志统一处理 采集/计算/存储 # GC 对象数量过多，GC 三色算法耗费较多 CPU 减少对象分配？用值类型代替对象类型？ 多用栈，少用堆？Goroutine 拷贝栈扩展？ 1.2 Go在Grab地理服务中的实践 # Nearby Service Node.js + PostGIS R-Tree 空间数据存储 一种平衡树 高频写 触发频繁再平衡 Golang + Geohash + Redis Geohash 一维字符串表示二维坐标数据(wtw6j89guz9y -&gt; [31.292494, 121.533371]) 具有相同前缀的 Geohash 字符串地理位置相近 基于 SortedSet 做 Range 查询 CPU/IO 非常高，内存非常低 不能横向(水平)扩展 Sharding 扩展 司机空间索引 -&gt; Shard -&gt; Node 空间索引 地球平面网格划分 Grid (Shard) 分层Grid (Cell) Shard -&gt; Cell (0,1,2,…N) / Cell -&gt; (LRU Queue) 一致性哈希 Ketema algorithm Replica supported 分布式 最终一致性 AP Serf 基于 Gossip 的 Membership 故障检测 SWIM Scable Weakly-consistent Infection-style process group Memmbership protocol 可扩展性一致性感染型进程组成员协议 Scable 随着结点的增多 故障检测耗时不会大幅度增加 如 heart-beating 机制 消息通信呈指数级 Weakly 在某一时刻不同的结点看到不同的系统状态 最终会收敛到相同的状态 Infection-style Gossip 每个结点持有部分结点信息 每个结点与其子结点交换信息 最终所有结点通过‘八卦’别人的信息获取全局信息 Membership 找到其他网络结点 1.3 Rethinking Errors for Go 2 package main import ( &quot;log&quot; &quot;os&quot; ) func main() { r, err := os.Open(&quot;let.go&quot;) if err != nil { log.Fatalf(&quot;oops: %v&quot;, err) } defer r.Close() } // Output // 2018/04/16 14:19:51 oops: open let.go: no such file or directory # Go 2 Draft handle err { … } defer err { … } try func writeToGS(c net.Context, bkt, dst string, r io.Reader) (err error) { w := client.Bucket(bkt).Object(dst).NewWriter(c) err = errPanicking defer func() { if err != nil { _ = w.CloseWithError(err) } else if err = w.Close(); err != nil { err = fmt.Errorf(&quot;oops: %v&quot;, err) } }() if _, err = io.Copy(w, r); err != nil { return fmt.Errorf(&quot;oops: %v&quot;, err) } return nil } var errPanicking = errors.New(&quot;panicking&quot;) func writeToGS(c context, bkt, dst string, r io.Reader) error { handle err { return errors.Wrap(err) } w := client.Bucket(bkt).Object(dst).NewWriter(c) defer err { try w.CloseWithError(err) } try io.Copy(w, r) return nil } 1.4 Go在区块链的发展和演进 # 区块链是什么 去中心化系统 (多中心化?) 数字化账本 不可篡改 确定性的可复制状态机 # 区块链的特点 去中心化、弱中心化 弱信任、对等的写入权限的数据库 共识信任机制，信任来自规则，非第三方 不可篡改 加密安全、强规则 可编程 匿名性 跨平台 # 区块链开发的特点 分布式 网络编程 多线程 使用大量的算法和数据结构 强规则 密码学 # Go 的优势 部署简单，直接编译成机器码 语言级并发支持 性能高 良好的 C 语言的支持 自动垃圾回收 Go 是工程上设计良好的语言，比如代码风格一致，自带工具链 代码简洁 静态类型 丰富的标准库 跨平台编译 # Go 思维 全面简单 简洁 类型推断 GC 25个 keyword package 正交组合 interface 与其实现之间无显示关联 通过组合架构让程序静态结构 垂直组合 (类型组合, type embedding) 水平组合, 通过 interface 进行组合 偏好并发 goroutines select channels 模块之间解耦 并发锁 消息通信 # 共识协议 POW / POS / DPOS / DBFT / DAG / … 1.5 Badger_ Fast Key-Value DB in Go Cgo is not Go RocksDB / BoltDB LSM trees / B+ trees 1.6 Golang在阿里巴巴调度系统Sigma中的实践 package main import &quot;fmt&quot; func main() { m := map[int][]byte{ 0xc4200761c0: []byte{228, 189, 160, 229, 165, 189, 229, 147, 135}, 0xc4200761c8: []byte{230, 189, 152, 233, 147, 129, 230, 159, 177}, } for _, v := range m { fmt.Printf(&quot;%p -&gt; %s\n&quot;, &amp;v, v) } } // Output 1 // 0xc420090020 -&gt; 潘铁柱 // 0xc420090020 -&gt; 你好哇 // // Output 2 // 0xc420092020 -&gt; 你好哇 // 0xc420092020 -&gt; 潘铁柱 1.7 罗辑思维Go语言微服务改造实践 1.8 Golang打造下一代互联网-IPFS全解析 Code your own blockchain in less than 200 lines of Go! Learn to securely share files on the blockchain with IPFS! 2.1 Composition In Go // Reader is the interface that wraps the basic Read method. type Reader interface { Read(p []byte) (n int, err error) } // Writer is the interface that wraps the basic Write method. type Writer interface { Write(p []byte) (n int, err error) } // ReadWriter is the interface that groups the basic Read and Write methods. type ReadWriter interface { Reader Writer } 2.3 Bazel build Go // https://bazel.build // vgo · golang/go Wiki // golang/dep: Go dependency management tool 2.4 基于Go-Ethereum构建DPOS机制下的区块链 // Ethereum Project # 以太坊技术协议，以太坊客户端 Geth (Go) Parity (Rust) cpp-ethereum (c++) ethereumj (java) # 以太坊核心组件 Solidity, a new language for smart contracts, 智能合约 Web3.js # 以太坊相关工具组 Truffle Metamask mist # 以太坊外部存储 IPFS (Go) Swarm (Go) # 共识机制对比 POW 消耗计算力 出块速度慢，确认慢 TPS 极低，10~20 确认1分支+ DPOS 代理人模式 出块速度快，确认块 TPS 700~1000 平均确认1~3秒 2.5 深入CGO编程 // cgo is not Go | Dave Cheney package main /* #include &lt;stdio.h&gt; static void _(const char* s) { printf(&quot;%s\n&quot;, s); } */ import &quot;C&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) C._(C.CString(string(bytes))) } $ go build -x hello.go WORK=/tmp/go-build276115419 mkdir -p $WORK/b001/ cd /tmp CGO_LDFLAGS=&#39;&quot;-g&quot; &quot;-O2&quot;&#39; /usr/local/go/pkg/tool/linux_amd64/cgo -objdir ./go-build276115419/b001/ -importpath command-line-arguments -- -I ./go-build276115419/b001/ -g -O2 ./hello.go cd $WORK gcc -fno-caret-diagnostics -c -x c - || true gcc -Qunused-arguments -c -x c - || true gcc -fdebug-prefix-map=a=b -c -x c - || true gcc -gno-record-gcc-switches -c -x c - || true cd $WORK/b001 gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x001.o -c _cgo_export.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x002.o -c hello.cgo2.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_cgo_main.o -c _cgo_main.c cd /tmp gcc -I . -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -o ./go-build276115419/b001/_cgo_.o ./go-build276115419/b001/_cgo_main.o ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o -g -O2 /usr/local/go/pkg/tool/linux_amd64/cgo -dynpackage main -dynimport ./go-build276115419/b001/_cgo_.o -dynout ./go-build276115419/b001/_cgo_import.go cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build276115419/b001/_pkg_.a -trimpath ./go-build276115419/b001 -p main -buildid mh6f74THdmFYkLXlaEeI/mh6f74THdmFYkLXlaEeI -goversion go1.10.1 -D _/tmp -importcfg ./go-build276115419/b001/importcfg -pack -c=4 ./go-build276115419/b001/_cgo_gotypes.go ./go-build276115419/b001/hello.cgo1.go ./go-build276115419/b001/_cgo_import.go /usr/local/go/pkg/tool/linux_amd64/pack r ./go-build276115419/b001/_pkg_.a ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o # internal /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/5f/5fbfbbfb3d3561c7d7f9b6eb2595c5b5c662c609289b0928d54557b768cf6c31-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=IDPnrZESvB0RYrGsJZll/mh6f74THdmFYkLXlaEeI/_kgrX-BOL__ZqaG2o79P/IDPnrZESvB0RYrGsJZll -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ 2.6 Go与虚拟化容器 runV/Kata // hyperhq/runv: Hypervisor-based Runtime for OCI # Secure as VM, Fast as Container package main import ( &quot;fmt&quot; ) func main() { arr := []struct{ v int }{{1}, {v: 2}, {3}} for _, e := range arr { e.v++ } fmt.Printf(&quot;%v\n&quot;, arr) for idx := range arr { arr[idx].v++ } fmt.Printf(&quot;%v\n&quot;, arr) } // Output // [{1} {2} {3}] // [{2} {3} {4}] package main import ( &quot;fmt&quot; ) func main() { s0 := []int{1, 2, 3, 4} s1 := s0[:2] // len=2, cap=4, [1, 2] s2 := append(s1, 5) // len=3, cap=4, [1, 2, 5] s3 := append(s1, 6, 7) // len=4, cap=4, [1, 2, 6, 7] s4 := append(s1, 8, 9, 0) // len=5, cap=8, [1, 2, 8, 9, 0] fmt.Println(s0) fmt.Println(s1) fmt.Println(s2) fmt.Println(s3) fmt.Println(s4) } // Output // [1 2 6 7] // [1 2] // [1 2 6] // [1 2 6 7] // [1 2 8 9 0] 2.7 Go toolchain internals and implementation based on arm64 // How does the go build command work ? | Dave Cheney # Go toolchain overview A toolchain is a package composed of the compiler and ancillary tools, libraries and runtime for a language which together allow you to build and run code written in that language. gc: evolved from the Plan 9 toolchain and includes its own compiler, assembler, linker and tools, as well as the Go runtime and standard library. gccgo: extends the gcc project to support Go. llgo: built on top of the LLVM compiler infrastructure. # Go toolchain example package main import &quot;fmt&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) fmt.Printf(&quot;%s\n&quot;, bytes) } $ go build -x hello.go WORK=/tmp/go-build173481643 mkdir -p $WORK/b001/ cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF cd /tmp /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build173481643/b001/_pkg_.a -trimpath ./go-build173481643/b001 -p main -complete -buildid 8sirXYvMbbfw92k19xYW/8sirXYvMbbfw92k19xYW -goversion go1.10.1 -D _/tmp -importcfg ./go-build173481643/b001/importcfg -pack -c=4 ./hello.go /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/30/30c2c39b4791f0cd3ff6f312df7ef17888d3eb206e0c11fac21287cff9e0cf3b-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile errors=/usr/local/go/pkg/linux_amd64/errors.a packagefile io=/usr/local/go/pkg/linux_amd64/io.a packagefile math=/usr/local/go/pkg/linux_amd64/math.a packagefile os=/usr/local/go/pkg/linux_amd64/os.a packagefile reflect=/usr/local/go/pkg/linux_amd64/reflect.a packagefile strconv=/usr/local/go/pkg/linux_amd64/strconv.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile unicode/utf8=/usr/local/go/pkg/linux_amd64/unicode/utf8.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a packagefile internal/cpu=/usr/local/go/pkg/linux_amd64/internal/cpu.a packagefile internal/poll=/usr/local/go/pkg/linux_amd64/internal/poll.a packagefile internal/testlog=/usr/local/go/pkg/linux_amd64/internal/testlog.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile time=/usr/local/go/pkg/linux_amd64/time.a packagefile unicode=/usr/local/go/pkg/linux_amd64/unicode.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=Vbu61g9AuYzF2ufqINOR/8sirXYvMbbfw92k19xYW/iWFW984BSmpZp9MnLdjK/Vbu61g9AuYzF2ufqINOR -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ package main /* #include &lt;stdio.h&gt; static void _(const char* s) { printf(&quot;%s\n&quot;, s); } */ import &quot;C&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) C._(C.CString(string(bytes))) } $ go build -x hello.go WORK=/tmp/go-build142064459 mkdir -p $WORK/b001/ cd /tmp CGO_LDFLAGS=&#39;&quot;-g&quot; &quot;-O2&quot;&#39; /usr/local/go/pkg/tool/linux_amd64/cgo -objdir ./go-build142064459/b001/ -importpath command-line-arguments -- -I ./go-build142064459/b001/ -g -O2 ./hello.go cd $WORK gcc -fno-caret-diagnostics -c -x c - || true gcc -Qunused-arguments -c -x c - || true gcc -fdebug-prefix-map=a=b -c -x c - || true gcc -gno-record-gcc-switches -c -x c - || true cd $WORK/b001 gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x001.o -c _cgo_export.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x002.o -c hello.cgo2.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_cgo_main.o -c _cgo_main.c cd /tmp gcc -I . -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -o ./go-build142064459/b001/_cgo_.o ./go-build142064459/b001/_cgo_main.o ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o -g -O2 /usr/local/go/pkg/tool/linux_amd64/cgo -dynpackage main -dynimport ./go-build142064459/b001/_cgo_.o -dynout ./go-build142064459/b001/_cgo_import.go cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build142064459/b001/_pkg_.a -trimpath ./go-build142064459/b001 -p main -buildid WZbBGQxOraNbiT0WofcS/WZbBGQxOraNbiT0WofcS -goversion go1.10.1 -D _/tmp -importcfg ./go-build142064459/b001/importcfg -pack -c=4 ./go-build142064459/b001/_cgo_gotypes.go ./go-build142064459/b001/hello.cgo1.go ./go-build142064459/b001/_cgo_import.go /usr/local/go/pkg/tool/linux_amd64/pack r ./go-build142064459/b001/_pkg_.a ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o # internal /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/5b/5bedc3923cfc8c06c00e1d8446bf5dd68c35f112d221a1589a8e4ec2fa4b9b11-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=4aUladWsuR7j-eqT9vPE/WZbBGQxOraNbiT0WofcS/8tvmjI0-hde6HLKu2J8F/4aUladWsuR7j-eqT9vPE -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ # Go toolchian overflow $ go tool addr2line asm buildid cgo compile cover dist doc fix link nm objdump pack pprof test2json tour trace vet *.go – compile –&gt; $WORK/b001/pkg.a *.s – asm –&gt; *.o – pack –&gt; runtime=$WORK/b002/pkg.a internal/bytealg=$WORK/b003/pkg.a . . . *.a – link –&gt; hello 2.8 Go在探探后端的工程实践" />
<meta property="og:description" content="1.1 基于Go构建滴滴核心业务平台的实践 1.2 Go在Grab地理服务中的实践 1.3 Rethinking Errors for Go 2 1.4 Go在区块链的发展和演进 1.5 Badger_ Fast Key-Value DB in Go 1.6 Golang在阿里巴巴调度系统Sigma中的实践 1.7 罗辑思维Go语言微服务改造实践 1.8 Golang打造下一代互联网-IPFS全解析 2.1 Composition In Go 2.3 Bazel build Go 2.4 基于Go-Ethereum构建DPOS机制下的区块链 2.5 深入CGO编程 2.6 Go与虚拟化容器 runV/Kata 2.7 Go toolchain internals and implementation based on arm64 2.8 Go在探探后端的工程实践 1.1 基于Go构建滴滴核心业务平台的实践 # 服务治理 异常定位 日志格式混乱 大量 adaptor 人工配置与分析 处理性能低，资源消耗大 服务串联困难 上下游定位困难 跨业务定位效率低 缺乏服务调用拓扑关系 链路难以分析 日志孤立 性能要素缺失 链路优化 全链路压测 服务迁移 接口一致性兼容/代理/切流(旁路引流/流量切换/线上观察) 日志规范化, 服务日志规范/通信接口规范/日志组件 数据结构化 DLTAG Key/Value 请求串联 TraceId 链路可视化 SpanId 处理统一化, 处理系统/日志统一处理 采集/计算/存储 # GC 对象数量过多，GC 三色算法耗费较多 CPU 减少对象分配？用值类型代替对象类型？ 多用栈，少用堆？Goroutine 拷贝栈扩展？ 1.2 Go在Grab地理服务中的实践 # Nearby Service Node.js + PostGIS R-Tree 空间数据存储 一种平衡树 高频写 触发频繁再平衡 Golang + Geohash + Redis Geohash 一维字符串表示二维坐标数据(wtw6j89guz9y -&gt; [31.292494, 121.533371]) 具有相同前缀的 Geohash 字符串地理位置相近 基于 SortedSet 做 Range 查询 CPU/IO 非常高，内存非常低 不能横向(水平)扩展 Sharding 扩展 司机空间索引 -&gt; Shard -&gt; Node 空间索引 地球平面网格划分 Grid (Shard) 分层Grid (Cell) Shard -&gt; Cell (0,1,2,…N) / Cell -&gt; (LRU Queue) 一致性哈希 Ketema algorithm Replica supported 分布式 最终一致性 AP Serf 基于 Gossip 的 Membership 故障检测 SWIM Scable Weakly-consistent Infection-style process group Memmbership protocol 可扩展性一致性感染型进程组成员协议 Scable 随着结点的增多 故障检测耗时不会大幅度增加 如 heart-beating 机制 消息通信呈指数级 Weakly 在某一时刻不同的结点看到不同的系统状态 最终会收敛到相同的状态 Infection-style Gossip 每个结点持有部分结点信息 每个结点与其子结点交换信息 最终所有结点通过‘八卦’别人的信息获取全局信息 Membership 找到其他网络结点 1.3 Rethinking Errors for Go 2 package main import ( &quot;log&quot; &quot;os&quot; ) func main() { r, err := os.Open(&quot;let.go&quot;) if err != nil { log.Fatalf(&quot;oops: %v&quot;, err) } defer r.Close() } // Output // 2018/04/16 14:19:51 oops: open let.go: no such file or directory # Go 2 Draft handle err { … } defer err { … } try func writeToGS(c net.Context, bkt, dst string, r io.Reader) (err error) { w := client.Bucket(bkt).Object(dst).NewWriter(c) err = errPanicking defer func() { if err != nil { _ = w.CloseWithError(err) } else if err = w.Close(); err != nil { err = fmt.Errorf(&quot;oops: %v&quot;, err) } }() if _, err = io.Copy(w, r); err != nil { return fmt.Errorf(&quot;oops: %v&quot;, err) } return nil } var errPanicking = errors.New(&quot;panicking&quot;) func writeToGS(c context, bkt, dst string, r io.Reader) error { handle err { return errors.Wrap(err) } w := client.Bucket(bkt).Object(dst).NewWriter(c) defer err { try w.CloseWithError(err) } try io.Copy(w, r) return nil } 1.4 Go在区块链的发展和演进 # 区块链是什么 去中心化系统 (多中心化?) 数字化账本 不可篡改 确定性的可复制状态机 # 区块链的特点 去中心化、弱中心化 弱信任、对等的写入权限的数据库 共识信任机制，信任来自规则，非第三方 不可篡改 加密安全、强规则 可编程 匿名性 跨平台 # 区块链开发的特点 分布式 网络编程 多线程 使用大量的算法和数据结构 强规则 密码学 # Go 的优势 部署简单，直接编译成机器码 语言级并发支持 性能高 良好的 C 语言的支持 自动垃圾回收 Go 是工程上设计良好的语言，比如代码风格一致，自带工具链 代码简洁 静态类型 丰富的标准库 跨平台编译 # Go 思维 全面简单 简洁 类型推断 GC 25个 keyword package 正交组合 interface 与其实现之间无显示关联 通过组合架构让程序静态结构 垂直组合 (类型组合, type embedding) 水平组合, 通过 interface 进行组合 偏好并发 goroutines select channels 模块之间解耦 并发锁 消息通信 # 共识协议 POW / POS / DPOS / DBFT / DAG / … 1.5 Badger_ Fast Key-Value DB in Go Cgo is not Go RocksDB / BoltDB LSM trees / B+ trees 1.6 Golang在阿里巴巴调度系统Sigma中的实践 package main import &quot;fmt&quot; func main() { m := map[int][]byte{ 0xc4200761c0: []byte{228, 189, 160, 229, 165, 189, 229, 147, 135}, 0xc4200761c8: []byte{230, 189, 152, 233, 147, 129, 230, 159, 177}, } for _, v := range m { fmt.Printf(&quot;%p -&gt; %s\n&quot;, &amp;v, v) } } // Output 1 // 0xc420090020 -&gt; 潘铁柱 // 0xc420090020 -&gt; 你好哇 // // Output 2 // 0xc420092020 -&gt; 你好哇 // 0xc420092020 -&gt; 潘铁柱 1.7 罗辑思维Go语言微服务改造实践 1.8 Golang打造下一代互联网-IPFS全解析 Code your own blockchain in less than 200 lines of Go! Learn to securely share files on the blockchain with IPFS! 2.1 Composition In Go // Reader is the interface that wraps the basic Read method. type Reader interface { Read(p []byte) (n int, err error) } // Writer is the interface that wraps the basic Write method. type Writer interface { Write(p []byte) (n int, err error) } // ReadWriter is the interface that groups the basic Read and Write methods. type ReadWriter interface { Reader Writer } 2.3 Bazel build Go // https://bazel.build // vgo · golang/go Wiki // golang/dep: Go dependency management tool 2.4 基于Go-Ethereum构建DPOS机制下的区块链 // Ethereum Project # 以太坊技术协议，以太坊客户端 Geth (Go) Parity (Rust) cpp-ethereum (c++) ethereumj (java) # 以太坊核心组件 Solidity, a new language for smart contracts, 智能合约 Web3.js # 以太坊相关工具组 Truffle Metamask mist # 以太坊外部存储 IPFS (Go) Swarm (Go) # 共识机制对比 POW 消耗计算力 出块速度慢，确认慢 TPS 极低，10~20 确认1分支+ DPOS 代理人模式 出块速度快，确认块 TPS 700~1000 平均确认1~3秒 2.5 深入CGO编程 // cgo is not Go | Dave Cheney package main /* #include &lt;stdio.h&gt; static void _(const char* s) { printf(&quot;%s\n&quot;, s); } */ import &quot;C&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) C._(C.CString(string(bytes))) } $ go build -x hello.go WORK=/tmp/go-build276115419 mkdir -p $WORK/b001/ cd /tmp CGO_LDFLAGS=&#39;&quot;-g&quot; &quot;-O2&quot;&#39; /usr/local/go/pkg/tool/linux_amd64/cgo -objdir ./go-build276115419/b001/ -importpath command-line-arguments -- -I ./go-build276115419/b001/ -g -O2 ./hello.go cd $WORK gcc -fno-caret-diagnostics -c -x c - || true gcc -Qunused-arguments -c -x c - || true gcc -fdebug-prefix-map=a=b -c -x c - || true gcc -gno-record-gcc-switches -c -x c - || true cd $WORK/b001 gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x001.o -c _cgo_export.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x002.o -c hello.cgo2.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_cgo_main.o -c _cgo_main.c cd /tmp gcc -I . -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -o ./go-build276115419/b001/_cgo_.o ./go-build276115419/b001/_cgo_main.o ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o -g -O2 /usr/local/go/pkg/tool/linux_amd64/cgo -dynpackage main -dynimport ./go-build276115419/b001/_cgo_.o -dynout ./go-build276115419/b001/_cgo_import.go cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build276115419/b001/_pkg_.a -trimpath ./go-build276115419/b001 -p main -buildid mh6f74THdmFYkLXlaEeI/mh6f74THdmFYkLXlaEeI -goversion go1.10.1 -D _/tmp -importcfg ./go-build276115419/b001/importcfg -pack -c=4 ./go-build276115419/b001/_cgo_gotypes.go ./go-build276115419/b001/hello.cgo1.go ./go-build276115419/b001/_cgo_import.go /usr/local/go/pkg/tool/linux_amd64/pack r ./go-build276115419/b001/_pkg_.a ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o # internal /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/5f/5fbfbbfb3d3561c7d7f9b6eb2595c5b5c662c609289b0928d54557b768cf6c31-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=IDPnrZESvB0RYrGsJZll/mh6f74THdmFYkLXlaEeI/_kgrX-BOL__ZqaG2o79P/IDPnrZESvB0RYrGsJZll -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ 2.6 Go与虚拟化容器 runV/Kata // hyperhq/runv: Hypervisor-based Runtime for OCI # Secure as VM, Fast as Container package main import ( &quot;fmt&quot; ) func main() { arr := []struct{ v int }{{1}, {v: 2}, {3}} for _, e := range arr { e.v++ } fmt.Printf(&quot;%v\n&quot;, arr) for idx := range arr { arr[idx].v++ } fmt.Printf(&quot;%v\n&quot;, arr) } // Output // [{1} {2} {3}] // [{2} {3} {4}] package main import ( &quot;fmt&quot; ) func main() { s0 := []int{1, 2, 3, 4} s1 := s0[:2] // len=2, cap=4, [1, 2] s2 := append(s1, 5) // len=3, cap=4, [1, 2, 5] s3 := append(s1, 6, 7) // len=4, cap=4, [1, 2, 6, 7] s4 := append(s1, 8, 9, 0) // len=5, cap=8, [1, 2, 8, 9, 0] fmt.Println(s0) fmt.Println(s1) fmt.Println(s2) fmt.Println(s3) fmt.Println(s4) } // Output // [1 2 6 7] // [1 2] // [1 2 6] // [1 2 6 7] // [1 2 8 9 0] 2.7 Go toolchain internals and implementation based on arm64 // How does the go build command work ? | Dave Cheney # Go toolchain overview A toolchain is a package composed of the compiler and ancillary tools, libraries and runtime for a language which together allow you to build and run code written in that language. gc: evolved from the Plan 9 toolchain and includes its own compiler, assembler, linker and tools, as well as the Go runtime and standard library. gccgo: extends the gcc project to support Go. llgo: built on top of the LLVM compiler infrastructure. # Go toolchain example package main import &quot;fmt&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) fmt.Printf(&quot;%s\n&quot;, bytes) } $ go build -x hello.go WORK=/tmp/go-build173481643 mkdir -p $WORK/b001/ cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF cd /tmp /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build173481643/b001/_pkg_.a -trimpath ./go-build173481643/b001 -p main -complete -buildid 8sirXYvMbbfw92k19xYW/8sirXYvMbbfw92k19xYW -goversion go1.10.1 -D _/tmp -importcfg ./go-build173481643/b001/importcfg -pack -c=4 ./hello.go /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/30/30c2c39b4791f0cd3ff6f312df7ef17888d3eb206e0c11fac21287cff9e0cf3b-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile errors=/usr/local/go/pkg/linux_amd64/errors.a packagefile io=/usr/local/go/pkg/linux_amd64/io.a packagefile math=/usr/local/go/pkg/linux_amd64/math.a packagefile os=/usr/local/go/pkg/linux_amd64/os.a packagefile reflect=/usr/local/go/pkg/linux_amd64/reflect.a packagefile strconv=/usr/local/go/pkg/linux_amd64/strconv.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile unicode/utf8=/usr/local/go/pkg/linux_amd64/unicode/utf8.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a packagefile internal/cpu=/usr/local/go/pkg/linux_amd64/internal/cpu.a packagefile internal/poll=/usr/local/go/pkg/linux_amd64/internal/poll.a packagefile internal/testlog=/usr/local/go/pkg/linux_amd64/internal/testlog.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile time=/usr/local/go/pkg/linux_amd64/time.a packagefile unicode=/usr/local/go/pkg/linux_amd64/unicode.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=Vbu61g9AuYzF2ufqINOR/8sirXYvMbbfw92k19xYW/iWFW984BSmpZp9MnLdjK/Vbu61g9AuYzF2ufqINOR -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ package main /* #include &lt;stdio.h&gt; static void _(const char* s) { printf(&quot;%s\n&quot;, s); } */ import &quot;C&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) C._(C.CString(string(bytes))) } $ go build -x hello.go WORK=/tmp/go-build142064459 mkdir -p $WORK/b001/ cd /tmp CGO_LDFLAGS=&#39;&quot;-g&quot; &quot;-O2&quot;&#39; /usr/local/go/pkg/tool/linux_amd64/cgo -objdir ./go-build142064459/b001/ -importpath command-line-arguments -- -I ./go-build142064459/b001/ -g -O2 ./hello.go cd $WORK gcc -fno-caret-diagnostics -c -x c - || true gcc -Qunused-arguments -c -x c - || true gcc -fdebug-prefix-map=a=b -c -x c - || true gcc -gno-record-gcc-switches -c -x c - || true cd $WORK/b001 gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x001.o -c _cgo_export.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x002.o -c hello.cgo2.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_cgo_main.o -c _cgo_main.c cd /tmp gcc -I . -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -o ./go-build142064459/b001/_cgo_.o ./go-build142064459/b001/_cgo_main.o ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o -g -O2 /usr/local/go/pkg/tool/linux_amd64/cgo -dynpackage main -dynimport ./go-build142064459/b001/_cgo_.o -dynout ./go-build142064459/b001/_cgo_import.go cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build142064459/b001/_pkg_.a -trimpath ./go-build142064459/b001 -p main -buildid WZbBGQxOraNbiT0WofcS/WZbBGQxOraNbiT0WofcS -goversion go1.10.1 -D _/tmp -importcfg ./go-build142064459/b001/importcfg -pack -c=4 ./go-build142064459/b001/_cgo_gotypes.go ./go-build142064459/b001/hello.cgo1.go ./go-build142064459/b001/_cgo_import.go /usr/local/go/pkg/tool/linux_amd64/pack r ./go-build142064459/b001/_pkg_.a ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o # internal /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/5b/5bedc3923cfc8c06c00e1d8446bf5dd68c35f112d221a1589a8e4ec2fa4b9b11-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=4aUladWsuR7j-eqT9vPE/WZbBGQxOraNbiT0WofcS/8tvmjI0-hde6HLKu2J8F/4aUladWsuR7j-eqT9vPE -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ # Go toolchian overflow $ go tool addr2line asm buildid cgo compile cover dist doc fix link nm objdump pack pprof test2json tour trace vet *.go – compile –&gt; $WORK/b001/pkg.a *.s – asm –&gt; *.o – pack –&gt; runtime=$WORK/b002/pkg.a internal/bytealg=$WORK/b003/pkg.a . . . *.a – link –&gt; hello 2.8 Go在探探后端的工程实践" />
<link rel="canonical" href="https://blog.codefarm.me/2018/04/16/gopherchina-2018/" />
<meta property="og:url" content="https://blog.codefarm.me/2018/04/16/gopherchina-2018/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-16T11:03:16+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="GopherChina 2018" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2018-04-16T11:03:16+08:00","datePublished":"2018-04-16T11:03:16+08:00","description":"1.1 基于Go构建滴滴核心业务平台的实践 1.2 Go在Grab地理服务中的实践 1.3 Rethinking Errors for Go 2 1.4 Go在区块链的发展和演进 1.5 Badger_ Fast Key-Value DB in Go 1.6 Golang在阿里巴巴调度系统Sigma中的实践 1.7 罗辑思维Go语言微服务改造实践 1.8 Golang打造下一代互联网-IPFS全解析 2.1 Composition In Go 2.3 Bazel build Go 2.4 基于Go-Ethereum构建DPOS机制下的区块链 2.5 深入CGO编程 2.6 Go与虚拟化容器 runV/Kata 2.7 Go toolchain internals and implementation based on arm64 2.8 Go在探探后端的工程实践 1.1 基于Go构建滴滴核心业务平台的实践 # 服务治理 异常定位 日志格式混乱 大量 adaptor 人工配置与分析 处理性能低，资源消耗大 服务串联困难 上下游定位困难 跨业务定位效率低 缺乏服务调用拓扑关系 链路难以分析 日志孤立 性能要素缺失 链路优化 全链路压测 服务迁移 接口一致性兼容/代理/切流(旁路引流/流量切换/线上观察) 日志规范化, 服务日志规范/通信接口规范/日志组件 数据结构化 DLTAG Key/Value 请求串联 TraceId 链路可视化 SpanId 处理统一化, 处理系统/日志统一处理 采集/计算/存储 # GC 对象数量过多，GC 三色算法耗费较多 CPU 减少对象分配？用值类型代替对象类型？ 多用栈，少用堆？Goroutine 拷贝栈扩展？ 1.2 Go在Grab地理服务中的实践 # Nearby Service Node.js + PostGIS R-Tree 空间数据存储 一种平衡树 高频写 触发频繁再平衡 Golang + Geohash + Redis Geohash 一维字符串表示二维坐标数据(wtw6j89guz9y -&gt; [31.292494, 121.533371]) 具有相同前缀的 Geohash 字符串地理位置相近 基于 SortedSet 做 Range 查询 CPU/IO 非常高，内存非常低 不能横向(水平)扩展 Sharding 扩展 司机空间索引 -&gt; Shard -&gt; Node 空间索引 地球平面网格划分 Grid (Shard) 分层Grid (Cell) Shard -&gt; Cell (0,1,2,…N) / Cell -&gt; (LRU Queue) 一致性哈希 Ketema algorithm Replica supported 分布式 最终一致性 AP Serf 基于 Gossip 的 Membership 故障检测 SWIM Scable Weakly-consistent Infection-style process group Memmbership protocol 可扩展性一致性感染型进程组成员协议 Scable 随着结点的增多 故障检测耗时不会大幅度增加 如 heart-beating 机制 消息通信呈指数级 Weakly 在某一时刻不同的结点看到不同的系统状态 最终会收敛到相同的状态 Infection-style Gossip 每个结点持有部分结点信息 每个结点与其子结点交换信息 最终所有结点通过‘八卦’别人的信息获取全局信息 Membership 找到其他网络结点 1.3 Rethinking Errors for Go 2 package main import ( &quot;log&quot; &quot;os&quot; ) func main() { r, err := os.Open(&quot;let.go&quot;) if err != nil { log.Fatalf(&quot;oops: %v&quot;, err) } defer r.Close() } // Output // 2018/04/16 14:19:51 oops: open let.go: no such file or directory # Go 2 Draft handle err { … } defer err { … } try func writeToGS(c net.Context, bkt, dst string, r io.Reader) (err error) { w := client.Bucket(bkt).Object(dst).NewWriter(c) err = errPanicking defer func() { if err != nil { _ = w.CloseWithError(err) } else if err = w.Close(); err != nil { err = fmt.Errorf(&quot;oops: %v&quot;, err) } }() if _, err = io.Copy(w, r); err != nil { return fmt.Errorf(&quot;oops: %v&quot;, err) } return nil } var errPanicking = errors.New(&quot;panicking&quot;) func writeToGS(c context, bkt, dst string, r io.Reader) error { handle err { return errors.Wrap(err) } w := client.Bucket(bkt).Object(dst).NewWriter(c) defer err { try w.CloseWithError(err) } try io.Copy(w, r) return nil } 1.4 Go在区块链的发展和演进 # 区块链是什么 去中心化系统 (多中心化?) 数字化账本 不可篡改 确定性的可复制状态机 # 区块链的特点 去中心化、弱中心化 弱信任、对等的写入权限的数据库 共识信任机制，信任来自规则，非第三方 不可篡改 加密安全、强规则 可编程 匿名性 跨平台 # 区块链开发的特点 分布式 网络编程 多线程 使用大量的算法和数据结构 强规则 密码学 # Go 的优势 部署简单，直接编译成机器码 语言级并发支持 性能高 良好的 C 语言的支持 自动垃圾回收 Go 是工程上设计良好的语言，比如代码风格一致，自带工具链 代码简洁 静态类型 丰富的标准库 跨平台编译 # Go 思维 全面简单 简洁 类型推断 GC 25个 keyword package 正交组合 interface 与其实现之间无显示关联 通过组合架构让程序静态结构 垂直组合 (类型组合, type embedding) 水平组合, 通过 interface 进行组合 偏好并发 goroutines select channels 模块之间解耦 并发锁 消息通信 # 共识协议 POW / POS / DPOS / DBFT / DAG / … 1.5 Badger_ Fast Key-Value DB in Go Cgo is not Go RocksDB / BoltDB LSM trees / B+ trees 1.6 Golang在阿里巴巴调度系统Sigma中的实践 package main import &quot;fmt&quot; func main() { m := map[int][]byte{ 0xc4200761c0: []byte{228, 189, 160, 229, 165, 189, 229, 147, 135}, 0xc4200761c8: []byte{230, 189, 152, 233, 147, 129, 230, 159, 177}, } for _, v := range m { fmt.Printf(&quot;%p -&gt; %s\\n&quot;, &amp;v, v) } } // Output 1 // 0xc420090020 -&gt; 潘铁柱 // 0xc420090020 -&gt; 你好哇 // // Output 2 // 0xc420092020 -&gt; 你好哇 // 0xc420092020 -&gt; 潘铁柱 1.7 罗辑思维Go语言微服务改造实践 1.8 Golang打造下一代互联网-IPFS全解析 Code your own blockchain in less than 200 lines of Go! Learn to securely share files on the blockchain with IPFS! 2.1 Composition In Go // Reader is the interface that wraps the basic Read method. type Reader interface { Read(p []byte) (n int, err error) } // Writer is the interface that wraps the basic Write method. type Writer interface { Write(p []byte) (n int, err error) } // ReadWriter is the interface that groups the basic Read and Write methods. type ReadWriter interface { Reader Writer } 2.3 Bazel build Go // https://bazel.build // vgo · golang/go Wiki // golang/dep: Go dependency management tool 2.4 基于Go-Ethereum构建DPOS机制下的区块链 // Ethereum Project # 以太坊技术协议，以太坊客户端 Geth (Go) Parity (Rust) cpp-ethereum (c++) ethereumj (java) # 以太坊核心组件 Solidity, a new language for smart contracts, 智能合约 Web3.js # 以太坊相关工具组 Truffle Metamask mist # 以太坊外部存储 IPFS (Go) Swarm (Go) # 共识机制对比 POW 消耗计算力 出块速度慢，确认慢 TPS 极低，10~20 确认1分支+ DPOS 代理人模式 出块速度快，确认块 TPS 700~1000 平均确认1~3秒 2.5 深入CGO编程 // cgo is not Go | Dave Cheney package main /* #include &lt;stdio.h&gt; static void _(const char* s) { printf(&quot;%s\\n&quot;, s); } */ import &quot;C&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) C._(C.CString(string(bytes))) } $ go build -x hello.go WORK=/tmp/go-build276115419 mkdir -p $WORK/b001/ cd /tmp CGO_LDFLAGS=&#39;&quot;-g&quot; &quot;-O2&quot;&#39; /usr/local/go/pkg/tool/linux_amd64/cgo -objdir ./go-build276115419/b001/ -importpath command-line-arguments -- -I ./go-build276115419/b001/ -g -O2 ./hello.go cd $WORK gcc -fno-caret-diagnostics -c -x c - || true gcc -Qunused-arguments -c -x c - || true gcc -fdebug-prefix-map=a=b -c -x c - || true gcc -gno-record-gcc-switches -c -x c - || true cd $WORK/b001 gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x001.o -c _cgo_export.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x002.o -c hello.cgo2.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_cgo_main.o -c _cgo_main.c cd /tmp gcc -I . -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -o ./go-build276115419/b001/_cgo_.o ./go-build276115419/b001/_cgo_main.o ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o -g -O2 /usr/local/go/pkg/tool/linux_amd64/cgo -dynpackage main -dynimport ./go-build276115419/b001/_cgo_.o -dynout ./go-build276115419/b001/_cgo_import.go cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build276115419/b001/_pkg_.a -trimpath ./go-build276115419/b001 -p main -buildid mh6f74THdmFYkLXlaEeI/mh6f74THdmFYkLXlaEeI -goversion go1.10.1 -D _/tmp -importcfg ./go-build276115419/b001/importcfg -pack -c=4 ./go-build276115419/b001/_cgo_gotypes.go ./go-build276115419/b001/hello.cgo1.go ./go-build276115419/b001/_cgo_import.go /usr/local/go/pkg/tool/linux_amd64/pack r ./go-build276115419/b001/_pkg_.a ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o # internal /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/5f/5fbfbbfb3d3561c7d7f9b6eb2595c5b5c662c609289b0928d54557b768cf6c31-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=IDPnrZESvB0RYrGsJZll/mh6f74THdmFYkLXlaEeI/_kgrX-BOL__ZqaG2o79P/IDPnrZESvB0RYrGsJZll -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ 2.6 Go与虚拟化容器 runV/Kata // hyperhq/runv: Hypervisor-based Runtime for OCI # Secure as VM, Fast as Container package main import ( &quot;fmt&quot; ) func main() { arr := []struct{ v int }{{1}, {v: 2}, {3}} for _, e := range arr { e.v++ } fmt.Printf(&quot;%v\\n&quot;, arr) for idx := range arr { arr[idx].v++ } fmt.Printf(&quot;%v\\n&quot;, arr) } // Output // [{1} {2} {3}] // [{2} {3} {4}] package main import ( &quot;fmt&quot; ) func main() { s0 := []int{1, 2, 3, 4} s1 := s0[:2] // len=2, cap=4, [1, 2] s2 := append(s1, 5) // len=3, cap=4, [1, 2, 5] s3 := append(s1, 6, 7) // len=4, cap=4, [1, 2, 6, 7] s4 := append(s1, 8, 9, 0) // len=5, cap=8, [1, 2, 8, 9, 0] fmt.Println(s0) fmt.Println(s1) fmt.Println(s2) fmt.Println(s3) fmt.Println(s4) } // Output // [1 2 6 7] // [1 2] // [1 2 6] // [1 2 6 7] // [1 2 8 9 0] 2.7 Go toolchain internals and implementation based on arm64 // How does the go build command work ? | Dave Cheney # Go toolchain overview A toolchain is a package composed of the compiler and ancillary tools, libraries and runtime for a language which together allow you to build and run code written in that language. gc: evolved from the Plan 9 toolchain and includes its own compiler, assembler, linker and tools, as well as the Go runtime and standard library. gccgo: extends the gcc project to support Go. llgo: built on top of the LLVM compiler infrastructure. # Go toolchain example package main import &quot;fmt&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) fmt.Printf(&quot;%s\\n&quot;, bytes) } $ go build -x hello.go WORK=/tmp/go-build173481643 mkdir -p $WORK/b001/ cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF cd /tmp /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build173481643/b001/_pkg_.a -trimpath ./go-build173481643/b001 -p main -complete -buildid 8sirXYvMbbfw92k19xYW/8sirXYvMbbfw92k19xYW -goversion go1.10.1 -D _/tmp -importcfg ./go-build173481643/b001/importcfg -pack -c=4 ./hello.go /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/30/30c2c39b4791f0cd3ff6f312df7ef17888d3eb206e0c11fac21287cff9e0cf3b-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile errors=/usr/local/go/pkg/linux_amd64/errors.a packagefile io=/usr/local/go/pkg/linux_amd64/io.a packagefile math=/usr/local/go/pkg/linux_amd64/math.a packagefile os=/usr/local/go/pkg/linux_amd64/os.a packagefile reflect=/usr/local/go/pkg/linux_amd64/reflect.a packagefile strconv=/usr/local/go/pkg/linux_amd64/strconv.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile unicode/utf8=/usr/local/go/pkg/linux_amd64/unicode/utf8.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a packagefile internal/cpu=/usr/local/go/pkg/linux_amd64/internal/cpu.a packagefile internal/poll=/usr/local/go/pkg/linux_amd64/internal/poll.a packagefile internal/testlog=/usr/local/go/pkg/linux_amd64/internal/testlog.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile time=/usr/local/go/pkg/linux_amd64/time.a packagefile unicode=/usr/local/go/pkg/linux_amd64/unicode.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=Vbu61g9AuYzF2ufqINOR/8sirXYvMbbfw92k19xYW/iWFW984BSmpZp9MnLdjK/Vbu61g9AuYzF2ufqINOR -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ package main /* #include &lt;stdio.h&gt; static void _(const char* s) { printf(&quot;%s\\n&quot;, s); } */ import &quot;C&quot; func main() { bytes := *new([]byte) bytes = append(bytes, 72) bytes = append(bytes, 101, 121) bytes = append(bytes, 32, 230, 159) bytes = append(bytes, 177, 33, 33, 33) C._(C.CString(string(bytes))) } $ go build -x hello.go WORK=/tmp/go-build142064459 mkdir -p $WORK/b001/ cd /tmp CGO_LDFLAGS=&#39;&quot;-g&quot; &quot;-O2&quot;&#39; /usr/local/go/pkg/tool/linux_amd64/cgo -objdir ./go-build142064459/b001/ -importpath command-line-arguments -- -I ./go-build142064459/b001/ -g -O2 ./hello.go cd $WORK gcc -fno-caret-diagnostics -c -x c - || true gcc -Qunused-arguments -c -x c - || true gcc -fdebug-prefix-map=a=b -c -x c - || true gcc -gno-record-gcc-switches -c -x c - || true cd $WORK/b001 gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x001.o -c _cgo_export.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_x002.o -c hello.cgo2.c gcc -I /tmp -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -I ./ -g -O2 -o ./_cgo_main.o -c _cgo_main.c cd /tmp gcc -I . -fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=$WORK/b001=/tmp/go-build -gno-record-gcc-switches -o ./go-build142064459/b001/_cgo_.o ./go-build142064459/b001/_cgo_main.o ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o -g -O2 /usr/local/go/pkg/tool/linux_amd64/cgo -dynpackage main -dynimport ./go-build142064459/b001/_cgo_.o -dynout ./go-build142064459/b001/_cgo_import.go cat &gt;$WORK/b001/importcfg &lt;&lt; &#39;EOF&#39; # internal # import config packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a EOF /usr/local/go/pkg/tool/linux_amd64/compile -o ./go-build142064459/b001/_pkg_.a -trimpath ./go-build142064459/b001 -p main -buildid WZbBGQxOraNbiT0WofcS/WZbBGQxOraNbiT0WofcS -goversion go1.10.1 -D _/tmp -importcfg ./go-build142064459/b001/importcfg -pack -c=4 ./go-build142064459/b001/_cgo_gotypes.go ./go-build142064459/b001/hello.cgo1.go ./go-build142064459/b001/_cgo_import.go /usr/local/go/pkg/tool/linux_amd64/pack r ./go-build142064459/b001/_pkg_.a ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o # internal /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/_pkg_.a # internal cp $WORK/b001/_pkg_.a /home/x/.cache/go-build/5b/5bedc3923cfc8c06c00e1d8446bf5dd68c35f112d221a1589a8e4ec2fa4b9b11-d # internal cat &gt;$WORK/b001/importcfg.link &lt;&lt; &#39;EOF&#39; # internal packagefile command-line-arguments=$WORK/b001/_pkg_.a packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a EOF mkdir -p $WORK/b001/exe/ cd . /usr/local/go/pkg/tool/linux_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=4aUladWsuR7j-eqT9vPE/WZbBGQxOraNbiT0WofcS/8tvmjI0-hde6HLKu2J8F/4aUladWsuR7j-eqT9vPE -extld=gcc $WORK/b001/_pkg_.a /usr/local/go/pkg/tool/linux_amd64/buildid -w $WORK/b001/exe/a.out # internal mv $WORK/b001/exe/a.out hello rm -r $WORK/b001/ # Go toolchian overflow $ go tool addr2line asm buildid cgo compile cover dist doc fix link nm objdump pack pprof test2json tour trace vet *.go – compile –&gt; $WORK/b001/pkg.a *.s – asm –&gt; *.o – pack –&gt; runtime=$WORK/b002/pkg.a internal/bytealg=$WORK/b003/pkg.a . . . *.a – link –&gt; hello 2.8 Go在探探后端的工程实践","headline":"GopherChina 2018","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2018/04/16/gopherchina-2018/"},"url":"https://blog.codefarm.me/2018/04/16/gopherchina-2018/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">GopherChina 2018</h1><p class="c-post-meta">16 Apr 2018</p>
  </header>

  <div class="c-post-content">
    <ul id="markdown-toc">
  <li><a href="#11-基于go构建滴滴核心业务平台的实践" id="markdown-toc-11-基于go构建滴滴核心业务平台的实践">1.1 基于Go构建滴滴核心业务平台的实践</a></li>
  <li><a href="#12-go在grab地理服务中的实践" id="markdown-toc-12-go在grab地理服务中的实践">1.2 Go在Grab地理服务中的实践</a></li>
  <li><a href="#13-rethinking-errors-for-go-2" id="markdown-toc-13-rethinking-errors-for-go-2">1.3 Rethinking Errors for Go 2</a></li>
  <li><a href="#14-go在区块链的发展和演进" id="markdown-toc-14-go在区块链的发展和演进">1.4 Go在区块链的发展和演进</a></li>
  <li><a href="#15-badger_-fast-key-value-db-in-go" id="markdown-toc-15-badger_-fast-key-value-db-in-go">1.5 Badger_ Fast Key-Value DB in Go</a></li>
  <li><a href="#16-golang在阿里巴巴调度系统sigma中的实践" id="markdown-toc-16-golang在阿里巴巴调度系统sigma中的实践">1.6 Golang在阿里巴巴调度系统Sigma中的实践</a></li>
  <li><a href="#17-罗辑思维go语言微服务改造实践" id="markdown-toc-17-罗辑思维go语言微服务改造实践">1.7 罗辑思维Go语言微服务改造实践</a></li>
  <li><a href="#18-golang打造下一代互联网-ipfs全解析" id="markdown-toc-18-golang打造下一代互联网-ipfs全解析">1.8 Golang打造下一代互联网-IPFS全解析</a></li>
  <li><a href="#21-composition-in-go" id="markdown-toc-21-composition-in-go">2.1 Composition In Go</a></li>
  <li><a href="#23-bazel-build-go" id="markdown-toc-23-bazel-build-go">2.3 Bazel build Go</a></li>
  <li><a href="#24-基于go-ethereum构建dpos机制下的区块链" id="markdown-toc-24-基于go-ethereum构建dpos机制下的区块链">2.4 基于Go-Ethereum构建DPOS机制下的区块链</a></li>
  <li><a href="#25-深入cgo编程" id="markdown-toc-25-深入cgo编程">2.5 深入CGO编程</a></li>
  <li><a href="#26-go与虚拟化容器-runvkata" id="markdown-toc-26-go与虚拟化容器-runvkata">2.6 Go与虚拟化容器 runV/Kata</a></li>
  <li><a href="#27-go-toolchain-internals-and-implementation-based-on-arm64" id="markdown-toc-27-go-toolchain-internals-and-implementation-based-on-arm64">2.7 Go toolchain internals and implementation based on arm64</a></li>
  <li><a href="#28-go在探探后端的工程实践" id="markdown-toc-28-go在探探后端的工程实践">2.8 Go在探探后端的工程实践</a></li>
</ul>

<hr />

<h3 id="11-基于go构建滴滴核心业务平台的实践">1.1 基于Go构建滴滴核心业务平台的实践</h3>

<p># 服务治理</p>

<ul>
  <li>异常定位
    <ul>
      <li>日志格式混乱
        <ul>
          <li>大量 adaptor</li>
          <li>人工配置与分析</li>
          <li>处理性能低，资源消耗大</li>
        </ul>
      </li>
      <li>服务串联困难
        <ul>
          <li>上下游定位困难</li>
          <li>跨业务定位效率低</li>
          <li>缺乏服务调用拓扑关系</li>
        </ul>
      </li>
      <li>链路难以分析
        <ul>
          <li>日志孤立</li>
          <li>性能要素缺失</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>链路优化
    <ul>
      <li>全链路压测</li>
    </ul>
  </li>
  <li>服务迁移
    <ul>
      <li>接口一致性兼容/代理/切流(旁路引流/流量切换/线上观察)</li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>日志规范化, 服务日志规范/通信接口规范/日志组件
    <ul>
      <li>数据结构化
        <ul>
          <li>DLTAG</li>
          <li>Key/Value</li>
        </ul>
      </li>
      <li>请求串联
        <ul>
          <li>TraceId</li>
        </ul>
      </li>
      <li>链路可视化
        <ul>
          <li>SpanId</li>
        </ul>
      </li>
      <li>处理统一化, 处理系统/日志统一处理
        <ul>
          <li>采集/计算/存储</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p># GC</p>
<ul>
  <li>对象数量过多，GC 三色算法耗费较多 CPU
    <ul>
      <li>减少对象分配？用值类型代替对象类型？</li>
      <li>多用栈，少用堆？Goroutine 拷贝栈扩展？</li>
    </ul>
  </li>
</ul>

<h3 id="12-go在grab地理服务中的实践">1.2 Go在Grab地理服务中的实践</h3>

<p># Nearby Service</p>
<ul>
  <li>Node.js + PostGIS
    <ul>
      <li>R-Tree
        <ul>
          <li>空间数据存储 一种平衡树</li>
          <li>高频写 触发频繁再平衡</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Golang + Geohash + Redis
    <ul>
      <li>Geohash
        <ul>
          <li>一维字符串表示二维坐标数据(wtw6j89guz9y -&gt; [31.292494, 121.533371])</li>
          <li>具有相同前缀的 Geohash 字符串地理位置相近</li>
          <li>基于 SortedSet 做 Range 查询</li>
        </ul>
      </li>
      <li>CPU/IO 非常高，内存非常低</li>
      <li>不能横向(水平)扩展</li>
    </ul>
  </li>
  <li>Sharding 扩展
    <ul>
      <li>司机空间索引 -&gt; Shard -&gt; Node</li>
      <li>空间索引
        <ul>
          <li>地球平面网格划分 Grid (Shard)</li>
          <li>分层Grid              (Cell)</li>
          <li>Shard -&gt; Cell (0,1,2,…N) / Cell -&gt; (LRU Queue)</li>
        </ul>
      </li>
      <li>一致性哈希
        <ul>
          <li>Ketema algorithm</li>
          <li>Replica supported</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>分布式
    <ul>
      <li>最终一致性 AP</li>
      <li>Serf
        <ul>
          <li>基于 Gossip 的 Membership</li>
          <li>故障检测</li>
        </ul>
      </li>
      <li>SWIM
        <ul>
          <li>Scable Weakly-consistent Infection-style process group Memmbership protocol
            <ul>
              <li>可扩展性一致性感染型进程组成员协议</li>
              <li>Scable
                <ul>
                  <li>随着结点的增多 故障检测耗时不会大幅度增加
                    <ul>
                      <li>如 heart-beating 机制 消息通信呈指数级</li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li>Weakly
                <ul>
                  <li>在某一时刻不同的结点看到不同的系统状态</li>
                  <li>最终会收敛到相同的状态</li>
                </ul>
              </li>
              <li>Infection-style
                <ul>
                  <li>Gossip</li>
                  <li>每个结点持有部分结点信息 每个结点与其子结点交换信息</li>
                  <li>最终所有结点通过‘八卦’别人的信息获取全局信息</li>
                </ul>
              </li>
              <li>Membership
                <ul>
                  <li>找到其他网络结点</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="13-rethinking-errors-for-go-2">1.3 Rethinking Errors for Go 2</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"log"</span>
        <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"let.go"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"oops: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="n">r</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
<span class="p">}</span>
<span class="c">// Output</span>
<span class="c">// 2018/04/16 14:19:51 oops: open let.go: no such file or directory</span>
</code></pre></div></div>

<p># Go 2 Draft</p>
<ul>
  <li>handle err { … }</li>
  <li>defer err { … }</li>
  <li>try <expr></expr></li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">writeToGS</span><span class="p">(</span><span class="n">c</span> <span class="n">net</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">bkt</span><span class="p">,</span> <span class="n">dst</span> <span class="kt">string</span><span class="p">,</span> <span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">w</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bkt</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">errPanicking</span>
        <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">CloseWithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Close</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"oops: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}()</span>
        <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"oops: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">errPanicking</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"panicking"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">func</span> <span class="n">writeToGS</span><span class="p">(</span><span class="n">c</span> <span class="n">context</span><span class="p">,</span> <span class="n">bkt</span><span class="p">,</span> <span class="n">dst</span> <span class="kt">string</span><span class="p">,</span> <span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrap</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">w</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bkt</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">err</span> <span class="p">{</span> <span class="n">try</span> <span class="n">w</span><span class="o">.</span><span class="n">CloseWithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">try</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="14-go在区块链的发展和演进">1.4 Go在区块链的发展和演进</h3>
<p># 区块链是什么</p>
<ul>
  <li>去中心化系统 (多中心化?)</li>
  <li>数字化账本</li>
  <li>不可篡改</li>
  <li>确定性的可复制状态机</li>
</ul>

<p># 区块链的特点</p>
<ul>
  <li>去中心化、弱中心化</li>
  <li>弱信任、对等的写入权限的数据库</li>
  <li>共识信任机制，信任来自规则，非第三方</li>
  <li>不可篡改</li>
  <li>加密安全、强规则</li>
  <li>可编程</li>
  <li>匿名性</li>
  <li>跨平台</li>
</ul>

<p># 区块链开发的特点</p>
<ul>
  <li>分布式
    <ul>
      <li>网络编程
        <ul>
          <li>多线程</li>
        </ul>
      </li>
      <li>使用大量的算法和数据结构</li>
      <li>强规则
        <ul>
          <li>密码学</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p># Go 的优势</p>
<ul>
  <li>部署简单，直接编译成机器码</li>
  <li>语言级并发支持</li>
  <li>性能高</li>
  <li>良好的 C 语言的支持</li>
  <li>自动垃圾回收</li>
  <li>Go 是工程上设计良好的语言，比如代码风格一致，自带工具链</li>
  <li>代码简洁</li>
  <li>静态类型</li>
  <li>丰富的标准库</li>
  <li>跨平台编译</li>
</ul>

<p># Go 思维</p>
<ul>
  <li>全面简单
    <ul>
      <li>简洁</li>
      <li>类型推断</li>
      <li>GC</li>
      <li>25个 keyword</li>
      <li>package</li>
    </ul>
  </li>
  <li>正交组合
    <ul>
      <li>interface 与其实现之间无显示关联</li>
      <li>通过组合架构让程序静态结构</li>
      <li>垂直组合 (类型组合, type embedding)</li>
      <li>水平组合, 通过 interface 进行组合</li>
    </ul>
  </li>
  <li>偏好并发
    <ul>
      <li>goroutines</li>
      <li>select</li>
      <li>channels
        <ul>
          <li>模块之间解耦</li>
          <li>并发锁</li>
          <li>消息通信</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p># 共识协议</p>
<ul>
  <li>POW / POS / DPOS / DBFT / DAG / …</li>
</ul>

<h3 id="15-badger_-fast-key-value-db-in-go">1.5 Badger_ Fast Key-Value DB in Go</h3>

<ul>
  <li>Cgo is not Go</li>
  <li>RocksDB / BoltDB</li>
  <li>LSM trees / B+ trees</li>
</ul>

<h3 id="16-golang在阿里巴巴调度系统sigma中的实践">1.6 Golang在阿里巴巴调度系统Sigma中的实践</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">m</span> <span class="o">:=</span> <span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][]</span><span class="kt">byte</span><span class="p">{</span>
                <span class="m">0xc4200761c0</span><span class="o">:</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">228</span><span class="p">,</span> <span class="m">189</span><span class="p">,</span> <span class="m">160</span><span class="p">,</span> <span class="m">229</span><span class="p">,</span> <span class="m">165</span><span class="p">,</span> <span class="m">189</span><span class="p">,</span> <span class="m">229</span><span class="p">,</span> <span class="m">147</span><span class="p">,</span> <span class="m">135</span><span class="p">},</span>
                <span class="m">0xc4200761c8</span><span class="o">:</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">230</span><span class="p">,</span> <span class="m">189</span><span class="p">,</span> <span class="m">152</span><span class="p">,</span> <span class="m">233</span><span class="p">,</span> <span class="m">147</span><span class="p">,</span> <span class="m">129</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">,</span> <span class="m">177</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">m</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%p -&gt; %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="c">// Output 1</span>
<span class="c">// 0xc420090020 -&gt; 潘铁柱</span>
<span class="c">// 0xc420090020 -&gt; 你好哇</span>
<span class="c">// </span>
<span class="c">// Output 2</span>
<span class="c">// 0xc420092020 -&gt; 你好哇</span>
<span class="c">// 0xc420092020 -&gt; 潘铁柱</span>
</code></pre></div></div>

<h3 id="17-罗辑思维go语言微服务改造实践">1.7 罗辑思维Go语言微服务改造实践</h3>

<h3 id="18-golang打造下一代互联网-ipfs全解析">1.8 Golang打造下一代互联网-IPFS全解析</h3>

<ul>
  <li><a href="https://medium.com/@mycoralhealth/code-your-own-blockchain-in-less-than-200-lines-of-go-e296282bcffc">Code your own blockchain in less than 200 lines of Go!</a></li>
  <li><a href="https://medium.com/@mycoralhealth/learn-to-securely-share-files-on-the-blockchain-with-ipfs-219ee47df54c">Learn to securely share files on the blockchain with IPFS!</a></li>
</ul>

<h3 id="21-composition-in-go">2.1 Composition In Go</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Reader is the interface that wraps the basic Read method.</span>
<span class="k">type</span> <span class="n">Reader</span> <span class="k">interface</span> <span class="p">{</span>
        <span class="n">Read</span><span class="p">(</span><span class="n">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Writer is the interface that wraps the basic Write method.</span>
<span class="k">type</span> <span class="n">Writer</span> <span class="k">interface</span> <span class="p">{</span>
        <span class="n">Write</span><span class="p">(</span><span class="n">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// ReadWriter is the interface that groups the basic Read and Write methods.</span>
<span class="k">type</span> <span class="n">ReadWriter</span> <span class="k">interface</span> <span class="p">{</span>
        <span class="n">Reader</span>
        <span class="n">Writer</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="23-bazel-build-go">2.3 Bazel build Go</h3>

<p>// <a href="https://bazel.build">https://bazel.build</a></p>

<p>// <a href="https://github.com/golang/go/wiki/vgo">vgo · golang/go Wiki</a></p>

<p>// <a href="https://github.com/golang/dep">golang/dep: Go dependency management tool</a></p>

<h3 id="24-基于go-ethereum构建dpos机制下的区块链">2.4 基于Go-Ethereum构建DPOS机制下的区块链</h3>

<p>// <a href="https://www.ethereum.org/">Ethereum Project</a></p>

<p># 以太坊技术协议，以太坊客户端</p>
<ul>
  <li>Geth (Go)</li>
  <li>Parity (Rust)</li>
  <li>cpp-ethereum (c++)</li>
  <li>ethereumj (java)</li>
</ul>

<p># 以太坊核心组件</p>
<ul>
  <li>Solidity, a new language for smart contracts, 智能合约</li>
  <li>Web3.js</li>
</ul>

<p># 以太坊相关工具组</p>
<ul>
  <li>Truffle</li>
  <li>Metamask</li>
  <li>mist</li>
</ul>

<p># 以太坊外部存储</p>
<ul>
  <li>IPFS (Go)</li>
  <li>Swarm (Go)</li>
</ul>

<p># 共识机制对比</p>
<ul>
  <li>POW
    <ul>
      <li>消耗计算力</li>
      <li>出块速度慢，确认慢</li>
      <li>TPS 极低，10~20</li>
      <li>确认1分支+</li>
    </ul>
  </li>
  <li>DPOS
    <ul>
      <li>代理人模式</li>
      <li>出块速度快，确认块</li>
      <li>TPS 700~1000</li>
      <li>平均确认1~3秒</li>
    </ul>
  </li>
</ul>

<h3 id="25-深入cgo编程">2.5 深入CGO编程</h3>

<p>// <a href="https://dave.cheney.net/2016/01/18/cgo-is-not-go">cgo is not Go | Dave Cheney</a></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="c">/*
#include &lt;stdio.h&gt;

static void _(const char* s) {
    printf("%s\n", s);
}
*/</span>
<span class="k">import</span> <span class="s">"C"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">bytes</span> <span class="o">:=</span> <span class="o">*</span><span class="nb">new</span><span class="p">([]</span><span class="kt">byte</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">72</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">101</span><span class="p">,</span> <span class="m">121</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">32</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">177</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">)</span>
    <span class="n">C</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">CString</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">bytes</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go build <span class="nt">-x</span> hello.go
<span class="nv">WORK</span><span class="o">=</span>/tmp/go-build276115419
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/
<span class="nb">cd</span> /tmp
<span class="nv">CGO_LDFLAGS</span><span class="o">=</span><span class="s1">'"-g" "-O2"'</span> /usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-objdir</span> ./go-build276115419/b001/ <span class="nt">-importpath</span> command-line-arguments <span class="nt">--</span> <span class="nt">-I</span> ./go-build276115419/b001/ <span class="nt">-g</span> <span class="nt">-O2</span> ./hello.go
<span class="nb">cd</span> <span class="nv">$WORK</span>
gcc <span class="nt">-fno-caret-diagnostics</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-Qunused-arguments</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">a</span><span class="o">=</span>b <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
cd</span> <span class="nv">$WORK</span>/b001
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x001.o <span class="nt">-c</span> _cgo_export.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x002.o <span class="nt">-c</span> hello.cgo2.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_cgo_main.o <span class="nt">-c</span> _cgo_main.c
<span class="nb">cd</span> /tmp
gcc <span class="nt">-I</span> <span class="nb">.</span> <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-o</span> ./go-build276115419/b001/_cgo_.o ./go-build276115419/b001/_cgo_main.o ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o <span class="nt">-g</span> <span class="nt">-O2</span>
/usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-dynpackage</span> main <span class="nt">-dynimport</span> ./go-build276115419/b001/_cgo_.o <span class="nt">-dynout</span> ./go-build276115419/b001/_cgo_import.go
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
# import config
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
</span><span class="no">EOF
</span>/usr/local/go/pkg/tool/linux_amd64/compile <span class="nt">-o</span> ./go-build276115419/b001/_pkg_.a <span class="nt">-trimpath</span> ./go-build276115419/b001 <span class="nt">-p</span> main <span class="nt">-buildid</span> mh6f74THdmFYkLXlaEeI/mh6f74THdmFYkLXlaEeI <span class="nt">-goversion</span> go1.10.1 <span class="nt">-D</span> _/tmp <span class="nt">-importcfg</span> ./go-build276115419/b001/importcfg <span class="nt">-pack</span> <span class="nt">-c</span><span class="o">=</span>4 ./go-build276115419/b001/_cgo_gotypes.go ./go-build276115419/b001/hello.cgo1.go ./go-build276115419/b001/_cgo_import.go
/usr/local/go/pkg/tool/linux_amd64/pack r ./go-build276115419/b001/_pkg_.a ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o <span class="c"># internal</span>
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/_pkg_.a <span class="c"># internal</span>
<span class="nb">cp</span> <span class="nv">$WORK</span>/b001/_pkg_.a /home/x/.cache/go-build/5f/5fbfbbfb3d3561c7d7f9b6eb2595c5b5c662c609289b0928d54557b768cf6c31-d <span class="c"># internal</span>
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg.link <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
packagefile command-line-arguments=</span><span class="nv">$WORK</span><span class="sh">/b001/_pkg_.a
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a
packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a
packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a
packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a
</span><span class="no">EOF
</span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/exe/
<span class="nb">cd</span> <span class="nb">.</span>
/usr/local/go/pkg/tool/linux_amd64/link <span class="nt">-o</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="nt">-importcfg</span> <span class="nv">$WORK</span>/b001/importcfg.link <span class="nt">-buildmode</span><span class="o">=</span>exe <span class="nt">-buildid</span><span class="o">=</span>IDPnrZESvB0RYrGsJZll/mh6f74THdmFYkLXlaEeI/_kgrX-BOL__ZqaG2o79P/IDPnrZESvB0RYrGsJZll <span class="nt">-extld</span><span class="o">=</span>gcc <span class="nv">$WORK</span>/b001/_pkg_.a
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="c"># internal</span>
<span class="nb">mv</span> <span class="nv">$WORK</span>/b001/exe/a.out hello
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nv">$WORK</span>/b001/
</code></pre></div></div>

<h3 id="26-go与虚拟化容器-runvkata">2.6 Go与虚拟化容器 runV/Kata</h3>

<p>// <a href="https://github.com/hyperhq/runv">hyperhq/runv: Hypervisor-based Runtime for OCI</a></p>

<p># Secure as VM, Fast as Container</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">arr</span> <span class="o">:=</span> <span class="p">[]</span><span class="k">struct</span><span class="p">{</span> <span class="n">v</span> <span class="kt">int</span> <span class="p">}{{</span><span class="m">1</span><span class="p">},</span> <span class="p">{</span><span class="n">v</span><span class="o">:</span> <span class="m">2</span><span class="p">},</span> <span class="p">{</span><span class="m">3</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">arr</span> <span class="p">{</span>
                <span class="n">e</span><span class="o">.</span><span class="n">v</span><span class="o">++</span>
        <span class="p">}</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">arr</span> <span class="p">{</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">++</span>
        <span class="p">}</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Output</span>
<span class="c">// [{1} {2} {3}]</span>
<span class="c">// [{2} {3} {4}]</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">s0</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">}</span>
        <span class="n">s1</span> <span class="o">:=</span> <span class="n">s0</span><span class="p">[</span><span class="o">:</span><span class="m">2</span><span class="p">]</span>              <span class="c">// len=2, cap=4, [1, 2]</span>
        <span class="n">s2</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>       <span class="c">// len=3, cap=4, [1, 2, 5]</span>
        <span class="n">s3</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">)</span>    <span class="c">// len=4, cap=4, [1, 2, 6, 7]</span>
        <span class="n">s4</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span> <span class="c">// len=5, cap=8, [1, 2, 8, 9, 0]</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s4</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Output</span>
<span class="c">// [1 2 6 7]</span>
<span class="c">// [1 2]</span>
<span class="c">// [1 2 6]</span>
<span class="c">// [1 2 6 7]</span>
<span class="c">// [1 2 8 9 0]</span>
</code></pre></div></div>

<h3 id="27-go-toolchain-internals-and-implementation-based-on-arm64">2.7 Go toolchain internals and implementation based on arm64</h3>

<p>// <a href="https://dave.cheney.net/2013/10/15/how-does-the-go-build-command-work">How does the go build command work ? | Dave Cheney</a></p>

<p># Go toolchain overview</p>

<p>A toolchain is a package composed of the compiler and ancillary tools, libraries and runtime for a language which together allow you to build and run code written in that language.</p>

<ul>
  <li><strong>gc</strong>: evolved from the <a href="https://en.wikipedia.org/wiki/Plan_9_from_Bell_Labs">Plan 9</a> toolchain and includes its own compiler, assembler, linker and tools, as well as the Go runtime and standard library.</li>
  <li><strong>gccgo</strong>: extends the <a href="https://gcc.gnu.org/">gcc</a> project to support Go.</li>
  <li><strong>llgo</strong>: built on top of the LLVM compiler infrastructure.</li>
</ul>

<p># Go toolchain example</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">:=</span> <span class="o">*</span><span class="nb">new</span><span class="p">([]</span><span class="kt">byte</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">72</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">101</span><span class="p">,</span> <span class="m">121</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">32</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">177</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go build <span class="nt">-x</span> hello.go
<span class="nv">WORK</span><span class="o">=</span>/tmp/go-build173481643
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
# import config
packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
</span><span class="no">EOF
</span><span class="nb">cd</span> /tmp
/usr/local/go/pkg/tool/linux_amd64/compile <span class="nt">-o</span> ./go-build173481643/b001/_pkg_.a <span class="nt">-trimpath</span> ./go-build173481643/b001 <span class="nt">-p</span> main <span class="nt">-complete</span> <span class="nt">-buildid</span> 8sirXYvMbbfw92k19xYW/8sirXYvMbbfw92k19xYW <span class="nt">-goversion</span> go1.10.1 <span class="nt">-D</span> _/tmp <span class="nt">-importcfg</span> ./go-build173481643/b001/importcfg <span class="nt">-pack</span> <span class="nt">-c</span><span class="o">=</span>4 ./hello.go
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/_pkg_.a <span class="c"># internal</span>
<span class="nb">cp</span> <span class="nv">$WORK</span>/b001/_pkg_.a /home/x/.cache/go-build/30/30c2c39b4791f0cd3ff6f312df7ef17888d3eb206e0c11fac21287cff9e0cf3b-d <span class="c"># internal</span>
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg.link <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
packagefile command-line-arguments=</span><span class="nv">$WORK</span><span class="sh">/b001/_pkg_.a
packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
packagefile errors=/usr/local/go/pkg/linux_amd64/errors.a
packagefile io=/usr/local/go/pkg/linux_amd64/io.a
packagefile math=/usr/local/go/pkg/linux_amd64/math.a
packagefile os=/usr/local/go/pkg/linux_amd64/os.a
packagefile reflect=/usr/local/go/pkg/linux_amd64/reflect.a
packagefile strconv=/usr/local/go/pkg/linux_amd64/strconv.a
packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a
packagefile unicode/utf8=/usr/local/go/pkg/linux_amd64/unicode/utf8.a
packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a
packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a
packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a
packagefile internal/cpu=/usr/local/go/pkg/linux_amd64/internal/cpu.a
packagefile internal/poll=/usr/local/go/pkg/linux_amd64/internal/poll.a
packagefile internal/testlog=/usr/local/go/pkg/linux_amd64/internal/testlog.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile time=/usr/local/go/pkg/linux_amd64/time.a
packagefile unicode=/usr/local/go/pkg/linux_amd64/unicode.a
packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
</span><span class="no">EOF
</span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/exe/
<span class="nb">cd</span> <span class="nb">.</span>
/usr/local/go/pkg/tool/linux_amd64/link <span class="nt">-o</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="nt">-importcfg</span> <span class="nv">$WORK</span>/b001/importcfg.link <span class="nt">-buildmode</span><span class="o">=</span>exe <span class="nt">-buildid</span><span class="o">=</span>Vbu61g9AuYzF2ufqINOR/8sirXYvMbbfw92k19xYW/iWFW984BSmpZp9MnLdjK/Vbu61g9AuYzF2ufqINOR <span class="nt">-extld</span><span class="o">=</span>gcc <span class="nv">$WORK</span>/b001/_pkg_.a
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="c"># internal</span>
<span class="nb">mv</span> <span class="nv">$WORK</span>/b001/exe/a.out hello
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nv">$WORK</span>/b001/
</code></pre></div></div>

<hr />

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="c">/*
 #include &lt;stdio.h&gt;

 static void _(const char* s) {
     printf("%s\n", s);
 }
*/</span>
<span class="k">import</span> <span class="s">"C"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">:=</span> <span class="o">*</span><span class="nb">new</span><span class="p">([]</span><span class="kt">byte</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">72</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">101</span><span class="p">,</span> <span class="m">121</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">32</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">177</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">)</span>
        <span class="n">C</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">CString</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">bytes</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go build <span class="nt">-x</span> hello.go
<span class="nv">WORK</span><span class="o">=</span>/tmp/go-build142064459
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/
<span class="nb">cd</span> /tmp
<span class="nv">CGO_LDFLAGS</span><span class="o">=</span><span class="s1">'"-g" "-O2"'</span> /usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-objdir</span> ./go-build142064459/b001/ <span class="nt">-importpath</span> command-line-arguments <span class="nt">--</span> <span class="nt">-I</span> ./go-build142064459/b001/ <span class="nt">-g</span> <span class="nt">-O2</span> ./hello.go
<span class="nb">cd</span> <span class="nv">$WORK</span>
gcc <span class="nt">-fno-caret-diagnostics</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-Qunused-arguments</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">a</span><span class="o">=</span>b <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
cd</span> <span class="nv">$WORK</span>/b001
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x001.o <span class="nt">-c</span> _cgo_export.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x002.o <span class="nt">-c</span> hello.cgo2.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_cgo_main.o <span class="nt">-c</span> _cgo_main.c
<span class="nb">cd</span> /tmp
gcc <span class="nt">-I</span> <span class="nb">.</span> <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-o</span> ./go-build142064459/b001/_cgo_.o ./go-build142064459/b001/_cgo_main.o ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o <span class="nt">-g</span> <span class="nt">-O2</span>
/usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-dynpackage</span> main <span class="nt">-dynimport</span> ./go-build142064459/b001/_cgo_.o <span class="nt">-dynout</span> ./go-build142064459/b001/_cgo_import.go
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
# import config
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
</span><span class="no">EOF
</span>/usr/local/go/pkg/tool/linux_amd64/compile <span class="nt">-o</span> ./go-build142064459/b001/_pkg_.a <span class="nt">-trimpath</span> ./go-build142064459/b001 <span class="nt">-p</span> main <span class="nt">-buildid</span> WZbBGQxOraNbiT0WofcS/WZbBGQxOraNbiT0WofcS <span class="nt">-goversion</span> go1.10.1 <span class="nt">-D</span> _/tmp <span class="nt">-importcfg</span> ./go-build142064459/b001/importcfg <span class="nt">-pack</span> <span class="nt">-c</span><span class="o">=</span>4 ./go-build142064459/b001/_cgo_gotypes.go ./go-build142064459/b001/hello.cgo1.go ./go-build142064459/b001/_cgo_import.go
/usr/local/go/pkg/tool/linux_amd64/pack r ./go-build142064459/b001/_pkg_.a ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o <span class="c"># internal</span>
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/_pkg_.a <span class="c"># internal</span>
<span class="nb">cp</span> <span class="nv">$WORK</span>/b001/_pkg_.a /home/x/.cache/go-build/5b/5bedc3923cfc8c06c00e1d8446bf5dd68c35f112d221a1589a8e4ec2fa4b9b11-d <span class="c"># internal</span>
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg.link <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
packagefile command-line-arguments=</span><span class="nv">$WORK</span><span class="sh">/b001/_pkg_.a
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a
packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a
packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a
packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a
</span><span class="no">EOF
</span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/exe/
<span class="nb">cd</span> <span class="nb">.</span>
/usr/local/go/pkg/tool/linux_amd64/link <span class="nt">-o</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="nt">-importcfg</span> <span class="nv">$WORK</span>/b001/importcfg.link <span class="nt">-buildmode</span><span class="o">=</span>exe <span class="nt">-buildid</span><span class="o">=</span>4aUladWsuR7j-eqT9vPE/WZbBGQxOraNbiT0WofcS/8tvmjI0-hde6HLKu2J8F/4aUladWsuR7j-eqT9vPE <span class="nt">-extld</span><span class="o">=</span>gcc <span class="nv">$WORK</span>/b001/_pkg_.a
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="c"># internal</span>
<span class="nb">mv</span> <span class="nv">$WORK</span>/b001/exe/a.out hello
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nv">$WORK</span>/b001/
</code></pre></div></div>

<p># Go toolchian overflow</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go tool
addr2line
asm
buildid
cgo
compile
cover
dist
doc
fix
<span class="nb">link
</span>nm
objdump
pack
pprof
test2json
tour
trace
vet
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">*.go</code> – compile –&gt; $WORK/b001/<em>pkg</em>.a</li>
  <li><code class="language-plaintext highlighter-rouge">*.s</code>  – asm –&gt; <code class="language-plaintext highlighter-rouge">*.o</code> – pack –&gt; runtime=$WORK/b002/<em>pkg</em>.a</li>
  <li>internal/bytealg=$WORK/b003/<em>pkg</em>.a</li>
  <li>. . .</li>
</ul>

<hr />

<ul>
  <li><code class="language-plaintext highlighter-rouge">*.a</code> – link –&gt; hello</li>
</ul>

<h3 id="28-go在探探后端的工程实践">2.8 Go在探探后端的工程实践</h3>

<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
