<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Linux as Router | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Linux as Router" />
<meta property="og:locale" content="en" />
<meta name="description" content="1. Linux ip Command 1.1. ip route: Routing table management commands 2. Let a Linux as a router 2.1. Test networking with ping References 1. Linux ip Command NAME ip - show / manipulate routing, network devices, interfaces and tunnels SYNOPSIS ip [ OPTIONS ] OBJECT { COMMAND | help } ip [ -force ] -batch filename OBJECT := { link | address | addrlabel | route | rule | neigh | ntable | tunnel | tuntap | maddress | mroute | mrule | monitor | xfrm | netns | l2tp | tcp_metrics | token | macsec | vrf | mptcp } OPTIONS := { -V[ersion] | -h[uman-readable] | -s[tatistics] | -d[etails] | -r[esolve] | -iec | -f[amily] { inet | inet6 | link } | -4 | -6 | -I | -D | -B | -0 | -l[oops] { maximum-addr-flush-attempts } | -o[neline] | -rc[vbuf] [size] | -t[imestamp] | -ts[hort] | -n[etns] name | -N[umeric] | -a[ll] | -c[olor] | -br[ief] | -j[son] | -p[retty] } EXAMPLES ip addr Shows addresses assigned to all network interfaces. ip neigh Shows the current neighbour table in kernel. ip link set x up Bring up interface x. ip link set x down Bring down interface x. ip route Show table routes. Table 1. OBJECTS can be any one of the following and may be written in full or abbreviated form[1] Object Abbreviated form Purpose link l Network device. address a addr Protocol (IP or IPv6) address on a device. addrlabel addrl Label configuration for protocol address selection. neighbour n neigh ARP or NDISC cache entry. route r Routing table entry. rule ru Rule in routing policy database. maddress m maddr Multicast address. mroute mr Multicast routing cache entry. tunnel t Tunnel over IP. xfrm x Framework for IPsec protocol. Table 2. Deprecated Linux command and their replacement cheat sheet. Old command (Deprecated) New command ifconfig -a ip a ifconfig enp6s0 down ip link set enp6s0 down ifconfig enp6s0 up ip link set enp6s0 up ifconfig enp6s0 192.168.2.24 ip addr add 192.168.2.24/24 dev enp6s0 ifconfig enp6s0 netmask 255.255.255.0 ip addr add 192.168.1.1/24 dev enp6s0 ifconfig enp6s0 mtu 9000 ip link set enp6s0 mtu 9000 ifconfig enp6s0:0 192.168.2.25 ip addr add 192.168.2.25/24 dev enp6s0 netstat ss netstat -tulpn ss -tulpn netstat -neopa ss -neopa netstat -g ip maddr route ip r route add -net 192.168.2.0 netmask 255.255.255.0 dev enp6s0 ip route add 192.168.2.0/24 dev enp6s0 route add default gw 192.168.2.254 ip route add default via 192.168.2.254 arp -a ip neigh arp -v ip -s neigh arp -s 192.168.2.33 1:2:3:4:5:6 ip neigh add 192.168.3.33 lladdr 1:2:3:4:5:6 dev enp6s0 arp -i enp6s0 -d 192.168.2.254 ip neigh del 192.168.2.254 dev wlp7s0 1.1. ip route: Routing table management commands Show routing table $ ip r default via 192.168.91.2 dev ens32 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 192.168.91.2 0.0.0.0 UG 0 0 0 ens32 192.168.91.0 0.0.0.0 255.255.255.0 U 0 0 0 ens32 $ ip r l 192.168.91.0/24 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 Delete a route $ sudo ip r del default $ ip r 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo ip r del 192.168.91.0/24 $ ip r Add a new route # ip route add {NETWORK/MASK} via {GATEWAYIP} # ip route add {NETWORK/MASK} dev {DEVICE} # ## Add default route using ip ## # ip route add default {NETWORK/MASK} dev {DEVICE} # ip route add default {NETWORK/MASK} via {GATEWAYIP} $ sudo ip r add default via 192.168.91.2 dev ens32 $ ip r default via 192.168.91.2 dev ens32 $ sudo ip r add 192.168.91.0/24 dev ens32 $ ip r default via 192.168.91.2 dev ens32 192.168.91.0/24 dev ens32 scope link 2. Let a Linux as a router Update the default route to another Linux $ ip r default via 192.168.91.2 dev ens32 onlink 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo ip r del default $ ip r 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 # set the default gateway to another Linux (192.168.91.137) $ sudo ip r add default via 192.168.91.137 dev ens32 $ ip r default via 192.168.91.137 dev ens32 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 2.1. Test networking with ping Open a terminal and run tcpdump to capture the network packet: $ sudo tcpdump -nv host 10.170.108.237 tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes 15:02:58.708055 IP (tos 0x0, ttl 64, id 61339, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.91.128 &gt; 10.170.108.237: ICMP echo request, id 4621, seq 1, length 64 15:02:59.715911 IP (tos 0x0, ttl 64, id 61408, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.91.128 &gt; 10.170.108.237: ICMP echo request, id 4621, seq 2, length 64 ^C 2 packets captured 2 packets received by filter 0 packets dropped by kernel Run ping to test networking: $ ping -c 2 10.170.108.237 PING 10.170.108.237 (10.170.108.237) 56(84) bytes of data. --- 10.170.108.237 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 1008ms Here, we see all the packet were lost. This is beacuse the target Linux host (192.168.91.137) should enable the ip forward feature as below. $ sudo sysctl net.ipv4.ip_forward net.ipv4.ip_forward = 0 $ sudo sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 Now let&#8217;s run the ping at host (192.168.91.128) again: $ ping -c 2 10.170.108.237 PING 10.170.108.237 (10.170.108.237) 56(84) bytes of data. 64 bytes from 10.170.108.237: icmp_seq=1 ttl=128 time=1.50 ms 64 bytes from 10.170.108.237: icmp_seq=2 ttl=128 time=1.18 ms --- 10.170.108.237 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1003ms rtt min/avg/max/mdev = 1.175/1.338/1.501/0.163 ms Show the gateway Linux host (192.168.91.137) route: $ ip -d r unicast default via 192.168.91.2 dev ens34 proto boot scope global unicast 192.168.91.0/24 dev ens34 proto kernel scope link src 192.168.91.131 unicast 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.137 Run the traceroute at the source host (192.168.91.128) to print the route trace: $ sudo traceroute -I 10.170.108.237 traceroute to 10.170.108.237 (10.170.108.237), 30 hops max, 60 byte packets 1 192.168.91.131 (192.168.91.131) 2.323 ms 1.998 ms 1.781 ms 2 192.168.91.2 (192.168.91.2) 1.636 ms 1.460 ms 1.162 ms 3 10.170.108.237 (10.170.108.237) 3.304 ms 3.895 ms 6.811 ms References [1] https://www.cyberciti.biz/faq/linux-ip-command-examples-usage-syntax/" />
<meta property="og:description" content="1. Linux ip Command 1.1. ip route: Routing table management commands 2. Let a Linux as a router 2.1. Test networking with ping References 1. Linux ip Command NAME ip - show / manipulate routing, network devices, interfaces and tunnels SYNOPSIS ip [ OPTIONS ] OBJECT { COMMAND | help } ip [ -force ] -batch filename OBJECT := { link | address | addrlabel | route | rule | neigh | ntable | tunnel | tuntap | maddress | mroute | mrule | monitor | xfrm | netns | l2tp | tcp_metrics | token | macsec | vrf | mptcp } OPTIONS := { -V[ersion] | -h[uman-readable] | -s[tatistics] | -d[etails] | -r[esolve] | -iec | -f[amily] { inet | inet6 | link } | -4 | -6 | -I | -D | -B | -0 | -l[oops] { maximum-addr-flush-attempts } | -o[neline] | -rc[vbuf] [size] | -t[imestamp] | -ts[hort] | -n[etns] name | -N[umeric] | -a[ll] | -c[olor] | -br[ief] | -j[son] | -p[retty] } EXAMPLES ip addr Shows addresses assigned to all network interfaces. ip neigh Shows the current neighbour table in kernel. ip link set x up Bring up interface x. ip link set x down Bring down interface x. ip route Show table routes. Table 1. OBJECTS can be any one of the following and may be written in full or abbreviated form[1] Object Abbreviated form Purpose link l Network device. address a addr Protocol (IP or IPv6) address on a device. addrlabel addrl Label configuration for protocol address selection. neighbour n neigh ARP or NDISC cache entry. route r Routing table entry. rule ru Rule in routing policy database. maddress m maddr Multicast address. mroute mr Multicast routing cache entry. tunnel t Tunnel over IP. xfrm x Framework for IPsec protocol. Table 2. Deprecated Linux command and their replacement cheat sheet. Old command (Deprecated) New command ifconfig -a ip a ifconfig enp6s0 down ip link set enp6s0 down ifconfig enp6s0 up ip link set enp6s0 up ifconfig enp6s0 192.168.2.24 ip addr add 192.168.2.24/24 dev enp6s0 ifconfig enp6s0 netmask 255.255.255.0 ip addr add 192.168.1.1/24 dev enp6s0 ifconfig enp6s0 mtu 9000 ip link set enp6s0 mtu 9000 ifconfig enp6s0:0 192.168.2.25 ip addr add 192.168.2.25/24 dev enp6s0 netstat ss netstat -tulpn ss -tulpn netstat -neopa ss -neopa netstat -g ip maddr route ip r route add -net 192.168.2.0 netmask 255.255.255.0 dev enp6s0 ip route add 192.168.2.0/24 dev enp6s0 route add default gw 192.168.2.254 ip route add default via 192.168.2.254 arp -a ip neigh arp -v ip -s neigh arp -s 192.168.2.33 1:2:3:4:5:6 ip neigh add 192.168.3.33 lladdr 1:2:3:4:5:6 dev enp6s0 arp -i enp6s0 -d 192.168.2.254 ip neigh del 192.168.2.254 dev wlp7s0 1.1. ip route: Routing table management commands Show routing table $ ip r default via 192.168.91.2 dev ens32 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 192.168.91.2 0.0.0.0 UG 0 0 0 ens32 192.168.91.0 0.0.0.0 255.255.255.0 U 0 0 0 ens32 $ ip r l 192.168.91.0/24 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 Delete a route $ sudo ip r del default $ ip r 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo ip r del 192.168.91.0/24 $ ip r Add a new route # ip route add {NETWORK/MASK} via {GATEWAYIP} # ip route add {NETWORK/MASK} dev {DEVICE} # ## Add default route using ip ## # ip route add default {NETWORK/MASK} dev {DEVICE} # ip route add default {NETWORK/MASK} via {GATEWAYIP} $ sudo ip r add default via 192.168.91.2 dev ens32 $ ip r default via 192.168.91.2 dev ens32 $ sudo ip r add 192.168.91.0/24 dev ens32 $ ip r default via 192.168.91.2 dev ens32 192.168.91.0/24 dev ens32 scope link 2. Let a Linux as a router Update the default route to another Linux $ ip r default via 192.168.91.2 dev ens32 onlink 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo ip r del default $ ip r 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 # set the default gateway to another Linux (192.168.91.137) $ sudo ip r add default via 192.168.91.137 dev ens32 $ ip r default via 192.168.91.137 dev ens32 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 2.1. Test networking with ping Open a terminal and run tcpdump to capture the network packet: $ sudo tcpdump -nv host 10.170.108.237 tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes 15:02:58.708055 IP (tos 0x0, ttl 64, id 61339, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.91.128 &gt; 10.170.108.237: ICMP echo request, id 4621, seq 1, length 64 15:02:59.715911 IP (tos 0x0, ttl 64, id 61408, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.91.128 &gt; 10.170.108.237: ICMP echo request, id 4621, seq 2, length 64 ^C 2 packets captured 2 packets received by filter 0 packets dropped by kernel Run ping to test networking: $ ping -c 2 10.170.108.237 PING 10.170.108.237 (10.170.108.237) 56(84) bytes of data. --- 10.170.108.237 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 1008ms Here, we see all the packet were lost. This is beacuse the target Linux host (192.168.91.137) should enable the ip forward feature as below. $ sudo sysctl net.ipv4.ip_forward net.ipv4.ip_forward = 0 $ sudo sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 Now let&#8217;s run the ping at host (192.168.91.128) again: $ ping -c 2 10.170.108.237 PING 10.170.108.237 (10.170.108.237) 56(84) bytes of data. 64 bytes from 10.170.108.237: icmp_seq=1 ttl=128 time=1.50 ms 64 bytes from 10.170.108.237: icmp_seq=2 ttl=128 time=1.18 ms --- 10.170.108.237 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1003ms rtt min/avg/max/mdev = 1.175/1.338/1.501/0.163 ms Show the gateway Linux host (192.168.91.137) route: $ ip -d r unicast default via 192.168.91.2 dev ens34 proto boot scope global unicast 192.168.91.0/24 dev ens34 proto kernel scope link src 192.168.91.131 unicast 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.137 Run the traceroute at the source host (192.168.91.128) to print the route trace: $ sudo traceroute -I 10.170.108.237 traceroute to 10.170.108.237 (10.170.108.237), 30 hops max, 60 byte packets 1 192.168.91.131 (192.168.91.131) 2.323 ms 1.998 ms 1.781 ms 2 192.168.91.2 (192.168.91.2) 1.636 ms 1.460 ms 1.162 ms 3 10.170.108.237 (10.170.108.237) 3.304 ms 3.895 ms 6.811 ms References [1] https://www.cyberciti.biz/faq/linux-ip-command-examples-usage-syntax/" />
<link rel="canonical" href="https://blog.codefarm.me/2022/11/08/linux-as-router/" />
<meta property="og:url" content="https://blog.codefarm.me/2022/11/08/linux-as-router/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-11-08T10:24:40+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Linux as Router" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-08T10:24:40+08:00","datePublished":"2022-11-08T10:24:40+08:00","description":"1. Linux ip Command 1.1. ip route: Routing table management commands 2. Let a Linux as a router 2.1. Test networking with ping References 1. Linux ip Command NAME ip - show / manipulate routing, network devices, interfaces and tunnels SYNOPSIS ip [ OPTIONS ] OBJECT { COMMAND | help } ip [ -force ] -batch filename OBJECT := { link | address | addrlabel | route | rule | neigh | ntable | tunnel | tuntap | maddress | mroute | mrule | monitor | xfrm | netns | l2tp | tcp_metrics | token | macsec | vrf | mptcp } OPTIONS := { -V[ersion] | -h[uman-readable] | -s[tatistics] | -d[etails] | -r[esolve] | -iec | -f[amily] { inet | inet6 | link } | -4 | -6 | -I | -D | -B | -0 | -l[oops] { maximum-addr-flush-attempts } | -o[neline] | -rc[vbuf] [size] | -t[imestamp] | -ts[hort] | -n[etns] name | -N[umeric] | -a[ll] | -c[olor] | -br[ief] | -j[son] | -p[retty] } EXAMPLES ip addr Shows addresses assigned to all network interfaces. ip neigh Shows the current neighbour table in kernel. ip link set x up Bring up interface x. ip link set x down Bring down interface x. ip route Show table routes. Table 1. OBJECTS can be any one of the following and may be written in full or abbreviated form[1] Object Abbreviated form Purpose link l Network device. address a addr Protocol (IP or IPv6) address on a device. addrlabel addrl Label configuration for protocol address selection. neighbour n neigh ARP or NDISC cache entry. route r Routing table entry. rule ru Rule in routing policy database. maddress m maddr Multicast address. mroute mr Multicast routing cache entry. tunnel t Tunnel over IP. xfrm x Framework for IPsec protocol. Table 2. Deprecated Linux command and their replacement cheat sheet. Old command (Deprecated) New command ifconfig -a ip a ifconfig enp6s0 down ip link set enp6s0 down ifconfig enp6s0 up ip link set enp6s0 up ifconfig enp6s0 192.168.2.24 ip addr add 192.168.2.24/24 dev enp6s0 ifconfig enp6s0 netmask 255.255.255.0 ip addr add 192.168.1.1/24 dev enp6s0 ifconfig enp6s0 mtu 9000 ip link set enp6s0 mtu 9000 ifconfig enp6s0:0 192.168.2.25 ip addr add 192.168.2.25/24 dev enp6s0 netstat ss netstat -tulpn ss -tulpn netstat -neopa ss -neopa netstat -g ip maddr route ip r route add -net 192.168.2.0 netmask 255.255.255.0 dev enp6s0 ip route add 192.168.2.0/24 dev enp6s0 route add default gw 192.168.2.254 ip route add default via 192.168.2.254 arp -a ip neigh arp -v ip -s neigh arp -s 192.168.2.33 1:2:3:4:5:6 ip neigh add 192.168.3.33 lladdr 1:2:3:4:5:6 dev enp6s0 arp -i enp6s0 -d 192.168.2.254 ip neigh del 192.168.2.254 dev wlp7s0 1.1. ip route: Routing table management commands Show routing table $ ip r default via 192.168.91.2 dev ens32 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 192.168.91.2 0.0.0.0 UG 0 0 0 ens32 192.168.91.0 0.0.0.0 255.255.255.0 U 0 0 0 ens32 $ ip r l 192.168.91.0/24 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 Delete a route $ sudo ip r del default $ ip r 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo ip r del 192.168.91.0/24 $ ip r Add a new route # ip route add {NETWORK/MASK} via {GATEWAYIP} # ip route add {NETWORK/MASK} dev {DEVICE} # ## Add default route using ip ## # ip route add default {NETWORK/MASK} dev {DEVICE} # ip route add default {NETWORK/MASK} via {GATEWAYIP} $ sudo ip r add default via 192.168.91.2 dev ens32 $ ip r default via 192.168.91.2 dev ens32 $ sudo ip r add 192.168.91.0/24 dev ens32 $ ip r default via 192.168.91.2 dev ens32 192.168.91.0/24 dev ens32 scope link 2. Let a Linux as a router Update the default route to another Linux $ ip r default via 192.168.91.2 dev ens32 onlink 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 $ sudo ip r del default $ ip r 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 # set the default gateway to another Linux (192.168.91.137) $ sudo ip r add default via 192.168.91.137 dev ens32 $ ip r default via 192.168.91.137 dev ens32 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 2.1. Test networking with ping Open a terminal and run tcpdump to capture the network packet: $ sudo tcpdump -nv host 10.170.108.237 tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes 15:02:58.708055 IP (tos 0x0, ttl 64, id 61339, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.91.128 &gt; 10.170.108.237: ICMP echo request, id 4621, seq 1, length 64 15:02:59.715911 IP (tos 0x0, ttl 64, id 61408, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.91.128 &gt; 10.170.108.237: ICMP echo request, id 4621, seq 2, length 64 ^C 2 packets captured 2 packets received by filter 0 packets dropped by kernel Run ping to test networking: $ ping -c 2 10.170.108.237 PING 10.170.108.237 (10.170.108.237) 56(84) bytes of data. --- 10.170.108.237 ping statistics --- 2 packets transmitted, 0 received, 100% packet loss, time 1008ms Here, we see all the packet were lost. This is beacuse the target Linux host (192.168.91.137) should enable the ip forward feature as below. $ sudo sysctl net.ipv4.ip_forward net.ipv4.ip_forward = 0 $ sudo sysctl -w net.ipv4.ip_forward=1 net.ipv4.ip_forward = 1 Now let&#8217;s run the ping at host (192.168.91.128) again: $ ping -c 2 10.170.108.237 PING 10.170.108.237 (10.170.108.237) 56(84) bytes of data. 64 bytes from 10.170.108.237: icmp_seq=1 ttl=128 time=1.50 ms 64 bytes from 10.170.108.237: icmp_seq=2 ttl=128 time=1.18 ms --- 10.170.108.237 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1003ms rtt min/avg/max/mdev = 1.175/1.338/1.501/0.163 ms Show the gateway Linux host (192.168.91.137) route: $ ip -d r unicast default via 192.168.91.2 dev ens34 proto boot scope global unicast 192.168.91.0/24 dev ens34 proto kernel scope link src 192.168.91.131 unicast 192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.137 Run the traceroute at the source host (192.168.91.128) to print the route trace: $ sudo traceroute -I 10.170.108.237 traceroute to 10.170.108.237 (10.170.108.237), 30 hops max, 60 byte packets 1 192.168.91.131 (192.168.91.131) 2.323 ms 1.998 ms 1.781 ms 2 192.168.91.2 (192.168.91.2) 1.636 ms 1.460 ms 1.162 ms 3 10.170.108.237 (10.170.108.237) 3.304 ms 3.895 ms 6.811 ms References [1] https://www.cyberciti.biz/faq/linux-ip-command-examples-usage-syntax/","headline":"Linux as Router","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2022/11/08/linux-as-router/"},"url":"https://blog.codefarm.me/2022/11/08/linux-as-router/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">Linux as Router</h1><p class="c-post-meta">08 Nov 2022</p>
  </header>

  <div class="c-post-content">
    <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#linux-ip-command">1. Linux ip Command</a>
<ul class="sectlevel2">
<li><a href="#ip-route-routing-table-management-commands">1.1. ip route: Routing table management commands</a></li>
</ul>
</li>
<li><a href="#let-a-linux-as-a-router">2. Let a Linux as a router</a>
<ul class="sectlevel2">
<li><a href="#test-networking-with-ping">2.1. Test networking with ping</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="linux-ip-command">1. Linux ip Command</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="man">NAME
       ip - show / manipulate routing, network devices, interfaces and tunnels

SYNOPSIS
       ip [ OPTIONS ] OBJECT { COMMAND | help }

       ip [ -force ] -batch filename

       OBJECT := { link | address | addrlabel | route | rule | neigh | ntable | tunnel | tuntap | maddress | mroute | mrule | monitor | xfrm | netns | l2tp |
               tcp_metrics | token | macsec | vrf | mptcp }

       OPTIONS := { -V[ersion] | -h[uman-readable] | -s[tatistics] | -d[etails] | -r[esolve] | -iec | -f[amily] { inet | inet6 | link } | -4 | -6 | -I | -D | -B |
               -0 | -l[oops] { maximum-addr-flush-attempts } | -o[neline] | -rc[vbuf] [size] | -t[imestamp] | -ts[hort] | -n[etns] name | -N[umeric] | -a[ll] |
               -c[olor] | -br[ief] | -j[son] | -p[retty] }

EXAMPLES
       ip addr
           Shows addresses assigned to all network interfaces.

       ip neigh
           Shows the current neighbour table in kernel.

       ip link set x up
           Bring up interface x.

       ip link set x down
           Bring down interface x.

       ip route
           Show table routes.</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. OBJECTS can be any one of the following and may be written in full or abbreviated form<a href="#1">[1]</a></caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Object</th>
<th class="tableblock halign-left valign-top">Abbreviated form</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>link</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>l</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network device.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>address</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>a</code> <code>addr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Protocol (IP or IPv6) address on a device.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addrlabel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>addrl</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Label configuration for protocol address selection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>neighbour</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>n</code> <code>neigh</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARP or NDISC cache entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>r</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Routing table entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rule</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ru</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rule in routing policy database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maddress</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>m</code> <code>maddr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mroute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast routing cache entry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tunnel</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tunnel over IP.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>xfrm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Framework for IPsec protocol.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Deprecated Linux command and their replacement cheat sheet.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Old command (Deprecated)</th>
<th class="tableblock halign-left valign-top">New command</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifconfig -a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip a</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifconfig enp6s0 down</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip link set enp6s0 down</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifconfig enp6s0 up</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip link set enp6s0 up</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifconfig enp6s0 192.168.2.24</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip addr add 192.168.2.24/24 dev enp6s0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifconfig enp6s0 netmask 255.255.255.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip addr add 192.168.1.1/24 dev enp6s0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifconfig enp6s0 mtu 9000</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip link set enp6s0 mtu 9000</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ifconfig enp6s0:0 192.168.2.25</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip addr add 192.168.2.25/24 dev enp6s0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netstat</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ss</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netstat -tulpn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ss -tulpn</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netstat -neopa</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ss -neopa</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>netstat -g</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip maddr</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip r</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route add -net 192.168.2.0 netmask 255.255.255.0 dev enp6s0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip route add 192.168.2.0/24 dev enp6s0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>route add default gw 192.168.2.254</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip route add default via 192.168.2.254</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>arp -a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip neigh</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>arp -v</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip -s neigh</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>arp -s 192.168.2.33 1:2:3:4:5:6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip neigh add 192.168.3.33 lladdr 1:2:3:4:5:6 dev enp6s0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>arp -i enp6s0 -d 192.168.2.254</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip neigh del 192.168.2.254 dev wlp7s0</code></p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="ip-route-routing-table-management-commands">1.1. ip route: Routing table management commands</h3>
<div class="ulist">
<ul>
<li>
<p>Show routing table</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>ip r
<span class="go">default via 192.168.91.2 dev ens32
192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>route <span class="nt">-n</span>
<span class="go">Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.91.2    0.0.0.0         UG    0      0        0 ens32
192.168.91.0    0.0.0.0         255.255.255.0   U     0      0        0 ens32

</span><span class="gp">$</span><span class="w"> </span>ip r l 192.168.91.0/24
<span class="go">192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128</span></code></pre>
</div>
</div>
</li>
<li>
<p>Delete a route</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ip r del default
<span class="gp">$</span><span class="w"> </span>ip r
<span class="go">192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ip r del 192.168.91.0/24
<span class="gp">$</span><span class="w"> </span>ip r</code></pre>
</div>
</div>
</li>
<li>
<p>Add a new route</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="c"># ip route add {NETWORK/MASK} via {GATEWAYIP}</span>
<span class="c"># ip route add {NETWORK/MASK} dev {DEVICE}</span>
<span class="c"># ## Add default route using ip ##</span>
<span class="c"># ip route add default {NETWORK/MASK} dev {DEVICE}</span>
<span class="c"># ip route add default {NETWORK/MASK} via {GATEWAYIP}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ip r add default via 192.168.91.2 dev ens32
<span class="gp">$</span><span class="w"> </span>ip r
<span class="go">default via 192.168.91.2 dev ens32

</span><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>ip r add 192.168.91.0/24 dev ens32
<span class="gp">$</span><span class="w"> </span>ip r
<span class="go">default via 192.168.91.2 dev ens32
192.168.91.0/24 dev ens32 scope link</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="let-a-linux-as-a-router">2. Let a Linux as a router</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Update the default route to another Linux</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>ip r
default via 192.168.91.2 dev ens32 onlink
192.168.91.0/24 dev ens32 proto kernel scope <span class="nb">link </span>src 192.168.91.128

<span class="nv">$ </span><span class="nb">sudo </span>ip r del default
<span class="nv">$ </span>ip r
192.168.91.0/24 dev ens32 proto kernel scope <span class="nb">link </span>src 192.168.91.128

<span class="c"># set the default gateway to another Linux (192.168.91.137)</span>
<span class="nv">$ </span><span class="nb">sudo </span>ip r add default via 192.168.91.137 dev ens32
<span class="nv">$ </span>ip r
default via 192.168.91.137 dev ens32
192.168.91.0/24 dev ens32 proto kernel scope <span class="nb">link </span>src 192.168.91.128</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="test-networking-with-ping">2.1. Test networking with ping</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a terminal and run <code>tcpdump</code> to capture the network packet:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>tcpdump <span class="nt">-nv</span> host 10.170.108.237
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
15:02:58.708055 IP (tos 0x0, ttl 64, id 61339, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.108.237: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>4621, <span class="nb">seq </span>1, length 64
<span class="go">15:02:59.715911 IP (tos 0x0, ttl 64, id 61408, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.108.237: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>4621, <span class="nb">seq </span>2, length 64
<span class="go">^C
2 packets captured
2 packets received by filter
0 packets dropped by kernel</span></code></pre>
</div>
</div>
</li>
<li>
<p>Run <code>ping</code> to test networking:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>ping <span class="nt">-c</span> 2 10.170.108.237
<span class="go">PING 10.170.108.237 (10.170.108.237) 56(84) bytes of data.

--- 10.170.108.237 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1008ms</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we see all the packet were lost. This is beacuse the target Linux host (<code>192.168.91.137</code>) should enable the ip forward feature as below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>sysctl net.ipv4.ip_forward
net.ipv4.ip_forward <span class="o">=</span> 0

<span class="nv">$ </span><span class="nb">sudo </span>sysctl <span class="nt">-w</span> net.ipv4.ip_forward<span class="o">=</span>1
net.ipv4.ip_forward <span class="o">=</span> 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s run the ping at host (<code>192.168.91.128</code>) again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>ping <span class="nt">-c</span> 2 10.170.108.237
PING 10.170.108.237 <span class="o">(</span>10.170.108.237<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.170.108.237: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>128 <span class="nb">time</span><span class="o">=</span>1.50 ms
64 bytes from 10.170.108.237: <span class="nv">icmp_seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>128 <span class="nb">time</span><span class="o">=</span>1.18 ms

<span class="nt">---</span> 10.170.108.237 ping statistics <span class="nt">---</span>
2 packets transmitted, 2 received, 0% packet loss, <span class="nb">time </span>1003ms
rtt min/avg/max/mdev <span class="o">=</span> 1.175/1.338/1.501/0.163 ms</code></pre>
</div>
</div>
</li>
<li>
<p>Show the gateway Linux host (<code>192.168.91.137</code>) route:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>ip <span class="nt">-d</span> r
unicast default via 192.168.91.2 dev ens34 proto boot scope global
unicast 192.168.91.0/24 dev ens34 proto kernel scope <span class="nb">link </span>src 192.168.91.131
unicast 192.168.91.0/24 dev ens32 proto kernel scope <span class="nb">link </span>src 192.168.91.137</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>traceroute</code> at the source host (<code>192.168.91.128</code>) to print the route trace:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span><span class="nb">sudo </span>traceroute <span class="nt">-I</span> 10.170.108.237
traceroute to 10.170.108.237 <span class="o">(</span>10.170.108.237<span class="o">)</span>, 30 hops max, 60 byte packets
 1  192.168.91.131 <span class="o">(</span>192.168.91.131<span class="o">)</span>  2.323 ms  1.998 ms  1.781 ms
 2  192.168.91.2 <span class="o">(</span>192.168.91.2<span class="o">)</span>  1.636 ms  1.460 ms  1.162 ms
 3  10.170.108.237 <span class="o">(</span>10.170.108.237<span class="o">)</span>  3.304 ms  3.895 ms  6.811 ms</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="linux-ip-nixcraft"></a>[1] <a href="https://www.cyberciti.biz/faq/linux-ip-command-examples-usage-syntax/" class="bare">https://www.cyberciti.biz/faq/linux-ip-command-examples-usage-syntax/</a></p>
</li>
</ul>
</div>
</div>
</div>
<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
