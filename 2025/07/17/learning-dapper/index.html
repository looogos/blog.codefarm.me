<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Learning Dapper: A Lightweight ORM for .NET | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Learning Dapper: A Lightweight ORM for .NET" />
<meta property="og:locale" content="en" />
<meta name="description" content="Dapper offers a powerful yet lightweight solution for interacting with databases in .NET applications. Its high performance and minimal overhead make it an excellent choice for scenarios where fine-grained control over SQL and efficient data access are critical. This document has demonstrated Dapper’s versatility in handling various querying methods, from scalar values to multiple result sets, and its robust parameter handling capabilities, including anonymous and dynamic parameters, as well as support for ‘IN’ clauses. Furthermore, the implementation of optional filters and comprehensive pagination logic showcases Dapper’s flexibility in building efficient and scalable data access layers." />
<meta property="og:description" content="Dapper offers a powerful yet lightweight solution for interacting with databases in .NET applications. Its high performance and minimal overhead make it an excellent choice for scenarios where fine-grained control over SQL and efficient data access are critical. This document has demonstrated Dapper’s versatility in handling various querying methods, from scalar values to multiple result sets, and its robust parameter handling capabilities, including anonymous and dynamic parameters, as well as support for ‘IN’ clauses. Furthermore, the implementation of optional filters and comprehensive pagination logic showcases Dapper’s flexibility in building efficient and scalable data access layers." />
<link rel="canonical" href="https://blog.codefarm.me/2025/07/17/learning-dapper/" />
<meta property="og:url" content="https://blog.codefarm.me/2025/07/17/learning-dapper/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-07-17T19:12:46+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Learning Dapper: A Lightweight ORM for .NET" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-07-17T19:12:46+08:00","datePublished":"2025-07-17T19:12:46+08:00","description":"Dapper offers a powerful yet lightweight solution for interacting with databases in .NET applications. Its high performance and minimal overhead make it an excellent choice for scenarios where fine-grained control over SQL and efficient data access are critical. This document has demonstrated Dapper’s versatility in handling various querying methods, from scalar values to multiple result sets, and its robust parameter handling capabilities, including anonymous and dynamic parameters, as well as support for ‘IN’ clauses. Furthermore, the implementation of optional filters and comprehensive pagination logic showcases Dapper’s flexibility in building efficient and scalable data access layers.","headline":"Learning Dapper: A Lightweight ORM for .NET","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2025/07/17/learning-dapper/"},"url":"https://blog.codefarm.me/2025/07/17/learning-dapper/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">Learning Dapper: A Lightweight ORM for .NET</h1><p class="c-post-meta">17 Jul 2025</p>
  </header>

  <div class="c-post-content">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Dapper is a simple object mapper for .NET, often referred to as a "micro-ORM." It&#8217;s known for its high performance and minimal overhead, making it a popular choice for applications that need direct control over SQL queries while still benefiting from object mapping.</p>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#_setup">1. Setup</a>
<ul class="sectlevel2">
<li><a href="#entity-classes">1.1. Entity Classes</a></li>
<li><a href="#miniprofiler-integration">1.2. MiniProfiler Integration</a></li>
<li><a href="#database-setup-and-data-seeding">1.3. Database Setup and Data Seeding</a></li>
<li><a href="#console-output">1.4. Console Output</a></li>
</ul>
</li>
<li><a href="#_querying_data_with_dapper">2. Querying Data with Dapper</a>
<ul class="sectlevel2">
<li><a href="#querying-scalar-values">2.1. Querying Scalar Values</a></li>
<li><a href="#querying-single-row">2.2. Querying Single Row</a></li>
<li><a href="#querying-multiple-rows">2.3. Querying Multiple Rows</a></li>
<li><a href="#_query_multiple_results">2.4. Querying Multiple Results</a></li>
</ul>
</li>
<li><a href="#_parameter_handling_with_dapper">3. Parameter Handling with Dapper</a>
<ul class="sectlevel2">
<li><a href="#anonymous-parameters">3.1. Anonymous Parameters</a></li>
<li><a href="#dynamic-parameters">3.2. Dynamic Parameters</a></li>
<li><a href="#where-in-parameters">3.3. WHERE IN Parameters</a></li>
<li><a href="#_optional_filters">3.4. Best Practices for Optional Filters</a></li>
</ul>
</li>
<li><a href="#pagination-with-dapper">4. Pagination with Dapper</a></li>
<li><a href="#_extending_dapper_unmapped_columns">5. A Learning Example: Extending Dapper to Handle Unmapped Columns</a>
<ul class="sectlevel2">
<li><a href="#the-problem-unmapped-columns">5.1. The Problem: Unmapped Columns</a></li>
<li><a href="#the-solution-a-custom-extension-pattern">5.2. The Solution: A Custom Extension Pattern</a></li>
<li><a href="#implementation-walkthrough">5.3. Implementation Walkthrough</a>
<ul class="sectlevel3">
<li><a href="#1-the-marker-extradata-attribute">5.3.1. 1. The Marker: <code>[ExtraData]</code> Attribute</a></li>
<li><a href="#2-the-model-preparing-the-product-entity">5.3.2. 2. The Model: Preparing the <code>Product</code> Entity</a></li>
<li><a href="#3-the-core-dbconnectionextensions">5.3.3. 3. The Core: <code>DbConnectionExtensions</code></a></li>
<li><a href="#4-the-helper-datareaderextensions">5.3.4. 4. The Helper: <code>DataReaderExtensions</code></a></li>
</ul>
</li>
<li><a href="#putting-it-all-together">5.4. Putting It All Together</a></li>
</ul>
</li>
<li><a href="#_conclusion">6. Conclusion</a></li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_setup">1. Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To get started with Dapper, a simple console application can be set up. This involves creating a new project, adding the necessary NuGet packages, defining entity classes, and preparing a database schema with some seed data.</p>
</div>
<div class="paragraph">
<p>First, create a new console project and navigate into its directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh">dotnet new console <span class="nt">-o</span> Learning.Dapper <span class="nt">-f</span> net8.0
<span class="nb">cd </span>Learning.Dapper/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, add the required NuGet packages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh">dotnet add package Dapper <span class="nt">--version</span> 2.1.66
dotnet add package Microsoft.Data.Sqlite <span class="nt">--version</span> 9.0.7
dotnet add package MiniProfiler.AspNetCore <span class="nt">--version</span> 4.5.4</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="entity-classes">1.1. Entity Classes</h3>
<div class="paragraph">
<p>Two simple entity classes, <code>Category</code> and <code>Product</code>, are defined to map to the database tables.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Entities/Category.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">namespace</span> <span class="nn">Learning.Dapper.Entities</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Category</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">required</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Entities/Product.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">namespace</span> <span class="nn">Learning.Dapper.Entities</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Stock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">CategoryId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">ProductStatus</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">ProductCondition</span> <span class="n">Condition</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">enum</span> <span class="n">ProductStatus</span>
<span class="p">{</span>
    <span class="n">Available</span><span class="p">,</span>
    <span class="n">OutOfStock</span><span class="p">,</span>
    <span class="n">Discontinued</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">enum</span> <span class="n">ProductCondition</span>
<span class="p">{</span>
    <span class="n">New</span><span class="p">,</span>
    <span class="n">Used</span><span class="p">,</span>
    <span class="n">Refurbished</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="miniprofiler-integration">1.2. MiniProfiler Integration</h3>
<div class="paragraph">
<p>MiniProfiler is a simple yet effective mini-profiler for .NET applications. It helps in identifying performance bottlenecks by providing detailed timing information for various operations, including database queries.</p>
</div>
<div class="paragraph">
<p>To integrate MiniProfiler with Dapper, database connections are wrapped with <code>ProfiledDbConnection</code>. This allows MiniProfiler to automatically capture and display SQL execution times.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Program.cs (MiniProfiler Setup)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">Dapper</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Data.Sqlite</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">StackExchange.Profiling</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">StackExchange.Profiling.Data</span><span class="p">;</span>

<span class="c1">// Initialize MiniProfiler.</span>
<span class="kt">var</span> <span class="n">profiler</span> <span class="p">=</span> <span class="n">MiniProfiler</span><span class="p">.</span><span class="nf">StartNew</span><span class="p">(</span><span class="s">"Learn Dapper"</span><span class="p">);</span>  <span class="c1">// MiniProfiler.Current is the profiler now.</span>

<span class="c1">// Use in-memory SQLite database.</span>
<span class="k">using</span> <span class="nn">var</span> <span class="n">sqliteConnection</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SqliteConnection</span><span class="p">(</span><span class="s">"Data Source=:memory:"</span><span class="p">);</span>

<span class="c1">// Wrap connection with ProfiledDbConnection for Dapper (i.e., ADO.NET) profiling.</span>
<span class="k">using</span> <span class="nn">var</span> <span class="n">conn</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProfiledDbConnection</span><span class="p">(</span><span class="n">sqliteConnection</span><span class="p">,</span> <span class="n">profiler</span><span class="p">);</span>

<span class="n">conn</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Program.cs (MiniProfiler Setup)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="c1">/// Recursively prints the timing information collected by MiniProfiler,</span>
<span class="c1">/// including custom SQL timings for each step.</span>
<span class="k">static</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">PrintTimings</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Timing</span><span class="p">&gt;</span> <span class="n">timings</span><span class="p">,</span> <span class="kt">string</span> <span class="n">indent</span> <span class="p">=</span> <span class="s">""</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">timing</span> <span class="k">in</span> <span class="n">timings</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Display the name and duration of the current timing step.</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">indent</span><span class="p">}{</span><span class="n">timing</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> - </span><span class="p">{</span><span class="n">timing</span><span class="p">.</span><span class="n">DurationMilliseconds</span><span class="p">}</span><span class="s"> ms"</span><span class="p">);</span>

        <span class="c1">// If custom timings (e.g., SQL queries) exist for this step, print them.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">timing</span><span class="p">.</span><span class="n">CustomTimings</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">CustomTiming</span><span class="p">&gt;&gt;</span> <span class="n">pair</span> <span class="k">in</span> <span class="n">timing</span><span class="p">.</span><span class="n">CustomTimings</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="n">CustomTiming</span> <span class="n">customTiming</span> <span class="k">in</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">customTiming</span><span class="p">.</span><span class="n">CommandString</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kt">string</span> <span class="n">heading</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">indent</span><span class="p">}</span><span class="s">  [SQL]:"</span><span class="p">;</span>
                        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">heading</span><span class="p">);</span>
                        <span class="kt">string</span> <span class="n">prefix</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Repeat</span><span class="p">(</span><span class="s">" "</span><span class="p">,</span> <span class="n">heading</span><span class="p">.</span><span class="n">Length</span><span class="p">));</span>
                        <span class="k">using</span> <span class="nn">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringReader</span><span class="p">(</span><span class="n">customTiming</span><span class="p">.</span><span class="n">CommandString</span><span class="p">);</span>
                        <span class="kt">string</span><span class="p">?</span> <span class="n">line</span> <span class="p">=</span> <span class="k">await</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadLineAsync</span><span class="p">();</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">prefix</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">line</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                            <span class="n">line</span> <span class="p">=</span> <span class="k">await</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadLineAsync</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Recursively print child timings to maintain the hierarchy.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">timing</span><span class="p">.</span><span class="n">Children</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">timing</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">PrintTimings</span><span class="p">(</span><span class="n">timing</span><span class="p">.</span><span class="n">Children</span><span class="p">,</span> <span class="n">indent</span> <span class="p">+</span> <span class="s">"  "</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="database-setup-and-data-seeding">1.3. Database Setup and Data Seeding</h3>
<div class="paragraph">
<p>An in-memory SQLite database is used for simplicity. The <code>Program.cs</code> file handles the database connection, schema creation, and data seeding.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Program.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"INIT SCHEMA"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">schemaSql</span> <span class="p">=</span> <span class="k">await</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllTextAsync</span><span class="p">(</span><span class="s">@"sql/schema.sql"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">schemaSql</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"SEED DATA"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">seedSql</span> <span class="p">=</span> <span class="k">await</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllTextAsync</span><span class="p">(</span><span class="s">@"sql/seed.sql"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">seedSql</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Stop MiniProfiler session.</span>
<span class="k">await</span> <span class="n">profiler</span><span class="p">!.</span><span class="nf">StopAsync</span><span class="p">();</span>

<span class="c1">// Print profiling timings.</span>
<span class="nf">PrintTimings</span><span class="p">([</span><span class="n">profiler</span><span class="p">.</span><span class="n">Root</span><span class="p">]);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>sql</code> directory and the <code>schema.sql</code> and <code>seed.sql</code> files also need to be created within the <code>Learning.Dapper</code> project.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/sql/schema.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">Categories</span> <span class="p">(</span>
    <span class="n">Id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
    <span class="n">Name</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">Products</span> <span class="p">(</span>
    <span class="n">Id</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
    <span class="n">Name</span> <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">Description</span> <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">Price</span> <span class="nb">REAL</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">Stock</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">CategoryId</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">Status</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="c1">-- Mapped from ProductStatus enum</span>
    <span class="n">Condition</span> <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="c1">-- Mapped from ProductCondition enum</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">CategoryId</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Categories</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/sql/seed.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Categories</span> <span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Electronics'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Categories</span> <span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Books'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Categories</span> <span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Home &amp; Kitchen'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Categories</span> <span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Sports &amp; Outdoors'</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Laptop'</span><span class="p">,</span> <span class="s1">'Powerful laptop for work and gaming'</span><span class="p">,</span> <span class="mi">1200</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Smartphone'</span><span class="p">,</span> <span class="s1">'Latest model smartphone with advanced features'</span><span class="p">,</span> <span class="mi">800</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Headphones'</span><span class="p">,</span> <span class="s1">'Noise-cancelling over-ear headphones'</span><span class="p">,</span> <span class="mi">150</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Smart TV'</span><span class="p">,</span> <span class="s1">'4K UHD Smart TV with HDR'</span><span class="p">,</span> <span class="mi">750</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'The Hitchhiker</span><span class="se">''</span><span class="s1">s Guide to the Galaxy'</span><span class="p">,</span> <span class="s1">'A comedic science fiction series'</span><span class="p">,</span> <span class="mi">15</span><span class="p">.</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'1984'</span><span class="p">,</span> <span class="s1">'Dystopian social science fiction novel'</span><span class="p">,</span> <span class="mi">12</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'To Kill a Mockingbird'</span><span class="p">,</span> <span class="s1">'Classic American novel'</span><span class="p">,</span> <span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Coffee Maker'</span><span class="p">,</span> <span class="s1">'Automatic drip coffee maker'</span><span class="p">,</span> <span class="mi">45</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Blender'</span><span class="p">,</span> <span class="s1">'High-speed professional blender'</span><span class="p">,</span> <span class="mi">90</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Toaster'</span><span class="p">,</span> <span class="s1">'2-slice stainless steel toaster'</span><span class="p">,</span> <span class="mi">30</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Yoga Mat'</span><span class="p">,</span> <span class="s1">'Non-slip yoga mat for all types of yoga'</span><span class="p">,</span> <span class="mi">25</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Dumbbell Set'</span><span class="p">,</span> <span class="s1">'Adjustable dumbbell set (5-25 lbs)'</span><span class="p">,</span> <span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Products</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">CategoryId</span><span class="p">,</span> <span class="n">Status</span><span class="p">,</span> <span class="n">Condition</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Camping Tent'</span><span class="p">,</span> <span class="s1">'Lightweight 2-person camping tent'</span><span class="p">,</span> <span class="mi">120</span><span class="p">.</span><span class="mi">00</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="console-output">1.4. Console Output</h3>
<div class="paragraph">
<p>After running <code>dotnet run</code> in the <code>Learning.Dapper</code> directory, output similar to this should appear, indicating the schema initialization and data seeding were successful:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Learn Dapper - 189.45 ms
  [SQL]:
         Connection Open()
  INIT SCHEMA - 103.35 ms
    [SQL]:
           CREATE TABLE IF NOT EXISTS Categories (
               Id INTEGER PRIMARY KEY AUTOINCREMENT,
               Name TEXT NOT NULL
</span><span class="gp">           );</span><span class="w">
</span><span class="go">
           CREATE TABLE IF NOT EXISTS Products (
               Id INTEGER PRIMARY KEY AUTOINCREMENT,
               Name TEXT NOT NULL,
               Description TEXT NULL,
               Price REAL NOT NULL,
               Stock INTEGER NOT NULL,
               CategoryId INTEGER NOT NULL,
               Status INTEGER NOT NULL,
               CONDITION TEXT NOT NULL,
               FOREIGN KEY (CategoryId) REFERENCES Categories (Id)
</span><span class="gp">           );</span><span class="w">
</span><span class="go">  SEED DATA - 2.97 ms
    [SQL]:
</span><span class="gp">           INSERT INTO Categories (Name) VALUES ('Electronics');</span><span class="w">
</span><span class="gp">           INSERT INTO Categories (Name) VALUES ('Books');</span><span class="w">
</span><span class="gp">           INSERT INTO Categories (Name) VALUES ('Home &amp; Kitchen');</span><span class="w">
</span><span class="gp">           INSERT INTO Categories (Name) VALUES ('Sports &amp; Outdoors');</span><span class="w">
</span><span class="go">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Laptop', 'Powerful laptop for work and gaming', 1200.00, 50, 1, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Smartphone', 'Latest model smartphone with advanced features', 800.00, 150, 1, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Headphones', 'Noise-cancelling over-ear headphones', 150.00, 100, 1, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Smart TV', '4K UHD Smart TV with HDR', 750.00, 30, 1, 0, 'New');</span><span class="w">
</span><span class="go">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('The Hitchhiker''s Guide to the Galaxy', 'A comedic science fiction series', 15.50, 200, 2, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('1984', 'Dystopian social science fiction novel', 12.00, 180, 2, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('To Kill a Mockingbird', 'Classic American novel', 10.00, 250, 2, 0, 'New');</span><span class="w">
</span><span class="go">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Coffee Maker', 'Automatic drip coffee maker', 45.00, 70, 3, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Blender', 'High-speed professional blender', 90.00, 60, 3, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Toaster', '2-slice stainless steel toaster', 30.00, 90, 3, 0, 'New');</span><span class="w">
</span><span class="go">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Yoga Mat', 'Non-slip yoga mat for all types of yoga', 25.00, 120, 4, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Dumbbell Set', 'Adjustable dumbbell set (5-25 lbs)', 100.00, 40, 4, 0, 'New');</span><span class="w">
</span><span class="gp">           INSERT INTO Products (Name, Description, Price, Stock, CategoryId, Status, Condition) VALUES ('Camping Tent', 'Lightweight 2-person camping tent', 120.00, 25, 4, 0, 'New');</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_querying_data_with_dapper">2. Querying Data with Dapper</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dapper provides a rich set of methods for querying data, from single scalar values to multiple result sets. Let&#8217;s explore some of the most commonly used querying methods.</p>
</div>
<div class="sect2">
<h3 id="querying-scalar-values">2.1. Querying Scalar Values</h3>
<div class="paragraph">
<p>Dapper provides methods to retrieve a single value (a scalar) from a database query. This is useful for operations like getting a count, sum, or any single piece of data.</p>
</div>
<div class="paragraph">
<p>The primary method for querying scalar values is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ExecuteScalarAsync&lt;T&gt;()</code>: Executes a command and returns the first column of the first row in the result set returned by the query as a <code>T</code> type. Additional columns or rows are ignored. This is typically used for <code>SELECT COUNT(*)</code>, <code>SELECT MAX(Id)</code>, etc.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Query Scalar Values"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Get the total count of products</span>
    <span class="kt">var</span> <span class="n">productCount</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">ExecuteScalarAsync</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="s">"SELECT COUNT(*) FROM Products"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Total Products: </span><span class="p">{</span><span class="n">productCount</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Get the maximum product price</span>
    <span class="kt">var</span> <span class="n">maxPrice</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">ExecuteScalarAsync</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;(</span><span class="s">"SELECT MAX(Price) FROM Products"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Maximum Product Price: </span><span class="p">{</span><span class="n">maxPrice</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Get the name of a specific category (e.g., CategoryId = 1)</span>
    <span class="kt">var</span> <span class="n">categoryName</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">ExecuteScalarAsync</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">"SELECT Name FROM Categories WHERE Id = @Id"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Category Name for Id 1: </span><span class="p">{</span><span class="n">categoryName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Attempt to get a non-existent category name (will return null/default)</span>
    <span class="kt">var</span> <span class="n">nonExistentCategoryName</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">ExecuteScalarAsync</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">"SELECT Name FROM Categories WHERE Id = @Id"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">999</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Category Name for Id 999: </span><span class="p">{</span><span class="n">nonExistentCategoryName</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="querying-single-row">2.2. Querying Single Row</h3>
<div class="paragraph">
<p>When expecting a query to return at most one row, Dapper provides several convenient methods to map that single row to a C# object:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>QueryFirstOrDefaultAsync&lt;T&gt;()</code>: Executes a query and maps the <strong>first</strong> row to a <code>T</code> type. If no rows are returned, it returns <code>default(T)</code>. If multiple rows are returned, it still returns only the first one without throwing an exception. This is generally the safest option when you&#8217;re unsure if a row will be found.</p>
</li>
<li>
<p><code>QuerySingleOrDefaultAsync&lt;T&gt;()</code>: Executes a query and maps <strong>exactly one</strong> row to a <code>T</code> type. If no rows are returned, it returns <code>default(T)</code>. If <strong>more than one</strong> row is returned, it throws an <code>InvalidOperationException</code>. Use this when you strictly expect zero or one result.</p>
</li>
<li>
<p><code>QueryFirstAsync&lt;T&gt;()</code>: Executes a query and maps the <strong>first</strong> row to a <code>T</code> type. If no rows are returned, it throws an <code>InvalidOperationException</code>. If multiple rows are returned, it still returns only the first one. Use this when you strictly expect at least one result.</p>
</li>
<li>
<p><code>QuerySingleAsync&lt;T&gt;()</code>: Executes a query and maps <strong>exactly one</strong> row to a <code>T</code> type. If no rows are returned or if more than one row is returned, it throws an <code>InvalidOperationException</code>. Use this when you strictly expect exactly one result.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s see these in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Query Single Row"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Query a product by Id using QueryFirstOrDefaultAsync</span>
    <span class="kt">var</span> <span class="n">product1</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryFirstOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Id = @Id"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Product 1 (QueryFirstOrDefault): </span><span class="p">{</span><span class="n">product1</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Query a non-existent product using QueryFirstOrDefaultAsync</span>
    <span class="kt">var</span> <span class="n">product999</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryFirstOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Id = @Id"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">999</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Product 999 (QueryFirstOrDefault): </span><span class="p">{</span><span class="n">product999</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Query a product by Id using QuerySingleOrDefaultAsync (expecting 0 or 1 result)</span>
    <span class="kt">var</span> <span class="n">product2</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QuerySingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Id = @Id"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">2</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Product 2 (QuerySingleOrDefault): </span><span class="p">{</span><span class="n">product2</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Example of QuerySingleAsync (expecting exactly one result)</span>
    <span class="c1">// This will throw an exception if the query returns zero or more than one result.</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">product3</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QuerySingleAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Id = @Id"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">3</span> <span class="p">});</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Product 3 (QuerySingle): </span><span class="p">{</span><span class="n">product3</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Error QuerySingle (Product 3): </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Demonstrate QuerySingleOrDefaultAsync throwing an exception for multiple results</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="c1">// This query will return multiple products, causing QuerySingleOrDefaultAsync to throw</span>
        <span class="kt">var</span> <span class="n">multipleProducts</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QuerySingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE CategoryId = @CategoryId"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">CategoryId</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Multiple Products (QuerySingleOrDefault): </span><span class="p">{</span><span class="n">multipleProducts</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Error QuerySingleOrDefault (Multiple Products): </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Querying Single Values vs. Single Rows</p>
</div>
<div class="paragraph">
<p>While <code>QueryFirstAsync</code>, <code>QueryFirstOrDefaultAsync</code>, <code>QuerySingleAsync</code>, and <code>QuerySingleOrDefaultAsync</code> can technically retrieve a single value if the SQL query selects only one column, <code>ExecuteScalarAsync&lt;T&gt;()</code> is the preferred and most semantically appropriate method for such scenarios.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ExecuteScalarAsync&lt;T&gt;()</code> is optimized for retrieving a single, scalar value (e.g., <code>COUNT(*)</code>, <code>MAX(Price)</code>). It efficiently fetches only the first column of the first row and ignores all other data, even if the SQL query selects multiple columns.</p>
</li>
<li>
<p>The <code>QueryXAsync</code> methods are primarily designed for mapping a single <strong>row</strong> of data to a C# <strong>object</strong>. When used to retrieve a single column (or when mapping to a primitive type from a multi-column query), they also extract the value from the first column of the first row. However, this usage can lead to data loss if other columns are intended to be used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For clarity, performance, and to express intent, use <code>ExecuteScalarAsync&lt;T&gt;()</code> when expecting a single value, and the <code>QueryXAsync</code> methods when mapping a single row to a structured object. If a <code>QueryXAsync</code> method is used with a multi-column query and mapped to a primitive type, only the first column&#8217;s value will be retrieved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Querying Single Values vs. Single Rows Example"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// SQL query selecting multiple columns</span>
    <span class="kt">var</span> <span class="n">sqlMultiColumn</span> <span class="p">=</span> <span class="s">"SELECT Price, Name, Description FROM Products ORDER BY Id LIMIT 1;"</span><span class="p">;</span>

    <span class="c1">// Using ExecuteScalarAsync&lt;T&gt; with a multi-column query:</span>
    <span class="c1">// Only the first column (Price) will be retrieved.</span>
    <span class="kt">var</span> <span class="n">priceScalar</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">ExecuteScalarAsync</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;(</span><span class="n">sqlMultiColumn</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"ExecuteScalarAsync&lt;decimal&gt; (multi-column, first column): </span><span class="p">{</span><span class="n">priceScalar</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Using QueryFirstAsync&lt;T&gt; with a multi-column query mapped to a primitive type:</span>
    <span class="c1">// Only the first column (Price) will be retrieved.</span>
    <span class="kt">var</span> <span class="n">priceQueryFirst</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryFirstAsync</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;(</span><span class="n">sqlMultiColumn</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"QueryFirstAsync&lt;decimal&gt; (multi-column, first column): </span><span class="p">{</span><span class="n">priceQueryFirst</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Using QuerySingleAsync&lt;T&gt; with a multi-column query mapped to a primitive type:</span>
    <span class="c1">// Only the first column (Price) will be retrieved. This will throw an exception if more than one row is returned.</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">priceQuerySingle</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QuerySingleAsync</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;(</span><span class="n">sqlMultiColumn</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"QuerySingleAsync&lt;decimal&gt; (multi-column, first column): </span><span class="p">{</span><span class="n">priceQuerySingle</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidOperationException</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Error QuerySingleAsync&lt;decimal&gt; (multi-column): </span><span class="p">{</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Using QueryFirstAsync&lt;T&gt; with a multi-column query mapped to an object:</span>
    <span class="c1">// All columns will be mapped to the Product object.</span>
    <span class="kt">var</span> <span class="n">productObject</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryFirstAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="n">sqlMultiColumn</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"QueryFirstAsync&lt;Product&gt; (multi-column): </span><span class="p">{</span><span class="n">productObject</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">, Price: </span><span class="p">{</span><span class="n">productObject</span><span class="p">.</span><span class="n">Price</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">, Description: </span><span class="p">{</span><span class="n">productObject</span><span class="p">.</span><span class="n">Description</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="querying-multiple-rows">2.3. Querying Multiple Rows</h3>
<div class="paragraph">
<p>When a query is expected to return multiple rows, Dapper&#8217;s <code>QueryAsync&lt;T&gt;()</code> method is used. This method executes the SQL query and maps each returned row to an instance of the specified C# type <code>T</code>. The results are returned as an <code>IEnumerable&lt;T&gt;</code>, allowing for flexible iteration and manipulation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Query Multiple Rows"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Query all products</span>
    <span class="kt">var</span> <span class="n">allProducts</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- All Products ---"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">product</span> <span class="k">in</span> <span class="n">allProducts</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> (Price: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Price</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">, Stock: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Stock</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Query products by CategoryId</span>
    <span class="kt">var</span> <span class="n">electronicsProducts</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE CategoryId = @CategoryId"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">CategoryId</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Electronics Products ---"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">product</span> <span class="k">in</span> <span class="n">electronicsProducts</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Query products with a price greater than a certain value</span>
    <span class="kt">var</span> <span class="n">expensiveProducts</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Price &gt; @MinPrice"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">MinPrice</span> <span class="p">=</span> <span class="m">100.00m</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Expensive Products (&gt; $100) ---"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">product</span> <span class="k">in</span> <span class="n">expensiveProducts</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> (Price: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Price</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In these examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>QueryAsync&lt;Product&gt;("SELECT * FROM Products")</code> retrieves all products and maps them to a collection of <code>Product</code> objects.</p>
</li>
<li>
<p>Parameterized queries, such as <code>SELECT * FROM Products WHERE CategoryId = @CategoryId</code>, are used to filter results. Dapper automatically handles parameter mapping, preventing SQL injection vulnerabilities.</p>
</li>
<li>
<p>The results are iterated over using a <code>foreach</code> loop, demonstrating how to access the mapped C# objects.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_query_multiple_results">2.4. Querying Multiple Results</h3>
<div class="paragraph">
<p>Dapper&#8217;s <code>QueryMultipleAsync</code> method allows executing multiple SQL queries in a single round trip to the database and mapping them to different object types. This is highly efficient for related data.</p>
</div>
<div class="paragraph">
<p>This feature relies on the underlying database driver&#8217;s ability to return multiple result sets from a single command execution. Many relational database management systems (RDBMS) support this, including SQL Server, MySQL, and SQLite (as demonstrated here). It is particularly useful for scenarios where fetching related data from different tables might not be easily joined, or when optimizing network round trips.</p>
</div>
<div class="paragraph">
<p>When using <code>QueryMultipleAsync</code>, Dapper returns an <code>SqlMapper.GridReader</code> object, which acts as a cursor over the multiple result sets. Each result set must be read in the order returned by the SQL query.</p>
</div>
<div class="paragraph">
<p>The <code>GridReader</code> provides several <code>Read</code> and <code>ReadAsync</code> methods to consume the results:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ReadAsync&lt;T&gt;()</code>: Reads all rows from the current result set and maps them to a collection of type <code>T</code>.</p>
</li>
<li>
<p><code>ReadFirstAsync&lt;T&gt;()</code>: Reads the first row from the current result set and maps it to type <code>T</code>. Throws an exception if no rows are returned.</p>
</li>
<li>
<p><code>ReadFirstOrDefaultAsync&lt;T&gt;()</code>: Reads the first row from the current result set and maps it to type <code>T</code>. Returns <code>default(T)</code> if no rows are returned.</p>
</li>
<li>
<p><code>ReadSingleAsync&lt;T&gt;()</code>: Reads exactly one row from the current result set and maps it to type <code>T</code>. Throws an exception if no rows or more than one row are returned.</p>
</li>
<li>
<p><code>ReadSingleOrDefaultAsync&lt;T&gt;()</code>: Reads exactly one row from the current result set and maps it to type <code>T</code>. Returns <code>default(T)</code> if no rows are returned, throws if more than one row.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Query Multiple Results"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">multi</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">QueryMultipleAsync</span><span class="p">(</span><span class="s">"SELECT Id, Name, Description, Price, Stock, CategoryId, Status, Condition FROM Products; SELECT Id, Name FROM Categories;"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// Read the first result set (Products)</span>
        <span class="kt">var</span> <span class="n">products</span> <span class="p">=</span> <span class="k">await</span> <span class="n">multi</span><span class="p">.</span><span class="n">ReadAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>

        <span class="c1">// Read the second result set (Categories)</span>
        <span class="kt">var</span> <span class="n">categories</span> <span class="p">=</span> <span class="k">await</span> <span class="n">multi</span><span class="p">.</span><span class="n">ReadAsync</span><span class="p">&lt;</span><span class="n">Category</span><span class="p">&gt;();</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- All Products (from multi-query) ---"</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">product</span> <span class="k">in</span> <span class="n">products</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> (Price: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Price</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">, CategoryId: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">CategoryId</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- All Categories (from multi-query) ---"</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">category</span> <span class="k">in</span> <span class="n">categories</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">category</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> (Id: </span><span class="p">{</span><span class="n">category</span><span class="p">.</span><span class="n">Id</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parameter_handling_with_dapper">3. Parameter Handling with Dapper</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dapper excels at mapping query parameters to C# objects. Let&#8217;s look at how to handle different types of parameters, including enums and <code>IN</code> clauses.</p>
</div>
<div class="sect2">
<h3 id="anonymous-parameters">3.1. Anonymous Parameters</h3>
<div class="paragraph">
<p>Dapper supports passing parameters to SQL queries using anonymous objects. This is a common and convenient way to provide values for placeholders in SQL statements. Dapper automatically maps properties of the anonymous object to parameters in the query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Anonymous Parameters"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Single parameter</span>
    <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryFirstOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Id = @ProductId"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">ProductId</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Product (Anonymous Parameter): </span><span class="p">{</span><span class="n">product</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Multiple parameters</span>
    <span class="kt">var</span> <span class="n">products</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE CategoryId = @CategoryId AND Stock &gt; @MinStock"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">CategoryId</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">MinStock</span> <span class="p">=</span> <span class="m">10</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Products with Anonymous Parameters (CategoryId = 1, Stock &gt; 10) ---"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">products</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Parameter with a different name than the property (Dapper matches by name)</span>
    <span class="kt">var</span> <span class="n">category</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryFirstOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Category</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Categories WHERE Name = @CategoryName"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">CategoryName</span> <span class="p">=</span> <span class="s">"Books"</span> <span class="p">});</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Category (Anonymous Parameter): </span><span class="p">{</span><span class="n">category</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An anonymous object <code>{ ProductId = 1 }</code> is used to pass a single parameter.</p>
</li>
<li>
<p>An anonymous object <code>{ CategoryId = 1, MinStock = 10 }</code> is used for multiple parameters.</p>
</li>
<li>
<p>Dapper matches the property names of the anonymous object (<code>ProductId</code>, <code>CategoryId</code>, <code>MinStock</code>, <code>CategoryName</code>) to the parameter placeholders in the SQL query (<code>@ProductId</code>, <code>@CategoryId</code>, <code>@MinStock</code>, <code>@CategoryName</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This approach offers a concise syntax for parameterization, enhancing readability and preventing SQL injection by ensuring values are properly escaped.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When passing enum values as parameters, it is crucial to ensure they are converted to a type that the database understands (e.g., <code>TEXT</code> or <code>INTEGER</code>). If not handled correctly, Dapper might pass the integer representation of the enum, which could lead to unexpected results if the database expects a string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Enum Parameter"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Example with ProductStatus enum</span>
    <span class="c1">// WRONG: INTEGER (if database expects string)</span>
    <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">QueryAsync</span><span class="p">(</span><span class="s">"SELECT Id, Name FROM Products WHERE Status = @Status"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Status</span> <span class="p">=</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Available</span> <span class="p">});</span>

    <span class="c1">// GOOD: TEXT (if database expects string)</span>
    <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">QueryAsync</span><span class="p">(</span><span class="s">"SELECT Id, Name FROM Products WHERE Status = @Status"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Status</span> <span class="p">=</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">OutOfStock</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()</span> <span class="p">});</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Explicitly converting the enum to a string using <code>.ToString()</code> ensures that the correct text value is passed to the database.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="dynamic-parameters">3.2. Dynamic Parameters</h3>
<div class="paragraph">
<p>For more complex scenarios or when parameter names and values are determined at runtime, Dapper provides the <code>DynamicParameters</code> class. This class allows for programmatic construction of parameter collections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Dynamic Parameters"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Single parameter</span>
    <span class="c1">// 1.</span>
    <span class="c1">//   var parameters = new DynamicParameters({ ProductId = 1 });</span>
    <span class="c1">// 2.</span>
    <span class="c1">//   var dictionary = new Dictionary&lt;string, object&gt;</span>
    <span class="c1">//   {</span>
    <span class="c1">//       { "@ProductId", 1 }</span>
    <span class="c1">//   };</span>
    <span class="c1">//   var parameters = new DynamicParameters(dictionary);</span>
    <span class="c1">// 3.</span>
    <span class="c1">//   var template = new Product { ProductId = 1 };</span>
    <span class="c1">//   var parameters = new DynamicParameters(template);</span>
    <span class="c1">// 4.</span>
    <span class="c1">//   var singleParam = new DynamicParameters();</span>
    <span class="c1">//   singleParam.Add("ProductId", 1);</span>
    <span class="kt">var</span> <span class="n">singleParam</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicParameters</span><span class="p">();</span>
    <span class="n">singleParam</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"@ProductId"</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryFirstOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Id = @ProductId"</span><span class="p">,</span> <span class="n">singleParam</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Product (Dynamic Parameter): </span><span class="p">{</span><span class="n">product</span><span class="p">?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">"Not Found"</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Multiple parameters</span>
    <span class="kt">var</span> <span class="n">multipleParams</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicParameters</span><span class="p">();</span>
    <span class="n">multipleParams</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"CategoryId"</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="n">multipleParams</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"MinStock"</span><span class="p">,</span> <span class="m">10</span><span class="p">);</span>
    <span class="n">multipleParams</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Status"</span><span class="p">,</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Available</span><span class="p">);</span> <span class="c1">// Dapper handles enum to underlying type (int) conversion automatically</span>
    <span class="n">multipleParams</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Condition"</span><span class="p">,</span> <span class="n">ProductCondition</span><span class="p">.</span><span class="n">New</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span> <span class="c1">// Convert enum to string for database if column is TEXT</span>
    <span class="kt">var</span> <span class="n">products</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE CategoryId = @CategoryId AND Stock &gt; @MinStock AND Status = @Status AND Condition = @Condition"</span><span class="p">,</span> <span class="n">multipleParams</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Products with Dynamic Parameters (CategoryId = 1, Stock &gt; 10) ---"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">products</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An instance of <code>DynamicParameters</code> is created.</p>
</li>
<li>
<p>Parameters are added using the <code>Add</code> method, specifying the parameter name (including the optional <code>@</code> prefix) and its value.</p>
</li>
<li>
<p>For multiple parameters, all parameters are added to the same <code>DynamicParameters</code> object.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>DynamicParameters</code> offers greater control over parameter types, directions (input, output, return value), and sizes, making it suitable for advanced scenarios like stored procedures with output parameters.</p>
</div>
</div>
<div class="sect2">
<h3 id="where-in-parameters">3.3. WHERE IN Parameters</h3>
<div class="paragraph">
<p>Dapper simplifies handling <code>WHERE IN</code> clauses by allowing collections to be passed directly as parameters.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Dapper will automatically expand the collection into a list of parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Method 1: Using an Anonymous Object (Recommended)</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cs"><span class="c1">// C# Code</span>
<span class="kt">var</span> <span class="n">ids</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span> <span class="p">};</span>

<span class="kt">var</span> <span class="n">sql</span> <span class="p">=</span> <span class="s">"SELECT * FROM YourTable WHERE Id IN @Ids"</span><span class="p">;</span>

<span class="c1">// Dapper will expand the 'ids' array automatically</span>
<span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="n">YourType</span><span class="p">&gt;(</span><span class="n">sql</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Ids</span> <span class="p">=</span> <span class="n">ids</span> <span class="p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dapper translates this into a parameterized query similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="c1">-- SQL generated by Dapper (conceptual)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">YourTable</span> <span class="k">WHERE</span> <span class="n">Id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">@</span><span class="n">Ids1</span><span class="p">,</span> <span class="o">@</span><span class="n">Ids2</span><span class="p">,</span> <span class="o">@</span><span class="n">Ids3</span><span class="p">,</span> <span class="o">@</span><span class="n">Ids4</span><span class="p">,</span> <span class="o">@</span><span class="n">Ids5</span><span class="p">)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Method 2: Using <code>DynamicParameters</code></p>
<div class="paragraph">
<p>The principle is the sam to build parameters dynamically by using <code>DynamicParameters</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="cs"><span class="c1">// C# Code</span>
<span class="kt">var</span> <span class="n">ids</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span> <span class="p">};</span>

<span class="kt">var</span> <span class="n">sql</span> <span class="p">=</span> <span class="s">"SELECT * FROM YourTable WHERE Id IN @Ids"</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicParameters</span><span class="p">();</span>
<span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"@Ids"</span><span class="p">,</span> <span class="n">ids</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">Query</span><span class="p">&lt;</span><span class="n">YourType</span><span class="p">&gt;(</span><span class="n">sql</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In both cases, the key is to pass an <code>IEnumerable&lt;T&gt;</code> (like an array <code>T[]</code> or a <code>List&lt;T&gt;</code>) as the value for the parameter used in the <code>IN</code> clause. Dapper handles the rest.</p>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper WHERE IN Parameters"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Anonymous Parameters (IN)"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">productNames</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="s">"Laptop"</span><span class="p">,</span> <span class="s">"Smartphone"</span> <span class="p">};</span>
        <span class="kt">var</span> <span class="n">productsByName</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Name IN @ProductNames"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">ProductNames</span> <span class="p">=</span> <span class="n">productNames</span> <span class="p">});</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Products by Name (Laptop, Smartphone) ---"</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">productsByName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Dynamic Parameters (IN)"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicParameters</span><span class="p">();</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"@ProductIds"</span><span class="p">,</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[]</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">3</span> <span class="p">});</span>
        <span class="kt">var</span> <span class="n">productsById</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Id IN @ProductIds"</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Products by Id (1, 3) ---"</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">productsById</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Dapper Anonymous Parameters (Enum IN)"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// WRONG: INTEGER (if database expects string)</span>
        <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">QueryAsync</span><span class="p">(</span><span class="s">"SELECT * FROM Products WHERE Status IN @Statuses"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Statuses</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProductStatus</span><span class="p">[]</span> <span class="p">{</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Available</span><span class="p">,</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Discontinued</span> <span class="p">}</span> <span class="p">});</span>

        <span class="c1">// GOOD: TEXT (if database expects string)</span>
        <span class="kt">var</span> <span class="n">productStatuses</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Available</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(),</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">OutOfStock</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()</span> <span class="p">};</span>
        <span class="kt">var</span> <span class="n">productsByStatus</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">"SELECT * FROM Products WHERE Status IN @Statuses"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Statuses</span> <span class="p">=</span> <span class="n">productStatuses</span> <span class="p">});</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Products by Status (Available, OutOfStock) ---"</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">productsByStatus</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> (Status: </span><span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">Status</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both anonymous objects and <code>DynamicParameters</code> can be used. For enum collections in <code>IN</code> clauses, the same principle applies: convert them to strings to match the database&#8217;s expected type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">  Dapper WHERE IN Parameters - 191.37 ms
    Dapper Anonymous Parameters (IN) - 169.38 ms
      [SQL]:
             SELECT * FROM Products WHERE Name IN ('Laptop', 'Smartphone')
    Dapper Dynamic Parameters (IN) - 10.87 ms
      [SQL]:
             SELECT * FROM Products WHERE Id IN (1, 3)
    Dapper Anonymous Parameters (Enum IN) - 10.95 ms
      [SQL]:
             SELECT * FROM Products WHERE Status IN (0, 2)
      [SQL]:
             SELECT * FROM Products WHERE Status IN ('Available', 'OutOfStock')</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_optional_filters">3.4. Best Practices for Optional Filters</h3>
<div class="paragraph">
<p>When building queries with optional search criteria, <code>DynamicParameters</code> combined with conditional logic provides a clean and flexible approach. This avoids string concatenation, which can be error-prone and lead to SQL injection vulnerabilities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Best Practices for Optional Filters"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="c1">// Simulate a search request with optional parameters</span>
    <span class="kt">string</span><span class="p">?</span> <span class="n">searchName</span> <span class="p">=</span> <span class="s">"Laptop"</span><span class="p">;</span> <span class="c1">// Can be null or empty</span>
    <span class="kt">decimal</span><span class="p">?</span> <span class="n">minPrice</span> <span class="p">=</span> <span class="m">500.00m</span><span class="p">;</span> <span class="c1">// Can be null</span>
    <span class="n">ProductStatus</span><span class="p">?</span> <span class="n">productStatus</span> <span class="p">=</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Available</span><span class="p">;</span> <span class="c1">// Can be null</span>
    <span class="n">ProductCondition</span><span class="p">?</span> <span class="n">productCondition</span> <span class="p">=</span> <span class="n">ProductCondition</span><span class="p">.</span><span class="n">New</span><span class="p">;</span> <span class="c1">// Can be null</span>

    <span class="kt">var</span> <span class="n">sql</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">(</span><span class="s">"SELECT * FROM Products WHERE 1=1"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicParameters</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">searchName</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sql</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">" AND Name LIKE @Name"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"@Name"</span><span class="p">,</span> <span class="s">$"%</span><span class="p">{</span><span class="n">searchName</span><span class="p">}</span><span class="s">%"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">minPrice</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sql</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">" AND Price &gt;= @MinPrice"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"@MinPrice"</span><span class="p">,</span> <span class="n">minPrice</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">productStatus</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sql</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">" AND Status = @Status"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"@Status"</span><span class="p">,</span> <span class="n">productStatus</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span> <span class="c1">// Convert enum to string</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">productCondition</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sql</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="s">" AND Condition = @Condition"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"@Condition"</span><span class="p">,</span> <span class="n">productCondition</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span> <span class="c1">// Convert enum to string</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">filteredProducts</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="n">sql</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(),</span> <span class="n">parameters</span><span class="p">);</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\n--- Filtered Products ---"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">product</span> <span class="k">in</span> <span class="n">filteredProducts</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> (Price: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Price</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">, Status: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Status</span><span class="p">}</span><span class="s">, Condition: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Condition</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A base <code>WHERE 1=1</code> clause is used to allow easy appending of <code>AND</code> conditions.</p>
</li>
<li>
<p><code>StringBuilder</code> dynamically constructs the SQL query based on the presence of optional parameters.</p>
</li>
<li>
<p><code>DynamicParameters</code> is used to add parameters conditionally, ensuring proper parameterization and preventing SQL injection.</p>
</li>
<li>
<p>Enum values are converted to strings before being added as parameters, assuming the database stores them as text.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pagination-with-dapper">4. Pagination with Dapper</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pagination is a common requirement for displaying large datasets. Dapper, combined with SQL&#8217;s <code>LIMIT</code> (or <code>TOP</code> in SQL Server) and <code>OFFSET</code> clauses, makes implementing pagination straightforward. It&#8217;s often efficient to retrieve both the paginated results and the total count in a single database call using <code>QueryMultipleAsync</code>.</p>
</div>
<div class="paragraph">
<p>To encapsulate pagination logic and optional filtering, request and result classes are defined:</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Paginator/PaginationRequest.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Learning.Dapper.Paginator</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PaginationRequest</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="kt">int</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">,</span> <span class="n">ErrorMessage</span> <span class="p">=</span> <span class="s">"{0} must be greater than or equal to {1}."</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span><span class="p">?</span> <span class="n">PageNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// 1-based</span>

    <span class="p">[</span><span class="nf">Range</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="kt">int</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">,</span> <span class="n">ErrorMessage</span> <span class="p">=</span> <span class="s">"{0} must be greater than or equal to {1}."</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">int</span><span class="p">?</span> <span class="n">PageSize</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">MinLength</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">ErrorMessage</span> <span class="p">=</span> <span class="s">"At least one {0} is required."</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">SortedField</span><span class="p">&gt;</span> <span class="n">SortFields</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SortedField</span><span class="p">&gt;();</span>

    <span class="k">public</span> <span class="n">PaginationQuery</span> <span class="nf">AsQuery</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PaginationQuery</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">SortedField</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">SortedDirection</span> <span class="n">Direction</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">enum</span> <span class="n">SortedDirection</span>
<span class="p">{</span>
    <span class="n">Asc</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
    <span class="n">Desc</span> <span class="p">=</span> <span class="m">1</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Paginator/PaginationQuery.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Learning.Dapper.Paginator</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PaginationQuery</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">PageNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">PageSize</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Offset</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// 0-based</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Limit</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">IReadOnlyList</span><span class="p">&lt;</span><span class="n">SortedField</span><span class="p">&gt;</span> <span class="n">SortedFields</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="nf">PaginationQuery</span><span class="p">(</span><span class="n">PaginationRequest</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">PageNumber</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">PageNumber</span> <span class="p">??</span> <span class="m">1</span><span class="p">;</span>
        <span class="n">PageSize</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">PageSize</span> <span class="p">??</span> <span class="m">10</span><span class="p">;</span>
        <span class="n">Offset</span> <span class="p">=</span> <span class="p">(</span><span class="n">PageNumber</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">PageSize</span><span class="p">;</span>
        <span class="n">Limit</span> <span class="p">=</span> <span class="n">PageSize</span><span class="p">;</span>
        <span class="n">SortedFields</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">SortFields</span> <span class="p">??</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SortedField</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="nf">AsOrderBy</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;?</span> <span class="n">allowedFields</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">SortedFields</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="p">!</span><span class="n">SortedFields</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">validSortFields</span> <span class="p">=</span> <span class="n">SortedFields</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="n">allowedFields</span><span class="p">?.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">StringComparer</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(!</span><span class="n">validSortFields</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">orderByClauses</span> <span class="p">=</span> <span class="n">validSortFields</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="s">$"</span><span class="p">{</span><span class="n">f</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">f</span><span class="p">.</span><span class="n">Direction</span><span class="p">.</span><span class="nf">ToString</span><span class="p">().</span><span class="nf">ToUpper</span><span class="p">()}</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="s">$"ORDER BY </span><span class="p">{</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">", "</span><span class="p">,</span> <span class="n">orderByClauses</span><span class="p">)}</span><span class="s">"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Paginator/PaginationResult.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">namespace</span> <span class="nn">Learning.Dapper.Paginator</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PaginationResult</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Items</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">TotalCount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">PageNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">PageSize</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">TotalPages</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Ceiling</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">TotalCount</span> <span class="p">/</span> <span class="n">PageSize</span><span class="p">);</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="n">HasPreviousPage</span> <span class="p">=&gt;</span> <span class="n">PageNumber</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="n">HasNextPage</span> <span class="p">=&gt;</span> <span class="n">PageNumber</span> <span class="p">&lt;</span> <span class="n">TotalPages</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">PaginationResult</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">items</span><span class="p">,</span> <span class="kt">int</span> <span class="n">totalCount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pageNumber</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pageSize</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Items</span> <span class="p">=</span> <span class="n">items</span> <span class="p">??</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
        <span class="n">TotalCount</span> <span class="p">=</span> <span class="n">totalCount</span><span class="p">;</span>
        <span class="n">PageNumber</span> <span class="p">=</span> <span class="n">pageNumber</span><span class="p">;</span>
        <span class="n">PageSize</span> <span class="p">=</span> <span class="n">pageSize</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Requests/ProductListRequest.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">Learning.Dapper.Paginator</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Learning.Dapper.Models</span><span class="p">;</span>

<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">ProductListRequest</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">Keyword</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// search for Id or name</span>

    <span class="k">public</span> <span class="kt">decimal</span><span class="p">?</span> <span class="n">MinPrice</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">ProductStatus</span><span class="p">?</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">ProductCondition</span><span class="p">?</span> <span class="n">Condition</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">PaginationRequest</span> <span class="n">Pagination</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PaginationRequest</span><span class="p">();</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Integration into the <code>Program.cs</code> example demonstrates fetching paginated products with optional filters.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Program.cs (Pagination Example)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"Pagination with Dapper"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProductListRequest</span>
    <span class="p">{</span>
        <span class="n">Keyword</span> <span class="p">=</span> <span class="s">"phone"</span><span class="p">,</span>
        <span class="n">MinPrice</span> <span class="p">=</span> <span class="m">10.0m</span><span class="p">,</span>
        <span class="n">Status</span> <span class="p">=</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Available</span><span class="p">,</span>
        <span class="n">Condition</span> <span class="p">=</span> <span class="n">ProductCondition</span><span class="p">.</span><span class="n">New</span><span class="p">,</span>

        <span class="n">Pagination</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PaginationRequest</span>
        <span class="p">{</span>
            <span class="n">PageNumber</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
            <span class="n">PageSize</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span>
            <span class="n">SortFields</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SortedField</span><span class="p">&gt;</span>
            <span class="p">{</span>
                <span class="k">new</span> <span class="n">SortedField</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Name"</span><span class="p">,</span> <span class="n">Direction</span> <span class="p">=</span> <span class="n">SortedDirection</span><span class="p">.</span><span class="n">Asc</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">paginationQuery</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">Pagination</span><span class="p">.</span><span class="nf">AsQuery</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">allowedSortFields</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span> <span class="s">"Name"</span><span class="p">,</span> <span class="s">"Id"</span> <span class="p">};</span>
    <span class="kt">var</span> <span class="n">orderByClause</span> <span class="p">=</span> <span class="n">paginationQuery</span><span class="p">.</span><span class="nf">AsOrderBy</span><span class="p">(</span><span class="n">allowedSortFields</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">whereClause</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">(</span><span class="s">"WHERE 1=1"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynamicParameters</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Keyword</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">whereClause</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">" AND (Id LIKE @Keyword OR Name LIKE @Keyword)"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Keyword"</span><span class="p">,</span> <span class="s">$"%</span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">Keyword</span><span class="p">}</span><span class="s">%"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">MinPrice</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">whereClause</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">" AND Price &gt;= @MinPrice"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"MinPrice"</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">MinPrice</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Status</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">whereClause</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">" AND Status = @Status"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Status"</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Status</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span> <span class="c1">// Cast enum to integer for database</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Condition</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">whereClause</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">" AND Condition = @Condition"</span><span class="p">);</span>
        <span class="n">parameters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Condition"</span><span class="p">,</span> <span class="s">$"</span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">Condition</span><span class="p">.</span><span class="n">Value</span><span class="p">}</span><span class="s">"</span><span class="p">);</span> <span class="c1">// Cast enum to text for database</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">sql</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">"SELECT *"</span><span class="p">);</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">"FROM Products"</span><span class="p">);</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">whereClause</span><span class="p">);</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">orderByClause</span><span class="p">!);</span> <span class="c1">// orderByClause may be NULL here!!!</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">$"LIMIT </span><span class="p">{</span><span class="n">paginationQuery</span><span class="p">.</span><span class="n">Limit</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">$"OFFSET </span><span class="p">{</span><span class="n">paginationQuery</span><span class="p">.</span><span class="n">Offset</span><span class="p">}</span><span class="s">;"</span><span class="p">);</span>

    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">"SELECT COUNT(*)"</span><span class="p">);</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">"FROM Products"</span><span class="p">);</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">whereClause</span><span class="p">);</span>
    <span class="n">sql</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="s">";"</span><span class="p">);</span>

    <span class="k">using</span> <span class="nn">var</span> <span class="n">multi</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="nf">QueryMultipleAsync</span><span class="p">(</span><span class="n">sql</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(),</span> <span class="n">parameters</span><span class="p">);</span>

    <span class="c1">// Read the first result set into a list of Product entities.</span>
    <span class="kt">var</span> <span class="n">products</span> <span class="p">=</span> <span class="n">multi</span><span class="p">.</span><span class="n">Read</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;().</span><span class="nf">ToList</span><span class="p">();</span>

    <span class="c1">// Read the second result set, which is the total count of products.</span>
    <span class="kt">var</span> <span class="n">totalCount</span> <span class="p">=</span> <span class="n">multi</span><span class="p">.</span><span class="n">Read</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;().</span><span class="nf">Single</span><span class="p">();</span>

    <span class="c1">// Create a PaginationResult object to encapsulate the paginated data and metadata.</span>
    <span class="kt">var</span> <span class="n">paginationResult</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PaginationResult</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="n">products</span><span class="p">,</span> <span class="n">totalCount</span><span class="p">,</span> <span class="n">paginationQuery</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">,</span> <span class="n">paginationQuery</span><span class="p">.</span><span class="n">PageSize</span><span class="p">);</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"\n--- Paginated Products (Page </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">}</span><span class="s"> of </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">TotalPages</span><span class="p">}</span><span class="s">, Total: </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">TotalCount</span><span class="p">}</span><span class="s">) ---"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Page Number: </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Page Size: </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">PageSize</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Total Pages: </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">TotalPages</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Has Previous Page: </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">HasPreviousPage</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Has Next Page: </span><span class="p">{</span><span class="n">paginationResult</span><span class="p">.</span><span class="n">HasNextPage</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">product</span> <span class="k">in</span> <span class="n">paginationResult</span><span class="p">.</span><span class="n">Items</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"- </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s"> (Price: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Price</span><span class="p">:</span><span class="n">C</span><span class="p">}</span><span class="s">, Status: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Status</span><span class="p">}</span><span class="s">, Condition: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Condition</span><span class="p">}</span><span class="s">)"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extending_dapper_unmapped_columns">5. A Learning Example: Extending Dapper to Handle Unmapped Columns</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following section demonstrates how to extend Dapper with custom functionality. The code shown here is not part of the core Dapper library but serves as a practical example of its flexibility in handling more advanced data mapping scenarios.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="the-problem-unmapped-columns">5.1. The Problem: Unmapped Columns</h3>
<div class="paragraph">
<p>A common challenge arises when a SQL query returns columns that do not have corresponding properties in the target C# model. By default, Dapper simply ignores this extra data. While this is often the desired behavior, there are cases where you might want to capture these unmapped columns without creating a new, highly specific view model for every query variation.</p>
</div>
<div class="paragraph">
<p>For instance, a query might join tables and return a <code>CategoryName</code> along with <code>Product</code> data. If the <code>Product</code> model doesn&#8217;t have a <code>CategoryName</code> property, that data is lost during mapping.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-solution-a-custom-extension-pattern">5.2. The Solution: A Custom Extension Pattern</h3>
<div class="paragraph">
<p>To solve this, we can implement a custom extension method, <code>QueryWithExtraAsync&lt;T&gt;</code>, that intelligently maps all known columns to the model&#8217;s properties and collects any unmapped columns into a dictionary.</p>
</div>
<div class="paragraph">
<p>This pattern requires a few components:
1.  A custom attribute to mark the dictionary property on our model.
2.  An update to our entity to include this dictionary property.
3.  The extension methods that contain the core logic for mapping.</p>
</div>
</div>
<div class="sect2">
<h3 id="implementation-walkthrough">5.3. Implementation Walkthrough</h3>
<div class="paragraph">
<p>Here’s how to build the extension and integrate it into the project.</p>
</div>
<div class="sect3">
<h4 id="1-the-marker-extradata-attribute">5.3.1. 1. The Marker: <code>[ExtraData]</code> Attribute</h4>
<div class="paragraph">
<p>First, we define a simple attribute to mark the property that will hold the unmapped data.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Attributes/ExtraDataAttribute.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="cp">#nullable enable
</span>
<span class="k">namespace</span> <span class="nn">Learning.Dapper.Attributes</span><span class="p">;</span>

<span class="p">[</span><span class="nf">AttributeUsage</span><span class="p">(</span><span class="n">AttributeTargets</span><span class="p">.</span><span class="n">Property</span><span class="p">,</span> <span class="n">AllowMultiple</span> <span class="p">=</span> <span class="k">false</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ExtraDataAttribute</span> <span class="p">:</span> <span class="n">Attribute</span>
<span class="p">{</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="2-the-model-preparing-the-product-entity">5.3.2. 2. The Model: Preparing the <code>Product</code> Entity</h4>
<div class="paragraph">
<p>Next, we modify the <code>Product</code> entity to include a dictionary property annotated with our new <code>[ExtraData]</code> attribute. This dictionary will store any unmapped columns and their values.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Entities/Product.cs (with ExtraData)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="cp">#nullable enable
</span>
<span class="k">using</span> <span class="nn">Learning.Dapper.Attributes</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Learning.Dapper.Entities</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span><span class="p">?</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Stock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">CategoryId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">ProductStatus</span> <span class="n">Status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">ProductCondition</span> <span class="n">Condition</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="n">ExtraData</span><span class="p">]</span>
    <span class="k">public</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">?&gt;?</span> <span class="n">ExtraData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="3-the-core-dbconnectionextensions">5.3.3. 3. The Core: <code>DbConnectionExtensions</code></h4>
<div class="paragraph">
<p>This is the main extension method. It uses a low-level <code>IDataReader</code> to inspect the query&#8217;s result set, identifies which columns map to the model&#8217;s properties, and funnels the rest into the <code>ExtraData</code> dictionary.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Extensions/DbConnectionExtensions.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="cp">#nullable enable
</span>
<span class="k">using</span> <span class="nn">Dapper</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Learning.Dapper.Attributes</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Learning.Dapper.Extensions</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// Provides extension methods for database connections that enhance Dapper's query capabilities</span>
<span class="c1">/// with support for collecting unmapped columns into a dictionary property.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DbConnectionExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">QueryWithExtraAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
        <span class="k">this</span> <span class="n">IDbConnection</span> <span class="n">cnn</span><span class="p">,</span>
        <span class="kt">string</span> <span class="n">sql</span><span class="p">,</span>
        <span class="kt">object</span><span class="p">?</span> <span class="n">param</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="n">IDbTransaction</span><span class="p">?</span> <span class="n">transaction</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="kt">int</span><span class="p">?</span> <span class="n">commandTimeout</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="n">CommandType</span><span class="p">?</span> <span class="n">commandType</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">QueryWithExtraAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">cnn</span><span class="p">,</span> <span class="k">new</span> <span class="nf">CommandDefinition</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">commandTimeout</span><span class="p">,</span> <span class="n">commandType</span><span class="p">,</span> <span class="n">CommandFlags</span><span class="p">.</span><span class="n">Buffered</span><span class="p">,</span> <span class="k">default</span><span class="p">));</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">QueryWithExtraAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IDbConnection</span> <span class="n">cnn</span><span class="p">,</span> <span class="n">CommandDefinition</span> <span class="n">command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">PropertyInfo</span><span class="p">[]</span> <span class="n">extraDataProperties</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="nf">GetProperties</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">ExtraDataAttribute</span><span class="p">&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">extraDataProperties</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"Only one property can be marked with [ExtraData]"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">extraDataProperties</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">cnn</span><span class="p">.</span><span class="n">QueryAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">command</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">PropertyInfo</span> <span class="n">extraDataProperty</span> <span class="p">=</span> <span class="n">extraDataProperties</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(!</span><span class="k">typeof</span><span class="p">(</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">?&gt;).</span><span class="nf">IsAssignableFrom</span><span class="p">(</span><span class="n">extraDataProperty</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">"ExtraData property must be a dictionary of type IDictionary&lt;string, object&gt;"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">defaultTypeMap</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DefaultTypeMap</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>

        <span class="k">using</span> <span class="nn">IDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">await</span> <span class="n">cnn</span><span class="p">.</span><span class="nf">ExecuteReaderAsync</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">columnNames</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">reader</span><span class="p">.</span><span class="n">FieldCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">columnNames</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="kt">string</span><span class="p">[]</span> <span class="n">extraColumnNames</span> <span class="p">=</span> <span class="n">columnNames</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">fn</span> <span class="p">=&gt;</span> <span class="n">defaultTypeMap</span><span class="p">.</span><span class="nf">GetMember</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">==</span> <span class="k">null</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>
        <span class="kt">string</span><span class="p">[]</span> <span class="n">directColumnNames</span> <span class="p">=</span> <span class="n">columnNames</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">fn</span> <span class="p">=&gt;</span> <span class="n">defaultTypeMap</span><span class="p">.</span><span class="nf">GetMember</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="nf">ToArray</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">Read</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">columnName</span> <span class="k">in</span> <span class="n">directColumnNames</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">SqlMapper</span><span class="p">.</span><span class="n">IMemberMap</span> <span class="n">memberMap</span> <span class="p">=</span> <span class="n">defaultTypeMap</span><span class="p">.</span><span class="nf">GetMember</span><span class="p">(</span><span class="n">columnName</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">memberMap</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">columnIndex</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetOrdinal</span><span class="p">(</span><span class="n">memberMap</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">);</span>
                    <span class="kt">object</span><span class="p">?</span> <span class="k">value</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetTargetValue</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">,</span> <span class="n">memberMap</span><span class="p">.</span><span class="n">MemberType</span><span class="p">);</span>
                    <span class="n">memberMap</span><span class="p">.</span><span class="n">Property</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">extraColumnNames</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">extraData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">?&gt;();</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">columnName</span> <span class="k">in</span> <span class="n">extraColumnNames</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">columnIndex</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetOrdinal</span><span class="p">(</span><span class="n">columnName</span><span class="p">);</span>
                    <span class="n">extraData</span><span class="p">[</span><span class="n">columnName</span><span class="p">]</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetTargetValue</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">extraDataProperty</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">extraData</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">result</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="4-the-helper-datareaderextensions">5.3.4. 4. The Helper: <code>DataReaderExtensions</code></h4>
<div class="paragraph">
<p>To make the main extension more robust, this helper method handles type conversions from the database to .NET types, including inferring types where possible.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Extensions/DataReaderExtensions.cs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="cp">#nullable enable
</span>
<span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Globalization</span><span class="p">;</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// Provides extension methods for &lt;see cref="IDataReader"/&gt; that enhance Dapper's query capabilities</span>
<span class="c1">/// with support for robust type conversion and column type inference.</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">internal</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DataReaderExtensions</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Gets the value of the specified column and robustly converts it to the target .NET type.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">object</span><span class="p">?</span> <span class="nf">GetTargetValue</span><span class="p">(</span><span class="k">this</span> <span class="n">IDataReader</span> <span class="n">reader</span><span class="p">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="p">,</span> <span class="n">Type</span><span class="p">?</span> <span class="n">targetType</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">object</span> <span class="n">dbValue</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dbValue</span> <span class="p">==</span> <span class="n">DBNull</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">targetType</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">targetType</span><span class="p">.</span><span class="n">IsValueType</span> <span class="p">&amp;&amp;</span> <span class="n">Nullable</span><span class="p">.</span><span class="nf">GetUnderlyingType</span><span class="p">(</span><span class="n">targetType</span><span class="p">)</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">Activator</span><span class="p">.</span><span class="nf">CreateInstance</span><span class="p">(</span><span class="n">targetType</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Type</span> <span class="n">effectiveTargetType</span> <span class="p">=</span> <span class="n">targetType</span> <span class="p">??</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetEffectiveType</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">effectiveTargetType</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">dbValue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">Type</span> <span class="n">conversionType</span> <span class="p">=</span> <span class="n">Nullable</span><span class="p">.</span><span class="nf">GetUnderlyingType</span><span class="p">(</span><span class="n">effectiveTargetType</span><span class="p">)</span> <span class="p">??</span> <span class="n">effectiveTargetType</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">conversionType</span><span class="p">.</span><span class="nf">IsInstanceOfType</span><span class="p">(</span><span class="n">dbValue</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">dbValue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ChangeType</span><span class="p">(</span><span class="n">dbValue</span><span class="p">,</span> <span class="n">conversionType</span><span class="p">,</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidCastException</span><span class="p">(</span><span class="s">$"Failed to convert database value of type '</span><span class="p">{</span><span class="n">dbValue</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="n">FullName</span><span class="p">}</span><span class="s">' to target type '</span><span class="p">{</span><span class="n">effectiveTargetType</span><span class="p">.</span><span class="n">FullName</span><span class="p">}</span><span class="s">'."</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">Type</span> <span class="nf">GetEffectiveType</span><span class="p">(</span><span class="k">this</span> <span class="n">IDataReader</span> <span class="n">reader</span><span class="p">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">dataTypeName</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetDataTypeName</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">).</span><span class="nf">ToUpperInvariant</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">dataTypeName</span> <span class="k">switch</span>
        <span class="p">{</span>
            <span class="s">"TIME"</span> <span class="p">=&gt;</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">),</span>
            <span class="s">"REAL"</span> <span class="p">=&gt;</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span>
            <span class="kt">var</span> <span class="n">s</span> <span class="k">when</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"DATE"</span><span class="p">)</span> <span class="p">||</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"TIMESTAMP"</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">typeof</span><span class="p">(</span><span class="n">DateTime</span><span class="p">),</span>
            <span class="kt">var</span> <span class="n">s</span> <span class="k">when</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"BOOL"</span><span class="p">)</span> <span class="p">||</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"BIT"</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span>
            <span class="kt">var</span> <span class="n">s</span> <span class="k">when</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"GUID"</span><span class="p">)</span> <span class="p">||</span> <span class="n">s</span> <span class="p">==</span> <span class="s">"UNIQUEIDENTIFIER"</span> <span class="p">=&gt;</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Guid</span><span class="p">),</span>
            <span class="kt">var</span> <span class="n">s</span> <span class="k">when</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"DECIMAL"</span><span class="p">)</span> <span class="p">||</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"NUMERIC"</span><span class="p">)</span> <span class="p">||</span> <span class="n">s</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"MONEY"</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">decimal</span><span class="p">),</span>
            <span class="n">_</span> <span class="p">=&gt;</span> <span class="n">reader</span><span class="p">.</span><span class="nf">GetFieldType</span><span class="p">(</span><span class="n">columnIndex</span><span class="p">),</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="putting-it-all-together">5.4. Putting It All Together</h3>
<div class="paragraph">
<p>With the extension in place, you can now execute a query that joins <code>Products</code> and <code>Categories</code> and capture the <code>CategoryName</code> without adding it to the <code>Product</code> model directly.</p>
</div>
<div class="listingblock">
<div class="title">Learning.Dapper/Program.cs (QueryWithExtraAsync Example)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">profiler</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">"A Learning Example: Extending Dapper to Handle Unmapped Columns"</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">sql</span> <span class="p">=</span> <span class="s">@"
SELECT
    p.*,
    c.Name AS CategoryName
FROM Products p
INNER JOIN Categories c ON p.CategoryId = c.Id
WHERE p.Id = 1;"</span><span class="p">;</span>

    <span class="c1">// Assumes all the extension code is available in the project</span>
    <span class="kt">var</span> <span class="n">productWithExtra</span> <span class="p">=</span> <span class="k">await</span> <span class="n">conn</span><span class="p">.</span><span class="n">QueryWithExtraAsync</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="n">sql</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="n">productWithExtra</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"
</span><span class="p">---</span> <span class="n">Product</span> <span class="k">with</span> <span class="n">Extra</span> <span class="n">Data</span> <span class="p">---</span><span class="s">");
</span>    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Product Name: </span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">ExtraData</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">product</span><span class="p">.</span><span class="n">ExtraData</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="s">"CategoryName"</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">categoryName</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"ExtraData[CategoryName]: </span><span class="p">{</span><span class="n">categoryName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The console output demonstrates that <code>CategoryName</code> was successfully captured in the <code>ExtraData</code> dictionary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">
--- Product with Extra Data ---
Product Name: Laptop
ExtraData[CategoryName]: Electronics</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This pattern provides significant flexibility, allowing you to handle dynamic query results gracefully without the need for a rigid class structure for every possible outcome.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">6. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dapper offers a powerful yet lightweight solution for interacting with databases in .NET applications. Its high performance and minimal overhead make it an excellent choice for scenarios where fine-grained control over SQL and efficient data access are critical. This document has demonstrated Dapper&#8217;s versatility in handling various querying methods, from scalar values to multiple result sets, and its robust parameter handling capabilities, including anonymous and dynamic parameters, as well as support for 'IN' clauses. Furthermore, the implementation of optional filters and comprehensive pagination logic showcases Dapper&#8217;s flexibility in building efficient and scalable data access layers.</p>
</div>
</div>
</div>
<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
