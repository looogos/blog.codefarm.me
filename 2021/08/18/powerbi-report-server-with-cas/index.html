<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>PowerBI Report Server Extensions with CAS | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="PowerBI Report Server Extensions with CAS" />
<meta property="og:locale" content="en" />
<meta name="description" content="1. Prerequisites 2. Reporting Services Custom Security 2.1. Step 1. Build the Extension Project 2.2. Step 2: Deployment and Configuration 2.3. Step 3: Generate Machine Keys 2.4. Step 4: Configure Passthrough cookies 3. Security Extensions Overview 3.1. Authentication in Reporting Services 3.2. Authorization in Reporting Services 4. References 1. Prerequisites .NET Framework 4.8 Developer Pack Microsoft Visual Studio Community 2019 Version 16.10.4+ Microsoft Power BI Report Server - May 2021 SQL Server 2019 NET 5.0 SDK(Optional) How to Build .NET Project with CLI \# Open Developer Command Prompt for VS 2019 and goto the project directory, then type the follow commands: &gt; msbuild -t:Clean (1) &gt; msbuild -t:Build (2) &gt; msbuild (3) &gt; msbuild -p:Configuration=Release (4) 1 Clean build outputs of a .NET project. 2 Build a .NET project. 3 Build a .NET project with default build target. 4 Build a .NET project with Release configuration. \# Open any Command Prompt or Bash Console and goto the project direcotry, then type the follow commands: $ dotnet clean (1) $ dotnet build (2) $ dotnet build -c Release (3) 1 Clean build outputs of a .NET project. 2 Build a .NET project. 3 Build a .NET project with Release configuration. 2. Reporting Services Custom Security You must first compile and install the extension. The procedure assumes that you have installed Reporting Services to the default location: C:\Program Files\Microsoft Power BI Report Server\PBIRS. This location will be referred to throughout the remainder of this topic as &lt;install&gt;. 2.1. Step 1. Build the Extension Project Source code @ https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git $ git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git Cloning into &#39;PowerBI.ReportingServices.Extensions&#39;... remote: Enumerating objects: 63, done. remote: Counting objects: 100% (63/63), done. remote: Compressing objects: 100% (54/54), done. remote: Total 63 (delta 15), reused 52 (delta 6), pack-reused 0 Receiving objects: 100% (63/63), 71.26 KiB | 513.00 KiB/s, done. Resolving deltas: 100% (15/15), done. $ cd PowerBI.ReportingServices.Extensions $ dotnet build Microsoft (R) Build Engine version 16.10.2+857e5a733 for .NET Copyright (C) Microsoft Corporation. All rights reserved. Determining projects to restore... Restored ...\src\PowerBI.ReportingServices.Security\PowerBI.ReportingServices.Security.csproj (in 209 ms). PowerBI.ReportingServices.Security -&gt; ...\src\PowerBI.ReportingServices.Security\bin\Debug\net48\PowerBI.ReportingServices.Security.dll Build succeeded. 0 Warning(s) 0 Error(s) Time Elapsed 00:00:03.51 To compile the Project using Visual Studio Open PowerBI.ReportingServices.sln in Microsoft Visual Studio. In Solution Explorer, select the PowerBI.ReportingServices.Security project. Look at the PowerBI.ReportingServices.Security project&#8217;s Dependencies&#8594;Assemblies. If you do not see Microsoft.ReportingServices.Interfaces.dll, then complete the following steps: On the Assemblies menu, right click Add Assembly Reference.... The Add References dialog box opens. Click Browse, and find Microsoft.ReportingServices.Interfaces on your local drive. By default, the assembly is in the &lt;install&gt;\ReportServer\bin directory. Click OK. The selected reference is added to your project. If you do not see EntityFramework.dll, EntityFramework.SqlServer.dll, Microsoft.Extensions.DependencyInjection.dll and Microsoft.Extensions.DependencyInjection.Abstractions.dll, then complete the following steps: On the Assemblies menu, right click Add Assembly Reference.... The Add References dialog box opens. Click Browse, and find these assemblies on your local drive. By default, the assembly is in the &lt;install&gt;\Portal directory- Click OK. The selected reference is added to your project. On the Build menu, click Build Solution. Debugging To debug the extension, you might want to attach the debugger to both ReportingServicesService.exe, RSPortal.exe and RSPowerBI.exe. And add breakpoints to the methods implementing the interface IAuthenticationExtension2 and IAuthorizationExtension. Troubleshooting If the report server cann&#8217;t work expectedly, you may need to analyze the reprot server log files at &lt;install&gt;/LogFiles, especially the following highlight files : $ ls -1 LogFiles/ ASManagedRoot_2021_11_05_09_56_18.log FlightRecorderCurrent.trc msmdsrv.log ReportingServicesService_2021_11_05_09_56_17.log ReportingServicesWMI_2021_11_05_09_54_26.log RSHostingService_2021_11_05_09_55_46.log RSManagement_2021_11_05_09_55_47.log RSOffice_2021_11_05_09_56_17.log RSPortal_2021_11_05_09_56_17.log RSPowerBI_2021_11_05_09_56_17.log 2.2. Step 2: Deployment and Configuration # The Build Outputs of the Security Extenstion Project $ ls src/PowerBI.ReportingServices.Security/bin/Debug/net48/ EntityFramework.dll* Microsoft.Extensions.DependencyInjection.Abstractions.dll* EntityFramework.SqlServer.dll* Microsoft.Extensions.DependencyInjection.dll* PowerBI.ReportingServices.Security.dll* Microsoft.ReportingServices.Interfaces.dll* PowerBI.ReportingServices.Security.pdb Sso.aspx 2.2.1. To deploy the security extension Copy the Sso.aspx page to the &lt;install&gt;\ReportServer directory. Copy all the *.dll and *.pdb to the follow directories: &lt;install&gt;\ReportServer\bin &lt;install&gt;\Portal &lt;install&gt;\PowerBI 2.2.2. Modify files in the &lt;install&gt;\ReportServer direcotry To modify the rsreportserver.config file. Open the rsreportserver.config file with Visual Studio or a simple text editor such as Notepad. rsreportserver.config is located in the &lt;install&gt;\ReportServer directory. Locate the &lt;AuthenticationTypes&gt; element and modify the settings as follows: &lt;Authentication&gt; &lt;AuthenticationTypes&gt; &lt;!--&lt;RSWindowsNTLM/&gt;--&gt; (1) &lt;Custom/&gt; &lt;/AuthenticationTypes&gt; &lt;RSWindowsExtendedProtectionLevel&gt;Off&lt;/RSWindowsExtendedProtectionLevel&gt; &lt;RSWindowsExtendedProtectionScenario&gt;Proxy&lt;/RSWindowsExtendedProtectionScenario&gt; &lt;EnableAuthPersistence&gt;true&lt;/EnableAuthPersistence&gt; &lt;/Authentication&gt; 1 Note that you cannot use Custom with other authentication types. Locate the &lt;Security&gt; and &lt;Authentication&gt; elements, within the &lt;Extensions&gt; element, and modify the settings as follows: &lt;Security&gt; &lt;Extension Name=&quot;Forms&quot; Type=&quot;PowerBI.ReportingServices.Security.Authorization, PowerBI.ReportingServices.Security&quot;&gt; &lt;Configuration&gt; &lt;AdminConfiguration&gt; &lt;UserName&gt;admin1@local.me,admin2@google.com&lt;/UserName&gt; (1) &lt;/AdminConfiguration&gt; &lt;/Configuration&gt; &lt;/Extension&gt; &lt;!--&lt;Extension Name=&quot;Windows&quot; Type=&quot;Microsoft.ReportingServices.Authorization.WindowsAuthorization, Microsoft.ReportingServices.Authorization&quot;/&gt;--&gt; &lt;/Security&gt; 1 Note that you should specify one or many administrators here. &lt;Authentication&gt; &lt;Extension Name=&quot;Forms&quot; Type=&quot;PowerBI.ReportingServices.Security.Cas.Authentication, PowerBI.ReportingServices.Security&quot;/&gt; &lt;!--&lt;Extension Name=&quot;Windows&quot; Type=&quot;Microsoft.ReportingServices.Authentication.WindowsAuthentication, Microsoft.ReportingServices.Authorization&quot;/&gt;--&gt; &lt;/Authentication&gt; 2.2.3. To modify the web.config file for Report Server Open the web.config file in a text editor. By default, the file is in the &lt;install&gt;\ReportServer directory. Locate the &lt;identity&gt; element and set the Impersonate attribute to false. &lt;identity impersonate=&quot;false&quot; /&gt; &lt;!--&lt;identity impersonate=&quot;true&quot; /&gt;--&gt; Locate the &lt;authentication&gt; element and change the Mode attribute to Forms. Also, add the following &lt;forms&gt; element as a child of the &lt;authentication&gt; element and set the loginUrl, name, timeout, path, requireSSL, and cookieSameSite attributes as follows: &lt;!--&lt;authentication mode=&quot;Windows&quot; /&gt;--&gt; &lt;authentication mode=&quot;Forms&quot;&gt; &lt;forms loginUrl=&quot;Sso.aspx&quot; name=&quot;X-RS-TOKEN&quot; timeout=&quot;60&quot; path=&quot;/&quot; requireSSL=&quot;true&quot; cookieSameSite=&quot;None&quot;&gt; &lt;/forms&gt; &lt;/authentication&gt; For local development, if you cann&#8217;t debug with HTTPS, you should delete both the requireSSL and cookieSameSite attributes. &lt;!--&lt;authentication mode=&quot;Windows&quot; /&gt;--&gt; &lt;authentication mode=&quot;Forms&quot;&gt; &lt;forms loginUrl=&quot;Sso.aspx&quot; name=&quot;X-RS-TOKEN&quot; timeout=&quot;60&quot; path=&quot;/&quot;&gt; &lt;/forms&gt; &lt;/authentication&gt; Add the following &lt;authorization&gt; element directly after the &lt;authentication&gt; element. &lt;authorization&gt; &lt;deny users=&quot;?&quot; /&gt; &lt;/authorization&gt; This will deny unauthenticated users the right to access the report server. The previously established loginUrl attribute of the &lt;authentication&gt; element will redirect unauthenticated requests to the Sso.aspx page. Configuration &lt;appSettings&gt; and &lt;connectionStrings&gt; inner the element &lt;configuration&gt; as below. &lt;appSettings&gt; &lt;add key=&quot;cas.baseaddress&quot; value=&quot;https://cas.example.com&quot; /&gt; &lt;add key=&quot;cas.login.path&quot; value=&quot;/cas/login&quot; /&gt; &lt;add key=&quot;cas.service.validate.path&quot; value=&quot;/cas/serviceValidate&quot; /&gt; &lt;/appSettings&gt; &lt;connectionStrings&gt; &lt;add name=&quot;cas.useraccounts&quot; (1) connectionString=&quot;Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt; &lt;/connectionStrings&gt; 1 Your should modify the Data Source with the Server Name of your MSSQL, User ID and Password with your only SQL Server Authentication credentials. Locate the &lt;trust&gt; element and update it as follows: &lt;!--&lt;securityPolicy&gt; &lt;trustLevel name=&quot;RosettaSrv&quot; policyFile=&quot;rssrvpolicy.config&quot; /&gt; &lt;/securityPolicy&gt; &lt;trust level=&quot;RosettaSrv&quot; originUrl=&quot;&quot; egacyCasModel=&quot;true&quot; /&gt;--&gt; &lt;trust level=&quot;Full&quot; /&gt; 2.2.4. To modify the RSPortal.exe.config file for Report Server Portal Open the web.config file in a text editor. By default, the file is in the &lt;install&gt;\Portal directory. Configuration &lt;connectionStrings&gt; under the &lt;configuration&gt; as same as web.config as below. &lt;connectionStrings&gt; &lt;add name=&quot;cas.useraccounts&quot; connectionString=&quot;Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt; &lt;/connectionStrings&gt; 2.3. Step 3: Generate Machine Keys Using Forms authentication requires that all report server processes can access the authentication cookie. This involves configuring a machine key and decryption algorithm&#8201;&#8212;&#8201;a familiar step for those who had previously setup SSRS to work in scale-out environments. Generate and add &lt;MachineKey&gt; under &lt;Configuration&gt; in your rsreportserver.config file. &lt;MachineKey ValidationKey=&quot;[YOUR KEY]&quot; DecryptionKey=&quot;[YOUR KEY]&quot; Validation=&quot;AES&quot; Decryption=&quot;AES&quot; /&gt; The follow code snippet is a sample: &lt;Configuration&gt; &lt;MachineKey ValidationKey=&quot;C9A00A9C93B7AC6B8B3C27054DEDA40FDE08D20C481E808042F32784B3A7F5EF&quot; DecryptionKey=&quot;8F3D5F7B29A0EB685B61299502490226DA98BCB73B024F78651C24517A5ACCB9&quot; Validation=&quot;AES&quot; Decryption=&quot;AES&quot;/&gt; . . . Check the casing of the attributes, it should be Pascal Casing as the example above. There is not need for a &lt;system.web&gt; entry. You should use a validation key specific for you deployment, there are several tools to generate the keys such as Internet Information Services Manager (IIS), or the online machine-key-generator. 2.4. Step 4: Configure Passthrough cookies The new portal and the reportserver communicate using internal soap APIs for some of its operations. When additional cookies are required to be passed from the portal to the server the PassThroughCookies properties is still available. More Details: https://msdn.microsoft.com/en-us/library/ms345241.aspx. In the rsreportserver.config file add following under &lt;UI&gt;. &lt;UI&gt; &lt;ReportServerUrl&gt;&lt;/ReportServerUrl&gt; &lt;PageCountMode&gt;Estimate&lt;/PageCountMode&gt; &lt;CustomAuthenticationUI&gt; &lt;PassThroughCookies&gt; &lt;PassThroughCookie&gt;X-RS-TOKEN&lt;/PassThroughCookie&gt; &lt;/PassThroughCookies&gt; &lt;/CustomAuthenticationUI&gt; &lt;/UI&gt; 3. Security Extensions Overview Reporting Services provides an extensible architecture that allows you to plug in custom or forms-based authentication modules. You might consider implementing a custom authentication extension if deployment requirements do not include Windows integrated security or Basic authentication. The most common scenario for using custom authentication is to support Internet or extranet access to a Web application. Replacing the default Windows Authentication extension with a custom authentication extension gives you more control over how external users are granted access to the report server. In practice, deploying a custom authentication extension requires multiple steps that include copying assemblies and application files, modifying configuration files, and testing. Creating a custom authentication extension requires custom code and expertise in ASP.NET security. If you do not want to create a custom authentication extension, you can use Microsoft Active Directory groups and accounts, but you should greatly reduce the scope of a report server deployment. For more information about custom authentication, see Implementing a Security Extension. We recommend that you use Windows Authentication if at all possible. However, custom authentication and authorization for Reporting Services may be appropriate in the following two cases: You have an Internet or extranet application that cannot use Windows accounts. You have custom-defined users and roles and need to provide a matching authorization scheme in Reporting Services. As shown in the above figure, authentication and authorization occur as follows: &lt;1&gt; A user tries to access the web portal by using a URL and is redirected to a form that collects user credentials for the client application. &lt;2&gt; The user submits credentials to the form. &lt;3&gt; The user credentials are submitted to the Reporting Services Web service through the LogonUser method. &lt;4&gt; The Web service calls the customer-supplied security extension and verifies that the user name and password exist in the custom security authority. &lt;5&gt; After authentication, the Web service creates an authentication ticket (known as a &quot;cookie&quot;), manages the ticket, and verifies the user&#8217;s role for the Home page of the web portal. &lt;6&gt; The Web service returns the cookie to the browser and displays the appropriate user interface in the web portal. &lt;7&gt; After the user is authenticated, the browser makes requests to the web portal while transmitting the cookie in the HTTP header. These requests are in response to user actions within the web portal. &lt;8&gt; The cookie is transmitted in the HTTP header to the Web service along with the requested user operation. &lt;9&gt; The cookie is validated, and if it is valid, the report server returns the security descriptor and other information relating to the requested operation from the report server database. &lt;10&gt; If the cookie is valid, the report server makes a call to the security extension to check if the user is authorized to perform the specific operation. &lt;11&gt; If the user is authorized, the report server performs the requested operation and returns control to the caller. &lt;12&gt; After the user is authenticated, URL access to the report server uses the same cookie. The cookie is transmitted in the HTTP header. &lt;13&gt; The user continues to request operations on the report server until the session has ended. 3.1. Authentication in Reporting Services Authentication is the process of establishing a user&#8217;s right to an identity. There are many techniques that you can use to authenticate a user. The most common way is to use passwords. When you implement Forms Authentication, for example, you want an implementation that queries users for credentials (usually by some interface that requests a login name and password) and then validates users against a data store, such as a database table or configuration file. If the credentials can&#8217;t be validated, the authentication process fails and the user will assume an anonymous identity. In Reporting Services, the Windows operating system handles the authentication of users either through integrated security or through the explicit reception and validation of user credentials. Custom authentication can be developed in Reporting Services to support additional authentication schemes. This is made possible through the security extension interface IAuthenticationExtension2. All extensions inherit from the IExtension base interface for any extension deployed and used by the report server. IExtension, as well as IAuthenticationExtension2, are members of the Microsoft.ReportingServices.Interfaces namespace. As shown in the above figure, the authentication process is as follows: &lt;1&gt; A client application calls the Web service LogonUser method to authenticate a user. &lt;2&gt; The Web service makes a call to the LogonUser method of your security extension, specifically, the class that implements IAuthenticationExtension2. &lt;3&gt; Your implementation of LogonUser validates the user name and password in the user store or security authority. &lt;4&gt; Upon successful authentication, the Web service creates a cookie and manages it for the session. &lt;5&gt; The Web service returns the authentication ticket to the calling application on the HTTP header. 3.2. Authorization in Reporting Services Authorization is the process of determining whether an identity should be granted the requested type of access to a given resource in the report server database. Reporting Services uses a role-based authorization architecture that grants a user access to a given resource based on the user&#8217;s role assignment for the application. Security extensions for Reporting Services contain an implementation of an authorization component that is used to grant access to users once they are authenticated on the report server. Authorization is invoked when a user attempts to perform an operation on the system or a report server item through the SOAP API and via URL access. This is made possible through the security extension interface IAuthorizationExtension. As stated previously, all extensions inherit from IExtension the base interface for any extension that you deploy. IExtension and IAuthorizationExtension are members of the Microsoft.ReportingServices.Interfaces namespace. As shown in the Figure 3, authorization follows this sequence: &lt;1&gt; Once authenticated, client applications make requests to the report server through the Reporting Services Web service methods. An authentication ticket is passed to the report server in the form of a cookie in the HTTP header of each Web request. &lt;2&gt; The cookie is validated prior to any access check. &lt;3&gt; Once the cookie is validated, the report server calls GetUserInfo and the user is given an identity. &lt;4&gt; The user attempts an operation through the Reporting Services Web service. &lt;5&gt; The report server calls the CheckAccess method. &lt;6&gt; The security descriptor is retrieved and passed to a custom security extension implementation of CheckAccess. At this point, the user, group, or computer is compared to the security descriptor of the item being accessed and is authorized to perform the requested operation. &lt;7&gt; If the user is authorized, the Web service performs the operation and returns a response to the calling application. 4. References https://docs.microsoft.com/en-us/power-bi/report-server/get-started, What is Power BI Report Server? https://docs.microsoft.com/en-us/power-bi/report-server/install-report-server, Install Power BI Report Server https://docs.microsoft.com/en-us/power-bi/report-server/install-powerbi-desktop, Install Power BI Desktop for Power BI Report Server https://www.microsoft.com/en-us/sql-server/sql-server-downloads, SQL Server Downloads Microsoft https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15, Download SQL Server Management Studio (SSMS) https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-configuration-files?view=sql-server-ver15, Reporting Services Configuration Files https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-log-files-and-sources?view=sql-server-ver15, Reporting Services Log Files and Sources https://docs.microsoft.com/en-us/sql/reporting-services/security/authentication-with-the-report-server?view=sql-server-ver15, Authentication with the Report Server https://docs.microsoft.com/en-us/sql/reporting-services/extensions-ssrs?view=sql-server-ver15, Extensions for SQL Server Reporting Services (SSRS) https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/security-extensions-overview?view=sql-server-ver15, Security Extensions Overview - Reporting Services (SSRS) https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authentication-in-reporting-services?view=sql-server-ver15, Authentication in Reporting Services https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authorization-in-reporting-services?view=sql-server-ver15, Authorization in Reporting Services https://docs.microsoft.com/en-us/sql/reporting-services/extensions/secure-development/using-reporting-services-security-policy-files?view=sql-server-ver15#placement-of-codegroup-elements-for-extensions, Placement of CodeGroup Elements for Extensions https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-1.1/b5ysx397(v=vs.71), ASP.NET Settings Schema https://docs.microsoft.com/en-us/previous-versions/, Previous versions of Microsoft products, services and technologies https://www.entityframeworktutorial.net/code-first/automated-migration-in-code-first.aspx, Automated Migration in Entity Framework 6 https://codewithshadman.com/machine-key-generator/, Machine Key Generator" />
<meta property="og:description" content="1. Prerequisites 2. Reporting Services Custom Security 2.1. Step 1. Build the Extension Project 2.2. Step 2: Deployment and Configuration 2.3. Step 3: Generate Machine Keys 2.4. Step 4: Configure Passthrough cookies 3. Security Extensions Overview 3.1. Authentication in Reporting Services 3.2. Authorization in Reporting Services 4. References 1. Prerequisites .NET Framework 4.8 Developer Pack Microsoft Visual Studio Community 2019 Version 16.10.4+ Microsoft Power BI Report Server - May 2021 SQL Server 2019 NET 5.0 SDK(Optional) How to Build .NET Project with CLI \# Open Developer Command Prompt for VS 2019 and goto the project directory, then type the follow commands: &gt; msbuild -t:Clean (1) &gt; msbuild -t:Build (2) &gt; msbuild (3) &gt; msbuild -p:Configuration=Release (4) 1 Clean build outputs of a .NET project. 2 Build a .NET project. 3 Build a .NET project with default build target. 4 Build a .NET project with Release configuration. \# Open any Command Prompt or Bash Console and goto the project direcotry, then type the follow commands: $ dotnet clean (1) $ dotnet build (2) $ dotnet build -c Release (3) 1 Clean build outputs of a .NET project. 2 Build a .NET project. 3 Build a .NET project with Release configuration. 2. Reporting Services Custom Security You must first compile and install the extension. The procedure assumes that you have installed Reporting Services to the default location: C:\Program Files\Microsoft Power BI Report Server\PBIRS. This location will be referred to throughout the remainder of this topic as &lt;install&gt;. 2.1. Step 1. Build the Extension Project Source code @ https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git $ git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git Cloning into &#39;PowerBI.ReportingServices.Extensions&#39;... remote: Enumerating objects: 63, done. remote: Counting objects: 100% (63/63), done. remote: Compressing objects: 100% (54/54), done. remote: Total 63 (delta 15), reused 52 (delta 6), pack-reused 0 Receiving objects: 100% (63/63), 71.26 KiB | 513.00 KiB/s, done. Resolving deltas: 100% (15/15), done. $ cd PowerBI.ReportingServices.Extensions $ dotnet build Microsoft (R) Build Engine version 16.10.2+857e5a733 for .NET Copyright (C) Microsoft Corporation. All rights reserved. Determining projects to restore... Restored ...\src\PowerBI.ReportingServices.Security\PowerBI.ReportingServices.Security.csproj (in 209 ms). PowerBI.ReportingServices.Security -&gt; ...\src\PowerBI.ReportingServices.Security\bin\Debug\net48\PowerBI.ReportingServices.Security.dll Build succeeded. 0 Warning(s) 0 Error(s) Time Elapsed 00:00:03.51 To compile the Project using Visual Studio Open PowerBI.ReportingServices.sln in Microsoft Visual Studio. In Solution Explorer, select the PowerBI.ReportingServices.Security project. Look at the PowerBI.ReportingServices.Security project&#8217;s Dependencies&#8594;Assemblies. If you do not see Microsoft.ReportingServices.Interfaces.dll, then complete the following steps: On the Assemblies menu, right click Add Assembly Reference.... The Add References dialog box opens. Click Browse, and find Microsoft.ReportingServices.Interfaces on your local drive. By default, the assembly is in the &lt;install&gt;\ReportServer\bin directory. Click OK. The selected reference is added to your project. If you do not see EntityFramework.dll, EntityFramework.SqlServer.dll, Microsoft.Extensions.DependencyInjection.dll and Microsoft.Extensions.DependencyInjection.Abstractions.dll, then complete the following steps: On the Assemblies menu, right click Add Assembly Reference.... The Add References dialog box opens. Click Browse, and find these assemblies on your local drive. By default, the assembly is in the &lt;install&gt;\Portal directory- Click OK. The selected reference is added to your project. On the Build menu, click Build Solution. Debugging To debug the extension, you might want to attach the debugger to both ReportingServicesService.exe, RSPortal.exe and RSPowerBI.exe. And add breakpoints to the methods implementing the interface IAuthenticationExtension2 and IAuthorizationExtension. Troubleshooting If the report server cann&#8217;t work expectedly, you may need to analyze the reprot server log files at &lt;install&gt;/LogFiles, especially the following highlight files : $ ls -1 LogFiles/ ASManagedRoot_2021_11_05_09_56_18.log FlightRecorderCurrent.trc msmdsrv.log ReportingServicesService_2021_11_05_09_56_17.log ReportingServicesWMI_2021_11_05_09_54_26.log RSHostingService_2021_11_05_09_55_46.log RSManagement_2021_11_05_09_55_47.log RSOffice_2021_11_05_09_56_17.log RSPortal_2021_11_05_09_56_17.log RSPowerBI_2021_11_05_09_56_17.log 2.2. Step 2: Deployment and Configuration # The Build Outputs of the Security Extenstion Project $ ls src/PowerBI.ReportingServices.Security/bin/Debug/net48/ EntityFramework.dll* Microsoft.Extensions.DependencyInjection.Abstractions.dll* EntityFramework.SqlServer.dll* Microsoft.Extensions.DependencyInjection.dll* PowerBI.ReportingServices.Security.dll* Microsoft.ReportingServices.Interfaces.dll* PowerBI.ReportingServices.Security.pdb Sso.aspx 2.2.1. To deploy the security extension Copy the Sso.aspx page to the &lt;install&gt;\ReportServer directory. Copy all the *.dll and *.pdb to the follow directories: &lt;install&gt;\ReportServer\bin &lt;install&gt;\Portal &lt;install&gt;\PowerBI 2.2.2. Modify files in the &lt;install&gt;\ReportServer direcotry To modify the rsreportserver.config file. Open the rsreportserver.config file with Visual Studio or a simple text editor such as Notepad. rsreportserver.config is located in the &lt;install&gt;\ReportServer directory. Locate the &lt;AuthenticationTypes&gt; element and modify the settings as follows: &lt;Authentication&gt; &lt;AuthenticationTypes&gt; &lt;!--&lt;RSWindowsNTLM/&gt;--&gt; (1) &lt;Custom/&gt; &lt;/AuthenticationTypes&gt; &lt;RSWindowsExtendedProtectionLevel&gt;Off&lt;/RSWindowsExtendedProtectionLevel&gt; &lt;RSWindowsExtendedProtectionScenario&gt;Proxy&lt;/RSWindowsExtendedProtectionScenario&gt; &lt;EnableAuthPersistence&gt;true&lt;/EnableAuthPersistence&gt; &lt;/Authentication&gt; 1 Note that you cannot use Custom with other authentication types. Locate the &lt;Security&gt; and &lt;Authentication&gt; elements, within the &lt;Extensions&gt; element, and modify the settings as follows: &lt;Security&gt; &lt;Extension Name=&quot;Forms&quot; Type=&quot;PowerBI.ReportingServices.Security.Authorization, PowerBI.ReportingServices.Security&quot;&gt; &lt;Configuration&gt; &lt;AdminConfiguration&gt; &lt;UserName&gt;admin1@local.me,admin2@google.com&lt;/UserName&gt; (1) &lt;/AdminConfiguration&gt; &lt;/Configuration&gt; &lt;/Extension&gt; &lt;!--&lt;Extension Name=&quot;Windows&quot; Type=&quot;Microsoft.ReportingServices.Authorization.WindowsAuthorization, Microsoft.ReportingServices.Authorization&quot;/&gt;--&gt; &lt;/Security&gt; 1 Note that you should specify one or many administrators here. &lt;Authentication&gt; &lt;Extension Name=&quot;Forms&quot; Type=&quot;PowerBI.ReportingServices.Security.Cas.Authentication, PowerBI.ReportingServices.Security&quot;/&gt; &lt;!--&lt;Extension Name=&quot;Windows&quot; Type=&quot;Microsoft.ReportingServices.Authentication.WindowsAuthentication, Microsoft.ReportingServices.Authorization&quot;/&gt;--&gt; &lt;/Authentication&gt; 2.2.3. To modify the web.config file for Report Server Open the web.config file in a text editor. By default, the file is in the &lt;install&gt;\ReportServer directory. Locate the &lt;identity&gt; element and set the Impersonate attribute to false. &lt;identity impersonate=&quot;false&quot; /&gt; &lt;!--&lt;identity impersonate=&quot;true&quot; /&gt;--&gt; Locate the &lt;authentication&gt; element and change the Mode attribute to Forms. Also, add the following &lt;forms&gt; element as a child of the &lt;authentication&gt; element and set the loginUrl, name, timeout, path, requireSSL, and cookieSameSite attributes as follows: &lt;!--&lt;authentication mode=&quot;Windows&quot; /&gt;--&gt; &lt;authentication mode=&quot;Forms&quot;&gt; &lt;forms loginUrl=&quot;Sso.aspx&quot; name=&quot;X-RS-TOKEN&quot; timeout=&quot;60&quot; path=&quot;/&quot; requireSSL=&quot;true&quot; cookieSameSite=&quot;None&quot;&gt; &lt;/forms&gt; &lt;/authentication&gt; For local development, if you cann&#8217;t debug with HTTPS, you should delete both the requireSSL and cookieSameSite attributes. &lt;!--&lt;authentication mode=&quot;Windows&quot; /&gt;--&gt; &lt;authentication mode=&quot;Forms&quot;&gt; &lt;forms loginUrl=&quot;Sso.aspx&quot; name=&quot;X-RS-TOKEN&quot; timeout=&quot;60&quot; path=&quot;/&quot;&gt; &lt;/forms&gt; &lt;/authentication&gt; Add the following &lt;authorization&gt; element directly after the &lt;authentication&gt; element. &lt;authorization&gt; &lt;deny users=&quot;?&quot; /&gt; &lt;/authorization&gt; This will deny unauthenticated users the right to access the report server. The previously established loginUrl attribute of the &lt;authentication&gt; element will redirect unauthenticated requests to the Sso.aspx page. Configuration &lt;appSettings&gt; and &lt;connectionStrings&gt; inner the element &lt;configuration&gt; as below. &lt;appSettings&gt; &lt;add key=&quot;cas.baseaddress&quot; value=&quot;https://cas.example.com&quot; /&gt; &lt;add key=&quot;cas.login.path&quot; value=&quot;/cas/login&quot; /&gt; &lt;add key=&quot;cas.service.validate.path&quot; value=&quot;/cas/serviceValidate&quot; /&gt; &lt;/appSettings&gt; &lt;connectionStrings&gt; &lt;add name=&quot;cas.useraccounts&quot; (1) connectionString=&quot;Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt; &lt;/connectionStrings&gt; 1 Your should modify the Data Source with the Server Name of your MSSQL, User ID and Password with your only SQL Server Authentication credentials. Locate the &lt;trust&gt; element and update it as follows: &lt;!--&lt;securityPolicy&gt; &lt;trustLevel name=&quot;RosettaSrv&quot; policyFile=&quot;rssrvpolicy.config&quot; /&gt; &lt;/securityPolicy&gt; &lt;trust level=&quot;RosettaSrv&quot; originUrl=&quot;&quot; egacyCasModel=&quot;true&quot; /&gt;--&gt; &lt;trust level=&quot;Full&quot; /&gt; 2.2.4. To modify the RSPortal.exe.config file for Report Server Portal Open the web.config file in a text editor. By default, the file is in the &lt;install&gt;\Portal directory. Configuration &lt;connectionStrings&gt; under the &lt;configuration&gt; as same as web.config as below. &lt;connectionStrings&gt; &lt;add name=&quot;cas.useraccounts&quot; connectionString=&quot;Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt; &lt;/connectionStrings&gt; 2.3. Step 3: Generate Machine Keys Using Forms authentication requires that all report server processes can access the authentication cookie. This involves configuring a machine key and decryption algorithm&#8201;&#8212;&#8201;a familiar step for those who had previously setup SSRS to work in scale-out environments. Generate and add &lt;MachineKey&gt; under &lt;Configuration&gt; in your rsreportserver.config file. &lt;MachineKey ValidationKey=&quot;[YOUR KEY]&quot; DecryptionKey=&quot;[YOUR KEY]&quot; Validation=&quot;AES&quot; Decryption=&quot;AES&quot; /&gt; The follow code snippet is a sample: &lt;Configuration&gt; &lt;MachineKey ValidationKey=&quot;C9A00A9C93B7AC6B8B3C27054DEDA40FDE08D20C481E808042F32784B3A7F5EF&quot; DecryptionKey=&quot;8F3D5F7B29A0EB685B61299502490226DA98BCB73B024F78651C24517A5ACCB9&quot; Validation=&quot;AES&quot; Decryption=&quot;AES&quot;/&gt; . . . Check the casing of the attributes, it should be Pascal Casing as the example above. There is not need for a &lt;system.web&gt; entry. You should use a validation key specific for you deployment, there are several tools to generate the keys such as Internet Information Services Manager (IIS), or the online machine-key-generator. 2.4. Step 4: Configure Passthrough cookies The new portal and the reportserver communicate using internal soap APIs for some of its operations. When additional cookies are required to be passed from the portal to the server the PassThroughCookies properties is still available. More Details: https://msdn.microsoft.com/en-us/library/ms345241.aspx. In the rsreportserver.config file add following under &lt;UI&gt;. &lt;UI&gt; &lt;ReportServerUrl&gt;&lt;/ReportServerUrl&gt; &lt;PageCountMode&gt;Estimate&lt;/PageCountMode&gt; &lt;CustomAuthenticationUI&gt; &lt;PassThroughCookies&gt; &lt;PassThroughCookie&gt;X-RS-TOKEN&lt;/PassThroughCookie&gt; &lt;/PassThroughCookies&gt; &lt;/CustomAuthenticationUI&gt; &lt;/UI&gt; 3. Security Extensions Overview Reporting Services provides an extensible architecture that allows you to plug in custom or forms-based authentication modules. You might consider implementing a custom authentication extension if deployment requirements do not include Windows integrated security or Basic authentication. The most common scenario for using custom authentication is to support Internet or extranet access to a Web application. Replacing the default Windows Authentication extension with a custom authentication extension gives you more control over how external users are granted access to the report server. In practice, deploying a custom authentication extension requires multiple steps that include copying assemblies and application files, modifying configuration files, and testing. Creating a custom authentication extension requires custom code and expertise in ASP.NET security. If you do not want to create a custom authentication extension, you can use Microsoft Active Directory groups and accounts, but you should greatly reduce the scope of a report server deployment. For more information about custom authentication, see Implementing a Security Extension. We recommend that you use Windows Authentication if at all possible. However, custom authentication and authorization for Reporting Services may be appropriate in the following two cases: You have an Internet or extranet application that cannot use Windows accounts. You have custom-defined users and roles and need to provide a matching authorization scheme in Reporting Services. As shown in the above figure, authentication and authorization occur as follows: &lt;1&gt; A user tries to access the web portal by using a URL and is redirected to a form that collects user credentials for the client application. &lt;2&gt; The user submits credentials to the form. &lt;3&gt; The user credentials are submitted to the Reporting Services Web service through the LogonUser method. &lt;4&gt; The Web service calls the customer-supplied security extension and verifies that the user name and password exist in the custom security authority. &lt;5&gt; After authentication, the Web service creates an authentication ticket (known as a &quot;cookie&quot;), manages the ticket, and verifies the user&#8217;s role for the Home page of the web portal. &lt;6&gt; The Web service returns the cookie to the browser and displays the appropriate user interface in the web portal. &lt;7&gt; After the user is authenticated, the browser makes requests to the web portal while transmitting the cookie in the HTTP header. These requests are in response to user actions within the web portal. &lt;8&gt; The cookie is transmitted in the HTTP header to the Web service along with the requested user operation. &lt;9&gt; The cookie is validated, and if it is valid, the report server returns the security descriptor and other information relating to the requested operation from the report server database. &lt;10&gt; If the cookie is valid, the report server makes a call to the security extension to check if the user is authorized to perform the specific operation. &lt;11&gt; If the user is authorized, the report server performs the requested operation and returns control to the caller. &lt;12&gt; After the user is authenticated, URL access to the report server uses the same cookie. The cookie is transmitted in the HTTP header. &lt;13&gt; The user continues to request operations on the report server until the session has ended. 3.1. Authentication in Reporting Services Authentication is the process of establishing a user&#8217;s right to an identity. There are many techniques that you can use to authenticate a user. The most common way is to use passwords. When you implement Forms Authentication, for example, you want an implementation that queries users for credentials (usually by some interface that requests a login name and password) and then validates users against a data store, such as a database table or configuration file. If the credentials can&#8217;t be validated, the authentication process fails and the user will assume an anonymous identity. In Reporting Services, the Windows operating system handles the authentication of users either through integrated security or through the explicit reception and validation of user credentials. Custom authentication can be developed in Reporting Services to support additional authentication schemes. This is made possible through the security extension interface IAuthenticationExtension2. All extensions inherit from the IExtension base interface for any extension deployed and used by the report server. IExtension, as well as IAuthenticationExtension2, are members of the Microsoft.ReportingServices.Interfaces namespace. As shown in the above figure, the authentication process is as follows: &lt;1&gt; A client application calls the Web service LogonUser method to authenticate a user. &lt;2&gt; The Web service makes a call to the LogonUser method of your security extension, specifically, the class that implements IAuthenticationExtension2. &lt;3&gt; Your implementation of LogonUser validates the user name and password in the user store or security authority. &lt;4&gt; Upon successful authentication, the Web service creates a cookie and manages it for the session. &lt;5&gt; The Web service returns the authentication ticket to the calling application on the HTTP header. 3.2. Authorization in Reporting Services Authorization is the process of determining whether an identity should be granted the requested type of access to a given resource in the report server database. Reporting Services uses a role-based authorization architecture that grants a user access to a given resource based on the user&#8217;s role assignment for the application. Security extensions for Reporting Services contain an implementation of an authorization component that is used to grant access to users once they are authenticated on the report server. Authorization is invoked when a user attempts to perform an operation on the system or a report server item through the SOAP API and via URL access. This is made possible through the security extension interface IAuthorizationExtension. As stated previously, all extensions inherit from IExtension the base interface for any extension that you deploy. IExtension and IAuthorizationExtension are members of the Microsoft.ReportingServices.Interfaces namespace. As shown in the Figure 3, authorization follows this sequence: &lt;1&gt; Once authenticated, client applications make requests to the report server through the Reporting Services Web service methods. An authentication ticket is passed to the report server in the form of a cookie in the HTTP header of each Web request. &lt;2&gt; The cookie is validated prior to any access check. &lt;3&gt; Once the cookie is validated, the report server calls GetUserInfo and the user is given an identity. &lt;4&gt; The user attempts an operation through the Reporting Services Web service. &lt;5&gt; The report server calls the CheckAccess method. &lt;6&gt; The security descriptor is retrieved and passed to a custom security extension implementation of CheckAccess. At this point, the user, group, or computer is compared to the security descriptor of the item being accessed and is authorized to perform the requested operation. &lt;7&gt; If the user is authorized, the Web service performs the operation and returns a response to the calling application. 4. References https://docs.microsoft.com/en-us/power-bi/report-server/get-started, What is Power BI Report Server? https://docs.microsoft.com/en-us/power-bi/report-server/install-report-server, Install Power BI Report Server https://docs.microsoft.com/en-us/power-bi/report-server/install-powerbi-desktop, Install Power BI Desktop for Power BI Report Server https://www.microsoft.com/en-us/sql-server/sql-server-downloads, SQL Server Downloads Microsoft https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15, Download SQL Server Management Studio (SSMS) https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-configuration-files?view=sql-server-ver15, Reporting Services Configuration Files https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-log-files-and-sources?view=sql-server-ver15, Reporting Services Log Files and Sources https://docs.microsoft.com/en-us/sql/reporting-services/security/authentication-with-the-report-server?view=sql-server-ver15, Authentication with the Report Server https://docs.microsoft.com/en-us/sql/reporting-services/extensions-ssrs?view=sql-server-ver15, Extensions for SQL Server Reporting Services (SSRS) https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/security-extensions-overview?view=sql-server-ver15, Security Extensions Overview - Reporting Services (SSRS) https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authentication-in-reporting-services?view=sql-server-ver15, Authentication in Reporting Services https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authorization-in-reporting-services?view=sql-server-ver15, Authorization in Reporting Services https://docs.microsoft.com/en-us/sql/reporting-services/extensions/secure-development/using-reporting-services-security-policy-files?view=sql-server-ver15#placement-of-codegroup-elements-for-extensions, Placement of CodeGroup Elements for Extensions https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-1.1/b5ysx397(v=vs.71), ASP.NET Settings Schema https://docs.microsoft.com/en-us/previous-versions/, Previous versions of Microsoft products, services and technologies https://www.entityframeworktutorial.net/code-first/automated-migration-in-code-first.aspx, Automated Migration in Entity Framework 6 https://codewithshadman.com/machine-key-generator/, Machine Key Generator" />
<link rel="canonical" href="https://blog.codefarm.me/2021/08/18/powerbi-report-server-with-cas/" />
<meta property="og:url" content="https://blog.codefarm.me/2021/08/18/powerbi-report-server-with-cas/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-18T13:38:01+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="PowerBI Report Server Extensions with CAS" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-08-18T13:38:01+08:00","datePublished":"2021-08-18T13:38:01+08:00","description":"1. Prerequisites 2. Reporting Services Custom Security 2.1. Step 1. Build the Extension Project 2.2. Step 2: Deployment and Configuration 2.3. Step 3: Generate Machine Keys 2.4. Step 4: Configure Passthrough cookies 3. Security Extensions Overview 3.1. Authentication in Reporting Services 3.2. Authorization in Reporting Services 4. References 1. Prerequisites .NET Framework 4.8 Developer Pack Microsoft Visual Studio Community 2019 Version 16.10.4+ Microsoft Power BI Report Server - May 2021 SQL Server 2019 NET 5.0 SDK(Optional) How to Build .NET Project with CLI \\# Open Developer Command Prompt for VS 2019 and goto the project directory, then type the follow commands: &gt; msbuild -t:Clean (1) &gt; msbuild -t:Build (2) &gt; msbuild (3) &gt; msbuild -p:Configuration=Release (4) 1 Clean build outputs of a .NET project. 2 Build a .NET project. 3 Build a .NET project with default build target. 4 Build a .NET project with Release configuration. \\# Open any Command Prompt or Bash Console and goto the project direcotry, then type the follow commands: $ dotnet clean (1) $ dotnet build (2) $ dotnet build -c Release (3) 1 Clean build outputs of a .NET project. 2 Build a .NET project. 3 Build a .NET project with Release configuration. 2. Reporting Services Custom Security You must first compile and install the extension. The procedure assumes that you have installed Reporting Services to the default location: C:\\Program Files\\Microsoft Power BI Report Server\\PBIRS. This location will be referred to throughout the remainder of this topic as &lt;install&gt;. 2.1. Step 1. Build the Extension Project Source code @ https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git $ git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git Cloning into &#39;PowerBI.ReportingServices.Extensions&#39;... remote: Enumerating objects: 63, done. remote: Counting objects: 100% (63/63), done. remote: Compressing objects: 100% (54/54), done. remote: Total 63 (delta 15), reused 52 (delta 6), pack-reused 0 Receiving objects: 100% (63/63), 71.26 KiB | 513.00 KiB/s, done. Resolving deltas: 100% (15/15), done. $ cd PowerBI.ReportingServices.Extensions $ dotnet build Microsoft (R) Build Engine version 16.10.2+857e5a733 for .NET Copyright (C) Microsoft Corporation. All rights reserved. Determining projects to restore... Restored ...\\src\\PowerBI.ReportingServices.Security\\PowerBI.ReportingServices.Security.csproj (in 209 ms). PowerBI.ReportingServices.Security -&gt; ...\\src\\PowerBI.ReportingServices.Security\\bin\\Debug\\net48\\PowerBI.ReportingServices.Security.dll Build succeeded. 0 Warning(s) 0 Error(s) Time Elapsed 00:00:03.51 To compile the Project using Visual Studio Open PowerBI.ReportingServices.sln in Microsoft Visual Studio. In Solution Explorer, select the PowerBI.ReportingServices.Security project. Look at the PowerBI.ReportingServices.Security project&#8217;s Dependencies&#8594;Assemblies. If you do not see Microsoft.ReportingServices.Interfaces.dll, then complete the following steps: On the Assemblies menu, right click Add Assembly Reference.... The Add References dialog box opens. Click Browse, and find Microsoft.ReportingServices.Interfaces on your local drive. By default, the assembly is in the &lt;install&gt;\\ReportServer\\bin directory. Click OK. The selected reference is added to your project. If you do not see EntityFramework.dll, EntityFramework.SqlServer.dll, Microsoft.Extensions.DependencyInjection.dll and Microsoft.Extensions.DependencyInjection.Abstractions.dll, then complete the following steps: On the Assemblies menu, right click Add Assembly Reference.... The Add References dialog box opens. Click Browse, and find these assemblies on your local drive. By default, the assembly is in the &lt;install&gt;\\Portal directory- Click OK. The selected reference is added to your project. On the Build menu, click Build Solution. Debugging To debug the extension, you might want to attach the debugger to both ReportingServicesService.exe, RSPortal.exe and RSPowerBI.exe. And add breakpoints to the methods implementing the interface IAuthenticationExtension2 and IAuthorizationExtension. Troubleshooting If the report server cann&#8217;t work expectedly, you may need to analyze the reprot server log files at &lt;install&gt;/LogFiles, especially the following highlight files : $ ls -1 LogFiles/ ASManagedRoot_2021_11_05_09_56_18.log FlightRecorderCurrent.trc msmdsrv.log ReportingServicesService_2021_11_05_09_56_17.log ReportingServicesWMI_2021_11_05_09_54_26.log RSHostingService_2021_11_05_09_55_46.log RSManagement_2021_11_05_09_55_47.log RSOffice_2021_11_05_09_56_17.log RSPortal_2021_11_05_09_56_17.log RSPowerBI_2021_11_05_09_56_17.log 2.2. Step 2: Deployment and Configuration # The Build Outputs of the Security Extenstion Project $ ls src/PowerBI.ReportingServices.Security/bin/Debug/net48/ EntityFramework.dll* Microsoft.Extensions.DependencyInjection.Abstractions.dll* EntityFramework.SqlServer.dll* Microsoft.Extensions.DependencyInjection.dll* PowerBI.ReportingServices.Security.dll* Microsoft.ReportingServices.Interfaces.dll* PowerBI.ReportingServices.Security.pdb Sso.aspx 2.2.1. To deploy the security extension Copy the Sso.aspx page to the &lt;install&gt;\\ReportServer directory. Copy all the *.dll and *.pdb to the follow directories: &lt;install&gt;\\ReportServer\\bin &lt;install&gt;\\Portal &lt;install&gt;\\PowerBI 2.2.2. Modify files in the &lt;install&gt;\\ReportServer direcotry To modify the rsreportserver.config file. Open the rsreportserver.config file with Visual Studio or a simple text editor such as Notepad. rsreportserver.config is located in the &lt;install&gt;\\ReportServer directory. Locate the &lt;AuthenticationTypes&gt; element and modify the settings as follows: &lt;Authentication&gt; &lt;AuthenticationTypes&gt; &lt;!--&lt;RSWindowsNTLM/&gt;--&gt; (1) &lt;Custom/&gt; &lt;/AuthenticationTypes&gt; &lt;RSWindowsExtendedProtectionLevel&gt;Off&lt;/RSWindowsExtendedProtectionLevel&gt; &lt;RSWindowsExtendedProtectionScenario&gt;Proxy&lt;/RSWindowsExtendedProtectionScenario&gt; &lt;EnableAuthPersistence&gt;true&lt;/EnableAuthPersistence&gt; &lt;/Authentication&gt; 1 Note that you cannot use Custom with other authentication types. Locate the &lt;Security&gt; and &lt;Authentication&gt; elements, within the &lt;Extensions&gt; element, and modify the settings as follows: &lt;Security&gt; &lt;Extension Name=&quot;Forms&quot; Type=&quot;PowerBI.ReportingServices.Security.Authorization, PowerBI.ReportingServices.Security&quot;&gt; &lt;Configuration&gt; &lt;AdminConfiguration&gt; &lt;UserName&gt;admin1@local.me,admin2@google.com&lt;/UserName&gt; (1) &lt;/AdminConfiguration&gt; &lt;/Configuration&gt; &lt;/Extension&gt; &lt;!--&lt;Extension Name=&quot;Windows&quot; Type=&quot;Microsoft.ReportingServices.Authorization.WindowsAuthorization, Microsoft.ReportingServices.Authorization&quot;/&gt;--&gt; &lt;/Security&gt; 1 Note that you should specify one or many administrators here. &lt;Authentication&gt; &lt;Extension Name=&quot;Forms&quot; Type=&quot;PowerBI.ReportingServices.Security.Cas.Authentication, PowerBI.ReportingServices.Security&quot;/&gt; &lt;!--&lt;Extension Name=&quot;Windows&quot; Type=&quot;Microsoft.ReportingServices.Authentication.WindowsAuthentication, Microsoft.ReportingServices.Authorization&quot;/&gt;--&gt; &lt;/Authentication&gt; 2.2.3. To modify the web.config file for Report Server Open the web.config file in a text editor. By default, the file is in the &lt;install&gt;\\ReportServer directory. Locate the &lt;identity&gt; element and set the Impersonate attribute to false. &lt;identity impersonate=&quot;false&quot; /&gt; &lt;!--&lt;identity impersonate=&quot;true&quot; /&gt;--&gt; Locate the &lt;authentication&gt; element and change the Mode attribute to Forms. Also, add the following &lt;forms&gt; element as a child of the &lt;authentication&gt; element and set the loginUrl, name, timeout, path, requireSSL, and cookieSameSite attributes as follows: &lt;!--&lt;authentication mode=&quot;Windows&quot; /&gt;--&gt; &lt;authentication mode=&quot;Forms&quot;&gt; &lt;forms loginUrl=&quot;Sso.aspx&quot; name=&quot;X-RS-TOKEN&quot; timeout=&quot;60&quot; path=&quot;/&quot; requireSSL=&quot;true&quot; cookieSameSite=&quot;None&quot;&gt; &lt;/forms&gt; &lt;/authentication&gt; For local development, if you cann&#8217;t debug with HTTPS, you should delete both the requireSSL and cookieSameSite attributes. &lt;!--&lt;authentication mode=&quot;Windows&quot; /&gt;--&gt; &lt;authentication mode=&quot;Forms&quot;&gt; &lt;forms loginUrl=&quot;Sso.aspx&quot; name=&quot;X-RS-TOKEN&quot; timeout=&quot;60&quot; path=&quot;/&quot;&gt; &lt;/forms&gt; &lt;/authentication&gt; Add the following &lt;authorization&gt; element directly after the &lt;authentication&gt; element. &lt;authorization&gt; &lt;deny users=&quot;?&quot; /&gt; &lt;/authorization&gt; This will deny unauthenticated users the right to access the report server. The previously established loginUrl attribute of the &lt;authentication&gt; element will redirect unauthenticated requests to the Sso.aspx page. Configuration &lt;appSettings&gt; and &lt;connectionStrings&gt; inner the element &lt;configuration&gt; as below. &lt;appSettings&gt; &lt;add key=&quot;cas.baseaddress&quot; value=&quot;https://cas.example.com&quot; /&gt; &lt;add key=&quot;cas.login.path&quot; value=&quot;/cas/login&quot; /&gt; &lt;add key=&quot;cas.service.validate.path&quot; value=&quot;/cas/serviceValidate&quot; /&gt; &lt;/appSettings&gt; &lt;connectionStrings&gt; &lt;add name=&quot;cas.useraccounts&quot; (1) connectionString=&quot;Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt; &lt;/connectionStrings&gt; 1 Your should modify the Data Source with the Server Name of your MSSQL, User ID and Password with your only SQL Server Authentication credentials. Locate the &lt;trust&gt; element and update it as follows: &lt;!--&lt;securityPolicy&gt; &lt;trustLevel name=&quot;RosettaSrv&quot; policyFile=&quot;rssrvpolicy.config&quot; /&gt; &lt;/securityPolicy&gt; &lt;trust level=&quot;RosettaSrv&quot; originUrl=&quot;&quot; egacyCasModel=&quot;true&quot; /&gt;--&gt; &lt;trust level=&quot;Full&quot; /&gt; 2.2.4. To modify the RSPortal.exe.config file for Report Server Portal Open the web.config file in a text editor. By default, the file is in the &lt;install&gt;\\Portal directory. Configuration &lt;connectionStrings&gt; under the &lt;configuration&gt; as same as web.config as below. &lt;connectionStrings&gt; &lt;add name=&quot;cas.useraccounts&quot; connectionString=&quot;Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt; &lt;/connectionStrings&gt; 2.3. Step 3: Generate Machine Keys Using Forms authentication requires that all report server processes can access the authentication cookie. This involves configuring a machine key and decryption algorithm&#8201;&#8212;&#8201;a familiar step for those who had previously setup SSRS to work in scale-out environments. Generate and add &lt;MachineKey&gt; under &lt;Configuration&gt; in your rsreportserver.config file. &lt;MachineKey ValidationKey=&quot;[YOUR KEY]&quot; DecryptionKey=&quot;[YOUR KEY]&quot; Validation=&quot;AES&quot; Decryption=&quot;AES&quot; /&gt; The follow code snippet is a sample: &lt;Configuration&gt; &lt;MachineKey ValidationKey=&quot;C9A00A9C93B7AC6B8B3C27054DEDA40FDE08D20C481E808042F32784B3A7F5EF&quot; DecryptionKey=&quot;8F3D5F7B29A0EB685B61299502490226DA98BCB73B024F78651C24517A5ACCB9&quot; Validation=&quot;AES&quot; Decryption=&quot;AES&quot;/&gt; . . . Check the casing of the attributes, it should be Pascal Casing as the example above. There is not need for a &lt;system.web&gt; entry. You should use a validation key specific for you deployment, there are several tools to generate the keys such as Internet Information Services Manager (IIS), or the online machine-key-generator. 2.4. Step 4: Configure Passthrough cookies The new portal and the reportserver communicate using internal soap APIs for some of its operations. When additional cookies are required to be passed from the portal to the server the PassThroughCookies properties is still available. More Details: https://msdn.microsoft.com/en-us/library/ms345241.aspx. In the rsreportserver.config file add following under &lt;UI&gt;. &lt;UI&gt; &lt;ReportServerUrl&gt;&lt;/ReportServerUrl&gt; &lt;PageCountMode&gt;Estimate&lt;/PageCountMode&gt; &lt;CustomAuthenticationUI&gt; &lt;PassThroughCookies&gt; &lt;PassThroughCookie&gt;X-RS-TOKEN&lt;/PassThroughCookie&gt; &lt;/PassThroughCookies&gt; &lt;/CustomAuthenticationUI&gt; &lt;/UI&gt; 3. Security Extensions Overview Reporting Services provides an extensible architecture that allows you to plug in custom or forms-based authentication modules. You might consider implementing a custom authentication extension if deployment requirements do not include Windows integrated security or Basic authentication. The most common scenario for using custom authentication is to support Internet or extranet access to a Web application. Replacing the default Windows Authentication extension with a custom authentication extension gives you more control over how external users are granted access to the report server. In practice, deploying a custom authentication extension requires multiple steps that include copying assemblies and application files, modifying configuration files, and testing. Creating a custom authentication extension requires custom code and expertise in ASP.NET security. If you do not want to create a custom authentication extension, you can use Microsoft Active Directory groups and accounts, but you should greatly reduce the scope of a report server deployment. For more information about custom authentication, see Implementing a Security Extension. We recommend that you use Windows Authentication if at all possible. However, custom authentication and authorization for Reporting Services may be appropriate in the following two cases: You have an Internet or extranet application that cannot use Windows accounts. You have custom-defined users and roles and need to provide a matching authorization scheme in Reporting Services. As shown in the above figure, authentication and authorization occur as follows: &lt;1&gt; A user tries to access the web portal by using a URL and is redirected to a form that collects user credentials for the client application. &lt;2&gt; The user submits credentials to the form. &lt;3&gt; The user credentials are submitted to the Reporting Services Web service through the LogonUser method. &lt;4&gt; The Web service calls the customer-supplied security extension and verifies that the user name and password exist in the custom security authority. &lt;5&gt; After authentication, the Web service creates an authentication ticket (known as a &quot;cookie&quot;), manages the ticket, and verifies the user&#8217;s role for the Home page of the web portal. &lt;6&gt; The Web service returns the cookie to the browser and displays the appropriate user interface in the web portal. &lt;7&gt; After the user is authenticated, the browser makes requests to the web portal while transmitting the cookie in the HTTP header. These requests are in response to user actions within the web portal. &lt;8&gt; The cookie is transmitted in the HTTP header to the Web service along with the requested user operation. &lt;9&gt; The cookie is validated, and if it is valid, the report server returns the security descriptor and other information relating to the requested operation from the report server database. &lt;10&gt; If the cookie is valid, the report server makes a call to the security extension to check if the user is authorized to perform the specific operation. &lt;11&gt; If the user is authorized, the report server performs the requested operation and returns control to the caller. &lt;12&gt; After the user is authenticated, URL access to the report server uses the same cookie. The cookie is transmitted in the HTTP header. &lt;13&gt; The user continues to request operations on the report server until the session has ended. 3.1. Authentication in Reporting Services Authentication is the process of establishing a user&#8217;s right to an identity. There are many techniques that you can use to authenticate a user. The most common way is to use passwords. When you implement Forms Authentication, for example, you want an implementation that queries users for credentials (usually by some interface that requests a login name and password) and then validates users against a data store, such as a database table or configuration file. If the credentials can&#8217;t be validated, the authentication process fails and the user will assume an anonymous identity. In Reporting Services, the Windows operating system handles the authentication of users either through integrated security or through the explicit reception and validation of user credentials. Custom authentication can be developed in Reporting Services to support additional authentication schemes. This is made possible through the security extension interface IAuthenticationExtension2. All extensions inherit from the IExtension base interface for any extension deployed and used by the report server. IExtension, as well as IAuthenticationExtension2, are members of the Microsoft.ReportingServices.Interfaces namespace. As shown in the above figure, the authentication process is as follows: &lt;1&gt; A client application calls the Web service LogonUser method to authenticate a user. &lt;2&gt; The Web service makes a call to the LogonUser method of your security extension, specifically, the class that implements IAuthenticationExtension2. &lt;3&gt; Your implementation of LogonUser validates the user name and password in the user store or security authority. &lt;4&gt; Upon successful authentication, the Web service creates a cookie and manages it for the session. &lt;5&gt; The Web service returns the authentication ticket to the calling application on the HTTP header. 3.2. Authorization in Reporting Services Authorization is the process of determining whether an identity should be granted the requested type of access to a given resource in the report server database. Reporting Services uses a role-based authorization architecture that grants a user access to a given resource based on the user&#8217;s role assignment for the application. Security extensions for Reporting Services contain an implementation of an authorization component that is used to grant access to users once they are authenticated on the report server. Authorization is invoked when a user attempts to perform an operation on the system or a report server item through the SOAP API and via URL access. This is made possible through the security extension interface IAuthorizationExtension. As stated previously, all extensions inherit from IExtension the base interface for any extension that you deploy. IExtension and IAuthorizationExtension are members of the Microsoft.ReportingServices.Interfaces namespace. As shown in the Figure 3, authorization follows this sequence: &lt;1&gt; Once authenticated, client applications make requests to the report server through the Reporting Services Web service methods. An authentication ticket is passed to the report server in the form of a cookie in the HTTP header of each Web request. &lt;2&gt; The cookie is validated prior to any access check. &lt;3&gt; Once the cookie is validated, the report server calls GetUserInfo and the user is given an identity. &lt;4&gt; The user attempts an operation through the Reporting Services Web service. &lt;5&gt; The report server calls the CheckAccess method. &lt;6&gt; The security descriptor is retrieved and passed to a custom security extension implementation of CheckAccess. At this point, the user, group, or computer is compared to the security descriptor of the item being accessed and is authorized to perform the requested operation. &lt;7&gt; If the user is authorized, the Web service performs the operation and returns a response to the calling application. 4. References https://docs.microsoft.com/en-us/power-bi/report-server/get-started, What is Power BI Report Server? https://docs.microsoft.com/en-us/power-bi/report-server/install-report-server, Install Power BI Report Server https://docs.microsoft.com/en-us/power-bi/report-server/install-powerbi-desktop, Install Power BI Desktop for Power BI Report Server https://www.microsoft.com/en-us/sql-server/sql-server-downloads, SQL Server Downloads Microsoft https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15, Download SQL Server Management Studio (SSMS) https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-configuration-files?view=sql-server-ver15, Reporting Services Configuration Files https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-log-files-and-sources?view=sql-server-ver15, Reporting Services Log Files and Sources https://docs.microsoft.com/en-us/sql/reporting-services/security/authentication-with-the-report-server?view=sql-server-ver15, Authentication with the Report Server https://docs.microsoft.com/en-us/sql/reporting-services/extensions-ssrs?view=sql-server-ver15, Extensions for SQL Server Reporting Services (SSRS) https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/security-extensions-overview?view=sql-server-ver15, Security Extensions Overview - Reporting Services (SSRS) https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authentication-in-reporting-services?view=sql-server-ver15, Authentication in Reporting Services https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authorization-in-reporting-services?view=sql-server-ver15, Authorization in Reporting Services https://docs.microsoft.com/en-us/sql/reporting-services/extensions/secure-development/using-reporting-services-security-policy-files?view=sql-server-ver15#placement-of-codegroup-elements-for-extensions, Placement of CodeGroup Elements for Extensions https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-1.1/b5ysx397(v=vs.71), ASP.NET Settings Schema https://docs.microsoft.com/en-us/previous-versions/, Previous versions of Microsoft products, services and technologies https://www.entityframeworktutorial.net/code-first/automated-migration-in-code-first.aspx, Automated Migration in Entity Framework 6 https://codewithshadman.com/machine-key-generator/, Machine Key Generator","headline":"PowerBI Report Server Extensions with CAS","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2021/08/18/powerbi-report-server-with-cas/"},"url":"https://blog.codefarm.me/2021/08/18/powerbi-report-server-with-cas/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">PowerBI Report Server Extensions with CAS</h1><p class="c-post-meta">18 Aug 2021</p>
  </header>

  <div class="c-post-content">
    <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#prerequisites">1. Prerequisites</a></li>
<li><a href="#reporting-services-custom-security">2. Reporting Services Custom Security</a>
<ul class="sectlevel2">
<li><a href="#step-1-build-the-extension-project">2.1. Step 1. Build the Extension Project</a></li>
<li><a href="#step-2-deployment-and-configuration">2.2. Step 2: Deployment and Configuration</a></li>
<li><a href="#step-3-generate-machine-keys">2.3. Step 3: Generate Machine Keys</a></li>
<li><a href="#step-4-configure-passthrough-cookies">2.4. Step 4: Configure Passthrough cookies</a></li>
</ul>
</li>
<li><a href="#security-extensions-overview">3. Security Extensions Overview</a>
<ul class="sectlevel2">
<li><a href="#authentication-in-reporting-services">3.1. Authentication in Reporting Services</a></li>
<li><a href="#authorization-in-reporting-services">3.2. Authorization in Reporting Services</a></li>
</ul>
</li>
<li><a href="#references">4. References</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="prerequisites">1. Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://dotnet.microsoft.com/download/dotnet-framework/net48">.NET Framework 4.8 Developer Pack</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/visualstudio/releases/2019/release-notes">Microsoft Visual Studio Community 2019 Version 16.10.4+</a></p>
</li>
<li>
<p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56722">Microsoft Power BI Report Server - May 2021</a></p>
</li>
<li>
<p><a href="https://www.microsoft.com/en-us/evalcenter/evaluate-sql-server-2019?filetype=EXE">SQL Server 2019</a></p>
</li>
<li>
<p><a href="https://dotnet.microsoft.com/download/dotnet/5.0">NET 5.0 SDK</a>(Optional)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<div class="title"><strong>How to Build .NET Project with CLI</strong></div>
<p>\# Open <code>Developer Command Prompt for VS 2019</code> and goto the project directory, then type the follow commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="dos">&gt; msbuild -t:Clean <i class="conum" data-value="1"></i><b>(1)</b>
&gt; msbuild -t:Build <i class="conum" data-value="2"></i><b>(2)</b>
&gt; msbuild <i class="conum" data-value="3"></i><b>(3)</b>
&gt; msbuild -p:Configuration=Release <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Clean build outputs of a .NET project.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Build a .NET project.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Build a .NET project with default <code>build</code> target.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build a .NET project with <code>Release</code> configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>\# Open any Command Prompt or Bash Console and goto the project direcotry, then type the follow commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh"><span class="nv">$ </span>dotnet clean <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nv">$ </span>dotnet build <i class="conum" data-value="2"></i><b>(2)</b>
<span class="nv">$ </span>dotnet build <span class="nt">-c</span> Release <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Clean build outputs of a .NET project.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Build a .NET project.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Build a .NET project with <code>Release</code> configuration.</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reporting-services-custom-security">2. Reporting Services Custom Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You must first compile and install the extension. The procedure assumes that you have installed Reporting Services to the default location: <code>C:\Program Files\Microsoft Power BI Report Server\PBIRS</code>. This location will be referred to throughout the remainder of this topic as <code>&lt;install&gt;</code>.</p>
</div>
<div class="sect2">
<h3 id="step-1-build-the-extension-project">2.1. Step 1. Build the Extension Project</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Source code @ <a href="https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git" class="bare">https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git
<span class="go">git clone https://github.com/qqbuby/PowerBI.ReportingServices.Extensions.git
Cloning into 'PowerBI.ReportingServices.Extensions'...
remote: Enumerating objects: 63, done.
remote: Counting objects: 100% (63/63), done.
remote: Compressing objects: 100% (54/54), done.
remote: Total 63 (delta 15), reused 52 (delta 6), pack-reused 0
Receiving objects: 100% (63/63), 71.26 KiB | 513.00 KiB/s, done.
Resolving deltas: 100% (15/15), done.
</span><span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>PowerBI.ReportingServices.Extensions</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>dotnet build
<span class="go">Microsoft (R) Build Engine version 16.10.2+857e5a733 for .NET
Copyright (C) Microsoft Corporation. All rights reserved.

  Determining projects to restore...
  Restored ...\src\PowerBI.ReportingServices.Security\PowerBI.ReportingServices.Security.csproj (in 209 ms).
</span><span class="gp">  PowerBI.ReportingServices.Security -&gt;</span><span class="w"> </span>...<span class="se">\s</span>rc<span class="se">\P</span>owerBI.ReportingServices.Security<span class="se">\b</span><span class="k">in</span><span class="se">\D</span>ebug<span class="se">\n</span>et48<span class="se">\P</span>owerBI.ReportingServices.Security.dll
<span class="go">
Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:03.51</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<div class="title">To compile the Project using Visual Studio</div>
<ul>
<li>
<p>Open <code>PowerBI.ReportingServices.sln</code> in Microsoft Visual Studio.</p>
</li>
<li>
<p>In Solution Explorer, select the PowerBI.ReportingServices.Security project.</p>
</li>
<li>
<p>Look at the PowerBI.ReportingServices.Security project&#8217;s Dependencies&#8594;Assemblies.</p>
<div class="ulist">
<ul>
<li>
<p>If you do not see <code>Microsoft.ReportingServices.Interfaces.dll</code>, then complete the following steps:</p>
<div class="ulist">
<ul>
<li>
<p>On the Assemblies menu, right click <code>Add Assembly Reference...</code>. The Add References dialog box opens.</p>
</li>
<li>
<p>Click Browse, and find Microsoft.ReportingServices.Interfaces on your local drive. By default, the assembly is in the <code>&lt;install&gt;\ReportServer\bin</code> directory. Click OK. The selected reference is added to your project.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If you do not see <code>EntityFramework.dll</code>, <code>EntityFramework.SqlServer.dll</code>, <code>Microsoft.Extensions.DependencyInjection.dll</code> and <code>Microsoft.Extensions.DependencyInjection.Abstractions.dll</code>, then complete the following steps:</p>
<div class="ulist">
<ul>
<li>
<p>On the Assemblies menu, right click <code>Add Assembly Reference...</code>. The Add References dialog box opens.</p>
</li>
<li>
<p>Click Browse, and find these assemblies on your local drive. By default, the assembly is in the <code>&lt;install&gt;\Portal</code> directory- Click OK. The selected reference is added to your project.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>On the Build menu, click Build Solution.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<div class="title">Debugging</div>
<p>To debug the extension, you might want to attach the debugger to both <code>ReportingServicesService.exe</code>, <code>RSPortal.exe</code> and <code>RSPowerBI.exe</code>. And add breakpoints to the methods implementing the interface <code>IAuthenticationExtension2</code> and <code>IAuthorizationExtension</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<div class="title">Troubleshooting</div>
<p>If the report server cann&#8217;t work expectedly, you may need to analyze the reprot server log files at <code>&lt;install&gt;/LogFiles</code>, especially the following highlight files :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-1</span> LogFiles/
<span class="go">ASManagedRoot_2021_11_05_09_56_18.log</span>
<span class="go">FlightRecorderCurrent.trc</span>
<span class="go">msmdsrv.log</span>
<span class="hll"><span class="go">ReportingServicesService_2021_11_05_09_56_17.log</span>
</span><span class="go">ReportingServicesWMI_2021_11_05_09_54_26.log</span>
<span class="go">RSHostingService_2021_11_05_09_55_46.log</span>
<span class="go">RSManagement_2021_11_05_09_55_47.log</span>
<span class="go">RSOffice_2021_11_05_09_56_17.log</span>
<span class="hll"><span class="go">RSPortal_2021_11_05_09_56_17.log</span>
</span><span class="hll"><span class="go">RSPowerBI_2021_11_05_09_56_17.log</span>
</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="step-2-deployment-and-configuration">2.2. Step 2: Deployment and Configuration</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">#</span><span class="w"> </span>The Build Outputs of the Security Extenstion Project
<span class="gp">$</span><span class="w"> </span><span class="nb">ls </span>src/PowerBI.ReportingServices.Security/bin/Debug/net48/
<span class="go">EntityFramework.dll*                   Microsoft.Extensions.DependencyInjection.Abstractions.dll*
EntityFramework.SqlServer.dll*         Microsoft.Extensions.DependencyInjection.dll*
PowerBI.ReportingServices.Security.dll*  Microsoft.ReportingServices.Interfaces.dll*
PowerBI.ReportingServices.Security.pdb   Sso.aspx</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="to-deploy-the-security-extension">2.2.1. To deploy the security extension</h4>
<div class="ulist">
<ul>
<li>
<p>Copy the <code>Sso.aspx</code> page to the <code>&lt;install&gt;\ReportServer</code> directory.</p>
</li>
<li>
<p>Copy all the <code>*.dll</code> and <code>*.pdb</code> to the follow directories:</p>
<div class="ulist">
<ul>
<li>
<p><code>&lt;install&gt;\ReportServer\bin</code></p>
</li>
<li>
<p><code>&lt;install&gt;\Portal</code></p>
</li>
<li>
<p><code>&lt;install&gt;\PowerBI</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="modify-files-in-the-installreportserver-direcotry">2.2.2. Modify files in the <code>&lt;install&gt;\ReportServer</code> direcotry</h4>
<div class="ulist">
<ul>
<li>
<p>To modify the <code>rsreportserver.config</code> file.</p>
</li>
<li>
<p>Open the <code>rsreportserver.config</code> file with Visual Studio or a simple text editor such as Notepad. <code>rsreportserver.config</code> is located in the <code>&lt;install&gt;\ReportServer</code> directory.</p>
</li>
<li>
<p>Locate the <code>&lt;AuthenticationTypes&gt;</code> element and modify the settings as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Authentication&gt;</span>
  <span class="nt">&lt;AuthenticationTypes&gt;</span>
    <span class="c">&lt;!--&lt;RSWindowsNTLM/&gt;--&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nt">&lt;Custom/&gt;</span>
  <span class="nt">&lt;/AuthenticationTypes&gt;</span>
  <span class="nt">&lt;RSWindowsExtendedProtectionLevel&gt;</span>Off<span class="nt">&lt;/RSWindowsExtendedProtectionLevel&gt;</span>
  <span class="nt">&lt;RSWindowsExtendedProtectionScenario&gt;</span>Proxy<span class="nt">&lt;/RSWindowsExtendedProtectionScenario&gt;</span>
  <span class="nt">&lt;EnableAuthPersistence&gt;</span>true<span class="nt">&lt;/EnableAuthPersistence&gt;</span>
<span class="nt">&lt;/Authentication&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that you cannot use Custom with other authentication types.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Locate the <code>&lt;Security&gt;</code> and <code>&lt;Authentication&gt;</code> elements, within the <code>&lt;Extensions&gt;</code> element, and modify the settings as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Security&gt;</span>
  <span class="nt">&lt;Extension</span> <span class="na">Name=</span><span class="s">"Forms"</span> <span class="na">Type=</span><span class="s">"PowerBI.ReportingServices.Security.Authorization, PowerBI.ReportingServices.Security"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Configuration&gt;</span>
    <span class="nt">&lt;AdminConfiguration&gt;</span>
        <span class="nt">&lt;UserName&gt;</span>admin1@local.me,admin2@google.com<span class="nt">&lt;/UserName&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="nt">&lt;/AdminConfiguration&gt;</span>
    <span class="nt">&lt;/Configuration&gt;</span>
  <span class="nt">&lt;/Extension&gt;</span>
  <span class="c">&lt;!--&lt;Extension Name="Windows" Type="Microsoft.ReportingServices.Authorization.WindowsAuthorization, Microsoft.ReportingServices.Authorization"/&gt;--&gt;</span>
<span class="nt">&lt;/Security&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that you should specify one or many administrators here.
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Authentication&gt;</span>
  <span class="nt">&lt;Extension</span> <span class="na">Name=</span><span class="s">"Forms"</span> <span class="na">Type=</span><span class="s">"PowerBI.ReportingServices.Security.Cas.Authentication, PowerBI.ReportingServices.Security"</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!--&lt;Extension Name="Windows" Type="Microsoft.ReportingServices.Authentication.WindowsAuthentication, Microsoft.ReportingServices.Authorization"/&gt;--&gt;</span>
<span class="nt">&lt;/Authentication&gt;</span></code></pre>
</div>
</div></td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="to-modify-the-web-config-file-for-report-server">2.2.3. To modify the <code>web.config</code> file for Report Server</h4>
<div class="ulist">
<ul>
<li>
<p>Open the <code>web.config</code> file in a text editor. By default, the file is in the <code>&lt;install&gt;\ReportServer</code> directory.</p>
</li>
<li>
<p>Locate the <code>&lt;identity&gt;</code> element and set the <code>Impersonate</code> attribute to <code>false</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;identity</span> <span class="na">impersonate=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
<span class="c">&lt;!--&lt;identity impersonate="true" /&gt;--&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Locate the <code>&lt;authentication&gt;</code> element and change the <code>Mode</code> attribute to <code>Forms</code>. Also, add the following <code>&lt;forms&gt;</code> element as a child of the <code>&lt;authentication&gt;</code> element and set the <code>loginUrl</code>, <code>name</code>, <code>timeout</code>, <code>path</code>, <code>requireSSL</code>, and <code>cookieSameSite</code> attributes as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!--&lt;authentication mode="Windows" /&gt;--&gt;</span>
<span class="nt">&lt;authentication</span> <span class="na">mode=</span><span class="s">"Forms"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;forms</span> <span class="na">loginUrl=</span><span class="s">"Sso.aspx"</span> <span class="na">name=</span><span class="s">"X-RS-TOKEN"</span> <span class="na">timeout=</span><span class="s">"60"</span> <span class="na">path=</span><span class="s">"/"</span> <span class="na">requireSSL=</span><span class="s">"true"</span> <span class="na">cookieSameSite=</span><span class="s">"None"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/forms&gt;</span>
<span class="nt">&lt;/authentication&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For local development, if you cann&#8217;t debug with HTTPS, you should delete both the <code>requireSSL</code> and <code>cookieSameSite</code> attributes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!--&lt;authentication mode="Windows" /&gt;--&gt;</span>
<span class="nt">&lt;authentication</span> <span class="na">mode=</span><span class="s">"Forms"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;forms</span> <span class="na">loginUrl=</span><span class="s">"Sso.aspx"</span> <span class="na">name=</span><span class="s">"X-RS-TOKEN"</span> <span class="na">timeout=</span><span class="s">"60"</span>  <span class="na">path=</span><span class="s">"/"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/forms&gt;</span>
<span class="nt">&lt;/authentication&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add the following <code>&lt;authorization&gt;</code> element directly after the <code>&lt;authentication&gt;</code> element.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;authorization&gt;</span>
  <span class="nt">&lt;deny</span> <span class="na">users=</span><span class="s">"?"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/authorization&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will deny unauthenticated users the right to access the report server. The previously established <code>loginUrl</code> attribute of the <code>&lt;authentication&gt;</code> element will redirect unauthenticated requests to the <code>Sso.aspx</code> page.</p>
</div>
</li>
<li>
<p>Configuration <code>&lt;appSettings&gt;</code> and <code>&lt;connectionStrings&gt;</code> inner the element <code>&lt;configuration&gt;</code> as below.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;appSettings&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"cas.baseaddress"</span> <span class="na">value=</span><span class="s">"https://cas.example.com"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"cas.login.path"</span> <span class="na">value=</span><span class="s">"/cas/login"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"cas.service.validate.path"</span> <span class="na">value=</span><span class="s">"/cas/serviceValidate"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/appSettings&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;connectionStrings&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"cas.useraccounts"</span> <i class="conum" data-value="1"></i><b>(1)</b>
       <span class="na">connectionString=</span><span class="s">"Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******"</span>
       <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/connectionStrings&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Your should modify the <code>Data Source</code> with the Server Name of your MSSQL, <code>User ID</code> and <code>Password</code> with your only SQL Server Authentication credentials.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Locate the <code>&lt;trust&gt;</code> element and update it as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="c">&lt;!--&lt;securityPolicy&gt;
  &lt;trustLevel name="RosettaSrv" policyFile="rssrvpolicy.config" /&gt;
&lt;/securityPolicy&gt;
&lt;trust level="RosettaSrv" originUrl="" egacyCasModel="true" /&gt;--&gt;</span>
<span class="nt">&lt;trust</span> <span class="na">level=</span><span class="s">"Full"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="to-modify-the-rsportal-exe-config-file-for-report-server-portal">2.2.4. To modify the <code>RSPortal.exe.config</code> file for Report Server Portal</h4>
<div class="ulist">
<ul>
<li>
<p>Open the <code>web.config</code> file in a text editor. By default, the file is in the <code>&lt;install&gt;\Portal</code> directory.</p>
</li>
<li>
<p>Configuration <code>&lt;connectionStrings&gt;</code> under the  <code>&lt;configuration&gt;</code> <mark>as same as</mark> <code>web.config</code> as below.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;connectionStrings&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"cas.useraccounts"</span>
       <span class="na">connectionString=</span><span class="s">"Data Source=mssql;Initial Catalog=UserAccounts;Persist Security Info=True;User ID=sa;Password=******"</span>
       <span class="na">providerName=</span><span class="s">"System.Data.SqlClient"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/connectionStrings&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="step-3-generate-machine-keys">2.3. Step 3: Generate Machine Keys</h3>
<div class="paragraph">
<p>Using <em>Forms</em> authentication requires that all report server processes can access the authentication cookie. This involves configuring a machine key and decryption algorithm&#8201;&#8212;&#8201;a familiar step for those who had previously setup SSRS to work in scale-out environments.</p>
</div>
<div class="paragraph">
<p>Generate and add <code>&lt;MachineKey&gt;</code> under <code>&lt;Configuration&gt;</code> in your <code>rsreportserver.config</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;MachineKey</span> <span class="na">ValidationKey=</span><span class="s">"[YOUR KEY]"</span> <span class="na">DecryptionKey=</span><span class="s">"[YOUR KEY]"</span> <span class="na">Validation=</span><span class="s">"AES"</span> <span class="na">Decryption=</span><span class="s">"AES"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The follow code snippet is a sample:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Configuration&gt;</span>
  <span class="nt">&lt;MachineKey</span>
    <span class="na">ValidationKey=</span><span class="s">"C9A00A9C93B7AC6B8B3C27054DEDA40FDE08D20C481E808042F32784B3A7F5EF"</span>
    <span class="na">DecryptionKey=</span><span class="s">"8F3D5F7B29A0EB685B61299502490226DA98BCB73B024F78651C24517A5ACCB9"</span>
    <span class="na">Validation=</span><span class="s">"AES"</span>
    <span class="na">Decryption=</span><span class="s">"AES"</span><span class="nt">/&gt;</span>
    . . .</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Check the casing of the attributes, it should be Pascal Casing as the example above.</strong></p>
</div>
<div class="paragraph">
<p>There is not need for a <code>&lt;system.web&gt;</code> entry.</p>
</div>
<div class="paragraph">
<p>You should use a validation key specific for you deployment, there are several tools to generate the keys such as Internet Information Services Manager (IIS), or the online <a href="https://codewithshadman.com/machine-key-generator/">machine-key-generator</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="step-4-configure-passthrough-cookies">2.4. Step 4: Configure Passthrough cookies</h3>
<div class="paragraph">
<p>The new portal and the reportserver communicate using internal soap APIs for some of its operations. When additional cookies are required to be passed from the portal to the server the <code>PassThroughCookies</code> properties is still available. More Details: <a href="https://msdn.microsoft.com/en-us/library/ms345241.aspx" class="bare">https://msdn.microsoft.com/en-us/library/ms345241.aspx</a>. In the <code>rsreportserver.config</code> file add following under <code>&lt;UI&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;UI&gt;</span>
  <span class="nt">&lt;ReportServerUrl&gt;&lt;/ReportServerUrl&gt;</span>
  <span class="nt">&lt;PageCountMode&gt;</span>Estimate<span class="nt">&lt;/PageCountMode&gt;</span>
  <span class="nt">&lt;CustomAuthenticationUI&gt;</span>
    <span class="nt">&lt;PassThroughCookies&gt;</span>
      <span class="nt">&lt;PassThroughCookie&gt;</span>X-RS-TOKEN<span class="nt">&lt;/PassThroughCookie&gt;</span>
    <span class="nt">&lt;/PassThroughCookies&gt;</span>
  <span class="nt">&lt;/CustomAuthenticationUI&gt;</span>
<span class="nt">&lt;/UI&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security-extensions-overview">3. Security Extensions Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Reporting Services provides an extensible architecture that allows you to plug in custom or forms-based authentication modules. You might consider implementing a custom authentication extension if deployment requirements do not include Windows integrated security or Basic authentication. The most common scenario for using custom authentication is to support Internet or extranet access to a Web application. Replacing the default Windows Authentication extension with a custom authentication extension gives you more control over how external users are granted access to the report server.</p>
</div>
<div class="paragraph">
<p>In practice, deploying a custom authentication extension requires multiple steps that include copying assemblies and application files, modifying configuration files, and testing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Creating a custom authentication extension requires custom code and expertise in ASP.NET security. If you do not want to create a custom authentication extension, you can use Microsoft Active Directory groups and accounts, but you should greatly reduce the scope of a report server deployment. For more information about custom authentication, see <a href="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/implementing-a-security-extension?view=sql-server-ver15">Implementing a Security Extension</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We recommend that you use Windows Authentication if at all possible. However, custom authentication and authorization for Reporting Services may be appropriate in the following two cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You have an Internet or extranet application that cannot use Windows accounts.</p>
</li>
<li>
<p>You have custom-defined users and roles and need to provide a matching authorization scheme in Reporting Services.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/media/rosettasecurityextensionflow.gif?view=sql-server-ver15.gif" alt="Security Extensions Overview">
</div>
</div>
<div class="paragraph">
<p>As shown in the above figure, authentication and authorization occur as follows:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
&lt;1&gt;
</td>
<td class="hdlist2">
<p>A user tries to access the web portal by using a URL and is redirected to a form that collects user credentials for the client application.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;2&gt;
</td>
<td class="hdlist2">
<p>The user submits credentials to the form.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;3&gt;
</td>
<td class="hdlist2">
<p>The user credentials are submitted to the Reporting Services Web service through the LogonUser method.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;4&gt;
</td>
<td class="hdlist2">
<p>The Web service calls the customer-supplied security extension and verifies that the user name and password exist in the custom security authority.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;5&gt;
</td>
<td class="hdlist2">
<p>After authentication, the Web service creates an authentication ticket (known as a "cookie"), manages the ticket, and verifies the user&#8217;s role for the Home page of the web portal.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;6&gt;
</td>
<td class="hdlist2">
<p>The Web service returns the cookie to the browser and displays the appropriate user interface in the web portal.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;7&gt;
</td>
<td class="hdlist2">
<p>After the user is authenticated, the browser makes requests to the web portal while transmitting the cookie in the HTTP header. These requests are in response to user actions within the web portal.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;8&gt;
</td>
<td class="hdlist2">
<p>The cookie is transmitted in the HTTP header to the Web service along with the requested user operation.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;9&gt;
</td>
<td class="hdlist2">
<p>The cookie is validated, and if it is valid, the report server returns the security descriptor and other information relating to the requested operation from the report server database.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;10&gt;
</td>
<td class="hdlist2">
<p>If the cookie is valid, the report server makes a call to the security extension to check if the user is authorized to perform the specific operation.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;11&gt;
</td>
<td class="hdlist2">
<p>If the user is authorized, the report server performs the requested operation and returns control to the caller.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;12&gt;
</td>
<td class="hdlist2">
<p>After the user is authenticated, URL access to the report server uses the same cookie. The cookie is transmitted in the HTTP header.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;13&gt;
</td>
<td class="hdlist2">
<p>The user continues to request operations on the report server until the session has ended.</p>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="authentication-in-reporting-services">3.1. Authentication in Reporting Services</h3>
<div class="paragraph">
<p>Authentication is the process of establishing a user&#8217;s right to an identity. There are many techniques that you can use to authenticate a user. The most common way is to use passwords. When you implement Forms Authentication, for example, you want an implementation that queries users for credentials (usually by some interface that requests a login name and password) and then validates users against a data store, such as a database table or configuration file. If the credentials can&#8217;t be validated, the authentication process fails and the user will assume an anonymous identity.</p>
</div>
<div class="paragraph">
<p>In Reporting Services, the Windows operating system handles the authentication of users either through integrated security or through the explicit reception and validation of user credentials. Custom authentication can be developed in Reporting Services to support additional authentication schemes. This is made possible through the security extension interface <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthenticationextension2">IAuthenticationExtension2</a>. All extensions inherit from the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iextension">IExtension</a> base interface for any extension deployed and used by the report server. <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iextension">IExtension</a>, as well as <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthenticationextension2">IAuthenticationExtension2</a>, are members of the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces">Microsoft.ReportingServices.Interfaces</a> namespace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/media/rosettasecurityextensionauthenticationflow.gif?view=sql-server-ver15" alt="Authentication Flow">
</div>
</div>
<div class="paragraph">
<p>As shown in the above figure, the authentication process is as follows:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
&lt;1&gt;
</td>
<td class="hdlist2">
<p>A client application calls the Web service <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthenticationextension2.logonuser?view=sqlserver-2016">LogonUser</a> method to authenticate a user.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;2&gt;
</td>
<td class="hdlist2">
<p>The Web service makes a call to the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthenticationextension2.logonuser?view=sqlserver-2016">LogonUser</a> method of your security extension, specifically, the class that implements <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthenticationextension2?view=sqlserver-2016">IAuthenticationExtension2</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;3&gt;
</td>
<td class="hdlist2">
<p>Your implementation of <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthenticationextension2.logonuser?view=sqlserver-2016">LogonUser</a> validates the user name and password in the user store or security authority.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;4&gt;
</td>
<td class="hdlist2">
<p>Upon successful authentication, the Web service creates a cookie and manages it for the session.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;5&gt;
</td>
<td class="hdlist2">
<p>The Web service returns the authentication ticket to the calling application on the HTTP header.</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="authorization-in-reporting-services">3.2. Authorization in Reporting Services</h3>
<div class="paragraph">
<p>Authorization is the process of determining whether an identity should be granted the requested type of access to a given resource in the report server database. Reporting Services uses a role-based authorization architecture that grants a user access to a given resource based on the user&#8217;s role assignment for the application. Security extensions for Reporting Services contain an implementation of an authorization component that is used to grant access to users once they are authenticated on the report server. Authorization is invoked when a user attempts to perform an operation on the system or a report server item through the SOAP API and via URL access. This is made possible through the security extension interface <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthorizationextension">IAuthorizationExtension</a>. As stated previously, all extensions inherit from <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iextension">IExtension</a> the base interface for any extension that you deploy. <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iextension">IExtension</a> and <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthorizationextension">IAuthorizationExtension</a> are members of the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces">Microsoft.ReportingServices.Interfaces</a> namespace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/media/rosettasecurityextensionauthorizationflow.gif?view=sql-server-ver15" alt="Authorization Flow">
</div>
</div>
<div class="paragraph">
<p>As shown in the Figure 3, authorization follows this sequence:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
&lt;1&gt;
</td>
<td class="hdlist2">
<p>Once authenticated, client applications make requests to the report server through the Reporting Services Web service methods. An authentication ticket is passed to the report server in the form of a cookie in the HTTP header of each Web request.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;2&gt;
</td>
<td class="hdlist2">
<p>The cookie is validated prior to any access check.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;3&gt;
</td>
<td class="hdlist2">
<p>Once the cookie is validated, the report server calls <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthenticationextension.getuserinfo">GetUserInfo</a> and the user is given an identity.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;4&gt;
</td>
<td class="hdlist2">
<p>The user attempts an operation through the Reporting Services Web service.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;5&gt;
</td>
<td class="hdlist2">
<p>The report server calls the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthorizationextension.checkaccess">CheckAccess</a> method.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;6&gt;
</td>
<td class="hdlist2">
<p>The security descriptor is retrieved and passed to a custom security extension implementation of <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.reportingservices.interfaces.iauthorizationextension.checkaccess">CheckAccess</a>. At this point, the user, group, or computer is compared to the security descriptor of the item being accessed and is authorized to perform the requested operation.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
&lt;7&gt;
</td>
<td class="hdlist2">
<p>If the user is authorized, the Web service performs the operation and returns a response to the calling application.</p>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">4. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.microsoft.com/en-us/power-bi/report-server/get-started" class="bare">https://docs.microsoft.com/en-us/power-bi/report-server/get-started</a>, What is Power BI Report Server?</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/power-bi/report-server/install-report-server" class="bare">https://docs.microsoft.com/en-us/power-bi/report-server/install-report-server</a>, Install Power BI Report Server</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/power-bi/report-server/install-powerbi-desktop" class="bare">https://docs.microsoft.com/en-us/power-bi/report-server/install-powerbi-desktop</a>, Install Power BI Desktop for Power BI Report Server</p>
</li>
<li>
<p><a href="https://www.microsoft.com/en-us/sql-server/sql-server-downloads" class="bare">https://www.microsoft.com/en-us/sql-server/sql-server-downloads</a>, SQL Server Downloads Microsoft</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15</a>, Download SQL Server Management Studio (SSMS)</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-configuration-files?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-configuration-files?view=sql-server-ver15</a>, Reporting Services Configuration Files</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-log-files-and-sources?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/report-server/reporting-services-log-files-and-sources?view=sql-server-ver15</a>, Reporting Services Log Files and Sources</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/security/authentication-with-the-report-server?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/security/authentication-with-the-report-server?view=sql-server-ver15</a>, Authentication with the Report Server</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/extensions-ssrs?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/extensions-ssrs?view=sql-server-ver15</a>, Extensions for SQL Server Reporting Services (SSRS)</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/security-extensions-overview?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/security-extensions-overview?view=sql-server-ver15</a>, Security Extensions Overview - Reporting Services (SSRS)</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authentication-in-reporting-services?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authentication-in-reporting-services?view=sql-server-ver15</a>, Authentication in Reporting Services</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authorization-in-reporting-services?view=sql-server-ver15" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/extensions/security-extension/authorization-in-reporting-services?view=sql-server-ver15</a>, Authorization in Reporting Services</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sql/reporting-services/extensions/secure-development/using-reporting-services-security-policy-files?view=sql-server-ver15#placement-of-codegroup-elements-for-extensions" class="bare">https://docs.microsoft.com/en-us/sql/reporting-services/extensions/secure-development/using-reporting-services-security-policy-files?view=sql-server-ver15#placement-of-codegroup-elements-for-extensions</a>, Placement of CodeGroup Elements for Extensions</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-1.1/b5ysx397(v=vs.71" class="bare">https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-1.1/b5ysx397(v=vs.71</a>), ASP.NET Settings Schema</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/" class="bare">https://docs.microsoft.com/en-us/previous-versions/</a>, Previous versions of Microsoft products, services and technologies</p>
</li>
<li>
<p><a href="https://www.entityframeworktutorial.net/code-first/automated-migration-in-code-first.aspx" class="bare">https://www.entityframeworktutorial.net/code-first/automated-migration-in-code-first.aspx</a>, Automated Migration in Entity Framework 6</p>
</li>
<li>
<p><a href="https://codewithshadman.com/machine-key-generator/" class="bare">https://codewithshadman.com/machine-key-generator/</a>, Machine Key Generator</p>
</li>
</ul>
</div>
</div>
</div>
<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
