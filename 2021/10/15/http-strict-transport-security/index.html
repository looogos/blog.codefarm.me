<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HTTP Strict-Transport-Security | CODE FARM</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="HTTP Strict-Transport-Security" />
<meta property="og:locale" content="en" />
<meta name="description" content="1. Syntax 2. Directives 3. Description 3.1. An example scenario 3.2. How the browser handles it 4. Preloading Strict Transport Security 5. Examples 5.1. Create a self-signed certificate 5.2. Import CA root certificates 5.3. Test subdomain with echo.local.io 5.4. Test root domain with local.io 5.5. Update or clear HSTS via max-age=0 6. References The HTTP Strict-Transport-Security response header (often abbreviated as HSTS) lets a web site tell browsers that it should only be accessed using HTTPS, instead of using HTTP. 1. Syntax Strict-Transport-Security: max-age=&lt;expire-time&gt; Strict-Transport-Security: max-age=&lt;expire-time&gt;; includeSubDomains Strict-Transport-Security: max-age=&lt;expire-time&gt;; preload 2. Directives max-age=&lt;expire-time&gt; The time, in seconds, that the browser should remember that a site is only to be accessed using HTTPS. includeSubDomains Optional If this optional parameter is specified, this rule applies to all of the site&#8217;s subdomains as well. 6.1.2. The includeSubDomains Directive The OPTIONAL &quot;includeSubDomains&quot; directive is a valueless directive which, if present (i.e., it is &quot;asserted&quot;), signals the UA that the HSTS Policy applies to this HSTS Host as well as any subdomains of the host&#8217;s domain name. https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2 preload Optional See Preloading Strict Transport Security for details. Not part of the specification. 3. Description If a website accepts a connection through HTTP and redirects to HTTPS, visitors may initially communicate with the non-encrypted version of the site before being redirected, if, for example, the visitor types http://www.foo.com/ or even just foo.com. This creates an opportunity for a man-in-the-middle attack. The redirect could be exploited to direct visitors to a malicious site instead of the secure version of the original site. The HTTP Strict Transport Security header informs the browser that it should never load a site using HTTP and should automatically convert all attempts to access the site using HTTP to HTTPS requests instead. The Strict-Transport-Security header is ignored by the browser when your site is accessed using HTTP; this is because an attacker may intercept HTTP connections and inject the header or remove it. When your site is accessed over HTTPS with no certificate errors, the browser knows your site is HTTPS capable and will honor the Strict-Transport-Security header. 3.1. An example scenario You log into a free WiFi access point at an airport and start surfing the web, visiting your online banking service to check your balance and pay a couple of bills. Unfortunately, the access point you&#8217;re using is actually a hacker&#8217;s laptop, and they&#8217;re intercepting your original HTTP request and redirecting you to a clone of your bank&#8217;s site instead of the real thing. Now your private data is exposed to the hacker. Strict Transport Security resolves this problem; as long as you&#8217;ve accessed your bank&#8217;s web site once using HTTPS, and the bank&#8217;s web site uses Strict Transport Security, your browser will know to automatically use only HTTPS, which prevents hackers from performing this sort of man-in-the-middle attack. 3.2. How the browser handles it The first time your site is accessed using HTTPS and it returns the Strict-Transport-Security header, the browser records this information, so that future attempts to load the site using HTTP will automatically use HTTPS instead. When the expiration time specified by the Strict-Transport-Security header elapses, the next attempt to load the site via HTTP will proceed as normal instead of automatically using HTTPS. Whenever the Strict-Transport-Security header is delivered to the browser, it will update the expiration time for that site, so sites can refresh this information and prevent the timeout from expiring. Should it be necessary to disable Strict Transport Security, setting the max-age to 0 (over an https connection) will immediately expire the Strict-Transport-Security header, allowing access via http. 4. Preloading Strict Transport Security Google maintains an HSTS preload service. By following the guidelines and successfully submitting your domain, browsers will never connect to your domain using an insecure connection. While the service is hosted by Google, all browsers have stated an intent to use (or actually started using) the preload list. However, it is not part of the HSTS specification and should not be treated as official. Information regarding the HSTS preload list in Chrome : https://www.chromium.org/hsts Consultation of the Firefox HSTS preload list : nsSTSPreloadList.inc 5. Examples All present and future subdomains will be HTTPS for a max-age of 1 year. This blocks access to pages or subdomains that can only be served over HTTP. Strict-Transport-Security: max-age=31536000; includeSubDomains If a max-age of 1 year is acceptable for a domain, however, two years is the recommended value as explained on https://hstspreload.org. In the following example, max-age is set to 2 years, and is suffixed with preload, which is necessary for inclusion in most major web browsers&#39; HSTS preload lists, like Chromium, Edge, and Firefox. Strict-Transport-Security: max-age=63072000; includeSubDomains; preload 5.1. Create a self-signed certificate $ openssl req -x509 \ -nodes \ -newkey rsa:4096 \ -days 3650 \ -keyout local.io.ca.key \ -out local.io.ca.crt \ -subj &quot;/C=CN/ST=Shanghai/L=Shanghai/O=Global Security/OU=IT Department/CN=*.local.io&quot; \ -addext &quot;subjectAltName=DNS:local.io,DNS:*.local.io&quot; $ openssl x509 -in local.io.crt -noout -text Certificate: Data: Version: 3 (0x2) Serial Number: 62:13:50:8d:8f:d9:8e:8a:ff:36:a7:c1:d0:b7:47:cc:6f:c4:b1:66 Signature Algorithm: sha256WithRSAEncryption Issuer: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io Validity Not Before: Oct 15 09:24:46 2021 GMT Not After : Oct 13 09:24:46 2031 GMT Subject: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:c0:ee:c5:35:60:e2:d7:82:98:2b:ae:22:0c:ec: 01:ae:d1:49:20:4b:c9:b4:fd:e8:1f:7e:32:80:ed: 16:b9:98:73:0a:5f:7f:54:9c:f1:62:09:d2:1a:38: 15:27:ea:d8:2f:2e:7f:9b:ac:ef:08:a5:17:cb:5b: c4:44:a7:d7:13:bf:8e:d6:e3:d0:ce:fa:dd:08:70: 99:a3:3c:76:1a:6e:21:fa:42:ea:db:3a:6a:35:0e: 2d:ac:8b:89:ec:ad:e6:bd:c3:8c:1a:f0:21:c4:3d: ac:c2:2e:74:63:ac:71:35:4e:65:30:07:63:6a:1e: f2:68:7e:bb:58:25:45:e1:95:a4:e0:e6:23:62:48: a3:0f:4a:a3:1d:b3:aa:94:3a:ea:ca:a6:2a:90:1c: f9:04:77:d1:26:29:a1:f4:b5:12:4e:46:eb:5f:f3: 46:aa:1c:0a:61:44:04:56:bc:6e:52:6d:b9:d0:fa: 76:4d:ca:3a:b3:80:94:8c:6d:8a:96:f7:27:56:a5: 58:b3:1a:f7:4c:9f:99:06:09:1b:a8:da:a7:82:7d: 3f:1e:5d:24:7c:d8:0f:37:48:42:ea:8e:2b:e7:aa: 22:cf:af:18:4c:8e:29:1f:c2:d3:6b:af:52:5a:67: 57:78:04:58:b7:8c:11:9c:ce:23:c7:a0:b2:d2:53: e4:f5 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29 X509v3 Authority Key Identifier: keyid:4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29 X509v3 Basic Constraints: critical CA:TRUE X509v3 Subject Alternative Name: DNS:local.io, DNS:*.local.io Signature Algorithm: sha256WithRSAEncryption 86:9e:85:87:5b:b1:64:a6:9f:7b:a3:ca:a0:1d:df:bc:3a:a3: 3c:aa:95:df:51:98:27:fd:5b:aa:1a:c1:7d:f0:a5:66:0b:13: 74:ba:e8:ab:0e:be:78:73:db:09:ba:f5:19:4a:e8:b4:fd:2e: b3:10:26:5a:c0:98:f7:77:e3:73:92:e2:5a:8d:26:04:be:d3: fc:84:61:9e:f9:f0:4a:8c:27:27:66:ab:77:d3:73:7c:b4:72: 82:f5:00:20:46:b2:ec:9a:cb:80:ad:cc:7c:ca:51:5c:a1:33: 17:46:28:8b:14:32:90:55:a5:de:a6:90:dd:78:99:8a:48:73: e2:ec:a2:a8:ef:eb:d3:64:e9:65:cc:4c:bc:85:3d:ab:e3:13: f3:72:3b:fa:43:f5:4e:32:68:7d:44:35:d8:17:99:af:79:aa: af:7d:72:4f:b6:0c:41:7d:bd:e8:ee:1f:66:70:7e:c1:d7:cf: 3b:07:86:78:70:be:0b:60:91:e3:26:3c:a3:a3:a0:7c:c8:a0: 97:9b:2c:45:cd:07:05:d4:f7:ff:78:63:7f:f7:51:8e:71:b0: d7:cc:c3:6a:21:85:4f:3d:5c:22:62:bf:cb:f2:09:73:9e:bc: 77:0f:5b:93:24:fa:df:c4:bf:f7:49:16:e0:72:6b:f7:48:be: f9:69:83:64 5.2. Import CA root certificates 5.2.1. Linux (Debian / Ubuntu) $ curl -iI https://local.io curl: (60) SSL certificate problem: self signed certificate More details here: https://curl.haxx.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. Installing the root certificate on a Linux PC is straight forward: $ sudo mkdir /usr/local/share/ca-certificates/extra $ sudo cp local.io.crt /usr/local/share/ca-certificates/extra/ $ sudo update-ca-certificates Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done. Running hooks in /etc/ca-certificates/update.d... Adding debian:local.io.pem done. done. After these steps the new CA is known by system utilities like curl and get. $ curl -iI https://local.io HTTP/2 200 date: Fri, 15 Oct 2021 10:39:53 GMT content-type: text/plain strict-transport-security: max-age=15724800; includeSubDomains cache-control: public, max-age=3600 5.2.2. Windows Double click the certificate file local.io.crt and click the Install Certificate&#8230;&#8203;. 5.3. Test subdomain with echo.local.io Open https://echo.local.io on Chrome(Version 94.0.4606.81 (Official Build) (64-bit)) Figure 1. Open https://echo.local.io on Windows Chrome Browser then open chrome://net-internals/#hsts and Query HSTS/PKP host domain with echo.local.io. Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634294710.318108 dynamic_sts_expiry: 1650019510.318091 Query HSTS/PKP domain with another subdoamin as level as host domain foo.local.io. Not found Query HSTS/PKP domain with root domain fo the host domain local.io. Not found Query HSTS/PKP domain with subdomain to the host domain buzz.echo.local.io. Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634298549.210941 dynamic_sts_expiry: 1650023349.210936 Open echo.local.io with HTTPS scheme via http://echo.local.io Figure 2. Access with http after HSTS 5.4. Test root domain with local.io Clear Chrome browing data to remove HSTS. Open https://loca.io with Chrome Query HSTS/PKP domain with loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295941.084076 dynamic_sts_expiry: 1650020741.084073 Query HSTS/PKP domain with subdomain echo.loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295977.355846 dynamic_sts_expiry: 1650020777.355843 5.5. Update or clear HSTS via max-age=0 Open https://loca.io with Chrome $ curl -iIL https://local.io HTTP/2 200 date: Fri, 15 Oct 2021 11:13:43 GMT content-type: text/plain cache-control: public, max-age=3600 strict-transport-security: max-age=0; includeSubDomain Figure 3. Server response HSTS with max-age=0 Query HSTS/PKP domain with loca.io Not found Query HSTS/PKP domain with subdomain echo.loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295977.355846 dynamic_sts_expiry: 1650020777.355843 Ingress Nginx in Kubernetes nginx.ingress.kubernetes.io/configuration-snippet: | proxy_hide_header Strict-Transport-Security; add_header Strict-Transport-Security &quot;max-age=0; includeSubDomains&quot; always; 6. References https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2 https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security https://www.chromium.org/hsts https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/certmgr https://thomas-leister.de/en/how-to-import-ca-root-certificate/ http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header" />
<meta property="og:description" content="1. Syntax 2. Directives 3. Description 3.1. An example scenario 3.2. How the browser handles it 4. Preloading Strict Transport Security 5. Examples 5.1. Create a self-signed certificate 5.2. Import CA root certificates 5.3. Test subdomain with echo.local.io 5.4. Test root domain with local.io 5.5. Update or clear HSTS via max-age=0 6. References The HTTP Strict-Transport-Security response header (often abbreviated as HSTS) lets a web site tell browsers that it should only be accessed using HTTPS, instead of using HTTP. 1. Syntax Strict-Transport-Security: max-age=&lt;expire-time&gt; Strict-Transport-Security: max-age=&lt;expire-time&gt;; includeSubDomains Strict-Transport-Security: max-age=&lt;expire-time&gt;; preload 2. Directives max-age=&lt;expire-time&gt; The time, in seconds, that the browser should remember that a site is only to be accessed using HTTPS. includeSubDomains Optional If this optional parameter is specified, this rule applies to all of the site&#8217;s subdomains as well. 6.1.2. The includeSubDomains Directive The OPTIONAL &quot;includeSubDomains&quot; directive is a valueless directive which, if present (i.e., it is &quot;asserted&quot;), signals the UA that the HSTS Policy applies to this HSTS Host as well as any subdomains of the host&#8217;s domain name. https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2 preload Optional See Preloading Strict Transport Security for details. Not part of the specification. 3. Description If a website accepts a connection through HTTP and redirects to HTTPS, visitors may initially communicate with the non-encrypted version of the site before being redirected, if, for example, the visitor types http://www.foo.com/ or even just foo.com. This creates an opportunity for a man-in-the-middle attack. The redirect could be exploited to direct visitors to a malicious site instead of the secure version of the original site. The HTTP Strict Transport Security header informs the browser that it should never load a site using HTTP and should automatically convert all attempts to access the site using HTTP to HTTPS requests instead. The Strict-Transport-Security header is ignored by the browser when your site is accessed using HTTP; this is because an attacker may intercept HTTP connections and inject the header or remove it. When your site is accessed over HTTPS with no certificate errors, the browser knows your site is HTTPS capable and will honor the Strict-Transport-Security header. 3.1. An example scenario You log into a free WiFi access point at an airport and start surfing the web, visiting your online banking service to check your balance and pay a couple of bills. Unfortunately, the access point you&#8217;re using is actually a hacker&#8217;s laptop, and they&#8217;re intercepting your original HTTP request and redirecting you to a clone of your bank&#8217;s site instead of the real thing. Now your private data is exposed to the hacker. Strict Transport Security resolves this problem; as long as you&#8217;ve accessed your bank&#8217;s web site once using HTTPS, and the bank&#8217;s web site uses Strict Transport Security, your browser will know to automatically use only HTTPS, which prevents hackers from performing this sort of man-in-the-middle attack. 3.2. How the browser handles it The first time your site is accessed using HTTPS and it returns the Strict-Transport-Security header, the browser records this information, so that future attempts to load the site using HTTP will automatically use HTTPS instead. When the expiration time specified by the Strict-Transport-Security header elapses, the next attempt to load the site via HTTP will proceed as normal instead of automatically using HTTPS. Whenever the Strict-Transport-Security header is delivered to the browser, it will update the expiration time for that site, so sites can refresh this information and prevent the timeout from expiring. Should it be necessary to disable Strict Transport Security, setting the max-age to 0 (over an https connection) will immediately expire the Strict-Transport-Security header, allowing access via http. 4. Preloading Strict Transport Security Google maintains an HSTS preload service. By following the guidelines and successfully submitting your domain, browsers will never connect to your domain using an insecure connection. While the service is hosted by Google, all browsers have stated an intent to use (or actually started using) the preload list. However, it is not part of the HSTS specification and should not be treated as official. Information regarding the HSTS preload list in Chrome : https://www.chromium.org/hsts Consultation of the Firefox HSTS preload list : nsSTSPreloadList.inc 5. Examples All present and future subdomains will be HTTPS for a max-age of 1 year. This blocks access to pages or subdomains that can only be served over HTTP. Strict-Transport-Security: max-age=31536000; includeSubDomains If a max-age of 1 year is acceptable for a domain, however, two years is the recommended value as explained on https://hstspreload.org. In the following example, max-age is set to 2 years, and is suffixed with preload, which is necessary for inclusion in most major web browsers&#39; HSTS preload lists, like Chromium, Edge, and Firefox. Strict-Transport-Security: max-age=63072000; includeSubDomains; preload 5.1. Create a self-signed certificate $ openssl req -x509 \ -nodes \ -newkey rsa:4096 \ -days 3650 \ -keyout local.io.ca.key \ -out local.io.ca.crt \ -subj &quot;/C=CN/ST=Shanghai/L=Shanghai/O=Global Security/OU=IT Department/CN=*.local.io&quot; \ -addext &quot;subjectAltName=DNS:local.io,DNS:*.local.io&quot; $ openssl x509 -in local.io.crt -noout -text Certificate: Data: Version: 3 (0x2) Serial Number: 62:13:50:8d:8f:d9:8e:8a:ff:36:a7:c1:d0:b7:47:cc:6f:c4:b1:66 Signature Algorithm: sha256WithRSAEncryption Issuer: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io Validity Not Before: Oct 15 09:24:46 2021 GMT Not After : Oct 13 09:24:46 2031 GMT Subject: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:c0:ee:c5:35:60:e2:d7:82:98:2b:ae:22:0c:ec: 01:ae:d1:49:20:4b:c9:b4:fd:e8:1f:7e:32:80:ed: 16:b9:98:73:0a:5f:7f:54:9c:f1:62:09:d2:1a:38: 15:27:ea:d8:2f:2e:7f:9b:ac:ef:08:a5:17:cb:5b: c4:44:a7:d7:13:bf:8e:d6:e3:d0:ce:fa:dd:08:70: 99:a3:3c:76:1a:6e:21:fa:42:ea:db:3a:6a:35:0e: 2d:ac:8b:89:ec:ad:e6:bd:c3:8c:1a:f0:21:c4:3d: ac:c2:2e:74:63:ac:71:35:4e:65:30:07:63:6a:1e: f2:68:7e:bb:58:25:45:e1:95:a4:e0:e6:23:62:48: a3:0f:4a:a3:1d:b3:aa:94:3a:ea:ca:a6:2a:90:1c: f9:04:77:d1:26:29:a1:f4:b5:12:4e:46:eb:5f:f3: 46:aa:1c:0a:61:44:04:56:bc:6e:52:6d:b9:d0:fa: 76:4d:ca:3a:b3:80:94:8c:6d:8a:96:f7:27:56:a5: 58:b3:1a:f7:4c:9f:99:06:09:1b:a8:da:a7:82:7d: 3f:1e:5d:24:7c:d8:0f:37:48:42:ea:8e:2b:e7:aa: 22:cf:af:18:4c:8e:29:1f:c2:d3:6b:af:52:5a:67: 57:78:04:58:b7:8c:11:9c:ce:23:c7:a0:b2:d2:53: e4:f5 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29 X509v3 Authority Key Identifier: keyid:4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29 X509v3 Basic Constraints: critical CA:TRUE X509v3 Subject Alternative Name: DNS:local.io, DNS:*.local.io Signature Algorithm: sha256WithRSAEncryption 86:9e:85:87:5b:b1:64:a6:9f:7b:a3:ca:a0:1d:df:bc:3a:a3: 3c:aa:95:df:51:98:27:fd:5b:aa:1a:c1:7d:f0:a5:66:0b:13: 74:ba:e8:ab:0e:be:78:73:db:09:ba:f5:19:4a:e8:b4:fd:2e: b3:10:26:5a:c0:98:f7:77:e3:73:92:e2:5a:8d:26:04:be:d3: fc:84:61:9e:f9:f0:4a:8c:27:27:66:ab:77:d3:73:7c:b4:72: 82:f5:00:20:46:b2:ec:9a:cb:80:ad:cc:7c:ca:51:5c:a1:33: 17:46:28:8b:14:32:90:55:a5:de:a6:90:dd:78:99:8a:48:73: e2:ec:a2:a8:ef:eb:d3:64:e9:65:cc:4c:bc:85:3d:ab:e3:13: f3:72:3b:fa:43:f5:4e:32:68:7d:44:35:d8:17:99:af:79:aa: af:7d:72:4f:b6:0c:41:7d:bd:e8:ee:1f:66:70:7e:c1:d7:cf: 3b:07:86:78:70:be:0b:60:91:e3:26:3c:a3:a3:a0:7c:c8:a0: 97:9b:2c:45:cd:07:05:d4:f7:ff:78:63:7f:f7:51:8e:71:b0: d7:cc:c3:6a:21:85:4f:3d:5c:22:62:bf:cb:f2:09:73:9e:bc: 77:0f:5b:93:24:fa:df:c4:bf:f7:49:16:e0:72:6b:f7:48:be: f9:69:83:64 5.2. Import CA root certificates 5.2.1. Linux (Debian / Ubuntu) $ curl -iI https://local.io curl: (60) SSL certificate problem: self signed certificate More details here: https://curl.haxx.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. Installing the root certificate on a Linux PC is straight forward: $ sudo mkdir /usr/local/share/ca-certificates/extra $ sudo cp local.io.crt /usr/local/share/ca-certificates/extra/ $ sudo update-ca-certificates Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done. Running hooks in /etc/ca-certificates/update.d... Adding debian:local.io.pem done. done. After these steps the new CA is known by system utilities like curl and get. $ curl -iI https://local.io HTTP/2 200 date: Fri, 15 Oct 2021 10:39:53 GMT content-type: text/plain strict-transport-security: max-age=15724800; includeSubDomains cache-control: public, max-age=3600 5.2.2. Windows Double click the certificate file local.io.crt and click the Install Certificate&#8230;&#8203;. 5.3. Test subdomain with echo.local.io Open https://echo.local.io on Chrome(Version 94.0.4606.81 (Official Build) (64-bit)) Figure 1. Open https://echo.local.io on Windows Chrome Browser then open chrome://net-internals/#hsts and Query HSTS/PKP host domain with echo.local.io. Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634294710.318108 dynamic_sts_expiry: 1650019510.318091 Query HSTS/PKP domain with another subdoamin as level as host domain foo.local.io. Not found Query HSTS/PKP domain with root domain fo the host domain local.io. Not found Query HSTS/PKP domain with subdomain to the host domain buzz.echo.local.io. Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634298549.210941 dynamic_sts_expiry: 1650023349.210936 Open echo.local.io with HTTPS scheme via http://echo.local.io Figure 2. Access with http after HSTS 5.4. Test root domain with local.io Clear Chrome browing data to remove HSTS. Open https://loca.io with Chrome Query HSTS/PKP domain with loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295941.084076 dynamic_sts_expiry: 1650020741.084073 Query HSTS/PKP domain with subdomain echo.loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295977.355846 dynamic_sts_expiry: 1650020777.355843 5.5. Update or clear HSTS via max-age=0 Open https://loca.io with Chrome $ curl -iIL https://local.io HTTP/2 200 date: Fri, 15 Oct 2021 11:13:43 GMT content-type: text/plain cache-control: public, max-age=3600 strict-transport-security: max-age=0; includeSubDomain Figure 3. Server response HSTS with max-age=0 Query HSTS/PKP domain with loca.io Not found Query HSTS/PKP domain with subdomain echo.loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295977.355846 dynamic_sts_expiry: 1650020777.355843 Ingress Nginx in Kubernetes nginx.ingress.kubernetes.io/configuration-snippet: | proxy_hide_header Strict-Transport-Security; add_header Strict-Transport-Security &quot;max-age=0; includeSubDomains&quot; always; 6. References https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2 https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security https://www.chromium.org/hsts https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/certmgr https://thomas-leister.de/en/how-to-import-ca-root-certificate/ http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header" />
<link rel="canonical" href="https://blog.codefarm.me/2021/10/15/http-strict-transport-security/" />
<meta property="og:url" content="https://blog.codefarm.me/2021/10/15/http-strict-transport-security/" />
<meta property="og:site_name" content="CODE FARM" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-10-15T16:32:24+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HTTP Strict-Transport-Security" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-10-15T16:32:24+08:00","datePublished":"2021-10-15T16:32:24+08:00","description":"1. Syntax 2. Directives 3. Description 3.1. An example scenario 3.2. How the browser handles it 4. Preloading Strict Transport Security 5. Examples 5.1. Create a self-signed certificate 5.2. Import CA root certificates 5.3. Test subdomain with echo.local.io 5.4. Test root domain with local.io 5.5. Update or clear HSTS via max-age=0 6. References The HTTP Strict-Transport-Security response header (often abbreviated as HSTS) lets a web site tell browsers that it should only be accessed using HTTPS, instead of using HTTP. 1. Syntax Strict-Transport-Security: max-age=&lt;expire-time&gt; Strict-Transport-Security: max-age=&lt;expire-time&gt;; includeSubDomains Strict-Transport-Security: max-age=&lt;expire-time&gt;; preload 2. Directives max-age=&lt;expire-time&gt; The time, in seconds, that the browser should remember that a site is only to be accessed using HTTPS. includeSubDomains Optional If this optional parameter is specified, this rule applies to all of the site&#8217;s subdomains as well. 6.1.2. The includeSubDomains Directive The OPTIONAL &quot;includeSubDomains&quot; directive is a valueless directive which, if present (i.e., it is &quot;asserted&quot;), signals the UA that the HSTS Policy applies to this HSTS Host as well as any subdomains of the host&#8217;s domain name. https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2 preload Optional See Preloading Strict Transport Security for details. Not part of the specification. 3. Description If a website accepts a connection through HTTP and redirects to HTTPS, visitors may initially communicate with the non-encrypted version of the site before being redirected, if, for example, the visitor types http://www.foo.com/ or even just foo.com. This creates an opportunity for a man-in-the-middle attack. The redirect could be exploited to direct visitors to a malicious site instead of the secure version of the original site. The HTTP Strict Transport Security header informs the browser that it should never load a site using HTTP and should automatically convert all attempts to access the site using HTTP to HTTPS requests instead. The Strict-Transport-Security header is ignored by the browser when your site is accessed using HTTP; this is because an attacker may intercept HTTP connections and inject the header or remove it. When your site is accessed over HTTPS with no certificate errors, the browser knows your site is HTTPS capable and will honor the Strict-Transport-Security header. 3.1. An example scenario You log into a free WiFi access point at an airport and start surfing the web, visiting your online banking service to check your balance and pay a couple of bills. Unfortunately, the access point you&#8217;re using is actually a hacker&#8217;s laptop, and they&#8217;re intercepting your original HTTP request and redirecting you to a clone of your bank&#8217;s site instead of the real thing. Now your private data is exposed to the hacker. Strict Transport Security resolves this problem; as long as you&#8217;ve accessed your bank&#8217;s web site once using HTTPS, and the bank&#8217;s web site uses Strict Transport Security, your browser will know to automatically use only HTTPS, which prevents hackers from performing this sort of man-in-the-middle attack. 3.2. How the browser handles it The first time your site is accessed using HTTPS and it returns the Strict-Transport-Security header, the browser records this information, so that future attempts to load the site using HTTP will automatically use HTTPS instead. When the expiration time specified by the Strict-Transport-Security header elapses, the next attempt to load the site via HTTP will proceed as normal instead of automatically using HTTPS. Whenever the Strict-Transport-Security header is delivered to the browser, it will update the expiration time for that site, so sites can refresh this information and prevent the timeout from expiring. Should it be necessary to disable Strict Transport Security, setting the max-age to 0 (over an https connection) will immediately expire the Strict-Transport-Security header, allowing access via http. 4. Preloading Strict Transport Security Google maintains an HSTS preload service. By following the guidelines and successfully submitting your domain, browsers will never connect to your domain using an insecure connection. While the service is hosted by Google, all browsers have stated an intent to use (or actually started using) the preload list. However, it is not part of the HSTS specification and should not be treated as official. Information regarding the HSTS preload list in Chrome : https://www.chromium.org/hsts Consultation of the Firefox HSTS preload list : nsSTSPreloadList.inc 5. Examples All present and future subdomains will be HTTPS for a max-age of 1 year. This blocks access to pages or subdomains that can only be served over HTTP. Strict-Transport-Security: max-age=31536000; includeSubDomains If a max-age of 1 year is acceptable for a domain, however, two years is the recommended value as explained on https://hstspreload.org. In the following example, max-age is set to 2 years, and is suffixed with preload, which is necessary for inclusion in most major web browsers&#39; HSTS preload lists, like Chromium, Edge, and Firefox. Strict-Transport-Security: max-age=63072000; includeSubDomains; preload 5.1. Create a self-signed certificate $ openssl req -x509 \\ -nodes \\ -newkey rsa:4096 \\ -days 3650 \\ -keyout local.io.ca.key \\ -out local.io.ca.crt \\ -subj &quot;/C=CN/ST=Shanghai/L=Shanghai/O=Global Security/OU=IT Department/CN=*.local.io&quot; \\ -addext &quot;subjectAltName=DNS:local.io,DNS:*.local.io&quot; $ openssl x509 -in local.io.crt -noout -text Certificate: Data: Version: 3 (0x2) Serial Number: 62:13:50:8d:8f:d9:8e:8a:ff:36:a7:c1:d0:b7:47:cc:6f:c4:b1:66 Signature Algorithm: sha256WithRSAEncryption Issuer: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io Validity Not Before: Oct 15 09:24:46 2021 GMT Not After : Oct 13 09:24:46 2031 GMT Subject: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:c0:ee:c5:35:60:e2:d7:82:98:2b:ae:22:0c:ec: 01:ae:d1:49:20:4b:c9:b4:fd:e8:1f:7e:32:80:ed: 16:b9:98:73:0a:5f:7f:54:9c:f1:62:09:d2:1a:38: 15:27:ea:d8:2f:2e:7f:9b:ac:ef:08:a5:17:cb:5b: c4:44:a7:d7:13:bf:8e:d6:e3:d0:ce:fa:dd:08:70: 99:a3:3c:76:1a:6e:21:fa:42:ea:db:3a:6a:35:0e: 2d:ac:8b:89:ec:ad:e6:bd:c3:8c:1a:f0:21:c4:3d: ac:c2:2e:74:63:ac:71:35:4e:65:30:07:63:6a:1e: f2:68:7e:bb:58:25:45:e1:95:a4:e0:e6:23:62:48: a3:0f:4a:a3:1d:b3:aa:94:3a:ea:ca:a6:2a:90:1c: f9:04:77:d1:26:29:a1:f4:b5:12:4e:46:eb:5f:f3: 46:aa:1c:0a:61:44:04:56:bc:6e:52:6d:b9:d0:fa: 76:4d:ca:3a:b3:80:94:8c:6d:8a:96:f7:27:56:a5: 58:b3:1a:f7:4c:9f:99:06:09:1b:a8:da:a7:82:7d: 3f:1e:5d:24:7c:d8:0f:37:48:42:ea:8e:2b:e7:aa: 22:cf:af:18:4c:8e:29:1f:c2:d3:6b:af:52:5a:67: 57:78:04:58:b7:8c:11:9c:ce:23:c7:a0:b2:d2:53: e4:f5 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Subject Key Identifier: 4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29 X509v3 Authority Key Identifier: keyid:4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29 X509v3 Basic Constraints: critical CA:TRUE X509v3 Subject Alternative Name: DNS:local.io, DNS:*.local.io Signature Algorithm: sha256WithRSAEncryption 86:9e:85:87:5b:b1:64:a6:9f:7b:a3:ca:a0:1d:df:bc:3a:a3: 3c:aa:95:df:51:98:27:fd:5b:aa:1a:c1:7d:f0:a5:66:0b:13: 74:ba:e8:ab:0e:be:78:73:db:09:ba:f5:19:4a:e8:b4:fd:2e: b3:10:26:5a:c0:98:f7:77:e3:73:92:e2:5a:8d:26:04:be:d3: fc:84:61:9e:f9:f0:4a:8c:27:27:66:ab:77:d3:73:7c:b4:72: 82:f5:00:20:46:b2:ec:9a:cb:80:ad:cc:7c:ca:51:5c:a1:33: 17:46:28:8b:14:32:90:55:a5:de:a6:90:dd:78:99:8a:48:73: e2:ec:a2:a8:ef:eb:d3:64:e9:65:cc:4c:bc:85:3d:ab:e3:13: f3:72:3b:fa:43:f5:4e:32:68:7d:44:35:d8:17:99:af:79:aa: af:7d:72:4f:b6:0c:41:7d:bd:e8:ee:1f:66:70:7e:c1:d7:cf: 3b:07:86:78:70:be:0b:60:91:e3:26:3c:a3:a3:a0:7c:c8:a0: 97:9b:2c:45:cd:07:05:d4:f7:ff:78:63:7f:f7:51:8e:71:b0: d7:cc:c3:6a:21:85:4f:3d:5c:22:62:bf:cb:f2:09:73:9e:bc: 77:0f:5b:93:24:fa:df:c4:bf:f7:49:16:e0:72:6b:f7:48:be: f9:69:83:64 5.2. Import CA root certificates 5.2.1. Linux (Debian / Ubuntu) $ curl -iI https://local.io curl: (60) SSL certificate problem: self signed certificate More details here: https://curl.haxx.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. Installing the root certificate on a Linux PC is straight forward: $ sudo mkdir /usr/local/share/ca-certificates/extra $ sudo cp local.io.crt /usr/local/share/ca-certificates/extra/ $ sudo update-ca-certificates Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done. Running hooks in /etc/ca-certificates/update.d... Adding debian:local.io.pem done. done. After these steps the new CA is known by system utilities like curl and get. $ curl -iI https://local.io HTTP/2 200 date: Fri, 15 Oct 2021 10:39:53 GMT content-type: text/plain strict-transport-security: max-age=15724800; includeSubDomains cache-control: public, max-age=3600 5.2.2. Windows Double click the certificate file local.io.crt and click the Install Certificate&#8230;&#8203;. 5.3. Test subdomain with echo.local.io Open https://echo.local.io on Chrome(Version 94.0.4606.81 (Official Build) (64-bit)) Figure 1. Open https://echo.local.io on Windows Chrome Browser then open chrome://net-internals/#hsts and Query HSTS/PKP host domain with echo.local.io. Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634294710.318108 dynamic_sts_expiry: 1650019510.318091 Query HSTS/PKP domain with another subdoamin as level as host domain foo.local.io. Not found Query HSTS/PKP domain with root domain fo the host domain local.io. Not found Query HSTS/PKP domain with subdomain to the host domain buzz.echo.local.io. Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634298549.210941 dynamic_sts_expiry: 1650023349.210936 Open echo.local.io with HTTPS scheme via http://echo.local.io Figure 2. Access with http after HSTS 5.4. Test root domain with local.io Clear Chrome browing data to remove HSTS. Open https://loca.io with Chrome Query HSTS/PKP domain with loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295941.084076 dynamic_sts_expiry: 1650020741.084073 Query HSTS/PKP domain with subdomain echo.loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295977.355846 dynamic_sts_expiry: 1650020777.355843 5.5. Update or clear HSTS via max-age=0 Open https://loca.io with Chrome $ curl -iIL https://local.io HTTP/2 200 date: Fri, 15 Oct 2021 11:13:43 GMT content-type: text/plain cache-control: public, max-age=3600 strict-transport-security: max-age=0; includeSubDomain Figure 3. Server response HSTS with max-age=0 Query HSTS/PKP domain with loca.io Not found Query HSTS/PKP domain with subdomain echo.loca.io Found: static_sts_domain: static_upgrade_mode: UNKNOWN static_sts_include_subdomains: static_sts_observed: static_pkp_domain: static_pkp_include_subdomains: static_pkp_observed: static_spki_hashes: dynamic_sts_domain: echo.local.io dynamic_upgrade_mode: FORCE_HTTPS dynamic_sts_include_subdomains: true dynamic_sts_observed: 1634295977.355846 dynamic_sts_expiry: 1650020777.355843 Ingress Nginx in Kubernetes nginx.ingress.kubernetes.io/configuration-snippet: | proxy_hide_header Strict-Transport-Security; add_header Strict-Transport-Security &quot;max-age=0; includeSubDomains&quot; always; 6. References https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2 https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security https://www.chromium.org/hsts https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/certmgr https://thomas-leister.de/en/how-to-import-ca-root-certificate/ http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header","headline":"HTTP Strict-Transport-Security","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.codefarm.me/2021/10/15/http-strict-transport-security/"},"url":"https://blog.codefarm.me/2021/10/15/http-strict-transport-security/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-SN88FJ18E5');
    </script></head>
  <body>
    <header class="c-header">
  <div class="o-container">
    <a class="c-header-title" href="/">CODE FARM</a>
    <button class="c-header-nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
      <span class="c-header-nav-toggle-icon"></span>
    </button>
    <div class="c-header-nav-wrapper" id="nav-wrapper">
      <nav class="c-header-nav">
        <a href="/">Home</a>
        <a href="/categories/">Category</a>
        <a href="/tags/">Tag</a>
        <a href="/archives/">Archive</a>
        <a href="/about/">About</a>
        <a href="https://resume.github.io/?looogos" target="_blank">R&eacute;sum&eacute;</a>
      </nav>
    </div>
  </div>
  



<div class="o-container">
  <div class="c-banner">
    <img src="/assets/images/galaxy.svg" alt="Galaxy background" class="c-banner-bg">
    <div class="c-banner-quote">
      <p>"The Renaissance was a time when art, science, and philosophy flourished."</p>
      <cite>- Michelangelo</cite>
    </div>
  </div>
</div>
</header>

    <main class="o-container">
      <article class="c-post">
  <header class="c-post-header">
    <h1 class="c-post-title">HTTP Strict-Transport-Security</h1><p class="c-post-meta">15 Oct 2021</p>
  </header>

  <div class="c-post-content">
    <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#syntax">1. Syntax</a></li>
<li><a href="#directives">2. Directives</a></li>
<li><a href="#description">3. Description</a>
<ul class="sectlevel2">
<li><a href="#an-example-scenario">3.1. An example scenario</a></li>
<li><a href="#how-the-browser-handles-it">3.2. How the browser handles it</a></li>
</ul>
</li>
<li><a href="#preloading-strict-transport-security">4. Preloading Strict Transport Security</a></li>
<li><a href="#examples">5. Examples</a>
<ul class="sectlevel2">
<li><a href="#create-a-self-signed-certificate">5.1. Create a self-signed certificate</a></li>
<li><a href="#import-ca-root-certificates">5.2. Import CA root certificates</a></li>
<li><a href="#test-subdomain-with-echo-local-io">5.3. Test subdomain with <code>echo.local.io</code></a></li>
<li><a href="#test-root-domain-with-local-io">5.4. Test root domain with <code>local.io</code></a></li>
<li><a href="#update-or-clear-hsts-via-max-age0">5.5. Update or clear HSTS via <code>max-age=0</code></a></li>
</ul>
</li>
<li><a href="#references">6. References</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <strong>HTTP <code>Strict-Transport-Security</code></strong> response header (often abbreviated as <strong>HSTS</strong>) lets a web site tell browsers that it should only be accessed using HTTPS, instead of using HTTP.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="syntax">1. Syntax</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">Strict-Transport-Security: max-age=&lt;expire-time&gt;</span><span class="w">
</span><span class="gp">Strict-Transport-Security: max-age=&lt;expire-time&gt;</span><span class="p">;</span> includeSubDomains
<span class="gp">Strict-Transport-Security: max-age=&lt;expire-time&gt;</span><span class="p">;</span> preload</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="directives">2. Directives</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code>max-age=&lt;expire-time&gt;</code></p>
<div class="paragraph">
<p>The time, in seconds, that the browser should remember that a site is only to be accessed using HTTPS.</p>
</div>
</li>
<li>
<p><code>includeSubDomains</code> <code>Optional</code></p>
<div class="paragraph">
<p>If this optional parameter is specified, this rule applies to all of the site&#8217;s subdomains as well.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>6.1.2.  The includeSubDomains Directive</p>
</div>
<div class="paragraph">
<p>The OPTIONAL "includeSubDomains" directive is a valueless directive
which, if present (i.e., it is "asserted"), signals the UA that the
HSTS Policy <strong>applies to this HSTS Host as well as any subdomains of
the host&#8217;s domain name</strong>.</p>
</div>
<div class="paragraph">
<p><a href="https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2" class="bare">https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2</a></p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><code>preload</code> <code>Optional</code></p>
<div class="paragraph">
<p>See <a href="#xx">Preloading Strict Transport Security</a> for details. Not part of the specification.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="description">3. Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If a website accepts a connection through HTTP and redirects to HTTPS, visitors may initially communicate with the non-encrypted version of the site before being redirected, if, for example, the visitor types http://www.foo.com/ or even just foo.com. This creates an opportunity for a <strong>man-in-the-middle attack</strong>. The redirect could be exploited to direct visitors to a malicious site instead of the secure version of the original site.</p>
</div>
<div class="paragraph">
<p>The HTTP Strict Transport Security header informs the browser that it should never load a site using HTTP and should automatically convert all attempts to access the site using HTTP to HTTPS requests instead.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Strict-Transport-Security header is ignored by the browser when your site is accessed using HTTP; this is because an attacker may intercept HTTP connections and inject the header or remove it. When your site is accessed over HTTPS with no certificate errors, the browser knows your site is HTTPS capable and will honor the <strong>Strict-Transport-Security</strong> header.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="an-example-scenario">3.1. An example scenario</h3>
<div class="paragraph">
<p>You log into a free WiFi access point at an airport and start surfing the web, visiting your online banking service to check your balance and pay a couple of bills. Unfortunately, the access point you&#8217;re using is actually a hacker&#8217;s laptop, and they&#8217;re intercepting your original HTTP request and redirecting you to a clone of your bank&#8217;s site instead of the real thing. Now your private data is exposed to the hacker.</p>
</div>
<div class="paragraph">
<p>Strict Transport Security resolves this problem; as long as you&#8217;ve accessed your bank&#8217;s web site once using HTTPS, and the bank&#8217;s web site uses Strict Transport Security, your browser will know to automatically use only HTTPS, which prevents hackers from performing this sort of man-in-the-middle attack.</p>
</div>
</div>
<div class="sect2">
<h3 id="how-the-browser-handles-it">3.2. How the browser handles it</h3>
<div class="paragraph">
<p>The first time your site is accessed using HTTPS and it returns the Strict-Transport-Security header, the browser records this information, so that future attempts to load the site using HTTP will automatically use HTTPS instead.</p>
</div>
<div class="paragraph">
<p>When the expiration time specified by the Strict-Transport-Security header elapses, the next attempt to load the site via HTTP will proceed as normal instead of automatically using HTTPS.</p>
</div>
<div class="paragraph">
<p><em>Whenever the <strong>Strict-Transport-Security</strong> header is delivered to the browser, it will update the expiration time for that site, so sites can refresh this information and prevent the timeout from expiring. Should it be necessary to disable Strict Transport Security, setting the <strong>max-age to 0</strong> (over an https connection) will immediately expire the Strict-Transport-Security header, allowing access via http.</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preloading-strict-transport-security">4. Preloading Strict Transport Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google maintains an <a href="https://hg.mozilla.org/mozilla-central/raw-file/tip/security/manager/ssl/nsSTSPreloadList.inc">HSTS preload service</a>. By following the guidelines and successfully submitting your domain, browsers will never connect to your domain using an insecure connection. While the service is hosted by Google, all browsers have stated an intent to use (or actually started using) the preload list. However, it is not part of the HSTS specification and should not be treated as official.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Information regarding the HSTS preload list in Chrome : <a href="https://www.chromium.org/hsts" class="bare">https://www.chromium.org/hsts</a></p>
</li>
<li>
<p>Consultation of the Firefox HSTS preload list : <a href="https://hg.mozilla.org/mozilla-central/raw-file/tip/security/manager/ssl/nsSTSPreloadList.inc">nsSTSPreloadList.inc</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples">5. Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All present and future subdomains will be HTTPS for a <code>max-age</code> of 1 year. This blocks access to pages or subdomains that can only be served over HTTP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">Strict-Transport-Security: max-age=31536000;</span><span class="w"> </span>includeSubDomains</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a <code>max-age</code> of 1 year is acceptable for a domain, however, two years is the recommended value as explained on <a href="https://hstspreload.org" class="bare">https://hstspreload.org</a>.</p>
</div>
<div class="paragraph">
<p>In the following example, <code>max-age</code> is set to 2 years, and is suffixed with preload, which is necessary for inclusion in most major web browsers' HSTS preload lists, like Chromium, Edge, and Firefox.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">Strict-Transport-Security: max-age=63072000;</span><span class="w"> </span>includeSubDomains<span class="p">;</span> preload</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="create-a-self-signed-certificate">5.1. Create a self-signed certificate</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>openssl req <span class="nt">-x509</span> <span class="se">\</span>
<span class="go">  -nodes \</span>
<span class="go">  -newkey rsa:4096 \</span>
<span class="go">  -days 3650 \</span>
<span class="go">  -keyout local.io.ca.key \</span>
<span class="go">  -out local.io.ca.crt \</span>
<span class="go">  -subj "/C=CN/ST=Shanghai/L=Shanghai/O=Global Security/OU=IT Department/CN=*.local.io" \</span>
<span class="hll"><span class="go">  -addext "subjectAltName=DNS:local.io,DNS:*.local.io"</span>
</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>openssl x509 <span class="nt">-in</span> local.io.crt <span class="nt">-noout</span> <span class="nt">-text</span>
<span class="go">Certificate:</span>
<span class="go">    Data:</span>
<span class="go">        Version: 3 (0x2)</span>
<span class="go">        Serial Number:</span>
<span class="go">            62:13:50:8d:8f:d9:8e:8a:ff:36:a7:c1:d0:b7:47:cc:6f:c4:b1:66</span>
<span class="go">        Signature Algorithm: sha256WithRSAEncryption</span>
<span class="go">        Issuer: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io</span>
<span class="go">        Validity</span>
<span class="go">            Not Before: Oct 15 09:24:46 2021 GMT</span>
<span class="go">            Not After : Oct 13 09:24:46 2031 GMT</span>
<span class="go">        Subject: C = CN, ST = Shanghai, L = Shanghai, O = Global Security, OU = IT Department, CN = *.local.io</span>
<span class="go">        Subject Public Key Info:</span>
<span class="go">            Public Key Algorithm: rsaEncryption</span>
<span class="go">                RSA Public-Key: (2048 bit)</span>
<span class="go">                Modulus:</span>
<span class="go">                    00:c0:ee:c5:35:60:e2:d7:82:98:2b:ae:22:0c:ec:</span>
<span class="go">                    01:ae:d1:49:20:4b:c9:b4:fd:e8:1f:7e:32:80:ed:</span>
<span class="go">                    16:b9:98:73:0a:5f:7f:54:9c:f1:62:09:d2:1a:38:</span>
<span class="go">                    15:27:ea:d8:2f:2e:7f:9b:ac:ef:08:a5:17:cb:5b:</span>
<span class="go">                    c4:44:a7:d7:13:bf:8e:d6:e3:d0:ce:fa:dd:08:70:</span>
<span class="go">                    99:a3:3c:76:1a:6e:21:fa:42:ea:db:3a:6a:35:0e:</span>
<span class="go">                    2d:ac:8b:89:ec:ad:e6:bd:c3:8c:1a:f0:21:c4:3d:</span>
<span class="go">                    ac:c2:2e:74:63:ac:71:35:4e:65:30:07:63:6a:1e:</span>
<span class="go">                    f2:68:7e:bb:58:25:45:e1:95:a4:e0:e6:23:62:48:</span>
<span class="go">                    a3:0f:4a:a3:1d:b3:aa:94:3a:ea:ca:a6:2a:90:1c:</span>
<span class="go">                    f9:04:77:d1:26:29:a1:f4:b5:12:4e:46:eb:5f:f3:</span>
<span class="go">                    46:aa:1c:0a:61:44:04:56:bc:6e:52:6d:b9:d0:fa:</span>
<span class="go">                    76:4d:ca:3a:b3:80:94:8c:6d:8a:96:f7:27:56:a5:</span>
<span class="go">                    58:b3:1a:f7:4c:9f:99:06:09:1b:a8:da:a7:82:7d:</span>
<span class="go">                    3f:1e:5d:24:7c:d8:0f:37:48:42:ea:8e:2b:e7:aa:</span>
<span class="go">                    22:cf:af:18:4c:8e:29:1f:c2:d3:6b:af:52:5a:67:</span>
<span class="go">                    57:78:04:58:b7:8c:11:9c:ce:23:c7:a0:b2:d2:53:</span>
<span class="go">                    e4:f5</span>
<span class="go">                Exponent: 65537 (0x10001)</span>
<span class="go">        X509v3 extensions:</span>
<span class="go">            X509v3 Subject Key Identifier:</span>
<span class="go">                4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29</span>
<span class="go">            X509v3 Authority Key Identifier:</span>
<span class="go">                keyid:4D:38:64:F3:FC:A8:87:AA:81:C2:D9:2F:7B:CD:41:1C:A7:EC:AB:29</span>

<span class="go">            X509v3 Basic Constraints: critical</span>
<span class="go">                CA:TRUE</span>
<span class="go">            X509v3 Subject Alternative Name:</span>
<span class="hll"><span class="go">                DNS:local.io, DNS:*.local.io</span>
</span><span class="go">    Signature Algorithm: sha256WithRSAEncryption</span>
<span class="go">         86:9e:85:87:5b:b1:64:a6:9f:7b:a3:ca:a0:1d:df:bc:3a:a3:</span>
<span class="go">         3c:aa:95:df:51:98:27:fd:5b:aa:1a:c1:7d:f0:a5:66:0b:13:</span>
<span class="go">         74:ba:e8:ab:0e:be:78:73:db:09:ba:f5:19:4a:e8:b4:fd:2e:</span>
<span class="go">         b3:10:26:5a:c0:98:f7:77:e3:73:92:e2:5a:8d:26:04:be:d3:</span>
<span class="go">         fc:84:61:9e:f9:f0:4a:8c:27:27:66:ab:77:d3:73:7c:b4:72:</span>
<span class="go">         82:f5:00:20:46:b2:ec:9a:cb:80:ad:cc:7c:ca:51:5c:a1:33:</span>
<span class="go">         17:46:28:8b:14:32:90:55:a5:de:a6:90:dd:78:99:8a:48:73:</span>
<span class="go">         e2:ec:a2:a8:ef:eb:d3:64:e9:65:cc:4c:bc:85:3d:ab:e3:13:</span>
<span class="go">         f3:72:3b:fa:43:f5:4e:32:68:7d:44:35:d8:17:99:af:79:aa:</span>
<span class="go">         af:7d:72:4f:b6:0c:41:7d:bd:e8:ee:1f:66:70:7e:c1:d7:cf:</span>
<span class="go">         3b:07:86:78:70:be:0b:60:91:e3:26:3c:a3:a3:a0:7c:c8:a0:</span>
<span class="go">         97:9b:2c:45:cd:07:05:d4:f7:ff:78:63:7f:f7:51:8e:71:b0:</span>
<span class="go">         d7:cc:c3:6a:21:85:4f:3d:5c:22:62:bf:cb:f2:09:73:9e:bc:</span>
<span class="go">         77:0f:5b:93:24:fa:df:c4:bf:f7:49:16:e0:72:6b:f7:48:be:</span>
<span class="go">         f9:69:83:64</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="import-ca-root-certificates">5.2. Import CA root certificates</h3>
<div class="sect3">
<h4 id="linux-debian-ubuntu">5.2.1. Linux (Debian / Ubuntu)</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-iI</span> https://local.io
<span class="go">curl: (60) SSL certificate problem: self signed certificate
More details here: https://curl.haxx.se/docs/sslcerts.html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn more about this situation and
how to fix it, please visit the web page mentioned above.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Installing the root certificate on a Linux PC is straight forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">sudo mkdir</span> /usr/local/share/ca-certificates/extra
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo cp </span>local.io.crt /usr/local/share/ca-certificates/extra/
<span class="gp">$</span><span class="w"> </span><span class="nb">sudo </span>update-ca-certificates
<span class="go">Updating certificates in /etc/ssl/certs...
</span><span class="gp">1 added, 0 removed;</span><span class="w"> </span><span class="k">done</span><span class="nb">.</span>
<span class="go">Running hooks in /etc/ca-certificates/update.d...

Adding debian:local.io.pem
done.
done.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After these steps the new CA is known by system utilities like curl and get.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-iI</span> https://local.io
<span class="go">HTTP/2 200</span>
<span class="go">date: Fri, 15 Oct 2021 10:39:53 GMT</span>
<span class="go">content-type: text/plain</span>
<span class="hll"><span class="gp">strict-transport-security: max-age=15724800;</span><span class="w"> </span>includeSubDomains
</span><span class="go">cache-control: public, max-age=3600</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="windows">5.2.2. Windows</h4>
<div class="paragraph">
<p>Double click the certificate file <code>local.io.crt</code> and click the <code>Install Certificate&#8230;&#8203;</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-subdomain-with-echo-local-io">5.3. Test subdomain with <code>echo.local.io</code></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code><a href="https://echo.local.io" class="bare">https://echo.local.io</a></code> on Chrome(<strong>Version 94.0.4606.81 (Official Build) (64-bit)</strong>)</p>
<div class="imageblock">
<div class="content">
<img src="/assets/hsts/echo-local-io-hsts.png" alt="75%" width="75%">
</div>
<div class="title">Figure 1. Open <code><a href="https://echo.local.io" class="bare">https://echo.local.io</a></code> on Windows Chrome Browser</div>
</div>
</li>
<li>
<p>then open <code>chrome://net-internals/#hsts</code> and <code>Query HSTS/PKP host domain</code> with <code>echo.local.io</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Found:</span>
<span class="go">static_sts_domain:</span>
<span class="go">static_upgrade_mode: UNKNOWN</span>
<span class="go">static_sts_include_subdomains:</span>
<span class="go">static_sts_observed:</span>
<span class="go">static_pkp_domain:</span>
<span class="go">static_pkp_include_subdomains:</span>
<span class="go">static_pkp_observed:</span>
<span class="go">static_spki_hashes:</span>
<span class="hll"><span class="go">dynamic_sts_domain: echo.local.io</span>
</span><span class="hll"><span class="go">dynamic_upgrade_mode: FORCE_HTTPS</span>
</span><span class="hll"><span class="go">dynamic_sts_include_subdomains: true</span>
</span><span class="hll"><span class="go">dynamic_sts_observed: 1634294710.318108</span>
</span><span class="hll"><span class="go">dynamic_sts_expiry: 1650019510.318091</span>
</span></code></pre>
</div>
</div>
</li>
<li>
<p>Query HSTS/PKP domain with another subdoamin as level as host domain <code>foo.local.io</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Not found</span></code></pre>
</div>
</div>
</li>
<li>
<p>Query HSTS/PKP domain with root domain fo the host domain <code>local.io</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Not found</span></code></pre>
</div>
</div>
</li>
<li>
<p>Query HSTS/PKP domain with subdomain to the host domain <code>buzz.echo.local.io</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Found:</span>
<span class="go">static_sts_domain:</span>
<span class="go">static_upgrade_mode: UNKNOWN</span>
<span class="go">static_sts_include_subdomains:</span>
<span class="go">static_sts_observed:</span>
<span class="go">static_pkp_domain:</span>
<span class="go">static_pkp_include_subdomains:</span>
<span class="go">static_pkp_observed:</span>
<span class="go">static_spki_hashes:</span>
<span class="hll"><span class="go">dynamic_sts_domain: echo.local.io</span>
</span><span class="hll"><span class="go">dynamic_upgrade_mode: FORCE_HTTPS</span>
</span><span class="hll"><span class="go">dynamic_sts_include_subdomains: true</span>
</span><span class="hll"><span class="go">dynamic_sts_observed: 1634298549.210941</span>
</span><span class="hll"><span class="go">dynamic_sts_expiry: 1650023349.210936</span>
</span></code></pre>
</div>
</div>
</li>
<li>
<p>Open <code>echo.local.io</code> with HTTPS scheme via <code><a href="http://echo.local.io" class="bare">http://echo.local.io</a></code></p>
<div class="imageblock">
<div class="content">
<img src="/assets/hsts/echo-local-io-hsts-http-status-307.png" alt="75%" width="75%">
</div>
<div class="title">Figure 2. Access with http after HSTS</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="test-root-domain-with-local-io">5.4. Test root domain with <code>local.io</code></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clear Chrome browing data to remove <code>HSTS</code>.</p>
</li>
<li>
<p>Open <code><a href="https://loca.io" class="bare">https://loca.io</a></code> with Chrome</p>
</li>
<li>
<p>Query HSTS/PKP domain with <code>loca.io</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Found:</span>
<span class="go">static_sts_domain:</span>
<span class="go">static_upgrade_mode: UNKNOWN</span>
<span class="go">static_sts_include_subdomains:</span>
<span class="go">static_sts_observed:</span>
<span class="go">static_pkp_domain:</span>
<span class="go">static_pkp_include_subdomains:</span>
<span class="go">static_pkp_observed:</span>
<span class="go">static_spki_hashes:</span>
<span class="hll"><span class="go">dynamic_sts_domain: local.io</span>
</span><span class="hll"><span class="go">dynamic_upgrade_mode: FORCE_HTTPS</span>
</span><span class="hll"><span class="go">dynamic_sts_include_subdomains: true</span>
</span><span class="hll"><span class="go">dynamic_sts_observed: 1634295941.084076</span>
</span><span class="hll"><span class="go">dynamic_sts_expiry: 1650020741.084073</span>
</span></code></pre>
</div>
</div>
</li>
<li>
<p>Query HSTS/PKP domain with subdomain <code>echo.loca.io</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Found:</span>
<span class="go">static_sts_domain:</span>
<span class="go">static_upgrade_mode: UNKNOWN</span>
<span class="go">static_sts_include_subdomains:</span>
<span class="go">static_sts_observed:</span>
<span class="go">static_pkp_domain:</span>
<span class="go">static_pkp_include_subdomains:</span>
<span class="go">static_pkp_observed:</span>
<span class="go">static_spki_hashes:</span>
<span class="hll"><span class="go">dynamic_sts_domain: echo.local.io</span>
</span><span class="hll"><span class="go">dynamic_upgrade_mode: FORCE_HTTPS</span>
</span><span class="hll"><span class="go">dynamic_sts_include_subdomains: true</span>
</span><span class="hll"><span class="go">dynamic_sts_observed: 1634295977.355846</span>
</span><span class="hll"><span class="go">dynamic_sts_expiry: 1650020777.355843</span>
</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="update-or-clear-hsts-via-max-age0">5.5. Update or clear HSTS via <code>max-age=0</code></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code><a href="https://loca.io" class="bare">https://loca.io</a></code> with Chrome</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-iIL</span> https://local.io
<span class="go">HTTP/2 200
date: Fri, 15 Oct 2021 11:13:43 GMT
content-type: text/plain
cache-control: public, max-age=3600
</span><span class="gp">strict-transport-security: max-age=0;</span><span class="w"> </span>includeSubDomain</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/hsts/local-io-hsts-max-age-0.png" alt="75%" width="75%">
</div>
<div class="title">Figure 3. Server response HSTS with max-age=0</div>
</div>
</li>
<li>
<p>Query HSTS/PKP domain with <code>loca.io</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Not found</span></code></pre>
</div>
</div>
</li>
<li>
<p>Query HSTS/PKP domain with subdomain <code>echo.loca.io</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">Found:</span>
<span class="go">static_sts_domain:</span>
<span class="go">static_upgrade_mode: UNKNOWN</span>
<span class="go">static_sts_include_subdomains:</span>
<span class="go">static_sts_observed:</span>
<span class="go">static_pkp_domain:</span>
<span class="go">static_pkp_include_subdomains:</span>
<span class="go">static_pkp_observed:</span>
<span class="go">static_spki_hashes:</span>
<span class="hll"><span class="go">dynamic_sts_domain: echo.local.io</span>
</span><span class="hll"><span class="go">dynamic_upgrade_mode: FORCE_HTTPS</span>
</span><span class="hll"><span class="go">dynamic_sts_include_subdomains: true</span>
</span><span class="hll"><span class="go">dynamic_sts_observed: 1634295977.355846</span>
</span><span class="hll"><span class="go">dynamic_sts_expiry: 1650020777.355843</span>
</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="listingblock">
<div class="title">Ingress Nginx in Kubernetes</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">nginx.ingress.kubernetes.io/configuration-snippet</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">proxy_hide_header Strict-Transport-Security;</span>
  <span class="s">add_header Strict-Transport-Security "max-age=0; includeSubDomains" always;</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">6. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2" class="bare">https://datatracker.ietf.org/doc/html/rfc6797#section-6.1.2</a></p>
</li>
<li>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security" class="bare">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security</a></p>
</li>
<li>
<p><a href="https://www.chromium.org/hsts" class="bare">https://www.chromium.org/hsts</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/certmgr" class="bare">https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/certmgr</a></p>
</li>
<li>
<p><a href="https://thomas-leister.de/en/how-to-import-ca-root-certificate/" class="bare">https://thomas-leister.de/en/how-to-import-ca-root-certificate/</a></p>
</li>
<li>
<p><a href="http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header" class="bare">http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header</a></p>
</li>
<li>
<p><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header" class="bare">https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header</a></p>
</li>
</ul>
</div>
</div>
</div>
<style>
  .utterances {
      max-width: 100%;
  }
</style>
<script src="https://utteranc.es/client.js"
        repo="looogos/utterances"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</article>
    </main>
    <footer class="c-footer">
  <div class="c-footer-license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details class="c-footer-extralinks" open>
    <summary class="c-footer-extralinks-summary">Extral Links</summary>
    <div class="c-footer-extralinks-content">
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/liquid/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>

    <script src="/assets/js/nav.js" defer></script>
    <script src="/assets/js/heading-anchors.js" defer></script>
    <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->    
    <script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>
  </body>
</html>
